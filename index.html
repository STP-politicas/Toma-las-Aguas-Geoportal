<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <title>Chac Mool de Toma las Aguas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Header con logo */
        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: white;
            padding: 12px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .header-title h1:hover {
            color: #667eea;
        }

        /* Botones minimizar/maximizar */
        .toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .toggle-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .panel-minimized {
            width: 50px !important;
            height: 50px !important;
            overflow: hidden !important;
            padding: 10px !important;
        }

        .panel-minimized > *:not(.toggle-btn) {
            display: none !important;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .control-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c5282;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 8px;
        }

        .control-panel h3 {
            font-size: 13px;
            margin: 15px 0 8px 0;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-control {
            margin: 6px 0;
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .layer-control:hover {
            background-color: #f7fafc;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .layer-control label {
            cursor: pointer;
            flex: 1;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .layer-count {
            margin-left: auto;
            font-size: 10px;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .layer-count.loaded {
            background: #c6f6d5;
            color: #22543d;
        }

        .color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .toggle-all {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 10px 0;
            width: 100%;
        }

        .toggle-all:hover {
            background: #3182ce;
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 250px;
        }

        .custom-popup {
            padding: 15px;
            font-family: 'Segoe UI', sans-serif;
            max-width: 100%;
            box-sizing: border-box;
        }

        .custom-popup h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .custom-popup-divider {
            border-top: 2px solid;
            padding-top: 10px;
            margin-top: 10px;
        }

        .custom-popup p {
            margin: 8px 0;
            color: #374151;
            font-size: 13px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.5;
        }

        .custom-popup strong {
            color: #1f2937;
        }

        .custom-popup a {
            word-break: break-all;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: 100%;
        }

        /* Estilos globales para todos los popups de Leaflet */
        .leaflet-popup-content-wrapper {
            overflow: hidden;
            box-sizing: border-box;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            overflow: hidden;
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Popup espec√≠fico de proyectos colaborativos */
        .collaborative-project-popup .leaflet-popup-content-wrapper {
            min-width: 300px;
            max-width: 400px;
            overflow: hidden;
        }

        .collaborative-project-popup .leaflet-popup-content {
            overflow: hidden;
            word-wrap: break-word;
        }

        /* ========== ESTILOS PARA MODAL DE BIENVENIDA ========== */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-modal.closing {
            animation: slideToHeader 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes slideToHeader {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(0.1) translateY(-90vh);
            }
        }

        .welcome-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            color: white;
            position: relative;
            transform: scale(1);
            transition: transform 0.5s ease;
        }

        .welcome-modal.closing .welcome-content {
            transform: scale(0.8);
        }

        .welcome-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.5);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 20px;
        }

        .welcome-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-style: italic;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 15px;
            display: block;
        }

        .welcome-section {
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .welcome-section h3 {
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .welcome-section p {
            font-size: 15px;
            margin-bottom: 10px;
            text-align: justify;
        }

        .highlight-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #fbbf24;
        }

        .highlight-box strong {
            color: #fbbf24;
        }

        .alert-box {
            background: rgba(239, 68, 68, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .features-list li:before {
            content: "üíß";
            position: absolute;
            left: 0;
        }

        .close-welcome-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .close-welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: #fbbf24;
            color: white;
        }

        /* Scrollbar personalizado para modal */
        .welcome-content::-webkit-scrollbar {
            width: 10px;
        }

        .welcome-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* ========== MEJORA PARA PANELES ARRASTRABLES ========== */
        .header {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .panel-minimized {
            cursor: move !important;
            user-select: none;
        }

        .panel-minimized.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        }

        .control-panel, .legends-panel {
            transition: box-shadow 0.3s;
        }

        /* ========== RESPONSIVE DESIGN PARA M√ìVILES ========== */
        @media (max-width: 768px) {
            /* Ajustar paneles laterales en m√≥vil - M√ÅS PEQUE√ëOS */
            .control-panel, .legends-panel {
                max-width: 90vw !important;
                max-height: 70vh !important;
                width: auto !important;
                font-size: 13px;
                overflow-y: auto;
            }

            /* Hacer el control panel m√°s compacto */
            .control-panel {
                padding: 12px;
                top: 10px;
                left: 10px;
                max-width: 85vw !important;
            }

            /* Panel de leyendas - M√ÅS COMPACTO */
            .legends-panel {
                right: 10px;
                bottom: 10px !important;
                top: auto !important;
                padding: 12px;
                max-width: 85vw !important;
                max-height: 60vh !important;
            }

            /* Hacer los botones de toggle M√ÅS GRANDES y VISIBLES */
            .toggle-btn {
                width: 44px !important;
                height: 44px !important;
                font-size: 20px !important;
                top: 5px !important;
                right: 5px !important;
                background: #ef4444 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .toggle-btn:active {
                transform: scale(0.95);
            }

            /* Panel minimizado M√ÅS GRANDE para f√°cil tap */
            .panel-minimized {
                width: 70px !important;
                height: 70px !important;
                padding: 10px !important;
            }

            /* Ajustar tama√±o de botones para touch */
            .layer-control {
                padding: 10px 12px;
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
            }

            .layer-control input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            /* Ajustar controles de capas */
            .control-panel h3 {
                font-size: 15px;
                margin: 15px 0 10px 0;
            }

            /* Hacer los botones m√°s grandes para m√≥vil */
            button {
                min-height: 44px;
                font-size: 14px !important;
                padding: 10px 15px !important;
            }

            /* Modal de agregar/editar proyecto responsive */
            #add-project-modal > div,
            #edit-project-modal > div {
                width: 95% !important;
                max-width: 95% !important;
                padding: 20px !important;
                margin: 10px;
                max-height: 90vh !important;
            }

            /* Inputs m√°s grandes en m√≥vil */
            input, textarea, select {
                font-size: 16px !important; /* Evita zoom autom√°tico en iOS */
                padding: 12px !important;
                min-height: 44px;
            }

            /* Ajustar grid de coordenadas */
            #add-project-modal input[type="number"],
            #edit-project-modal input[type="number"] {
                font-size: 14px !important;
            }

            /* Popups m√°s peque√±os en m√≥vil */
            .leaflet-popup-content-wrapper {
                max-width: calc(100vw - 60px) !important;
            }

            .collaborative-project-popup .leaflet-popup-content-wrapper {
                min-width: auto !important;
                max-width: calc(100vw - 60px) !important;
            }

            .custom-popup {
                font-size: 12px;
                padding: 12px;
            }

            .custom-popup h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .custom-popup p {
                font-size: 12px;
                margin: 6px 0;
            }

            .custom-popup button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            /* Indicador de captura de coordenadas en m√≥vil */
            #map-click-indicator {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: calc(100vw - 20px);
                padding: 15px;
            }

            #map-click-indicator h3 {
                font-size: 14px;
            }

            #map-click-indicator p {
                font-size: 11px;
            }

            /* Ajustar panel de usuario */
            #user-section {
                font-size: 11px;
            }

            #user-section button {
                font-size: 11px !important;
                padding: 8px !important;
                min-height: 40px;
            }

            /* Hacer el t√≠tulo m√°s peque√±o */
            .control-panel h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            /* Layer count badges */
            .layer-count {
                min-width: 28px;
                height: 28px;
                font-size: 12px;
            }

            /* Bot√≥n de minimizar/maximizar m√°s grande */
            .toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            /* Panel minimizado m√°s grande en m√≥vil */
            .panel-minimized {
                width: 60px !important;
                height: 60px !important;
            }

            /* Ocultar algunos elementos cuando el espacio es limitado */
            .welcome-modal {
                padding: 20px;
                max-width: 90%;
            }

            .welcome-modal h1 {
                font-size: 22px;
            }

            .welcome-modal p {
                font-size: 14px;
            }

            /* Ajustar modales de login/registro */
            #login-modal > div,
            #register-modal > div {
                width: 95% !important;
                padding: 20px !important;
                max-height: 90vh;
            }

            /* Hacer los formularios m√°s espaciados en m√≥vil */
            form > div {
                margin-bottom: 12px !important;
            }

            label {
                font-size: 13px !important;
            }
        }

        /* Para pantallas muy peque√±as (tel√©fonos en portrait) */
        @media (max-width: 480px) {
            .control-panel, .legends-panel {
                font-size: 12px;
                padding: 12px;
            }

            .control-panel h2 {
                font-size: 14px;
            }

            .control-panel h3 {
                font-size: 13px;
            }

            button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }

            .layer-control {
                padding: 8px 10px;
            }

            /* Hacer los popups a√∫n m√°s peque√±os */
            .custom-popup {
                font-size: 11px;
                padding: 10px;
            }

            .custom-popup h3 {
                font-size: 13px;
            }

            .custom-popup p {
                font-size: 11px;
            }

            /* Botones en popups m√°s peque√±os */
            .custom-popup button {
                font-size: 10px !important;
                padding: 5px 8px !important;
                min-height: 32px !important;
            }

            /* Grid de botones de admin en una columna */
            .custom-popup button[onclick*="editProject"],
            .custom-popup button[onclick*="moveProject"],
            .custom-popup button[onclick*="deleteProject"] {
                width: 100%;
                margin-bottom: 4px;
            }

            /* T√≠tulo del geoportal m√°s peque√±o */
            .welcome-modal h1 {
                font-size: 18px;
            }

            /* Indicador de captura m√°s compacto */
            #map-click-indicator {
                padding: 12px;
            }

            #map-click-indicator div[style*="font-size: 32px"] {
                font-size: 24px !important;
            }
        }

        /* M√≥viles en modo HORIZONTAL (landscape) - espacio vertical muy limitado */
        @media (max-width: 896px) and (max-height: 450px) and (orientation: landscape) {
            /* Paneles a√∫n m√°s peque√±os en landscape */
            .control-panel, .legends-panel {
                max-width: 45vw !important;
                max-height: 85vh !important;
                font-size: 11px !important;
                padding: 10px !important;
            }

            .control-panel {
                max-width: 40vw !important;
            }

            .legends-panel {
                max-width: 40vw !important;
                bottom: 5px !important;
                right: 5px !important;
            }

            /* T√≠tulos m√°s peque√±os */
            .control-panel h2,
            .control-panel h3,
            .legends-panel h3 {
                font-size: 12px !important;
                margin: 5px 0 !important;
            }

            /* Layer controls m√°s compactos */
            .layer-control {
                padding: 6px 8px !important;
                min-height: 36px !important;
                font-size: 11px !important;
            }

            /* Botones m√°s peque√±os */
            button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            /* Toggle button */
            .toggle-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }

            /* Panel minimizado m√°s peque√±o */
            .panel-minimized {
                width: 55px !important;
                height: 55px !important;
            }

            /* Modales m√°s peque√±os */
            #add-project-modal > div,
            #edit-project-modal > div {
                max-height: 85vh !important;
                padding: 15px !important;
            }

            /* Leyendas m√°s compactas */
            .legends-panel > div {
                margin-bottom: 8px !important;
            }

            .legends-panel strong {
                font-size: 10px !important;
            }
        }

        /* Para tablets en modo landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                max-width: 350px;
            }

            .legends-panel {
                max-width: 350px;
            }
        }

        /* Animaci√≥n para marcador GPS */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.8);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
                transform: scale(1);
            }
        }

        .gps-marker {
            background: transparent !important;
            border: none !important;
        }
    </style>
</head>
<body>
    <!-- ========== MODAL DE BIENVENIDA ========== -->
    <div id="welcome-modal" class="welcome-modal">
        <div class="welcome-content">
            <img src="data:image/webp;base64,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" 
             alt="Toma las Aguas" class="welcome-logo">
            <span class="welcome-icon">üåäüíßüèùÔ∏è</span>
            
            <div class="welcome-header">
                <h2>Bienvenido al Chac Mool</h2>
                </h2>de Toma las Aguas</h2>
                <p class="subtitle">Transparencia y Participaci√≥n Ciudadana para la Seguridad H√≠drica de Puerto Morelos</p>
            </div>

            <div class="welcome-section">
    <h3>üó∫Ô∏è ¬øPor qu√© este geoportal (Chac Mool)?</h3>
    <p>
         Puerto Morelos se ubica en una de las regiones con mayor vulnerabilidad hidrol√≥gica de la Pen√≠nsula de Yucat√°n. Su territorio se asienta sobre un 
        <strong>acu√≠fero k√°rstico</strong>, un sistema geol√≥gico profundamente fr√°gil, donde el agua se infiltra de manera directa a trav√©s de la roca caliza porosa,
        conectando la superficie con el subsuelo que sostiene nuestra vida. En este contexto, cada decisi√≥n tomada sobre el territorio ‚Äîurbanizaci√≥n,
        extracci√≥n, contaminaci√≥n u omisi√≥n‚Äî tiene efectos inmediatos sobre nuestro √∫nico reservorio de agua dulce.
    </p>
    <p>
        El nombre <strong>Chac Mool</strong> no es decorativo: es una alegor√≠a. En la cosmovisi√≥n mesoamericana, el Chac Mool era colocado en los umbrales de los templos,
        en los l√≠mites entre el espacio sagrado y el mundo terrenal. No era un dios, sino un <em>mensajero</em>: un intermediario que recib√≠a ofrendas de la tierra
        y las transmit√≠a a los dioses, particularmente a Chac, se√±or de la lluvia y del agua.
    </p>
    <p>
        Este geoportal ocupa ese mismo umbral. Se sit√∫a entre el territorio y la decisi√≥n p√∫blica, entre la naturaleza y la pol√≠tica. Chac Mool representa hoy
        a la ciudadan√≠a que observa, documenta y comunica lo que ocurre en el subsuelo invisible: el estado del acu√≠fero, las presiones que lo amenazan y las
        consecuencias de gobernar ‚Äîo no gobernar‚Äî el agua. Es un mensajero contempor√°neo que traduce datos en conocimiento, y conocimiento en exigencia social.
    </p>
    <p>
        As√≠, este geoportal habla en nombre de los dioses y del territorio mismo. Su funci√≥n es advertir, recordar y exigir equilibrio: que las decisiones
        humanas escuchen a la tierra antes de que el agua ‚Äîsilenciosa pero implacable‚Äî nos reclame lo que no supimos cuidar.
    </p>
</div>
            <div class="alert-box">
                <h3>‚ö†Ô∏è Crisis de Seguridad H√≠drica</h3>
                <p>El acelerado desarrollo inmobiliario est√° generando una <strong>crisis sin precedentes</strong>:</p>
                <ul class="features-list">
                    <li>Sobreexplotaci√≥n del acu√≠fero mediante extracci√≥n masiva de agua dulce</li>
                    <li>Contaminaci√≥n indirecta al acu√≠fero por lixiviados (l√≠quidos y/o aceites resiudales t√≥xicos producto de nuestra vida diaria) y aguas residuales mal tratadas</li>
                    <li>Destrucci√≥n de cenotes y sistemas de infiltraci√≥n natural</li>
                    <li>P√©rdida irreversible de selva que regula el ciclo hidrol√≥gico k√°rstico</li>
                    <li>Intrusi√≥n salina por extracci√≥n excesiva de agua dulce de parte de hoteles e inmboilirias-tur√≠sticas en zona costera</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üî¨ Fragilidad del Sistema K√°rstico</h3>
                <p>A diferencia de otros acu√≠feros, el sistema k√°rstico de Quintana Roo <strong>no filtra contaminantes</strong>. Las fracturas, cavernas y r√≠os subterr√°neos permiten que cualquier contaminante llegue directamente al agua que consumimos. Una vez contaminado, <strong>la remediaci√≥n del acu√≠fero es pr√°cticamente imposible</strong>.</p>
            </div>

            <div class="alert-box">
                <h3>üè≠ Extracci√≥n de Agua y Consecuencias Regionales</h3>
                <p>Los sistemas de extracci√≥n de agua en Puerto Morelos no solo abastecen a nuestra poblaci√≥n local, sino que tambi√©n proveen de agua dulce a <strong>Canc√∫n y su Aeropuerto Internacional</strong>. Esta extracci√≥n masiva genera:</p>
                <ul class="features-list">
                    <li><strong>Presi√≥n adicional sobre el acu√≠fero</strong> que excede su capacidad de recarga natural</li>
                    <li><strong>Riesgo elevado de intrusi√≥n salina</strong> en la zona costera por el descenso del nivel fre√°tico</li>
                    <li><strong>Impacto desproporcionado</strong> en nuestro territorio mientras otros municipios se benefician del recurso</li>
                </ul>
            </div>

            <div class="highlight-box">
                <h3>üó∫Ô∏è La Fractura Holbox-Xel-H√° y Nuestra Reserva Estrat√©gica</h3>
                <p>Puerto Morelos se encuentra sobre la <strong>Fractura Holbox-Xel-H√°</strong>, una l√≠nea geol√≥gica de m√°s de 300 kil√≥metros que divide el estado de Quintana Roo en dos y pasa directamente por Leona Vicario. Esta fractura es m√°s que una caracter√≠stica geol√≥gica:</p>
                <ul class="features-list">
                    <li>Representa la <strong>reserva de agua m√°s importante del norte de Quintana Roo</strong></li>
                    <li>Es un corredor hidrogeol√≥gico fundamental que alimenta los sistemas de recarga del acu√≠fero Maya</li>
                    <li><strong>Provee agua a m√°s de 1.5 millones de habitantes</strong> de la zona tur√≠stica m√°s importante de M√©xico</li>
                    <li>Constituye la <strong>mayor capacidad de almacenamiento de agua</strong> del noreste peninsular</li>
                    <li>Su protecci√≥n es <strong>estrat√©gica para la seguridad h√≠drica</strong> de toda la Riviera Maya</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Por esta raz√≥n, Puerto Morelos debe ser reconocido como un municipio proveedor de agua</strong>, con normativas especiales de protecci√≥n ambiental, ordenamiento territorial estricto y compensaciones por los servicios ecosist√©micos que brinda a la regi√≥n.</p>
            </div>

            <div class="highlight-box">
                <h3>üí° La Informaci√≥n es Poder</h3>
                <p><strong>Este geoportal (Chac Mool) busca democratizar el acceso a la informaci√≥n geoespacial cr√≠tica</strong> que tradicionalmente ha estado dispersa o inaccesible para la ciudadan√≠a. Integramos datos sobre:</p>
                <ul class="features-list">
                    <li>Desarrollos inmobiliarios y su impacto territorial</li>
                    <li>Zonas de karstificaci√≥n y vulnerabilidad acu√≠fera</li>
                    <li>Cenotes, manglares, aguadas, humedales y cuerpos de agua amenazados por el desorden territorial del Municipio de Puerto Morelos</li>
                    <li>Fallas geol√≥gicas y riesgo s√≠smico</li>
                    <li>√Åreas naturales protegidas, ejidales, el POEL del 2013 y sus normativas clave</li>
                    <li>An√°lisis geoestrat√©gico del territorio</li>
                    <li>Recopilar Denuncias de ecocidio e iniciativas comunitarias de defensa del agua-territorio portomorelense</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üë• Participaci√≥n Ciudadana</h3>
                <p>Al <strong>registrarte e iniciar sesi√≥n</strong>, podr√°s:</p>
                <ul class="features-list">
                    <li>Reportar nuevos desarrollos inmobiliarios que detectes</li>
                    <li>Documentar irregularidades ambientales</li>
                    <li>Verificar si existe Manifestaci√≥n de Impacto Ambiental (MIA)</li>
                    <li>Contribuir a un mapeo colaborativo del territorio ya sea denunciando irregularidades o compartiendo propuestas para dar un buen uso al agua-territorio</li>
                    <li>Acceder a an√°lisis espaciales actualizados</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üéØ Nuestro Objetivo</h3>
                <p>Hacer <strong>p√∫blica, din√°mica y colaborativa</strong> la informaci√≥n sobre el estado de nuestro territorio. Solo con transparencia y participaci√≥n ciudadana informada podremos:</p>
                <ul class="features-list">
                    <li>Exigir cumplimiento de normativas ambientales</li>
                    <li>Presionar por un desarrollo territorial sostenible</li>
                    <li>Proteger nuestro acu√≠fero para generaciones futuras</li>
                    <li>Construir resiliencia h√≠drica comunitaria</li>
                </ul>
            </div>

            <div class="highlight-box">
                <p style="text-align: center; font-size: 16px;"><strong>El agua es vida. El territorio es comunidad. La informaci√≥n es poder y soberan√≠a.</strong></p>
            </div>

            <button class="close-welcome-btn" onclick="closeWelcome()">
                üöÄ Comenzar a Explorar Chac Mool
            </button>
        </div>
    </div>

    <!-- Header con logo -->
    <div class="header">
        <img src="data:image/webp;base64,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" 
             alt="Toma las Aguas" class="header-logo">
        <div class="header-title">
            <h1 onclick="openWelcome()">Chac Mool de Toma las Aguas</h1>
        </div>
    </div>

    <div id="map"></div>

    <div class="loading-overlay" id="loading">
        <div style="text-align: center; background: white; padding: 30px; border-radius: 8px;">
            <div class="spinner"></div>
            <h3 style="color: #2c5282; margin-bottom: 10px;">Cargando Geoportal</h3>
            <p id="loading-text" style="color: #718096; font-size: 14px;">Iniciando...</p>
        </div>
    </div>

    <div class="control-panel" id="control-panel">
        <button class="toggle-btn" onclick="togglePanel('control-panel')" title="Minimizar/Maximizar">
            <span id="control-toggle-icon">‚àí</span>
        </button>
        <h2>üõ∞Ô∏è Geoportal <span class="success-badge">SATELITAL</span></h2>

        <button class="toggle-all" onclick="toggleAllLayers()">‚úì Activar/Desactivar Todas</button>
        
        <h3>üèóÔ∏è Desarrollo Urbano</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos" checked>
            <label for="layer-proyectos">
                <span class="color-indicator" style="background-color: #e53e3e;"></span>
                Proyectos Inmobiliarios-tur√≠sticos
            </label>
            <span class="layer-count" id="count-proyectos">0</span>
        </div>

        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos-colab" checked>
            <label for="layer-proyectos-colab">
                <span class="color-indicator" style="background-color: #9333ea;"></span>
                Proyectos Colaborativos
            </label>
            <span class="layer-count" id="count-proyectos-colab">0</span>
        </div>
        
        <div id="add-project-section" style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 4px; display: none;">
            <button id="add-project-btn" style="width: 100%; padding: 8px; background: #9333ea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                ‚ûï Agregar Proyecto
            </button>
            <p style="font-size: 10px; color: #6b7280; margin: 5px 0 0 0; text-align: center;">Haz click en el mapa o ingresa coordenadas</p>
        </div>
        
        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos-hidrosociales" checked>
            <label for="layer-proyectos-hidrosociales">
                <span class="color-indicator" style="background-color: #06b6d4;"></span>
                üå± Proyectos comunitarios de soberania Hidrosocial
            </label>
            <span class="layer-count" id="count-proyectos-hidrosociales">0</span>
        </div>
        
        <div id="add-hidrosocial-section" style="margin: 10px 0; padding: 12px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 6px; border: 2px solid #10b981; display: none;">
            <p style="font-size: 11px; color: #065f46; margin: 0 0 8px 0; font-weight: 600; line-height: 1.4;">
                üíß Prop√≥n proyectos comunitarios para restaurar el ciclo del agua
            </p>
            <button id="add-hidrosocial-btn" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                üå± Proponer Proyecto Hidrosocial
            </button>
            <p style="font-size: 9px; color: #047857; margin: 6px 0 0 0; text-align: center; font-style: italic;">
                Jardines de lluvia, humedales, reforestaci√≥n, captaci√≥n pluvial...
            </p>
        </div>
        
        <div id="login-section" style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 4px; border: 1px solid #fbbf24;">
            <p style="font-size: 11px; color: #78350f; margin: 0 0 8px 0; font-weight: 600;">Inicia sesi√≥n para colaborar</p>
            <button id="show-login-btn" style="width: 100%; padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 5px;">
                üîê Iniciar Sesi√≥n
            </button>
            <button id="show-register-btn" style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                üìù Registrarse
            </button>
        </div>
        
        <div id="user-section" style="margin: 10px 0; padding: 10px; background: #d1fae5; border-radius: 4px; border: 1px solid #10b981; display: none;">
            <p style="font-size: 11px; color: #065f46; margin: 0 0 8px 0;">
                üë§ <strong id="username-display"></strong>
            </p>
            <button id="export-csv-btn" style="width: 100%; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-bottom: 5px; font-weight: 600;">
                üìä Exportar Proyectos a CSV
            </button>
            <button id="logout-btn" style="width: 100%; padding: 6px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                Cerrar Sesi√≥n
            </button>
        </div>

        <h3>üíß Agua</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-descargas" checked>
            <label for="layer-descargas">
                <span class="color-indicator" style="background: linear-gradient(90deg, #7dd3fc, #0369a1);"></span>
                Descargas de agua residuales hasta el 2023
            </label>
            <span class="layer-count" id="count-descargas">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-extracciones" checked>
            <label for="layer-extracciones">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fb923c, #ea580c);"></span>
                Extracciones de agua dulce hasta el 2023
            </label>
            <span class="layer-count" id="count-extracciones">0</span>
        </div>

        <h3>üåä Cuerpos de Agua Antropizados (IAHCSA)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-cuerpos-agua" checked>
            <label for="layer-cuerpos-agua">
                <span class="color-indicator" style="background: linear-gradient(135deg, #3b82f6, #10b981);"></span>
                Todos los Cuerpos de Agua
            </label>
            <span class="layer-count" id="count-cuerpos-agua">0</span>
        </div>
        <div id="cuerpos-agua-summary" style="padding: 8px 8px 8px 28px; font-size: 11px; color: #4a5568; background: #f7fafc; border-radius: 4px; margin: 5px 0 10px 0;">
            <strong>Total:</strong> <span id="total-area-cuerpos">0</span> m¬≤
        </div>
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-piscinas" checked>
            <label for="layer-piscinas">
                <span class="color-indicator" style="background-color: #ec4899;"></span>
                Piscinas
            </label>
            <span class="layer-count" id="count-piscinas">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-piscinas"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sup" checked>
            <label for="layer-cenotes-sup">
                <span class="color-indicator" style="background-color: #10b981;"></span>
                Cenotes Modificados
            </label>
            <span class="layer-count" id="count-cenotes-sup">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sup"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sub" checked>
            <label for="layer-cenotes-sub">
                <span class="color-indicator" style="background-color: #ef4444;"></span>
                Cenotes Artificiales
            </label>
            <span class="layer-count" id="count-cenotes-sub">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sub"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-art" checked>
            <label for="layer-aguadas-art">
                <span class="color-indicator" style="background-color: #3b82f6;"></span>
                Aguadas Antropizadas
            </label>
            <span class="layer-count" id="count-aguadas-art">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-art"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-nat" checked>
            <label for="layer-aguadas-nat">
                <span class="color-indicator" style="background-color: #8b5cf6;"></span>
                Aguadas Naturales
            </label>
            <span class="layer-count" id="count-aguadas-nat">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-nat"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-sascab" checked>
            <label for="layer-sascab">
                <span class="color-indicator" style="background-color: #f59e0b;"></span>
                Sascaberas
            </label>
            <span class="layer-count" id="count-sascab">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-sascab"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-rios" checked>
            <label for="layer-rios">
                <span class="color-indicator" style="background-color: #06b6d4;"></span>
                R√≠os Artificiales
            </label>
            <span class="layer-count" id="count-rios">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-rios"></div>

        <h3>üåä Geolog√≠a e Hidrolog√≠a</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-karstificacion" checked>
            <label for="layer-karstificacion">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fef3c7, #78350f);"></span>
                Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-karstificacion">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-colapso-karst" checked>
            <label for="layer-colapso-karst">
                <span class="color-indicator" style="background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00);"></span>
                ‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-colapso-karst">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-inegi" checked>
            <label for="layer-fallas-inegi">
                <span class="color-indicator" style="background-color: #9f7aea;"></span>
                Fallas y fracturas k√°rsticas (INEGI)
            </label>
            <span class="layer-count" id="count-fallas-inegi">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-cenapred" checked>
            <label for="layer-fallas-cenapred">
                <span class="color-indicator" style="background-color: #ed64a6;"></span>
                Fallas y fracturas k√°rsticas (CENAPRED)
            </label>
            <span class="layer-count" id="count-fallas-cenapred">0</span>
        </div>

        <h3>üèûÔ∏è Ordenamiento</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-poel" checked>
            <label for="layer-poel">
                <span class="color-indicator" style="background: linear-gradient(135deg, #0ea5e9, #1e3a8a);"></span>
                POEL 2013
            </label>
            <span class="layer-count" id="count-poel">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-socioeco" checked>
            <label for="layer-socioeco">
                <span class="color-indicator" style="background: linear-gradient(135deg, #10b981, #0891b2);"></span>
                Zonas Inundables / Humedales k√°rsticos temporales y permanentes
            </label>
            <span class="layer-count" id="count-socioeco">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-municipio" checked>
            <label for="layer-municipio">
                <span class="color-indicator" style="background-color: rgba(74, 85, 104, 0.3); border: 2px solid #4a5568;"></span>
                L√≠mite Municipal
            </label>
            <span class="layer-count" id="count-municipio">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-sin" checked>
            <label for="layer-pozos-sin">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #ef4444;"></span>
                Pozos de agua para la poblaci√≥n de Puerto Morelos (sin Protecci√≥n)
            </label>
            <span class="layer-count" id="count-pozos-sin">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-con" checked>
            <label for="layer-pozos-con">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #10b981;"></span>
                Pozos de agua para la poblaci√≥n de Quintana Roo (con Protecci√≥n)
            </label>
            <span class="layer-count" id="count-pozos-con">0</span>
        </div>

        <h3>üèòÔ∏è Tierras Ejidales</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-comunales" checked>
            <label for="layer-tierras-comunales">
                <span class="color-indicator" style="background-color: #a855f7;"></span>
                Zonas Comunales Ejidales
            </label>
            <span class="layer-count" id="count-tierras-comunales">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-parceladas" checked>
            <label for="layer-tierras-parceladas">
                <span class="color-indicator" style="background-color: #f97316;"></span>
                Zonas Parceladas
            </label>
            <span class="layer-count" id="count-tierras-parceladas">0</span>
        </div>

        <h3>üèòÔ∏è Registro Agrario Nacional (RAN)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-nucleos-agrarios" checked>
            <label for="layer-nucleos-agrarios">
                <span class="color-indicator" style="background-color: #6366f1;"></span>
                N√∫cleos Agrarios
            </label>
            <span class="layer-count" id="count-nucleos-agrarios">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-asentamientos-humanos" checked>
            <label for="layer-asentamientos-humanos">
                <span class="color-indicator" style="background-color: #ec4899;"></span>
                Asentamientos Humanos
            </label>
            <span class="layer-count" id="count-asentamientos-humanos">0</span>
        </div>
        
        <h3>‚ö†Ô∏è POEL/PDU 2024</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-fraccionamientos-poel" checked>
            <label for="layer-fraccionamientos-poel">
                <span class="color-indicator" style="background-color: #ef4444; border: 2px dashed #991b1b;"></span>
                Fraccionamientos que el municipio busca Legalizar-Reglamentar 
            </label>
            <span class="layer-count" id="count-fraccionamientos-poel">0</span>
        </div>
    </div>

    <!-- Panel de Leyendas -->
    <div id="legends-panel" class="legends-panel" style="position: absolute; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000; font-size: 11px;">
        <button class="toggle-btn" onclick="togglePanel('legends-panel')" title="Minimizar/Maximizar" style="top: 8px; right: 8px;">
            <span id="legends-toggle-icon">‚àí</span>
        </button>
        <h3 style="font-size: 14px; margin: 0 0 10px 0; color: #2c5282; border-bottom: 2px solid #4299e1; padding-bottom: 5px;">Leyendas</h3>
        
        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Volumen de Agua (hm¬≥/a√±o)</strong>
            <div style="margin-top: 5px;">
                <div style="font-size: 10px; font-weight: 600; color: #0369a1; margin-bottom: 2px;">Descargas</div>
                <div style="height: 12px; background: linear-gradient(90deg, #7dd3fc, #0369a1); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
            <div style="margin-top: 8px;">
                <div style="font-size: 10px; font-weight: 600; color: #ea580c; margin-bottom: 2px;">Extracciones</div>
                <div style="height: 12px; background: linear-gradient(90deg, #fb923c, #ea580c); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Intensidad de Karstificaci√≥n (medio a muy alto)</strong>
            <div style="height: 12px; background: linear-gradient(90deg, #fef3c7, #78350f); border-radius: 3px; margin: 5px 0 3px 0;"></div>
            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                <span>Medio</span><span>Muy Alto</span>
            </div>
        </div>

        <div style="margin-bottom: 12px;" id="legend-poel-section">
            <strong style="font-size: 11px; color: #4a5568;">POEL 2013 - UGAs por Pol√≠tica</strong>
            <div id="legend-poel-items" style="margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div>
            <strong style="font-size: 11px; color: #4a5568;">Cuerpos de Agua (IAHCSA)</strong>
            <div style="margin-top: 5px; font-size: 10px;">
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Piscinas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Modificados</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Artificiales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Antropizadas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Naturales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Sascaberas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #06b6d4; border-radius: 2px; margin-right: 6px;"></div>
                    <span>R√≠os Artificiales</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üîê Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="login-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a</label>
                    <input type="password" id="login-password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="login-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Entrar
                    </button>
                    <button type="button" id="close-login-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="register-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üìù Registrarse</h2>
            <form id="register-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre de Usuario</label>
                    <input type="text" id="register-username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="register-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a (m√≠nimo 6 caracteres)</label>
                    <input type="password" id="register-password" required minlength="6" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="register-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="register-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Crear Cuenta
                    </button>
                    <button type="button" id="close-register-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Agregar Proyecto -->
    <div id="add-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚ûï Agregar Proyecto Inmobiliario-tur√≠stico</h2>
            <form id="add-project-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                </div>
                <div style="padding: 12px; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; margin-bottom: 15px;">
                    <p style="margin: 0; font-size: 12px; color: #1e40af;">
                        üí° <strong>Tip:</strong> Haz click en el mapa para capturar las coordenadas autom√°ticamente
                    </p>
                    <button type="button" id="enable-map-click" style="margin-top: 8px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                        üìç Activar Click en Mapa
                    </button>
                </div>
                <div id="add-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="add-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üíæ Guardar Proyecto
                    </button>
                    <button type="button" id="close-add-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Editar Proyecto -->
    <div id="edit-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚úèÔ∏è Editar Proyecto</h2>
            <form id="edit-project-form">
                <input type="hidden" id="edit-project-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="edit-project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="edit-project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="edit-project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="edit-project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="edit-project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="edit-project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <div id="edit-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="edit-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        ‚úÖ Actualizar Proyecto
                    </button>
                    <button type="button" id="close-edit-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Indicador flotante para modo de captura de coordenadas -->
    <div id="map-click-indicator" style="display: none; position: fixed; top: 100px; right: 20px; z-index: 10001; background: rgba(147, 51, 234, 0.95); color: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(10px); pointer-events: none; max-width: 280px;">
        <div style="font-size: 32px; margin-bottom: 10px;">üéØ</div>
        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Modo Captura Activado</h3>
        <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa para seleccionar la ubicaci√≥n</p>
        <button id="cancel-map-click" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
            ‚ùå Cancelar
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Proj4js para conversi√≥n de coordenadas UTM a WGS84 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <script>
        console.log('=== GEOPORTAL PUERTO MORELOS - VISTA SATELITAL ===');

        const SUPABASE_URL = 'https://mrniyxyurgbpfqfuzgws.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ybml5eHl1cmdicGZxZnV6Z3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTI1OTgsImV4cCI6MjA4MDk4ODU5OH0.tkZIuDNUreGSqLL0JvuzJepZEfducQ3L5N4BS7Jxv4M';

        // Definir proyecciones para conversi√≥n de coordenadas
        // EPSG:32616 es UTM Zone 16N (usado en Quintana Roo, M√©xico)
        const UTM_ZONE_16N = '+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs';
        const WGS84 = 'EPSG:4326'; // Lat/Lon est√°ndar
        
        // Funci√≥n para detectar si coordenadas son UTM
        function isUTM(x, y) {
            // UTM en esta zona tiene valores aproximados:
            // X (Easting): 400,000 - 700,000
            // Y (Northing): 2,200,000 - 2,400,000
            return Math.abs(x) > 1000 || Math.abs(y) > 1000;
        }
        
        // Funci√≥n para convertir coordenadas UTM a Lat/Lon
        function convertUTMtoLatLon(x, y) {
            try {
                if (typeof proj4 === 'undefined') {
                    console.error('proj4 no est√° cargado');
                    return null;
                }
                
                const result = proj4(UTM_ZONE_16N, WGS84, [x, y]);
                return {
                    lon: result[0],
                    lat: result[1]
                };
            } catch (e) {
                console.error('Error convirtiendo coordenadas:', e);
                return null;
            }
        }

        // Variables globales (se inicializar√°n cuando las librer√≠as est√©n cargadas)
        let map;
        let layerGroups;
        let supabaseClient;

        const COLORS = {
            proyectos: '#e53e3e',
            proyectosColab: '#9333ea',
            proyectosHidrosociales: '#06b6d4',
            cuerposAgua: {
                'piscina': '#ec4899',
                'cenote_s_a': '#10b981',
                'cenote_s_s': '#ef4444',
                'aguada_a': '#3b82f6',
                'aguada_n': '#8b5cf6',
                'sascab_ce': '#f59e0b',
                'rio_a': '#06b6d4',
                'default': '#6b7280'
            },
            poel: {
                'Protecci√≥n': '#1e3a8a',
                'Conservaci√≥n': '#0369a1',
                'Preservaci√≥n': '#0284c7',
                'Aprovechamiento Sustentable': '#eab308',
                'Restauraci√≥n': '#f97316',
                'default': '#a0aec0'
            },
            socioeco: {
                'manglar': '#06b6d4',                              // Cyan 500
                'manglar 2': '#0891b2',                            // Cyan 600
                'tular': '#0e7490',                                // Cyan 700
                'planicie carstica sujeta a inu': '#0284c7',       // Sky 600
                'suelo con poca vegetacion prop': '#0ea5e9',       // Sky 500
                'zona de manglar inundada (est': '#38bdf8',        // Sky 400
                'selva mediana perennifolia': '#075985',           // Sky 700
                'nubes': '#0369a1',                                // Sky 800
                'zona de cambio de uso de suelo': '#7dd3fc',       // Sky 300 (azul claro)
                'default': '#718096'
            },
            colapsoKarst: {
                'Muy Alto': '#ff00ff',      // Magenta brillante
                'Alto': '#00ffff',           // Cyan ne√≥n
                'Medio': '#ffff00',          // Amarillo brillante
                'Bajo': '#ff1493',           // Rosa profundo
                'Muy Bajo': '#00ff00',       // Verde ne√≥n
                'default': '#ff69b4'         // Rosa chicle
            },
            tierrasEjidales: {
                'comunal': '#a855f7',        // P√∫rpura
                'parcelada': '#f97316',      // Naranja
                'default': '#8b5cf6'
            },
            fallasINEGI: '#9f7aea',
            fallasCENAPRED: '#ed64a6',
            municipio: '#4a5568',
            pozosSinProteccion: '#ef4444',
            pozosConProteccion: '#10b981'
        };

        // ========== FUNCIONES PARA MODAL DE BIENVENIDA ==========
        function openWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('closing');
            modal.style.display = 'flex';
        }

        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.add('closing');
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 800);
        }

        // ========== FUNCIONES PARA ARRASTRE DE PANELES MINIMIZADOS ==========
        let isDragging = false;
        let currentPanel = null;
        let offsetX = 0;
        let offsetY = 0;

        function setupDraggable() {
            const panels = document.querySelectorAll('.control-panel, .legends-panel');
            
            panels.forEach(panel => {
                panel.addEventListener('mousedown', startDrag);
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function startDrag(e) {
            // Solo permitir arrastre si el panel est√° minimizado y no se hizo click en el bot√≥n toggle
            if (!e.target.closest('.panel-minimized') || e.target.classList.contains('toggle-btn')) {
                return;
            }

            const panel = e.target.closest('.control-panel, .legends-panel');
            if (!panel || !panel.classList.contains('panel-minimized')) {
                return;
            }

            isDragging = true;
            currentPanel = panel;
            
            const rect = panel.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            currentPanel.classList.add('dragging');
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !currentPanel) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            // Mantener dentro de los l√≠mites de la ventana
            const maxX = window.innerWidth - 50;
            const maxY = window.innerHeight - 50;

            const finalX = Math.max(0, Math.min(x, maxX));
            const finalY = Math.max(0, Math.min(y, maxY));

            currentPanel.style.left = finalX + 'px';
            currentPanel.style.top = finalY + 'px';
        }

        function stopDrag() {
            if (currentPanel) {
                currentPanel.classList.remove('dragging');
            }
            isDragging = false;
            currentPanel = null;
        }

        let maxVolumenDescarga = 0;
        let maxVolumenExtraccion = 0;
        let maxIntensidadKarst = 0;
        let minIntensidadKarst = 999;

        // Almacenar datos de todas las capas para an√°lisis espacial
        let allLayersData = {
            proyectos: [],
            descargas: [],
            extracciones: [],
            cuerposAgua: [],
            rios: []
        };

        // Estado de autenticaci√≥n
        let currentUser = null;
        let mapClickEnabled = false;
        let tempMarker = null;
        let movingProjectId = null; // ID del proyecto que se est√° moviendo
        let movingProjectMode = false; // Modo de mover proyecto activo

        // Cliente de Supabase (ya inicializado globalmente)
        

        function updateStatus(text) {
            console.log('[STATUS]', text);
        }

        function updateLoading(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateLayerCount(layerId, count) {
            const element = document.getElementById(`count-${layerId}`);
            if (element) {
                element.textContent = count;
                element.classList.add('loaded');
            }
        }

        function parseGeoJSON(geojson) {
            if (!geojson || !geojson.coordinates) {
                return null;
            }

            try {
                const coords = geojson.coordinates;
                let allPolygons = [];

                for (const polygon of coords) {
                    for (const ring of polygon) {
                        const leafletCoords = ring.map(coord => {
                            const x = coord[0];
                            const y = coord[1];
                            
                            // Detectar si son coordenadas UTM y convertir
                            if (isUTM(x, y)) {
                                const converted = convertUTMtoLatLon(x, y);
                                if (converted) {
                                    return [converted.lat, converted.lon];
                                } else {
                                    console.warn('No se pudo convertir coordenada UTM:', { x, y });
                                    return null;
                                }
                            } else {
                                // Ya son lat/lon, solo invertir orden
                                return [y, x];
                            }
                        }).filter(c => c !== null); // Remover coordenadas que no se pudieron convertir
                        
                        if (leafletCoords.length > 0) {
                            allPolygons.push(leafletCoords);
                        }
                    }
                }

                return allPolygons.length > 0 ? allPolygons : null;
            } catch (e) {
                console.error('Error parsing GeoJSON:', e);
                return null;
            }
        }

        function parseGeometry(item) {
            try {
                if (item.geojson) {
                    const geom = typeof item.geojson === 'string' ? JSON.parse(item.geojson) : item.geojson;
                    return geom;
                }
                if (item.geom) {
                    if (typeof item.geom === 'string') return JSON.parse(item.geom);
                    if (item.geom.type) return item.geom;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function getDescargaColor(vol) {
            const ratio = vol / maxVolumenDescarga;
            const r = Math.floor(125 + (3 - 125) * ratio);
            const g = Math.floor(211 + (105 - 211) * ratio);
            const b = Math.floor(252 + (161 - 252) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getExtraccionColor(vol) {
            const ratio = vol / maxVolumenExtraccion;
            const r = Math.floor(251 + (234 - 251) * ratio);
            const g = Math.floor(146 + (88 - 146) * ratio);
            const b = Math.floor(60 + (12 - 60) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getKarstColor(intensidad) {
            const ratio = (intensidad - minIntensidadKarst) / (maxIntensidadKarst - minIntensidadKarst);
            const r = Math.floor(254 + (120 - 254) * ratio);
            const g = Math.floor(243 + (53 - 243) * ratio);
            const b = Math.floor(199 + (15 - 199) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getPOELColor(politica) {
            return COLORS.poel[politica] || COLORS.poel.default;
        }

        // ======== AUTENTICACI√ìN Y PROYECTOS COLABORATIVOS ========

        async function checkAuthState() {
            try {
                // Detectar si venimos de un link de confirmaci√≥n
                const hash = window.location.hash;
                const hasAuthToken = hash && (hash.includes('access_token') || hash.includes('type=signup'));
                
                if (hasAuthToken) {
                    console.log('üîë Detectado token de confirmaci√≥n en URL, procesando...');
                    // Esperar un momento para que Supabase procese el hash
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error obteniendo sesi√≥n:', error);
                    showLoginSection();
                    return;
                }
                
                if (session) {
                    console.log('‚úÖ Sesi√≥n activa encontrada');
                    currentUser = session.user;
                    const { data: profile } = await supabaseClient
                        .from('proyectos_colaborativos')
                        .select('username')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    const username = profile?.username || currentUser.email.split('@')[0];
                    showUserSection(username);
                    
                    // Cargar proyectos colaborativos
                    await loadCollaborativeProjects();
                    
                    // Cargar proyectos hidrosociales
                    await loadProyectosHidrosociales();
                    
                    // Limpiar el hash de la URL despu√©s de procesar
                    if (hash) {
                        console.log('üßπ Limpiando URL...');
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                    
                    // Mostrar mensaje de bienvenida si es confirmaci√≥n
                    if (hasAuthToken) {
                        alert('‚úÖ Email confirmado correctamente. ¬°Bienvenido al geoportal!');
                    }
                } else {
                    console.log('‚ùå No hay sesi√≥n activa');
                    currentUser = null;
                    showLoginSection();
                }
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                showLoginSection();
            }
        }
        
        // Escuchar cambios de autenticaci√≥n (incluye confirmaci√≥n de email)
        function setupAuthListener() {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('üì¢ Auth event:', event);
                
                if (event === 'SIGNED_IN') {
                    console.log('‚úÖ Usuario inici√≥ sesi√≥n');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                        await loadCollaborativeProjects();
                        await loadProyectosHidrosociales();
                    }
                } else if (event === 'USER_UPDATED') {
                    console.log('üîÑ Usuario actualizado');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                    }
                } else if (event === 'SIGNED_OUT') {
                    console.log('üëã Usuario cerr√≥ sesi√≥n');
                    currentUser = null;
                    showLoginSection();
                    layerGroups.proyectosColab.clearLayers();
                    layerGroups.proyectosHidrosociales.clearLayers();
                    updateLayerCount('proyectos-colab', 0);
                    updateLayerCount('proyectos-hidrosociales', 0);
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('üîÑ Token actualizado');
                }
            });
        }

        function showLoginSection() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('add-project-section').style.display = 'none';
            document.getElementById('add-hidrosocial-section').style.display = 'none';
        }

        function showUserSection(username) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'block';
            document.getElementById('add-project-section').style.display = 'block';
            document.getElementById('add-hidrosocial-section').style.display = 'block';
            document.getElementById('username-display').textContent = username;
        }

        async function handleLogin(email, password) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;
            
            currentUser = data.user;
            const { data: profile } = await supabaseClient
                .from('proyectos_colaborativos')
                .select('username')
                .eq('user_id', currentUser.id)
                .single();
            
            const username = profile?.username || email.split('@')[0];
            showUserSection(username);
            
            // Cerrar modal y recargar proyectos colaborativos
            document.getElementById('login-modal').style.display = 'none';
            await loadCollaborativeProjects();
        }

        async function handleRegister(username, email, password) {
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        username: username
                    }
                }
            });

            if (error) throw error;
            
            return data;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showLoginSection();
            
            // Limpiar proyectos colaborativos del mapa
            layerGroups.proyectosColab.clearLayers();
            updateLayerCount('proyectos-colab', 0);
        }

        async function addProjectToMap(projectData) {
            if (!currentUser) {
                alert('Debes iniciar sesi√≥n para agregar proyectos');
                return;
            }

            const { data, error } = await supabaseClient
                .from('proyectos_colaborativos')
                .insert([{
                    user_id: currentUser.id,
                    username: currentUser.user_metadata?.username || currentUser.email.split('@')[0],
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                }])
                .select();

            if (error) throw error;

            // Agregar al mapa inmediatamente
            await loadCollaborativeProjects();
            
            return data;
        }

        async function loadCollaborativeProjects() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('Tabla de proyectos colaborativos no disponible:', error.message || 'Error desconocido');
                    return;
                }

                if (data && data.length > 0) {
                    updateLayerCount('proyectos-colab', data.length);
                    renderCollaborativeProjects(data);
                    console.log(`‚úì ${data.length} proyectos colaborativos cargados`);
                } else {
                    updateLayerCount('proyectos-colab', 0);
                    console.log('No hay proyectos colaborativos todav√≠a');
                }
            } catch (e) {
                console.warn('Error cargando proyectos colaborativos:', e.message || String(e));
                updateLayerCount('proyectos-colab', 0);
            }
        }

        function renderCollaborativeProjects(data) {
            // Limpiar capa existente
            layerGroups.proyectosColab.clearLayers();
            
            const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
            
            data.forEach(item => {
                // Validar coordenadas antes de crear el marker
                if (!item.lat || !item.lng || isNaN(item.lat) || isNaN(item.lng)) {
                    console.warn('Proyecto colaborativo sin coordenadas v√°lidas:', item);
                    return;
                }
                
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 8,
                    fillColor: COLORS.proyectosColab,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9,
                    // Hacer el marcador arrastrable solo para el admin
                    draggable: isAdmin
                });

                const isOwner = currentUser && item.user_id === currentUser.id;
                const ownerBadge = isOwner ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">TU PROYECTO</span>' : '';
                const adminBadge = isAdmin ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">ADMIN</span>' : '';
                
                // Botones para el due√±o del proyecto
                let ownerButtons = '';
                if (isOwner && !isAdmin) {
                    ownerButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <button 
                                class="edit-project-btn" 
                                data-project-id="${item.id}" 
                                type="button"
                                style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 600;
                                    pointer-events: auto;
                                    touch-action: manipulation;
                                    user-select: none;
                                "
                                onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                            >
                                ‚úèÔ∏è Editar mi proyecto
                            </button>
                        </div>
                    `;
                }
                
                // Botones de admin
                let adminButtons = '';
                if (isAdmin) {
                    adminButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">‚öôÔ∏è Controles de Administrador</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <button 
                                    class="edit-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #f59e0b;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    class="move-project-btn" 
                                    data-project-id="${item.id}" 
                                    data-lat="${item.lat}" 
                                    data-lng="${item.lng}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); moveProject('${item.id}', ${item.lat}, ${item.lng});"
                                >
                                    üìç Mover
                                </button>
                                <button 
                                    class="delete-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #ef4444;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); deleteProject('${item.id}');"
                                >
                                    üóëÔ∏è Borrar
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectosColab};">
                            Proyecto Colaborativo ${ownerBadge} ${adminBadge}
                        </h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectosColab};">
                            <p><strong>Nombre:</strong> ${item.nombre_proyecto}</p>
                            ${item.descripcion ? `<p><strong>Descripci√≥n:</strong> ${item.descripcion}</p>` : ''}
                            ${item.mia ? `<p><strong>MIA:</strong> ${item.mia}</p>` : ''}
                            ${item.irregularidad ? `<p><strong>Irregularidad:</strong> ${item.irregularidad}</p>` : ''}
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">
                                üë§ Agregado por: <strong>${item.username}</strong><br>
                                üìÖ ${new Date(item.created_at).toLocaleDateString('es-MX')}<br>
                                üìç Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
                            </p>
                            ${ownerButtons}
                            ${adminButtons}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 400,
                    minWidth: 300,
                    className: 'collaborative-project-popup'
                });
                
                // Guardar referencia al item en el marcador para poder actualizarlo
                marker.projectId = item.id;
                marker.projectData = item;
                
                // Si es admin, permitir arrastrar el marcador (para mover proyecto)
                if (isAdmin) {
                    marker.on('dragend', async function(e) {
                        const newLatLng = e.target.getLatLng();
                        if (confirm('¬øMover este proyecto a la nueva ubicaci√≥n?')) {
                            try {
                                // Cerrar popup
                                map.closePopup();
                                
                                await updateProjectLocation(item.id, newLatLng.lat, newLatLng.lng);
                                
                                // Recargar proyectos inmediatamente
                                await loadCollaborativeProjects();
                                
                                alert('‚úÖ Proyecto movido exitosamente');
                            } catch (error) {
                                alert('‚ùå Error al mover proyecto: ' + error.message);
                                e.target.setLatLng([item.lat, item.lng]); // Revertir posici√≥n
                            }
                        } else {
                            e.target.setLatLng([item.lat, item.lng]); // Revertir posici√≥n
                        }
                    });
                }
                
                marker.addTo(layerGroups.proyectosColab);
            });
        }

        // Funciones de administrador (solo para storresperdigon@politicas.unam.mx)
        async function deleteProject(projectId) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para eliminar proyectos');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este proyecto? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                // Cerrar cualquier popup abierto
                map.closePopup();
                
                const { error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                // Recargar proyectos inmediatamente
                await loadCollaborativeProjects();
                
                alert('‚úÖ Proyecto eliminado exitosamente');
            } catch (error) {
                console.error('Error eliminando proyecto:', error);
                alert('‚ùå Error al eliminar proyecto: ' + error.message);
            }
        }

        async function moveProject(projectId, currentLat, currentLng) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para mover proyectos');
                return;
            }
            
            // Cerrar popup
            map.closePopup();
            
            // Activar modo mover proyecto
            movingProjectMode = true;
            movingProjectId = projectId;
            
            // Cambiar cursor
            map.getContainer().style.cursor = 'crosshair';
            
            // Mostrar indicador
            const indicator = document.getElementById('map-click-indicator');
            if (indicator) {
                indicator.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 10px;">üìç</div>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Mover Proyecto</h3>
                    <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa en la nueva ubicaci√≥n del proyecto</p>
                    <button id="cancel-move-project" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
                        ‚ùå Cancelar
                    </button>
                `;
                indicator.style.display = 'block';
                
                // Event listener para cancelar
                document.getElementById('cancel-move-project').addEventListener('click', () => {
                    movingProjectMode = false;
                    movingProjectId = null;
                    map.getContainer().style.cursor = '';
                    indicator.style.display = 'none';
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                });
            }
        }

        async function updateProjectLocation(projectId, newLat, newLng) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({ 
                    lat: newLat, 
                    lng: newLng 
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function editProject(projectId) {
            console.log('[EDIT PROJECT] Iniciando edici√≥n de proyecto:', projectId);
            
            try {
                // Verificar permisos
                const project = await getProjectById(projectId);
                
                if (!project) {
                    console.error('[EDIT PROJECT] Proyecto no encontrado:', projectId);
                    alert('‚ùå Proyecto no encontrado');
                    return;
                }
                
                console.log('[EDIT PROJECT] Proyecto cargado:', project);
                
                const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
                const isOwner = currentUser && project.user_id === currentUser.id;
                
                console.log('[EDIT PROJECT] Permisos:', { isAdmin, isOwner, currentUserEmail: currentUser?.email });
                
                if (!isAdmin && !isOwner) {
                    console.error('[EDIT PROJECT] Sin permisos para editar');
                    alert('‚ùå No tienes permisos para editar este proyecto');
                    return;
                }
                
                // Cargar datos en el formulario
                document.getElementById('edit-project-id').value = project.id;
                document.getElementById('edit-project-nombre').value = project.nombre_proyecto || '';
                document.getElementById('edit-project-descripcion').value = project.descripcion || '';
                document.getElementById('edit-project-mia').value = project.mia || '';
                document.getElementById('edit-project-irregularidad').value = project.irregularidad || '';
                document.getElementById('edit-project-lat').value = project.lat || '';
                document.getElementById('edit-project-lng').value = project.lng || '';
                
                // Limpiar mensajes anteriores
                document.getElementById('edit-project-error').style.display = 'none';
                document.getElementById('edit-project-success').style.display = 'none';
                
                console.log('[EDIT PROJECT] Mostrando modal de edici√≥n');
                
                // Mostrar modal
                document.getElementById('edit-project-modal').style.display = 'flex';
            } catch (error) {
                console.error('[EDIT PROJECT] Error:', error);
                alert('‚ùå Error al cargar proyecto: ' + error.message);
            }
        }

        async function getProjectById(projectId) {
            console.log('[GET PROJECT] Buscando proyecto ID:', projectId);
            
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .eq('id', projectId)
                    .single();
                
                if (error) {
                    console.error('[GET PROJECT] Error de Supabase:', error);
                    return null;
                }
                
                console.log('[GET PROJECT] Proyecto encontrado:', data);
                return data;
            } catch (e) {
                console.error('[GET PROJECT] Excepci√≥n:', e);
                return null;
            }
        }

        async function updateProject(projectId, projectData) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function exportProjectsToCSV() {
            try {
                // Obtener todos los proyectos
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('‚ùå No hay proyectos para exportar');
                    return;
                }
                
                // Crear CSV
                const headers = ['ID', 'Nombre', 'Descripci√≥n', 'MIA', 'Irregularidad', 'Latitud', 'Longitud', 'Usuario', 'Fecha de Creaci√≥n'];
                const csvRows = [headers.join(',')];
                
                data.forEach(project => {
                    const row = [
                        project.id,
                        `"${(project.nombre_proyecto || '').replace(/"/g, '""')}"`,
                        `"${(project.descripcion || '').replace(/"/g, '""')}"`,
                        `"${(project.mia || '').replace(/"/g, '""')}"`,
                        `"${(project.irregularidad || '').replace(/"/g, '""')}"`,
                        project.lat,
                        project.lng,
                        `"${project.username || ''}"`,
                        new Date(project.created_at).toLocaleString('es-MX')
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                // Crear y descargar archivo
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const fileName = `proyectos_colaborativos_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ ${data.length} proyectos exportados exitosamente a ${fileName}`);
            } catch (error) {
                console.error('Error exportando proyectos:', error);
                alert('‚ùå Error al exportar proyectos: ' + error.message);
            }
        }

        // ========== FUNCIONES PARA PROYECTOS HIDROSOCIALES ========== //
        
        async function loadProyectosHidrosociales() {
            try {
                const { data, error} = await supabaseClient
                    .from('proyectos_hidrosociales')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('Tabla de proyectos hidrosociales no disponible:', error.message || 'Error desconocido');
                    return;
                }

                if (data && data.length > 0) {
                    updateLayerCount('proyectos-hidrosociales', data.length);
                    renderProyectosHidrosociales(data);
                    console.log(`‚úì ${data.length} proyectos hidrosociales cargados`);
                } else {
                    updateLayerCount('proyectos-hidrosociales', 0);
                    console.log('No hay proyectos hidrosociales todav√≠a');
                }
            } catch (e) {
                console.warn('Error cargando proyectos hidrosociales:', e.message || String(e));
                updateLayerCount('proyectos-hidrosociales', 0);
            }
        }

        async function addProyectoHidrosocial(projectData) {
            if (!currentUser) {
                alert('Debes iniciar sesi√≥n para proponer proyectos');
                return;
            }

            const { data, error } = await supabaseClient
                .from('proyectos_hidrosociales')
                .insert([{
                    user_id: currentUser.id,
                    username: currentUser.user_metadata?.username || currentUser.email.split('@')[0],
                    nombre_proyecto: projectData.nombre_proyecto,
                    descripcion: projectData.descripcion || null,
                    tipo_proyecto: projectData.tipo_proyecto || null,
                    objetivos: projectData.objetivos || null,
                    beneficios_esperados: projectData.beneficios_esperados || null,
                    estado: projectData.estado || 'propuesto',
                    fecha_inicio: projectData.fecha_inicio || null,
                    participantes_estimados: projectData.participantes_estimados || null,
                    presupuesto_estimado: projectData.presupuesto_estimado || null,
                    organizacion: projectData.organizacion || null,
                    contacto_email: projectData.contacto_email || null,
                    contacto_telefono: projectData.contacto_telefono || null,
                    lat: projectData.lat,
                    lng: projectData.lng,
                    area_m2: projectData.area_m2 || null
                }])
                .select();

            if (error) throw error;

            await loadProyectosHidrosociales();
            return data;
        }

        async function updateProyectoHidrosocial(projectId, projectData) {
            const { error } = await supabaseClient
                .from('proyectos_hidrosociales')
                .update(projectData)
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function updateProyectoHidrosocialLocation(projectId, newLat, newLng) {
            const { error } = await supabaseClient
                .from('proyectos_hidrosociales')
                .update({ lat: newLat, lng: newLng })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function deleteProyectoHidrosocial(projectId) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para eliminar proyectos');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este proyecto de restauraci√≥n hidrosocial?')) {
                return;
            }
            
            try {
                map.closePopup();
                
                const { error } = await supabaseClient
                    .from('proyectos_hidrosociales')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                await loadProyectosHidrosociales();
                alert('‚úÖ Proyecto eliminado exitosamente');
            } catch (error) {
                console.error('Error eliminando proyecto:', error);
                alert('‚ùå Error al eliminar proyecto: ' + error.message);
            }
        }

        async function getProyectoHidrosocialById(projectId) {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_hidrosociales')
                    .select('*')
                    .eq('id', projectId)
                    .single();
                
                if (error) {
                    console.error('Error obteniendo proyecto:', error);
                    return null;
                }
                
                return data;
            } catch (e) {
                console.error('Excepci√≥n obteniendo proyecto:', e);
                return null;
            }
        }

        async function editProyectoHidrosocial(projectId) {
            try {
                map.closePopup();
                
                const project = await getProyectoHidrosocialById(projectId);
                if (!project) {
                    alert('‚ùå Error: No se pudo cargar el proyecto');
                    return;
                }
                
                // Llenar el formulario
                document.getElementById('edit-hidrosocial-id').value = project.id;
                document.getElementById('edit-hidrosocial-nombre').value = project.nombre_proyecto || '';
                document.getElementById('edit-hidrosocial-tipo').value = project.tipo_proyecto || '';
                document.getElementById('edit-hidrosocial-descripcion').value = project.descripcion || '';
                document.getElementById('edit-hidrosocial-objetivos').value = project.objetivos || '';
                document.getElementById('edit-hidrosocial-beneficios').value = project.beneficios_esperados || '';
                document.getElementById('edit-hidrosocial-lat').value = project.lat || '';
                document.getElementById('edit-hidrosocial-lng').value = project.lng || '';
                document.getElementById('edit-hidrosocial-area').value = project.area_m2 || '';
                document.getElementById('edit-hidrosocial-estado').value = project.estado || 'propuesto';
                document.getElementById('edit-hidrosocial-participantes').value = project.participantes_estimados || '';
                document.getElementById('edit-hidrosocial-presupuesto').value = project.presupuesto_estimado || '';
                document.getElementById('edit-hidrosocial-organizacion').value = project.organizacion || '';
                document.getElementById('edit-hidrosocial-email').value = project.contacto_email || '';
                document.getElementById('edit-hidrosocial-telefono').value = project.contacto_telefono || '';
                
                // Mostrar modal
                document.getElementById('edit-hidrosocial-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error en editProyectoHidrosocial:', error);
                alert('‚ùå Error al cargar proyecto: ' + error.message);
            }
        }

        function moveProyectoHidrosocial(projectId, currentLat, currentLng) {
            map.closePopup();
            
            alert(`üìç Modo de movimiento activado.\n\nHaz click en el mapa para mover el proyecto a una nueva ubicaci√≥n.`);
            
            // Destacar el marcador actual
            const currentMarker = Object.values(layerGroups.proyectosHidrosociales._layers).find(
                layer => layer.projectId === projectId
            );
            
            if (currentMarker) {
                currentMarker.setStyle({
                    fillColor: '#f59e0b',
                    radius: 15,
                    weight: 4
                });
            }
            
            // Activar modo click para mover
            const moveClickHandler = async function(e) {
                const newLat = e.latlng.lat;
                const newLng = e.latlng.lng;
                
                if (confirm(`¬øMover proyecto a:\nLat: ${newLat.toFixed(6)}\nLng: ${newLng.toFixed(6)}?`)) {
                    try {
                        await updateProyectoHidrosocialLocation(projectId, newLat, newLng);
                        await loadProyectosHidrosociales();
                        alert('‚úÖ Proyecto movido exitosamente');
                    } catch (error) {
                        alert('‚ùå Error al mover proyecto: ' + error.message);
                    }
                }
                
                // Desactivar handler
                map.off('click', moveClickHandler);
                map.getContainer().style.cursor = '';
                
                // Restaurar estilo del marcador
                if (currentMarker) {
                    currentMarker.setStyle({
                        fillColor: '#10b981',
                        radius: 12,
                        weight: 3
                    });
                }
            };
            
            map.on('click', moveClickHandler);
            map.getContainer().style.cursor = 'crosshair';
        }

        // ========== FUNCIONES HELPER PARA FORMATEO ========== //
        
        /**
         * Formatea el volumen de agua de manera inteligente
         * Si el volumen es menor a 0.1 hm¬≥, lo convierte a m¬≥ para mejor visualizaci√≥n
         * @param {number} volHm3 - Volumen en hm¬≥
         * @returns {string} - Volumen formateado con unidad
         */
        function formatVolume(volHm3) {
            if (volHm3 < 0.1) {
                // Convertir a m¬≥ (1 hm¬≥ = 1,000,000 m¬≥)
                const volM3 = volHm3 * 1000000;
                return `${volM3.toLocaleString('es-MX', {maximumFractionDigits: 2})} m¬≥/a√±o`;
            } else {
                return `${volHm3.toFixed(2)} hm¬≥/a√±o`;
            }
        }

        /**
         * Calcula el √°rea de un pol√≠gono usando la f√≥rmula de Shoelace
         * @param {Array} coords - Array de coordenadas [[lat, lng], ...]
         * @returns {number} - √Årea en metros cuadrados
         */
        function calculatePolygonArea(coords) {
            if (!coords || coords.length < 3) return 0;
            
            // Usar la f√≥rmula de Shoelace para calcular √°rea
            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coords[i][1] * coords[j][0]; // lng * lat
                area -= coords[j][1] * coords[i][0]; // lng * lat
            }
            
            area = Math.abs(area) / 2;
            
            // Convertir de grados cuadrados a metros cuadrados (aproximado)
            // En el ecuador: 1 grado ‚âà 111,320 metros
            // En Puerto Morelos (lat ~21¬∞): 1 grado lat ‚âà 110,900m, 1 grado lng ‚âà 103,500m
            const metersPerDegreeLat = 110900;
            const metersPerDegreeLng = 103500;
            area = area * metersPerDegreeLat * metersPerDegreeLng;
            
            return area;
        }

        // Funci√≥n para verificar si un punto est√° dentro de un pol√≠gono
        function pointInPolygon(point, polygon) {
            const x = point[1], y = point[0]; // [lng, lat] -> x=lat, y=lng
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][1], yi = polygon[i][0]; // lng, lat
                const xj = polygon[j][1], yj = polygon[j][0];
                
                const intersect = ((yi > y) !== (yj > y)) && 
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }

        // Verificar si un punto est√° dentro de cualquier pol√≠gono de una geometr√≠a
        function pointInGeometry(point, geojson) {
            if (!geojson || !geojson.coordinates) return false;
            
            try {
                if (geojson.type === 'Polygon') {
                    // Polygon: coordinates[ring][point]
                    // Solo verificar el anillo exterior (√≠ndice 0)
                    return pointInPolygon(point, geojson.coordinates[0]);
                    
                } else if (geojson.type === 'MultiPolygon') {
                    // MultiPolygon: coordinates[polygon][ring][point]
                    for (const polygon of geojson.coordinates) {
                        // Solo verificar el anillo exterior de cada pol√≠gono
                        if (pointInPolygon(point, polygon[0])) {
                            return true;
                        }
                    }
                }
            } catch (e) {
                console.warn('Error en point-in-polygon:', e);
            }
            
            return false;
        }

        async function initMap() {
            try {
                // Verificar que Leaflet est√© cargado
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet no est√° cargado');
                }
                
                updateLoading('Creando mapa...');
                
                // Inicializar grupos de capas (despu√©s de que Leaflet est√© cargado)
                layerGroups = {
                    proyectos: L.layerGroup(),
                    proyectosColab: L.layerGroup(),
                    proyectosHidrosociales: L.layerGroup(),
                    descargas: L.layerGroup(),
                    extracciones: L.layerGroup(),
                    cuerposAgua: L.layerGroup(),
                    piscinas: L.layerGroup(),
                    cenotesSup: L.layerGroup(),
                    cenotesSub: L.layerGroup(),
                    aguadasArt: L.layerGroup(),
                    aguadasNat: L.layerGroup(),
                    sascab: L.layerGroup(),
                    rios: L.layerGroup(),
                    karstificacion: L.layerGroup(),
                    colapsoKarst: L.layerGroup(),
                    fallasINEGI: L.layerGroup(),
                    fallasCENAPRED: L.layerGroup(),
                    poel: L.layerGroup(),
                    socioeco: L.layerGroup(),
                    municipio: L.layerGroup(),
                    pozosSinProteccion: L.layerGroup(),
                    pozosConProteccion: L.layerGroup(),
                    tierrasComunales: L.layerGroup(),
                    tierrasParceladas: L.layerGroup(),
                    nucleosAgrarios: L.layerGroup(),
                    asentamientosHumanos: L.layerGroup(),
                    fraccionamientosPOEL: L.layerGroup()
                };
                
                // Crear mapa Leaflet
                map = L.map('map', {
                    center: [20.849, -86.876],
                    zoom: 12,
                    zoomControl: true
                });

                // Capas base
                const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                });

                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19
                });

                const hybrid = L.layerGroup([
                    satellite,
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        opacity: 0.3,
                        maxZoom: 19
                    })
                ]);

                // Agregar capa satelital por defecto
                satellite.addTo(map);

                // Control de capas
                const baseMaps = {
                    "üõ∞Ô∏è Sat√©lite": satellite,
                    "üó∫Ô∏è H√≠brido": hybrid,
                    "üìç Calles": streets
                };

                L.control.layers(baseMaps, null, {
                    position: 'topright'
                }).addTo(map);

                console.log('‚úì Mapa creado');

                // Event listener para capturar coordenadas en el mapa
                map.on('click', (e) => {
                    // Modo: Mover proyecto existente
                    if (movingProjectMode && movingProjectId) {
                        const { lat, lng } = e.latlng;
                        
                        // Remover marcador temporal anterior
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                        }
                        
                        // Agregar marcador temporal
                        tempMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'temp-marker',
                                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        // Confirmar y mover
                        if (confirm('¬øMover el proyecto a esta ubicaci√≥n?')) {
                            updateProjectLocation(movingProjectId, lat, lng)
                                .then(async () => {
                                    await loadCollaborativeProjects();
                                    alert('‚úÖ Proyecto movido exitosamente');
                                    
                                    // Limpiar
                                    movingProjectMode = false;
                                    movingProjectId = null;
                                    map.getContainer().style.cursor = '';
                                    document.getElementById('map-click-indicator').style.display = 'none';
                                    if (tempMarker) {
                                        map.removeLayer(tempMarker);
                                        tempMarker = null;
                                    }
                                })
                                .catch(error => {
                                    alert('‚ùå Error al mover proyecto: ' + error.message);
                                    if (tempMarker) {
                                        map.removeLayer(tempMarker);
                                        tempMarker = null;
                                    }
                                });
                        } else {
                            // Cancelar - remover marcador temporal
                            if (tempMarker) {
                                map.removeLayer(tempMarker);
                                tempMarker = null;
                            }
                        }
                    }
                    // Modo: Agregar nuevo proyecto
                    else if (mapClickEnabled) {
                        const { lat, lng } = e.latlng;
                        
                        // Remover marcador temporal anterior
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                        }
                        
                        // Agregar marcador temporal
                        tempMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'temp-marker',
                                html: '<div style="background: #9333ea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        // Actualizar campos del formulario
                        document.getElementById('project-lat').value = lat.toFixed(6);
                        document.getElementById('project-lng').value = lng.toFixed(6);
                        
                        // Desactivar modo click
                        mapClickEnabled = false;
                        map.getContainer().style.cursor = '';
                        
                        // Reactivar clicks en los layers
                        map.eachLayer((layer) => {
                            if (layer._originalClickEvent && layer.getPopup) {
                                layer.on('click', function() {
                                    this.openPopup();
                                });
                            }
                        });
                        
                        // Ocultar indicador y mostrar modal
                        document.getElementById('map-click-indicator').style.display = 'none';
                        document.getElementById('add-project-modal').style.display = 'flex';
                        
                        // Actualizar bot√≥n
                        document.getElementById('enable-map-click').textContent = '‚úì Coordenadas capturadas';
                        document.getElementById('enable-map-click').style.background = '#10b981';
                        
                        setTimeout(() => {
                            document.getElementById('enable-map-click').textContent = 'üìç Activar Click en Mapa';
                            document.getElementById('enable-map-click').style.background = '#3b82f6';
                        }, 2000);
                    }
                });

                // Agregar grupos de capas al mapa
                Object.values(layerGroups).forEach(group => group.addTo(map));

                await loadAllLayers();

                updateStatus('Geoportal listo ‚úì');
                hideLoading();
                console.log('=== COMPLETADO ===');

            } catch (error) {
                console.error('ERROR:', error);
                updateStatus('Error: ' + error.message);
            }
        }

        async function loadAllLayers() {
            // PROYECTOS TI
            try {
                updateLoading('Cargando proyectos TI...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/proyectos_ti?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('proyectos', data.length);
                        renderProyectos(data);
                        console.log(`‚úì ${data.length} proyectos cargados`);
                    }
                }
            } catch (e) { console.error('Error proyectos:', e); }

            // DESCARGAS
            try {
                updateLoading('Cargando descargas de agua...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('clip de descarga de agua 2023')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Descargas response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Descargas data loaded:', data.length, 'items');
                    if (data && data.length > 0) {
                        maxVolumenDescarga = Math.max(...data.map(d => d.vol || 0));
                        console.log('Max volumen descarga:', maxVolumenDescarga);
                        updateLayerCount('descargas', data.length);
                        renderDescargas(data);
                        console.log(`‚úì ${data.length} descargas cargadas`);
                    }
                } else {
                    console.error('Error loading descargas:', response.status, response.statusText);
                }
            } catch (e) { 
                console.error('Error descargas:', e);
                console.error('Stack:', e.stack);
            }

            // EXTRACCIONES
            try {
                updateLoading('Cargando extracciones de agua...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('clip de extracci√≥n de agua 2023')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Extracciones response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Extracciones data loaded:', data.length, 'items');
                    if (data && data.length > 0) {
                        maxVolumenExtraccion = Math.max(...data.map(d => d.vol || 0));
                        console.log('Max volumen extracci√≥n:', maxVolumenExtraccion);
                        updateLayerCount('extracciones', data.length);
                        renderExtracciones(data);
                        console.log(`‚úì ${data.length} extracciones cargadas`);
                    }
                } else {
                    console.error('Error loading extracciones:', response.status, response.statusText);
                }
            } catch (e) { 
                console.error('Error extracciones:', e);
                console.error('Stack:', e.stack);
            }

            // CUERPOS DE AGUA (IAHCSA)
            try {
                updateLoading('Cargando cuerpos de agua...');
                
                const url = `${SUPABASE_URL}/rest/v1/${encodeURIComponent('IAHCSA_GEOPORTAL_TOMALASAGUAS ‚Äî indice_de_antropizacion_del_a')}?select=*`;
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('cuerpos-agua', data.length);
                        renderCuerposAgua(data);
                        console.log(`‚úì ${data.length} cuerpos de agua cargados`);
                    }
                }
            } catch (e) { console.error('Error cuerpos de agua:', e); }

            // KARSTIFICACI√ìN (solo medio a muy alto)
            try {
                updateLoading('Cargando karstificaci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Karstificaci√≥n')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        // Filtrar solo intensidades medias a altas (>=5)
                        const filteredData = data.filter(d => (d.intensidad || 0) >= 5);
                        
                        const intensidades = filteredData.map(d => d.intensidad || 0).filter(i => i > 0);
                        maxIntensidadKarst = Math.max(...intensidades);
                        minIntensidadKarst = Math.min(...intensidades);
                        
                        updateLayerCount('karstificacion', filteredData.length);
                        renderKarstificacion(filteredData);
                        console.log(`‚úì ${filteredData.length} pol√≠gonos de karstificaci√≥n (medio-alto) cargados`);
                    }
                }
            } catch (e) { console.error('Error karstificaci√≥n:', e); }

            // COLAPSO POR KARSTIFICACI√ìN
            try {
                updateLoading('Cargando riesgo de colapso por karstificaci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Colapso por karstificacion ‚Äî informacin_colapso_por_uga_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('colapso-karst', data.length);
                        renderColapsoKarst(data);
                        console.log(`‚úì ${data.length} pol√≠gonos de colapso por karstificaci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error colapso por karstificaci√≥n:', e); }

            // FALLAS INEGI
            try {
                updateLoading('Cargando fallas INEGI...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Fallas (INEGI) ‚Äî clip_fallas2_inegi')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Fallas INEGI response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Fallas INEGI data loaded:', data.length, 'items');
                    if (data && data.length > 0) {
                        updateLayerCount('fallas-inegi', data.length);
                        renderFallasINEGI(data);
                        console.log(`‚úì ${data.length} fallas INEGI cargadas`);
                    }
                } else {
                    console.error('Error loading fallas INEGI:', response.status, response.statusText);
                }
            } catch (e) { 
                console.error('Error fallas INEGI:', e);
                console.error('Stack:', e.stack);
            }

            // FALLAS CENAPRED
            try {
                updateLoading('Cargando fallas CENAPRED...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('fallas(CENAPRED) ‚Äî clip_fallas1_cenapred')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Fallas CENAPRED response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Fallas CENAPRED data loaded:', data.length, 'items');
                    if (data && data.length > 0) {
                        updateLayerCount('fallas-cenapred', data.length);
                        renderFallasCENAPRED(data);
                        console.log(`‚úì ${data.length} fallas CENAPRED cargadas`);
                    }
                } else {
                    console.error('Error loading fallas CENAPRED:', response.status, response.statusText);
                }
            } catch (e) { 
                console.error('Error fallas CENAPRED:', e);
                console.error('Stack:', e.stack);
            }

            // SOCIOECOSISTEMA
            try {
                updateLoading('Cargando socioecosistema...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('poligonos_del_socioecosistema ‚Äî shapes')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('socioeco', data.length);
                        renderSocioecosistema(data);
                        console.log(`‚úì ${data.length} pol√≠gonos socioecosistema cargados`);
                    }
                }
            } catch (e) { console.error('Error socioecosistema:', e); }

            // MUNICIPIO
            try {
                updateLoading('Cargando municipio...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Poligono_mun_pomo ‚Äî municipio_puerto_morelos_')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('municipio', data.length);
                        renderMunicipio(data);
                        console.log(`‚úì ${data.length} l√≠mite municipal cargado`);
                    }
                }
            } catch (e) { console.error('Error municipio:', e); }

            // POZOS SIN PROTECCI√ìN
            try {
                updateLoading('Cargando pozos sin protecci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('sin protecc')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('pozos-sin', data.length);
                        renderPozosSinProteccion(data);
                        console.log(`‚úì ${data.length} pozos sin protecci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error pozos sin protecci√≥n:', e); }

            // POZOS CON PROTECCI√ìN
            try {
                updateLoading('Cargando pozos con protecci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('protecci√≥n pozo BJ-pm')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('pozos-con', data.length);
                        renderPozosConProteccion(data);
                        console.log(`‚úì ${data.length} pozos con protecci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error pozos con protecci√≥n:', e); }

            // POEL 2013 - Cargar al final para an√°lisis espacial
            try {
                updateLoading('Cargando y analizando POEL 2013...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('poel_2013_ ‚Äî poel_clip_poel2013_oficial_clip_unico')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('poel', data.length);
                        renderPOEL(data);
                        console.log(`‚úì ${data.length} pol√≠gonos POEL cargados y analizados`);
                    }
                }
            } catch (e) { console.error('Error POEL:', e); }

            // TIERRAS COMUNALES EJIDALES
            try {
                updateLoading('Cargando zonas comunales ejidales...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zonas comunales ejidales ‚Äî zonas_comunales_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('tierras-comunales', data.length);
                        renderTierrasComunales(data);
                        console.log(`‚úì ${data.length} zonas comunales ejidales cargadas`);
                    }
                }
            } catch (e) { console.error('Error tierras comunales:', e); }

            // TIERRAS PARCELADAS
            try {
                updateLoading('Cargando zonas parceladas...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zonas parceladas ‚Äî zo_parceladas_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('tierras-parceladas', data.length);
                        renderTierrasParceladas(data);
                        console.log(`‚úì ${data.length} zonas parceladas cargadas`);
                    }
                }
            } catch (e) { console.error('Error tierras parceladas:', e); }

            // N√öCLEOS AGRARIOS (RAN)
            try {
                updateLoading('Cargando n√∫cleos agrarios...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('nucleos agrarios (ran) ‚Äî zo_nucleosagrarios_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('nucleos-agrarios', data.length);
                        renderNucleosAgrarios(data);
                        console.log(`‚úì ${data.length} n√∫cleos agrarios cargados`);
                    }
                }
            } catch (e) { console.error('Error n√∫cleos agrarios:', e); }

            // ASENTAMIENTOS HUMANOS (RAN)
            try {
                updateLoading('Cargando asentamientos humanos...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zona asentamientos humanos (RAN) ‚Äî zo_asentamientoshumanos_ra')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('asentamientos-humanos', data.length);
                        renderAsentamientosHumanos(data);
                        console.log(`‚úì ${data.length} asentamientos humanos cargados`);
                    }
                }
            } catch (e) { console.error('Error asentamientos humanos:', e); }

            // FRACCIONAMIENTOS IRREGULARES POEL
            try {
                updateLoading('Cargando fraccionamientos irregulares...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('fraccionamiento que busca legalizar el poel nuevo ‚Äî fracc_poe')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('fraccionamientos-poel', data.length);
                        renderFraccionamientosPOEL(data);
                        console.log(`‚úì ${data.length} fraccionamientos irregulares cargados`);
                    }
                }
            } catch (e) { console.error('Error fraccionamientos POEL:', e); }

            // PROYECTOS DE RESTAURACI√ìN HIDROSOCIAL
            try {
                updateLoading('Cargando proyectos de restauraci√≥n hidrosocial...');
                await loadProyectosHidrosociales();
            } catch (e) { console.error('Error proyectos hidrosociales:', e); }
        }

        function renderCuerposAgua(data) {
            const typeNames = {
                'piscina': 'Piscina',
                'cenote_s_a': 'Cenote Modificado',
                'cenote_s_s': 'Cenote Artificial',
                'aguada_a': 'Aguada Antropizada',
                'aguada_n': 'Aguada Natural',
                'sascab_ce': 'Sascabera',
                'rio_a': 'R√≠o Artificial'
            };

            const typeCounters = {};
            const typeAreas = {}; // Para sumar √°reas por tipo
            let totalArea = 0;

            data.forEach(item => {
                const geom = item.geom;
                if (!geom || (geom.type !== 'MultiPolygon' && geom.type !== 'Polygon')) return;

                const clase = item.CLASE || 'default';
                const areaHa = parseFloat(item['ha_cuerp_agua-sup']) || 0;
                const areaM2 = areaHa * 10000; // Convertir hect√°reas a m¬≤
                const color = COLORS.cuerposAgua[clase] || COLORS.cuerposAgua.default;

                if (!typeCounters[clase]) {
                    typeCounters[clase] = 0;
                    typeAreas[clase] = 0;
                }
                typeCounters[clase]++;
                typeAreas[clase] += areaM2;
                totalArea += areaM2;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    // Calcular centroide simple (promedio de coordenadas del primer ring)
                    const firstRing = coords[0];
                    let sumLat = 0, sumLng = 0;
                    firstRing.forEach(coord => {
                        sumLat += coord[0];
                        sumLng += coord[1];
                    });
                    const centroidLat = sumLat / firstRing.length;
                    const centroidLng = sumLng / firstRing.length;

                    const typeName = typeNames[clase] || clase;

                    // Guardar para an√°lisis espacial
                    allLayersData.cuerposAgua.push({
                        lat: centroidLat,
                        lng: centroidLng,
                        area: areaM2,
                        tipo: typeName,
                        clase: clase
                    });

                    if (clase === 'rio_a') {
                        allLayersData.rios.push({
                            lat: centroidLat,
                            lng: centroidLng,
                            area: areaM2,
                            tipo: 'R√≠o Artificial'
                        });
                    }

                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2,
                        opacity: 0.8
                    });
                    
                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">${typeName}</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>√Årea:</strong> ${areaM2.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤</p>
                                ${item.nombre ? `<p><strong>Ubicaci√≥n:</strong> ${item.nombre}</p>` : ''}
                                ${item.Politica ? `<p><strong>Pol√≠tica:</strong> ${item.Politica}</p>` : ''}
                                ${item.clase_valor ? `<p><strong>√çndice:</strong> ${item.clase_valor}</p>` : ''}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, {
                        maxWidth: 300,
                        closeButton: true
                    });

                    // Efecto hover
                    polygon.on('mouseover', function() {
                        this.setStyle({
                            fillOpacity: 0.6,
                            weight: 3
                        });
                    });

                    polygon.on('mouseout', function() {
                        this.setStyle({
                            fillOpacity: 0.4,
                            weight: 2
                        });
                    });

                    // Agregar a grupos
                    polygon.addTo(layerGroups.cuerposAgua);
                    
                    if (clase === 'piscina') polygon.addTo(layerGroups.piscinas);
                    else if (clase === 'cenote_s_a') polygon.addTo(layerGroups.cenotesSup);
                    else if (clase === 'cenote_s_s') polygon.addTo(layerGroups.cenotesSub);
                    else if (clase === 'aguada_a') polygon.addTo(layerGroups.aguadasArt);
                    else if (clase === 'aguada_n') polygon.addTo(layerGroups.aguadasNat);
                    else if (clase === 'sascab_ce') polygon.addTo(layerGroups.sascab);
                    else if (clase === 'rio_a') polygon.addTo(layerGroups.rios);
                }
            });

            // Actualizar contadores
            updateLayerCount('piscinas', typeCounters['piscina'] || 0);
            updateLayerCount('cenotes-sup', typeCounters['cenote_s_a'] || 0);
            updateLayerCount('cenotes-sub', typeCounters['cenote_s_s'] || 0);
            updateLayerCount('aguadas-art', typeCounters['aguada_a'] || 0);
            updateLayerCount('aguadas-nat', typeCounters['aguada_n'] || 0);
            updateLayerCount('sascab', typeCounters['sascab_ce'] || 0);
            updateLayerCount('rios', typeCounters['rio_a'] || 0);

            // Actualizar √°reas
            if (typeAreas['piscina']) {
                document.getElementById('area-piscinas').textContent = 
                    `${typeAreas['piscina'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['cenote_s_a']) {
                document.getElementById('area-cenotes-sup').textContent = 
                    `${typeAreas['cenote_s_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['cenote_s_s']) {
                document.getElementById('area-cenotes-sub').textContent = 
                    `${typeAreas['cenote_s_s'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['aguada_a']) {
                document.getElementById('area-aguadas-art').textContent = 
                    `${typeAreas['aguada_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['aguada_n']) {
                document.getElementById('area-aguadas-nat').textContent = 
                    `${typeAreas['aguada_n'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['sascab_ce']) {
                document.getElementById('area-sascab').textContent = 
                    `${typeAreas['sascab_ce'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['rio_a']) {
                document.getElementById('area-rios').textContent = 
                    `${typeAreas['rio_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }

            // Actualizar total
            document.getElementById('total-area-cuerpos').textContent = 
                totalArea.toLocaleString('es-MX', {maximumFractionDigits: 0});

            console.log(`‚úì Cuerpos de agua renderizados por tipo:`, typeCounters);
            console.log(`‚úì √Årea total: ${totalArea.toLocaleString('es-MX')} m¬≤`);
        }

        function renderProyectos(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || geom.type !== 'Point') return;

                // Validar que las coordenadas existan
                if (!geom.coordinates || geom.coordinates.length < 2) {
                    console.warn('Proyecto sin coordenadas v√°lidas:', item);
                    return;
                }

                const lat = geom.coordinates[1];
                const lng = geom.coordinates[0];
                
                // Validar que sean n√∫meros v√°lidos
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn('Coordenadas inv√°lidas:', { lat, lng });
                    return;
                }

                // Guardar para an√°lisis espacial
                allLayersData.proyectos.push({
                    lat: lat,
                    lng: lng,
                    nombre: item["Nombre_Poy"] || 'Proyecto',
                    tipo: 'Proyecto Inmobiliario-tur√≠stico'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: COLORS.proyectos,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectos};">Proyecto Inmobiliario-tur√≠stico</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectos};">
                            <p><strong>Nombre:</strong> ${item["Nombre_Poy"] || 'N/A'}</p>
                            <p><strong>MIA:</strong> ${item["MIA"] || 'N/A'}</p>
                            <p><strong>Irregularidad:</strong> ${item["¬øIlegalidad o irregularidad?"] || 'N/A'}</p>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.proyectos);
            });
        }

        function renderDescargas(data) {
            console.log('Renderizando descargas, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                // Debug para primeros items
                if (index < 3) {
                    console.log(`Descarga ${index}:`, {
                        geom: geom,
                        tipo: geom?.type,
                        vol: item.vol
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en descarga', index);
                    return;
                }
                
                // Manejar Point o MultiPoint
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no Point:', geom.type);
                    return;
                }

                const vol = item.vol || 0;
                const color = getDescargaColor(vol);

                // Guardar para an√°lisis espacial
                allLayersData.descargas.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Descarga'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenDescarga) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #0369a1;">üíß Descarga de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #0369a1;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Registro:</strong> ${item.registr || 'No registrada'}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autordd || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.cuerpo ? `<p><strong>üí¶ Cuerpo Receptor:</strong> ${item.cuerpo}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.descargas);
                rendered++;
            });
            
            console.log(`‚úì ${rendered} descargas renderizadas`);
        }

        function renderExtracciones(data) {
            console.log('Renderizando extracciones, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                // Debug para primeros items
                if (index < 3) {
                    console.log(`Extracci√≥n ${index}:`, {
                        geom: geom,
                        tipo: geom?.type,
                        vol: item.vol
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en extracci√≥n', index);
                    return;
                }
                
                // Manejar Point o MultiPoint
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no Point:', geom.type);
                    return;
                }

                const vol = item.vol || 0;
                const color = getExtraccionColor(vol);

                // Guardar para an√°lisis espacial
                allLayersData.extracciones.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Extracci√≥n'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenExtraccion) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #ea580c;">‚ö° Extracci√≥n de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #ea580c;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Fecha de Registro:</strong> ${item.dia || ''}/${item.mes || ''}/${item.a√±o || ''}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autoridad || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.fuente ? `<p><strong>üö∞ Fuente:</strong> ${item.fuente}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.extracciones);
                rendered++;
            });
            
            console.log(`‚úì ${rendered} extracciones renderizadas`);
        }

        function renderKarstificacion(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const intensidad = item.intensidad || 0;
                const color = getKarstColor(intensidad);

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#fbbf24',
                        fillColor: color,
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 0.9
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: #78350f;">Karstificaci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: #78350f;">
                                <p><strong>Categor√≠a:</strong> ${item.cat || 'N/A'}</p>
                                <p><strong>Intensidad:</strong> ${intensidad}</p>
                                <p><strong>Hect√°reas:</strong> ${(item.ha_cat || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.7, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 2 });
                    });

                    polygon.addTo(layerGroups.karstificacion);
                }
            });
        }

        function renderFallasINEGI(data) {
            console.log('Renderizando fallas INEGI, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                // Debug para primeros items
                if (index < 3) {
                    console.log(`Falla INEGI ${index}:`, {
                        geom: geom,
                        tipo: geom?.type
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en falla INEGI', index);
                    return;
                }
                
                // Manejar LineString o MultiLineString
                let linesToDraw = [];
                
                if (geom.type === 'LineString') {
                    linesToDraw.push(geom.coordinates);
                } else if (geom.type === 'MultiLineString') {
                    linesToDraw = geom.coordinates;
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no LineString:', geom.type);
                    return;
                }

                linesToDraw.forEach(lineCoords => {
                    const coords = lineCoords.map(coord => [coord[1], coord[0]]);

                    const line = L.polyline(coords, {
                        color: COLORS.fallasINEGI,
                        weight: 3,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasINEGI};">Falla Geol√≥gica INEGI</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasINEGI};">
                                <p><strong>Fuente:</strong> INEGI</p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasINEGI);
                    rendered++;
                });
            });
            
            console.log(`‚úì ${rendered} fallas INEGI renderizadas`);
        }

        function renderFallasCENAPRED(data) {
            console.log('Renderizando fallas CENAPRED, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                // Debug para primeros items
                if (index < 3) {
                    console.log(`Falla CENAPRED ${index}:`, {
                        geom: geom,
                        tipo: geom?.type
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en falla CENAPRED', index);
                    return;
                }
                
                // Manejar LineString o MultiLineString
                let linesToDraw = [];
                
                if (geom.type === 'LineString') {
                    linesToDraw.push(geom.coordinates);
                } else if (geom.type === 'MultiLineString') {
                    linesToDraw = geom.coordinates;
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no LineString:', geom.type);
                    return;
                }

                linesToDraw.forEach(lineCoords => {
                    const coords = lineCoords.map(coord => [coord[1], coord[0]]);

                    const line = L.polyline(coords, {
                        color: COLORS.fallasCENAPRED,
                        weight: 3,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasCENAPRED};">Falla Geol√≥gica CENAPRED</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasCENAPRED};">
                                <p><strong>Fuente:</strong> CENAPRED</p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasCENAPRED);
                    rendered++;
                });
            });
            
            console.log(`‚úì ${rendered} fallas CENAPRED renderizadas`);
        }

        function renderPOEL(data) {
            console.log('Analizando elementos dentro de POEL UGAs...');
            
            // Primero, agrupar TODOS los pol√≠gonos por UGA
            const ugaPolygons = {};
            const ugaData = {};
            
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;
                
                const uga = item.UGA || 'N/A';
                const politica = item["Pol√≠tica"] || 'default';
                const aprovechamiento = item.Aprovechamiento || item.Aprovecha || 'N/A';
                
                // Calcular √°rea: primero intentar desde los datos, si no calcular geom√©tricamente
                let area = parseFloat(item.ha_uga || item.ha || 0) * 10000;
                
                // Si el √°rea es 0, calcular geom√©tricamente
                if (area === 0) {
                    const coords = parseGeoJSON(geom);
                    if (coords && coords.length > 0) {
                        // Para MultiPolygon, sumar todas las partes
                        if (geom.type === 'MultiPolygon') {
                            coords.forEach(polygon => {
                                if (polygon.length > 0) {
                                    area += calculatePolygonArea(polygon[0]);
                                }
                            });
                        } else {
                            // Para Polygon simple
                            area = calculatePolygonArea(coords[0]);
                        }
                        console.log(`UGA ${uga}: √Årea calculada geom√©tricamente: ${area.toFixed(0)} m¬≤`);
                    }
                }
                
                if (!ugaPolygons[uga]) {
                    ugaPolygons[uga] = [];
                    ugaData[uga] = {
                        politica: politica,
                        aprovechamiento: aprovechamiento,
                        area: area,
                        proyectos: 0,
                        descargas: {count: 0, vol: 0},
                        extracciones: {count: 0, vol: 0},
                        cuerposAgua: {},
                        riosArt: {count: 0, area: 0}
                    };
                } else {
                    // Si ya existe la UGA, actualizar el √°rea si es mayor
                    if (area > ugaData[uga].area) {
                        ugaData[uga].area = area;
                    }
                }
                
                ugaPolygons[uga].push(geom);
            });

            // Ahora analizar cada elemento contra TODOS los pol√≠gonos de cada UGA
            console.log(`Analizando ${Object.keys(ugaPolygons).length} UGAs...`);
            console.log(`Total elementos a verificar: ${allLayersData.proyectos.length} proyectos, ${allLayersData.descargas.length} descargas, ${allLayersData.extracciones.length} extracciones, ${allLayersData.cuerposAgua.length} cuerpos de agua`);
            
            Object.entries(ugaPolygons).forEach(([uga, polygons]) => {
                const ugaInfo = ugaData[uga];
                
                // Debug detallado para UGAs espec√≠ficas
                const debugUGA = ['11', '16b', '16B'].includes(uga);
                if (debugUGA) {
                    console.log(`=== Analizando UGA ${uga} ===`);
                    console.log(`Pol√≠gonos en UGA: ${polygons.length}`);
                    polygons.forEach((p, i) => {
                        console.log(`  Pol√≠gono ${i}: tipo=${p.type}, coords length=${p.coordinates?.length}`);
                    });
                }
                
                // Verificar proyectos
                allLayersData.proyectos.forEach((proyecto, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([proyecto.lng, proyecto.lat], geom)) {
                            ugaInfo.proyectos++;
                            if (debugUGA) console.log(`  ‚úì Proyecto ${idx} dentro: [${proyecto.lat}, ${proyecto.lng}]`);
                            break;
                        }
                    }
                });

                // Verificar descargas
                allLayersData.descargas.forEach((descarga, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([descarga.lng, descarga.lat], geom)) {
                            ugaInfo.descargas.count++;
                            ugaInfo.descargas.vol += descarga.vol;
                            if (debugUGA) console.log(`  ‚úì Descarga ${idx} dentro: [${descarga.lat}, ${descarga.lng}]`);
                            break;
                        }
                    }
                });

                // Verificar extracciones
                allLayersData.extracciones.forEach((extraccion, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([extraccion.lng, extraccion.lat], geom)) {
                            ugaInfo.extracciones.count++;
                            ugaInfo.extracciones.vol += extraccion.vol;
                            if (debugUGA) console.log(`  ‚úì Extracci√≥n ${idx} dentro: [${extraccion.lat}, ${extraccion.lng}]`);
                            break;
                        }
                    }
                });

                // Verificar cuerpos de agua
                allLayersData.cuerposAgua.forEach((cuerpo, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([cuerpo.lng, cuerpo.lat], geom)) {
                            if (!ugaInfo.cuerposAgua[cuerpo.tipo]) {
                                ugaInfo.cuerposAgua[cuerpo.tipo] = {count: 0, area: 0};
                            }
                            ugaInfo.cuerposAgua[cuerpo.tipo].count++;
                            ugaInfo.cuerposAgua[cuerpo.tipo].area += cuerpo.area;
                            if (debugUGA && idx < 5) console.log(`  ‚úì ${cuerpo.tipo} ${idx} dentro: [${cuerpo.lat}, ${cuerpo.lng}]`);
                            break;
                        }
                    }
                });

                // Verificar r√≠os artificiales
                allLayersData.rios.forEach((rio, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([rio.lng, rio.lat], geom)) {
                            ugaInfo.riosArt.count++;
                            ugaInfo.riosArt.area += rio.area;
                            if (debugUGA) console.log(`  ‚úì R√≠o artificial ${idx} dentro: [${rio.lat}, ${rio.lng}]`);
                            break;
                        }
                    }
                });
                
                if (debugUGA || ugaInfo.proyectos > 0 || ugaInfo.descargas.count > 0) {
                    console.log(`UGA ${uga}: ${ugaInfo.proyectos} proyectos, ${ugaInfo.descargas.count} descargas, ${ugaInfo.extracciones.count} extracciones, ${Object.keys(ugaInfo.cuerposAgua).length} tipos de cuerpos`);
                }
            });

            // Ahora renderizar los pol√≠gonos
            const politicasCount = {};
            const ugasByPolitica = {}; // Agrupar UGAs por pol√≠tica
            
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const politica = item["Pol√≠tica"] || 'default';
                const uga = item.UGA || 'N/A';
                const color = getPOELColor(politica);

                if (!politicasCount[politica]) {
                    politicasCount[politica] = 0;
                    ugasByPolitica[politica] = new Set();
                }
                politicasCount[politica]++;
                ugasByPolitica[politica].add(uga); // Agregar UGA al set (evita duplicados)

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.3,
                        weight: 2,
                        opacity: 0.8
                    });

                    const ugaInfo = ugaData[uga];
                    
                    // Construir popup con toda la informaci√≥n
                    let elementosHTML = '';
                    
                    if (ugaInfo.proyectos > 0) {
                        elementosHTML += `<p>‚Ä¢ <strong>${ugaInfo.proyectos}</strong> Proyectos Inmobiliarios-tur√≠sticos</p>`;
                    }
                    
                    if (ugaInfo.descargas.count > 0) {
                        elementosHTML += `<p>‚Ä¢ <strong>${ugaInfo.descargas.count}</strong> Descargas (${formatVolume(ugaInfo.descargas.vol)})</p>`;
                    }
                    
                    if (ugaInfo.extracciones.count > 0) {
                        elementosHTML += `<p>‚Ä¢ <strong>${ugaInfo.extracciones.count}</strong> Extracciones (${formatVolume(ugaInfo.extracciones.vol)})</p>`;
                    }

                    if (ugaInfo.riosArt.count > 0) {
                        elementosHTML += `<p>‚Ä¢ <strong>${ugaInfo.riosArt.count}</strong> R√≠os Artificiales (${ugaInfo.riosArt.area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤)</p>`;
                    }

                    // Cuerpos de agua por tipo
                    Object.entries(ugaInfo.cuerposAgua).forEach(([tipo, data]) => {
                        if (tipo !== 'R√≠o Artificial' && data.count > 0) {
                            elementosHTML += `<p>‚Ä¢ <strong>${data.count}</strong> ${tipo}${data.count > 1 ? 's' : ''} (${data.area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤)</p>`;
                        }
                    });

                    if (elementosHTML === '') {
                        elementosHTML = '<p style="color: #9ca3af; font-style: italic;">No hay elementos mapeados en esta UGA</p>';
                    }
                    
                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">UGA ${uga}</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Pol√≠tica:</strong> ${politica}</p>
                                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 8px 0;">
                                <strong style="color: #4a5568;">Elementos en esta UGA:</strong>
                                ${elementosHTML}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, {
                        maxWidth: 350
                    });
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.3, weight: 2 });
                    });

                    polygon.addTo(layerGroups.poel);
                }
            });
            
            // Generar leyenda din√°mica con nombres de UGAs
            const legendItems = document.getElementById('legend-poel-items');
            let legendHTML = '';
            
            // Ordenar pol√≠ticas por n√∫mero de pol√≠gonos (descendente)
            const sortedPoliticas = Object.entries(politicasCount).sort((a, b) => b[1] - a[1]);
            
            sortedPoliticas.forEach(([politica, count]) => {
                const color = getPOELColor(politica);
                const ugas = Array.from(ugasByPolitica[politica]).sort((a, b) => {
                    // Ordenar UGAs num√©ricamente
                    const numA = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                    const numB = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                    return numA - numB;
                });
                
                legendHTML += `
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 3px;">
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; margin-right: 6px;"></div>
                            <strong style="font-size: 10px; color: #4a5568;">${politica}</strong>
                        </div>
                        <div style="padding-left: 18px; font-size: 9px; color: #6b7280; line-height: 1.3;">
                            ${ugas.join(', ')}
                        </div>
                    </div>
                `;
            });
            
            legendItems.innerHTML = legendHTML;
            
            console.log('‚úì An√°lisis espacial de POEL completado');
        }

        function renderSocioecosistema(data) {
            console.log('=== RENDERIZANDO SOCIOECOSISTEMA (ZONAS INUNDABLES) ===');
            console.log('Total items recibidos:', data.length);
            
            // Lista de tipos que queremos mostrar (zonas inundables)
            const tiposPermitidos = [
                'manglar',
                'manglar 2',
                'tular',
                'planicie carstica sujeta a inu',
                'suelo con poca vegetacion prop',
                'zona de manglar inundada (est',
                'selva mediana perennifolia',
                'nubes',
                'zona de cambio de uso de suelo'
            ];
            
            // Mapeo de nombres para mostrar en el popup
            const nombresDisplay = {
                'manglar': 'Manglar',
                'manglar 2': 'Manglar 2',
                'tular': 'Tular',
                'planicie carstica sujeta a inu': 'Planicie c√°rstica sujeta a inundaci√≥n',
                'suelo con poca vegetacion prop': 'Suelo con poca vegetaci√≥n propensa a inundaci√≥n',
                'zona de manglar inundada (est': 'Manglar inundado',
                'selva mediana perennifolia': 'Manglar con selva mediana perennifolia',
                'nubes': 'Planicies k√°rsticas sujetas a inundaci√≥n',
                'zona de cambio de uso de suelo': 'Zona inundada impactada por el cambio de uso de suelo'
            };
            
            console.log('Tipos permitidos:', tiposPermitidos);
            
            let rendered = 0;
            let filteredOut = 0;
            let noGeometry = 0;
            let wrongType = 0;
            let noCoords = 0;
            let errorCount = 0;
            
            // Contar tipos encontrados
            const tiposEncontrados = {};
            
            data.forEach((item, index) => {
                // Logging del primer item para debug
                if (index === 0) {
                    console.log('Primer item completo:', item);
                    console.log('Campo Tipo_sist:', item.Tipo_sist);
                    console.log('Campo tipo_sist:', item.tipo_sist);
                    console.log('Campo TIPO_SIST:', item.TIPO_SIST);
                    console.log('Campo geojson:', item.geojson ? 'presente' : 'ausente');
                    console.log('Campo geom:', item.geom ? 'presente' : 'ausente');
                }
                
                const geom = parseGeometry(item);
                if (!geom) {
                    noGeometry++;
                    if (index < 3) console.log(`Item ${index}: No geometry`);
                    return;
                }
                
                if (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon') {
                    wrongType++;
                    if (index < 3) console.log(`Item ${index}: Wrong type ${geom.type}`);
                    return;
                }

                const tipo = (item.CLASS_NAME || item.class_name || item.Tipo_sist || item.tipo_sist || '').toLowerCase().trim();
                
                // Contar tipos
                if (!tiposEncontrados[tipo]) {
                    tiposEncontrados[tipo] = 0;
                }
                tiposEncontrados[tipo]++;
                
                // Solo renderizar si est√° en la lista de tipos permitidos
                if (!tiposPermitidos.includes(tipo)) {
                    filteredOut++;
                    return;
                }
                
                const color = COLORS.socioeco[tipo] || COLORS.socioeco.default;

                const coords = parseGeoJSON(geom);
                if (!coords || coords.length === 0) {
                    noCoords++;
                    if (index < 3) console.log(`Item ${index}: Failed to parse coordinates`);
                    return;
                }
                
                // Log primera coordenada del primer pol√≠gono renderizado
                if (rendered === 0) {
                    console.log('Primera coordenada a renderizar:', coords[0][0]);
                }
                
                try {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">Zona Inundable</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Tipo:</strong> ${nombresDisplay[tipo] || tipo}</p>
                                ${item.ha ? `<p><strong>Hect√°reas:</strong> ${(item.ha).toLocaleString()}</p>` : ''}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.6, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.4, weight: 2 });
                    });

                    polygon.addTo(layerGroups.socioeco);
                    rendered++;
                } catch (e) {
                    errorCount++;
                    if (errorCount < 3) console.error(`Error rendering polygon ${index}:`, e);
                }
            });
            
            console.log('=== RESUMEN SOCIOECOSISTEMA ===');
            console.log('Total items:', data.length);
            console.log('‚úì Renderizados:', rendered);
            console.log('‚ùå Sin geometr√≠a:', noGeometry);
            console.log('‚ùå Tipo incorrecto:', wrongType);
            console.log('‚ùå Filtrados (no son zonas inundables):', filteredOut);
            console.log('‚ùå Error parseando coordenadas:', noCoords);
            console.log('‚ùå Error creando pol√≠gono:', errorCount);
            console.log('üìä Tipos encontrados:', tiposEncontrados);
        }

        function renderMunicipio(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#fbbf24',
                        fillColor: COLORS.municipio,
                        fillOpacity: 0.05,
                        weight: 4,
                        opacity: 1
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.municipio};">Municipio Puerto Morelos</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.municipio};">
                                <p><strong>L√≠mite municipal</strong></p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    polygon.addTo(layerGroups.municipio);
                }
            });
        }

        function renderPozosSinProteccion(data) {
            console.log('=== RENDERIZANDO POZOS SIN PROTECCI√ìN ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                if (index === 0) {
                    console.log('Primer item:', item);
                }
                
                const geom = parseGeometry(item);
                if (!geom) {
                    console.log(`Item ${index}: No geometry found`);
                    return;
                }
                
                if (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon') {
                    console.log(`Item ${index}: Wrong geometry type:`, geom.type);
                    return;
                }

                const coords = parseGeoJSON(geom);
                if (!coords || coords.length === 0) {
                    console.log(`Item ${index}: Failed to parse coordinates`);
                    return;
                }
                
                if (index === 0) {
                    console.log('Primera coordenada:', coords[0][0]);
                }
                
                try {
                    const polygon = L.polygon(coords, {
                        color: COLORS.pozosSinProteccion,
                        fillColor: COLORS.pozosSinProteccion,
                        fillOpacity: 0,
                        weight: 4,
                        opacity: 1
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.pozosSinProteccion};">‚ö†Ô∏è Pozo sin Protecci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.pozosSinProteccion};">
                                <p><strong>Estado:</strong> Sin protecci√≥n</p>
                                ${item.nombre || item.NOMBRE ? `<p><strong>Nombre:</strong> ${item.nombre || item.NOMBRE}</p>` : ''}
                                ${item.area || item.AREA ? `<p><strong>√Årea:</strong> ${(item.area || item.AREA).toLocaleString()} m¬≤</p>` : ''}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ weight: 5, opacity: 1 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ weight: 4, opacity: 1 });
                    });

                    polygon.addTo(layerGroups.pozosSinProteccion);
                    rendered++;
                } catch (e) {
                    console.error(`Error rendering polygon ${index}:`, e);
                }
            });
            
            console.log(`‚úì Rendered ${rendered} of ${data.length} pozos sin protecci√≥n`);
        }

        function renderPozosConProteccion(data) {
            console.log('=== RENDERIZANDO POZOS CON PROTECCI√ìN ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                if (index === 0) {
                    console.log('Primer item:', item);
                }
                
                const geom = parseGeometry(item);
                if (!geom) {
                    console.log(`Item ${index}: No geometry found`);
                    return;
                }
                
                if (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon') {
                    console.log(`Item ${index}: Wrong geometry type:`, geom.type);
                    return;
                }

                const coords = parseGeoJSON(geom);
                if (!coords || coords.length === 0) {
                    console.log(`Item ${index}: Failed to parse coordinates`);
                    return;
                }
                
                if (index === 0) {
                    console.log('Primera coordenada:', coords[0][0]);
                }
                
                try {
                    const polygon = L.polygon(coords, {
                        color: COLORS.pozosConProteccion,
                        fillColor: COLORS.pozosConProteccion,
                        fillOpacity: 0,
                        weight: 4,
                        opacity: 1
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.pozosConProteccion};">‚úÖ Pozo con Protecci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.pozosConProteccion};">
                                <p><strong>Estado:</strong> Con protecci√≥n</p>
                                ${item.nombre || item.NOMBRE ? `<p><strong>Nombre:</strong> ${item.nombre || item.NOMBRE}</p>` : ''}
                                ${item.area || item.AREA ? `<p><strong>√Årea:</strong> ${(item.area || item.AREA).toLocaleString()} m¬≤</p>` : ''}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ weight: 5, opacity: 1 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ weight: 4, opacity: 1 });
                    });

                    polygon.addTo(layerGroups.pozosConProteccion);
                    rendered++;
                } catch (e) {
                    console.error(`Error rendering polygon ${index}:`, e);
                }
            });
            
            console.log(`‚úì Rendered ${rendered} of ${data.length} pozos con protecci√≥n`);
        }

        function renderColapsoKarst(data) {
            console.log('=== RENDERIZANDO COLAPSO POR KARSTIFICACI√ìN ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const riesgo = item.riesgo || item.RIESGO || item.Riesgo || 'default';
                const color = COLORS.colapsoKarst[riesgo] || COLORS.colapsoKarst.default;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 0.9
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Nivel de Riesgo:</strong> ${riesgo}</p>
                                ${item.uga || item.UGA ? `<p><strong>UGA:</strong> ${item.uga || item.UGA}</p>` : ''}
                                ${item.descripcion || item.DESCRIPCION ? `<p><strong>Descripci√≥n:</strong> ${item.descripcion || item.DESCRIPCION}</p>` : ''}
                                <p style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; font-size: 12px;">
                                    <strong>‚ö†Ô∏è Advertencia:</strong> Esta zona presenta riesgo de colapso del terreno. No recomendado para construcci√≥n de infraestructura pesada.
                                </p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.7, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 2 });
                    });

                    polygon.addTo(layerGroups.colapsoKarst);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} pol√≠gonos de colapso por karstificaci√≥n renderizados`);
        }

        function renderTierrasComunales(data) {
            console.log('=== RENDERIZANDO TIERRAS COMUNALES EJIDALES ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const color = COLORS.tierrasEjidales.comunal;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">üèòÔ∏è Zona Comunal Ejidal</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Tipo:</strong> Tierra Comunal</p>
                                ${item.ejido || item.EJIDO ? `<p><strong>Ejido:</strong> ${item.ejido || item.EJIDO}</p>` : ''}
                                ${item.nucleo || item.NUCLEO ? `<p><strong>N√∫cleo Agrario:</strong> ${item.nucleo || item.NUCLEO}</p>` : ''}
                                ${item.superficie || item.SUPERFICIE ? `<p><strong>Superficie:</strong> ${(item.superficie || item.SUPERFICIE).toLocaleString()} ha</p>` : ''}
                                <p style="margin-top: 10px; padding: 10px; background: #f3e8ff; border-left: 4px solid #a855f7; font-size: 12px;">
                                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Tierras de uso colectivo del ejido. Cualquier desarrollo requiere consulta y aprobaci√≥n de la asamblea ejidal.
                                </p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.6, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.4, weight: 2 });
                    });

                    polygon.addTo(layerGroups.tierrasComunales);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} zonas comunales ejidales renderizadas`);
        }

        function renderTierrasParceladas(data) {
            console.log('=== RENDERIZANDO TIERRAS PARCELADAS ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const color = COLORS.tierrasEjidales.parcelada;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">üèòÔ∏è Zona Parcelada</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Tipo:</strong> Tierra Parcelada</p>
                                ${item.ejido || item.EJIDO ? `<p><strong>Ejido:</strong> ${item.ejido || item.EJIDO}</p>` : ''}
                                ${item.nucleo || item.NUCLEO ? `<p><strong>N√∫cleo Agrario:</strong> ${item.nucleo || item.NUCLEO}</p>` : ''}
                                ${item.superficie || item.SUPERFICIE ? `<p><strong>Superficie:</strong> ${(item.superficie || item.SUPERFICIE).toLocaleString()} ha</p>` : ''}
                                <p style="margin-top: 10px; padding: 10px; background: #fed7aa; border-left: 4px solid #f97316; font-size: 12px;">
                                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Tierras parceladas del ejido para uso individual de ejidatarios. Cualquier cambio de uso de suelo requiere autorizaci√≥n ejidal y tr√°mites legales.
                                </p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.6, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.4, weight: 2 });
                    });

                    polygon.addTo(layerGroups.tierrasParceladas);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} zonas parceladas renderizadas`);
        }

        function renderNucleosAgrarios(data) {
            console.log('=== RENDERIZANDO N√öCLEOS AGRARIOS ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#6366f1',
                        fillColor: '#6366f1',
                        fillOpacity: 0.35,
                        weight: 2,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: #6366f1;">üèòÔ∏è N√∫cleo Agrario (RAN)</h3>
                            <div class="custom-popup-divider" style="border-color: #6366f1;">
                                <p><strong>Nombre:</strong> ${item.NombreNucleoAgrario || item.nombre || 'N/A'}</p>
                                <p><strong>Tipo:</strong> ${item.TipoNucleoAgrario || item.tipo || 'N/A'}</p>
                                <p><strong>Municipio:</strong> ${item.NombreMunicipio || item.municipio || 'Puerto Morelos'}</p>
                                ${item.Area || item.area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area || item.area).toLocaleString('es-MX')} ha</p>` : ''}
                                
                                <div style="margin-top: 10px; padding: 10px; background: #e0e7ff; border-left: 4px solid #6366f1;">
                                    <strong>‚öñÔ∏è Marco Legal (Ley Agraria):</strong>
                                    <p style="font-size: 12px; margin: 5px 0;">
                                        <strong>Art. 23:</strong> Las tierras ejidales comprenden parceladas, de uso com√∫n y del asentamiento humano.<br>
                                        <strong>Art. 56:</strong> Cambios de uso requieren 2/3 de votos en asamblea.<br>
                                        <strong>Art. 87:</strong> Modificaciones requieren autorizaci√≥n del RAN.<br>
                                        <strong>Requisito ambiental:</strong> MIA ante SEMARNAT para cualquier desarrollo.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, { maxWidth: 450 });
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.55, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.35, weight: 2 });
                    });

                    polygon.addTo(layerGroups.nucleosAgrarios);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} n√∫cleos agrarios renderizados`);
        }

        function renderAsentamientosHumanos(data) {
            console.log('=== RENDERIZANDO ASENTAMIENTOS HUMANOS ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#ec4899',
                        fillColor: '#ec4899',
                        fillOpacity: 0.40,
                        weight: 2,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: #ec4899;">üèòÔ∏è Asentamiento Humano (RAN)</h3>
                            <div class="custom-popup-divider" style="border-color: #ec4899;">
                                <p><strong>Localidad:</strong> ${item.NombreLocalidad || item.localidad || 'N/A'}</p>
                                <p><strong>N√∫cleo Agrario:</strong> ${item.NombreNucleoAgrario || item.nucleo || 'N/A'}</p>
                                ${item.Area || item.area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area || item.area).toLocaleString('es-MX')} ha</p>` : ''}
                                
                                <div style="margin-top: 10px; padding: 10px; background: #fce7f3; border-left: 4px solid #ec4899;">
                                    <strong>‚öñÔ∏è Marco Legal (Ley Agraria Art. 63-72):</strong>
                                    <p style="font-size: 12px; margin: 5px 0;">
                                        √Årea necesaria para desarrollo de vida comunitaria del ejido.<br>
                                        <strong>Art. 64:</strong> Solares inalienables, no transferibles a personas ajenas al ejido.<br>
                                        <strong>Restricciones:</strong> Uso exclusivamente habitacional y de servicios comunitarios.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, { maxWidth: 450 });
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.60, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.40, weight: 2 });
                    });

                    polygon.addTo(layerGroups.asentamientosHumanos);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} asentamientos humanos renderizados`);
        }

        function renderFraccionamientosPOEL(data) {
            console.log('=== RENDERIZANDO FRACCIONAMIENTOS IRREGULARES POEL ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#ef4444',
                        fillColor: '#ef4444',
                        fillOpacity: 0.50,
                        weight: 3,
                        opacity: 0.9,
                        dashArray: '10, 5'
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <div style="background: #fee2e2; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 2px solid #ef4444;">
                                <h3 style="color: #991b1b; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 24px;">üö®</span>
                                    ALERTA CIUDADANA
                                </h3>
                                <p style="font-size: 13px; font-weight: 600; margin: 0; color: #7f1d1d;">
                                    Fraccionamiento Irregular que el Municipio busca legalizar mediante la actualizaci√≥n del POEL/PDU 2024
                                </p>
                            </div>
                            
                            <div class="custom-popup-divider" style="border-color: #ef4444;">
                                ${item.Nombre || item.nombre ? `<p><strong>Nombre:</strong> ${item.Nombre || item.nombre}</p>` : ''}
                                ${item.Area || item.area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area || item.area).toLocaleString('es-MX')} ha</p>` : ''}
                                ${item.Lotes || item.lotes ? `<p><strong>Lotes:</strong> ${item.Lotes || item.lotes}</p>` : ''}
                                
                                <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                                    <strong>‚ö†Ô∏è Situaci√≥n Legal:</strong>
                                    <p style="font-size: 12px; margin: 5px 0 0 0;">
                                        Desarrollo construido <strong>sin permisos ni MIA</strong>. El municipio busca legalizarlo retroactivamente mediante actualizaci√≥n del POEL/PDU 2024.
                                    </p>
                                </div>
                                
                                <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444;">
                                    <strong>üåä Implicaciones para Seguridad H√≠drica:</strong>
                                    <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                        <li><strong>Precedente peligroso:</strong> Incentiva m√°s construcciones ilegales</li>
                                        <li><strong>Zona cr√≠tica:</strong> Sobre la Fractura Holbox-Xel-H√° (reserva estrat√©gica) o humedales k√°rsticos</li>
                                        <li><strong>Sin MIA:</strong> Muchos de estos proeyctos no cuentan con evaluaci√≥n de impacto ambiental, un analisis exaustivo hidrol√≥gico es vital para mantener una calidad de vida aceptable en nuestro municipio</li>
                                        <li><strong>Impermeabilizaci√≥n:</strong> Reduce infiltraci√≥n natural del acu√≠fero</li>
                                        <li><strong>Pozos ilegales:</strong> Para que sean funcionales los fraccionamientos deben de tener pozos de extracci√≥n y descarga de agua. Estos pozos deben ser concesionados y reportados por la CONAGUA</li>
                                        <li><strong>Aguas residuales:</strong> Riesgo de contaminaci√≥n del acu√≠fero k√°rstico</li>
                                    </ul>
                                </div>
                                
                                <div style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6;">
                                    <strong>üë• ¬øQu√© puedes hacer?</strong>
                                    <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                        <li>Participar en consultas p√∫blicas del POEL/PDU 2024</li>
                                        <li>Exigir MIA retroactiva con evaluaci√≥n geohidrol√≥gica</li>
                                        <li>Demandar transparencia: comparar fechas de construcci√≥n vs permisos</li>
                                        <li>Reportar a PROFEPA (ambiental) y CONAGUA (agua)</li>
                                        <li>Exigir monitoreo de calidad del acu√≠fero en la zona</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, { maxWidth: 550 });
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.70, weight: 4 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.50, weight: 3 });
                    });

                    polygon.addTo(layerGroups.fraccionamientosPOEL);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} fraccionamientos irregulares renderizados`);
        }

        function renderProyectosHidrosociales(data) {
            console.log('=== RENDERIZANDO PROYECTOS DE RESTAURACI√ìN HIDROSOCIAL ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
            
            // Informaci√≥n educativa sobre ciclo hidrosocial
            const infoHidrosocial = {
                'infiltraci√≥n': {
                    icono: 'üíß',
                    color: '#0ea5e9',
                    explicacion: 'Facilita que el agua de lluvia penetre el suelo y recargue el acu√≠fero en lugar de escurrir y perderse.'
                },
                'reforestaci√≥n': {
                    icono: 'üå≥',
                    color: '#22c55e',
                    explicacion: 'Los √°rboles nativos captan agua de lluvia, reducen escorrent√≠a, aumentan infiltraci√≥n y protegen el suelo.'
                },
                'captaci√≥n_lluvia': {
                    icono: 'üè†',
                    color: '#3b82f6',
                    explicacion: 'Recolecta agua de lluvia de techos para uso dom√©stico, reduciendo extracci√≥n del acu√≠fero.'
                },
                'biofiltros': {
                    icono: 'üåø',
                    color: '#10b981',
                    explicacion: 'Sistemas naturales que filtran contaminantes del agua antes de que llegue al acu√≠fero k√°rstico.'
                },
                'humedales_artificiales': {
                    icono: 'ü¶Ü',
                    color: '#14b8a6',
                    explicacion: 'Tratan aguas residuales naturalmente usando plantas, protegiendo el acu√≠fero de contaminaci√≥n.'
                },
                'jardines_lluvia': {
                    icono: 'üå∫',
                    color: '#8b5cf6',
                    explicacion: '√Åreas vegetadas que captan escorrent√≠a, filtran contaminantes e infiltran agua limpia al subsuelo.'
                },
                'zanjas_infiltraci√≥n': {
                    icono: 'üèûÔ∏è',
                    color: '#84cc16',
                    explicacion: 'Canales que retienen y permiten infiltraci√≥n lenta del agua de lluvia en lugar de drenarla r√°pido.'
                },
                'protecci√≥n_cenotes': {
                    icono: 'üï≥Ô∏è',
                    color: '#06b6d4',
                    explicacion: 'Protege entradas directas al acu√≠fero de contaminaci√≥n y sobreexplotaci√≥n.'
                },
                'restauraci√≥n_manglar': {
                    icono: 'üå¥',
                    color: '#059669',
                    explicacion: 'Restaura ecosistemas costeros que filtran agua y protegen de intrusi√≥n salina al acu√≠fero.'
                },
                'desimpermeabilizaci√≥n': {
                    icono: 'üî®',
                    color: '#f59e0b',
                    explicacion: 'Remueve asfalto/concreto para permitir que el agua se infiltre naturalmente.'
                },
                'default': {
                    icono: 'üíö',
                    color: '#06b6d4',
                    explicacion: 'Proyecto comunitario de defensa y restauraci√≥n del ciclo hidrosocial.'
                }
            };
            
            data.forEach((item, index) => {
                if (!item.lat || !item.lng || isNaN(item.lat) || isNaN(item.lng)) {
                    console.warn('Proyecto sin coordenadas v√°lidas:', item);
                    return;
                }
                
                const tipoProyecto = item.tipo_proyecto || 'default';
                const info = infoHidrosocial[tipoProyecto] || infoHidrosocial.default;
                
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 12,
                    fillColor: info.color,
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.85,
                    draggable: isAdmin
                });
                
                const isOwner = currentUser && item.user_id === currentUser.id;
                const ownerBadge = isOwner ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 5px;">TU PROYECTO</span>' : '';
                const adminBadge = isAdmin ? '<span style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 5px;">ADMIN</span>' : '';
                
                let estadoBadge = '';
                let estadoColor = '#6b7280';
                if (item.estado === 'propuesto') {
                    estadoBadge = 'üå± Propuesto';
                    estadoColor = '#f59e0b';
                } else if (item.estado === 'en_planificaci√≥n') {
                    estadoBadge = 'üìã En Planificaci√≥n';
                    estadoColor = '#3b82f6';
                } else if (item.estado === 'en_curso') {
                    estadoBadge = 'üî® En Curso';
                    estadoColor = '#8b5cf6';
                } else if (item.estado === 'completado') {
                    estadoBadge = '‚úÖ Completado';
                    estadoColor = '#10b981';
                }
                
                let popupContent = `
                    <div class="custom-popup" style="max-width: 450px;">
                        <div style="background: linear-gradient(135deg, ${info.color}, ${info.color}dd); padding: 18px; border-radius: 8px 8px 0 0; margin: -15px -15px 15px -15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <div style="font-size: 36px; text-align: center; margin-bottom: 8px;">${info.icono}</div>
                            <h3 style="color: white; margin: 0 0 8px 0; font-size: 18px; text-align: center; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                                ${item.nombre_proyecto}
                            </h3>
                            <div style="text-align: center;">
                                <span style="background: ${estadoColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block;">
                                    ${estadoBadge}
                                </span>
                                ${ownerBadge}${adminBadge}
                            </div>
                        </div>
                        
                        <div class="custom-popup-divider" style="border-color: ${info.color};">
                            <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid ${info.color};">
                                <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                                    <strong style="color: #1e40af;">üí° ¬øQu√© es este tipo de proyecto?</strong><br>
                                    ${info.explicacion}
                                </p>
                            </div>
                `;
                
                if (item.descripcion) {
                    popupContent += `
                        <div style="margin-bottom: 12px;">
                            <p style="font-size: 13px; line-height: 1.5;"><strong>üìù Descripci√≥n:</strong><br>${item.descripcion}</p>
                        </div>
                    `;
                }
                
                if (item.objetivos) {
                    popupContent += `
                        <div style="background: #ecfdf5; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #10b981;">
                            <p style="font-size: 12px; margin: 0; line-height: 1.5;"><strong style="color: #065f46;">üéØ Objetivos:</strong><br>${item.objetivos}</p>
                        </div>
                    `;
                }
                
                if (item.beneficios_esperados) {
                    popupContent += `
                        <div style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #3b82f6;">
                            <p style="font-size: 12px; margin: 0; line-height: 1.5;"><strong style="color: #1e40af;">üåä Beneficios para el ciclo del agua:</strong><br>${item.beneficios_esperados}</p>
                        </div>
                    `;
                }
                
                // Informaci√≥n de participaci√≥n
                let participacionInfo = [];
                if (item.participantes_estimados) {
                    participacionInfo.push(`üë• ${item.participantes_estimados} participantes`);
                }
                if (item.area_m2) {
                    participacionInfo.push(`üìè ${item.area_m2.toLocaleString('es-MX')} m¬≤`);
                }
                if (item.fecha_inicio) {
                    const fecha = new Date(item.fecha_inicio);
                    participacionInfo.push(`üìÖ Inicio: ${fecha.toLocaleDateString('es-MX')}`);
                }
                
                if (participacionInfo.length > 0) {
                    popupContent += `
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                            ${participacionInfo.map(info => `
                                <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; color: #4b5563;">
                                    ${info}
                                </span>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (item.organizacion || item.contacto_email || item.contacto_telefono) {
                    popupContent += `
                        <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #f59e0b;">
                            <p style="font-size: 12px; margin: 0; line-height: 1.5;">
                                <strong style="color: #78350f;">üë• Contacto para colaborar:</strong><br>
                    `;
                    if (item.organizacion) popupContent += `Organizaci√≥n: ${item.organizacion}<br>`;
                    if (item.contacto_email) popupContent += `üìß ${item.contacto_email}<br>`;
                    if (item.contacto_telefono) popupContent += `üìû ${item.contacto_telefono}`;
                    popupContent += `</p></div>`;
                }
                
                if (item.presupuesto_estimado) {
                    popupContent += `
                        <p style="font-size: 12px; margin-bottom: 12px;">
                            <strong>üí∞ Presupuesto estimado:</strong> $${item.presupuesto_estimado.toLocaleString('es-MX')} MXN
                        </p>
                    `;
                }
                
                // Secci√≥n educativa sobre ciclo hidrosocial
                popupContent += `
                    <div style="background: linear-gradient(135deg, #e0f2fe, #bae6fd); padding: 12px; border-radius: 8px; margin: 15px 0; border: 2px solid #38bdf8;">
                        <p style="font-size: 11px; margin: 0; line-height: 1.6; color: #075985;">
                            <strong style="font-size: 12px; color: #0c4a6e;">üíß ¬øPor qu√© es importante defender el ciclo hidrosocial?</strong><br><br>
                            En Puerto Morelos, el agua de lluvia debe <strong>infiltrarse naturalmente</strong> en el suelo k√°rstico para recargar el acu√≠fero del que todos dependemos. 
                            Los megaproyectos impermeabilizan el suelo, contaminan con lixiviados y sobreexplotan el agua subterr√°nea.<br><br>
                            <strong>Proyectos comunitarios como este son actos de resistencia territorial</strong> que demuestran que es posible 
                            desarrollarnos en armon√≠a con el ciclo natural del agua, no contra √©l.
                        </p>
                    </div>
                `;
                
                popupContent += `
                    <p style="color: #6b7280; font-size: 11px; margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        üë§ Propuesto por: <strong>${item.username}</strong><br>
                        üìÖ ${new Date(item.created_at).toLocaleDateString('es-MX')}<br>
                        üìç Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
                    </p>
                `;
                
                // Botones de acci√≥n
                let ownerButtons = '';
                if (isOwner && !isAdmin) {
                    ownerButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <button 
                                class="edit-hidrosocial-btn" 
                                data-project-id="${item.id}" 
                                type="button"
                                style="width: 100%; padding: 10px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; pointer-events: auto; touch-action: manipulation;"
                                onclick="event.stopPropagation(); event.preventDefault(); editProyectoHidrosocial('${item.id}');"
                            >
                                ‚úèÔ∏è Editar mi proyecto
                            </button>
                        </div>
                    `;
                }
                
                let adminButtons = '';
                if (isAdmin) {
                    adminButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">‚öôÔ∏è Controles de Administrador</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <button onclick="event.stopPropagation(); editProyectoHidrosocial('${item.id}');" style="padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; pointer-events: auto;">‚úèÔ∏è Editar</button>
                                <button onclick="event.stopPropagation(); moveProyectoHidrosocial('${item.id}', ${item.lat}, ${item.lng});" style="padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; pointer-events: auto;">üìç Mover</button>
                                <button onclick="event.stopPropagation(); deleteProyectoHidrosocial('${item.id}');" style="padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; pointer-events: auto;">üóëÔ∏è Borrar</button>
                            </div>
                        </div>
                    `;
                }
                
                popupContent += ownerButtons + adminButtons;
                popupContent += `</div></div>`;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 480,
                    minWidth: 320,
                    className: 'hidrosocial-popup'
                });
                
                // Drag para admin
                if (isAdmin) {
                    marker.on('dragend', async function(e) {
                        const newLatLng = e.target.getLatLng();
                        if (confirm('¬øMover este proyecto a la nueva ubicaci√≥n?')) {
                            try {
                                map.closePopup();
                                await updateProyectoHidrosocialLocation(item.id, newLatLng.lat, newLatLng.lng);
                                await loadProyectosHidrosociales();
                                alert('‚úÖ Proyecto movido exitosamente');
                            } catch (error) {
                                alert('‚ùå Error: ' + error.message);
                                e.target.setLatLng([item.lat, item.lng]);
                            }
                        } else {
                            e.target.setLatLng([item.lat, item.lng]);
                        }
                    });
                }
                
                marker.projectId = item.id;
                marker.projectData = item;
                marker.addTo(layerGroups.proyectosHidrosociales);
                rendered++;
            });
            
            console.log(`‚úì ${rendered} proyectos hidrosociales renderizados`);
        }

        // Controles de capas
        document.getElementById('layer-proyectos').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.proyectos);
            else map.removeLayer(layerGroups.proyectos);
        });

        document.getElementById('layer-descargas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.descargas);
            else map.removeLayer(layerGroups.descargas);
        });

        document.getElementById('layer-extracciones').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.extracciones);
            else map.removeLayer(layerGroups.extracciones);
        });

        document.getElementById('layer-cuerpos-agua').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(layerGroups.cuerposAgua);
            } else {
                map.removeLayer(layerGroups.cuerposAgua);
            }
            // Sincronizar sub-checkboxes
            const subCheckboxes = ['layer-piscinas', 'layer-cenotes-sup', 'layer-cenotes-sub', 
                                    'layer-aguadas-art', 'layer-aguadas-nat', 'layer-sascab', 'layer-rios'];
            subCheckboxes.forEach(id => {
                document.getElementById(id).checked = e.target.checked;
                document.getElementById(id).dispatchEvent(new Event('change'));
            });
        });

        document.getElementById('layer-piscinas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.piscinas);
            else map.removeLayer(layerGroups.piscinas);
        });

        document.getElementById('layer-cenotes-sup').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.cenotesSup);
            else map.removeLayer(layerGroups.cenotesSup);
        });

        document.getElementById('layer-cenotes-sub').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.cenotesSub);
            else map.removeLayer(layerGroups.cenotesSub);
        });

        document.getElementById('layer-aguadas-art').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.aguadasArt);
            else map.removeLayer(layerGroups.aguadasArt);
        });

        document.getElementById('layer-aguadas-nat').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.aguadasNat);
            else map.removeLayer(layerGroups.aguadasNat);
        });

        document.getElementById('layer-sascab').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.sascab);
            else map.removeLayer(layerGroups.sascab);
        });

        document.getElementById('layer-rios').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.rios);
            else map.removeLayer(layerGroups.rios);
        });

        document.getElementById('layer-karstificacion').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.karstificacion);
            else map.removeLayer(layerGroups.karstificacion);
        });

        document.getElementById('layer-fallas-inegi').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fallasINEGI);
            else map.removeLayer(layerGroups.fallasINEGI);
        });

        document.getElementById('layer-fallas-cenapred').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fallasCENAPRED);
            else map.removeLayer(layerGroups.fallasCENAPRED);
        });

        document.getElementById('layer-poel').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.poel);
            else map.removeLayer(layerGroups.poel);
        });

        document.getElementById('layer-socioeco').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.socioeco);
            else map.removeLayer(layerGroups.socioeco);
        });

        document.getElementById('layer-municipio').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.municipio);
            else map.removeLayer(layerGroups.municipio);
        });

        document.getElementById('layer-pozos-sin').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.pozosSinProteccion);
            else map.removeLayer(layerGroups.pozosSinProteccion);
        });

        document.getElementById('layer-pozos-con').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.pozosConProteccion);
            else map.removeLayer(layerGroups.pozosConProteccion);
        });

        document.getElementById('layer-colapso-karst').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.colapsoKarst);
            else map.removeLayer(layerGroups.colapsoKarst);
        });

        document.getElementById('layer-tierras-comunales').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.tierrasComunales);
            else map.removeLayer(layerGroups.tierrasComunales);
        });

        document.getElementById('layer-tierras-parceladas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.tierrasParceladas);
            else map.removeLayer(layerGroups.tierrasParceladas);
        });

        document.getElementById('layer-nucleos-agrarios').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.nucleosAgrarios);
            else map.removeLayer(layerGroups.nucleosAgrarios);
        });

        document.getElementById('layer-asentamientos-humanos').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.asentamientosHumanos);
            else map.removeLayer(layerGroups.asentamientosHumanos);
        });

        document.getElementById('layer-fraccionamientos-poel').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fraccionamientosPOEL);
            else map.removeLayer(layerGroups.fraccionamientosPOEL);
        });

        // Funci√≥n para minimizar/maximizar paneles
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const icon = document.getElementById(panelId === 'control-panel' ? 'control-toggle-icon' : 'legends-toggle-icon');
            
            if (panel.classList.contains('panel-minimized')) {
                panel.classList.remove('panel-minimized');
                icon.textContent = '‚àí';
            } else {
                panel.classList.add('panel-minimized');
                icon.textContent = '+';
            }
        }

        function toggleAllLayers() {
            const checkboxes = document.querySelectorAll('.layer-control input[type="checkbox"]');
            const firstChecked = checkboxes[0].checked;
            checkboxes.forEach(cb => {
                cb.checked = !firstChecked;
                cb.dispatchEvent(new Event('change'));
            });
        }

        // Iniciar al cargar
        window.addEventListener('load', async () => {
            // Funci√≥n para esperar a que las librer√≠as est√©n disponibles
            async function waitForLibraries() {
                let attempts = 0;
                const maxAttempts = 100; // 10 segundos m√°ximo
                
                console.log('[INFO] Esperando a que se carguen Leaflet, Proj4 y Supabase...');
                
                while (attempts < maxAttempts) {
                    const leafletLoaded = typeof L !== 'undefined';
                    const proj4Loaded = typeof proj4 !== 'undefined';
                    const supabaseLoaded = typeof supabase !== 'undefined';
                    
                    if (attempts % 10 === 0) { // Log cada segundo
                        console.log(`[CHECK] Intento ${attempts}: Leaflet=${leafletLoaded}, Proj4=${proj4Loaded}, Supabase=${supabaseLoaded}`);
                    }
                    
                    if (leafletLoaded && proj4Loaded && supabaseLoaded) {
                        console.log('[SUCCESS] ‚úì Todas las librer√≠as cargadas correctamente');
                        return true;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                // Si llegamos aqu√≠, hubo timeout
                const leafletLoaded = typeof L !== 'undefined';
                const proj4Loaded = typeof proj4 !== 'undefined';
                const supabaseLoaded = typeof supabase !== 'undefined';
                console.error(`[TIMEOUT] Leaflet: ${leafletLoaded}, Proj4: ${proj4Loaded}, Supabase: ${supabaseLoaded}`);
                throw new Error('Timeout esperando librer√≠as');
            }
            
            try {
                // Esperar a que Leaflet y Supabase est√©n disponibles
                await waitForLibraries();
                
                // Ahora s√≠ inicializar Supabase
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('[STATUS] Supabase inicializado correctamente');
                
                // Optimizaciones para m√≥vil
                function applyMobileOptimizations() {
                    if (window.innerWidth <= 768) {
                        console.log('[MOBILE] Aplicando optimizaciones para dispositivos m√≥viles');
                        
                        // Colapsar paneles autom√°ticamente en m√≥vil
                        const controlPanel = document.querySelector('.control-panel');
                        const legendsPanel = document.querySelector('.legends-panel');
                        
                        if (controlPanel && !controlPanel.classList.contains('panel-minimized')) {
                            console.log('[MOBILE] Minimizando control panel');
                            controlPanel.classList.add('panel-minimized');
                            const icon = document.getElementById('control-toggle-icon');
                            if (icon) icon.textContent = '+';
                        }
                        if (legendsPanel && !legendsPanel.classList.contains('panel-minimized')) {
                            console.log('[MOBILE] Minimizando legends panel');
                            legendsPanel.classList.add('panel-minimized');
                            const icon = document.getElementById('legends-toggle-icon');
                            if (icon) icon.textContent = '+';
                        }
                        
                        console.log('[MOBILE] Optimizaciones aplicadas');
                    }
                }
                
                // Aplicar optimizaciones al cargar
                applyMobileOptimizations();
                
                // Replicar al cambiar orientaci√≥n o tama√±o de ventana
                window.addEventListener('orientationchange', () => {
                    console.log('[MOBILE] Orientaci√≥n cambiada, reaplicando optimizaciones');
                    setTimeout(applyMobileOptimizations, 300);
                });
                
                window.addEventListener('resize', () => {
                    if (window.innerWidth <= 768) {
                        applyMobileOptimizations();
                    }
                });
                
                // Prevenir zoom accidental en doble tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
                
                // Inicializar funcionalidad de arrastre para paneles
                setupDraggable();
            } catch (error) {
                console.error('[ERROR] Error cargando librer√≠as:', error);
                
                // Mostrar mensaje al usuario
                const modal = document.getElementById('welcome-modal');
                if (modal) {
                    modal.innerHTML = `
                        <div class="welcome-content" style="text-align: center;">
                            <h2 style="color: #ef4444;">‚ö†Ô∏è Error de Carga</h2>
                            <p style="margin: 20px 0;">No se pudieron cargar las librer√≠as necesarias.</p>
                            <p style="margin: 20px 0;">Posibles causas:</p>
                            <ul style="text-align: left; margin: 20px auto; max-width: 400px;">
                                <li>Problemas de conexi√≥n a Internet</li>
                                <li>CDNs bloqueados por firewall/antivirus</li>
                                <li>Extensiones del navegador bloqueando scripts</li>
                            </ul>
                            <button onclick="location.reload()" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 16px;
                                margin-top: 20px;
                            ">
                                üîÑ Recargar P√°gina
                            </button>
                        </div>
                    `;
                    modal.style.display = 'flex';
                }
                return;
            }

            // Primero inicializar el mapa
            await initMap();
            
            // Sincronizar capas visibles con checkboxes al inicio
            const initialCheckboxes = [
                'layer-proyectos',
                'layer-descargas',
                'layer-extracciones',
                'layer-cuerpos-agua',
                'layer-piscinas',
                'layer-cenotes-sup',
                'layer-cenotes-sub',
                'layer-aguadas-art',
                'layer-aguadas-nat',
                'layer-sascab',
                'layer-rios',
                'layer-karstificacion',
                'layer-fallas-inegi',
                'layer-fallas-cenapred',
                'layer-poel',
                'layer-socioeco',
                'layer-municipio',
                'layer-pozos-sin',
                'layer-pozos-con'
            ];
            
            initialCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked) {
                    const layerMapping = {
                        'layer-proyectos': 'proyectos',
                        'layer-descargas': 'descargas',
                        'layer-extracciones': 'extracciones',
                        'layer-cuerpos-agua': 'cuerposAgua',
                        'layer-piscinas': 'piscinas',
                        'layer-cenotes-sup': 'cenotesSup',
                        'layer-cenotes-sub': 'cenotesSub',
                        'layer-aguadas-art': 'aguadasArt',
                        'layer-aguadas-nat': 'aguadasNat',
                        'layer-sascab': 'sascab',
                        'layer-rios': 'rios',
                        'layer-karstificacion': 'karstificacion',
                        'layer-fallas-inegi': 'fallasINEGI',
                        'layer-fallas-cenapred': 'fallasCENAPRED',
                        'layer-poel': 'poel',
                        'layer-socioeco': 'socioeco',
                        'layer-municipio': 'municipio',
                        'layer-pozos-sin': 'pozosSinProteccion',
                        'layer-pozos-con': 'pozosConProteccion'
                    };
                    
                    const layerName = layerMapping[checkboxId];
                    if (layerName && layerGroups[layerName]) {
                        map.addLayer(layerGroups[layerName]);
                    }
                }
            });
            
            // Luego cargar proyectos colaborativos (pueden no haber si no hay auth)
            try {
                await loadCollaborativeProjects();
            } catch (e) {
                console.log('No se pudieron cargar proyectos colaborativos:', e);
            }
            
            // Finalmente verificar estado de autenticaci√≥n
            await checkAuthState();
            
            // Configurar listener para cambios de autenticaci√≥n (incluye confirmaci√≥n de email)
            setupAuthListener();

            // ======== EVENT LISTENERS (despu√©s de inicializar todo) ========

            // Mostrar modales
            document.getElementById('show-login-btn').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('login-error').style.display = 'none';
            });

            document.getElementById('show-register-btn').addEventListener('click', () => {
                document.getElementById('register-modal').style.display = 'flex';
                document.getElementById('register-error').style.display = 'none';
                document.getElementById('register-success').style.display = 'none';
            });

            document.getElementById('add-project-btn').addEventListener('click', () => {
                // En m√≥vil, colapsar paneles para dar m√°s espacio
                if (window.innerWidth <= 768) {
                    const controlPanel = document.querySelector('.control-panel');
                    const legendsPanel = document.querySelector('.legends-panel');
                    if (controlPanel && !controlPanel.classList.contains('panel-minimized')) {
                        controlPanel.classList.add('panel-minimized');
                    }
                    if (legendsPanel && !legendsPanel.classList.contains('panel-minimized')) {
                        legendsPanel.classList.add('panel-minimized');
                    }
                }
                
                document.getElementById('add-project-modal').style.display = 'flex';
                document.getElementById('add-project-error').style.display = 'none';
                document.getElementById('add-project-success').style.display = 'none';
            });

            // Event listener para agregar proyecto hidrosocial
            document.getElementById('add-hidrosocial-btn').addEventListener('click', () => {
                alert('‚ú® MODAL DE PROYECTOS HIDROSOCIALES\n\nEsta funcionalidad est√° en desarrollo.\n\nPermitir√° proponer proyectos comunitarios como:\n\nüå± Jardines de lluvia\nüíß Sistemas de captaci√≥n pluvial\nüåø Humedales de tratamiento\nüå≥ Reforestaci√≥n de zonas de recarga\nüï≥Ô∏è Restauraci√≥n de cenotes\nüåä Biofiltros comunitarios');
                // TODO: Abrir modal de proyectos hidrosociales cuando est√© listo
                // document.getElementById('add-hidrosocial-modal').style.display = 'flex';
            });

            // Event delegation para botones en popups
            document.addEventListener('click', (e) => {
                // Bot√≥n de editar proyecto
                if (e.target.classList.contains('edit-project-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const projectId = e.target.getAttribute('data-project-id');
                    console.log('[EDIT] Click en bot√≥n editar, proyecto ID:', projectId);
                    if (projectId) {
                        editProject(projectId);
                    }
                }
                
                // Bot√≥n de mover proyecto
                if (e.target.classList.contains('move-project-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const projectId = e.target.getAttribute('data-project-id');
                    const lat = parseFloat(e.target.getAttribute('data-lat'));
                    const lng = parseFloat(e.target.getAttribute('data-lng'));
                    console.log('[MOVE] Click en bot√≥n mover, proyecto ID:', projectId);
                    if (projectId) {
                        moveProject(projectId, lat, lng);
                    }
                }
                
                // Bot√≥n de borrar proyecto
                if (e.target.classList.contains('delete-project-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const projectId = e.target.getAttribute('data-project-id');
                    console.log('[DELETE] Click en bot√≥n borrar, proyecto ID:', projectId);
                    if (projectId) {
                        deleteProject(projectId);
                    }
                }
            });

            // Cerrar modales
            document.getElementById('close-login-modal').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'none';
            });

            document.getElementById('close-register-modal').addEventListener('click', () => {
                document.getElementById('register-modal').style.display = 'none';
            });

            document.getElementById('close-add-project-modal').addEventListener('click', () => {
                document.getElementById('add-project-modal').style.display = 'none';
                document.getElementById('map-click-indicator').style.display = 'none';
                if (mapClickEnabled) {
                    mapClickEnabled = false;
                    map.getContainer().style.cursor = '';
                    document.getElementById('enable-map-click').textContent = 'üìç Activar Click en Mapa';
                    document.getElementById('enable-map-click').style.background = '#3b82f6';
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                }
            });

            document.getElementById('close-edit-project-modal').addEventListener('click', () => {
                document.getElementById('edit-project-modal').style.display = 'none';
            });

            // Formulario de login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');

                try {
                    await handleLogin(email, password);
                    document.getElementById('login-form').reset();
                } catch (error) {
                    errorDiv.textContent = error.message || 'Error al iniciar sesi√≥n';
                    errorDiv.style.display = 'block';
                }
            });

            // Formulario de registro
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('register-error');
                const successDiv = document.getElementById('register-success');

                try {
                    await handleRegister(username, email, password);
                    successDiv.textContent = '¬°Cuenta creada! Revisa tu email para confirmar tu cuenta.';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    document.getElementById('register-form').reset();
                    
                    setTimeout(() => {
                        document.getElementById('register-modal').style.display = 'none';
                        document.getElementById('login-modal').style.display = 'flex';
                    }, 3000);
                } catch (error) {
                    errorDiv.textContent = error.message || 'Error al registrarse';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            });

            // Cerrar sesi√≥n
            document.getElementById('logout-btn').addEventListener('click', async () => {
                if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                    await handleLogout();
                }
            });

            // Formulario de agregar proyecto
            document.getElementById('add-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const errorDiv = document.getElementById('add-project-error');
                const successDiv = document.getElementById('add-project-success');

                const lat = document.getElementById('project-lat').value;
                const lng = document.getElementById('project-lng').value;
                
                // Validar que las coordenadas existan
                if (!lat || !lng) {
                    errorDiv.textContent = '‚ö†Ô∏è Por favor captura las coordenadas haciendo click en el mapa o ingr√©salas manualmente';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    return;
                }

                const projectData = {
                    nombre: document.getElementById('project-nombre').value,
                    descripcion: document.getElementById('project-descripcion').value,
                    mia: document.getElementById('project-mia').value,
                    irregularidad: document.getElementById('project-irregularidad').value,
                    lat: parseFloat(lat),
                    lng: parseFloat(lng)
                };

                try {
                    await addProjectToMap(projectData);
                    successDiv.textContent = '‚úì Proyecto agregado exitosamente';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    document.getElementById('add-project-form').reset();
                    
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                    
                    setTimeout(() => {
                        document.getElementById('add-project-modal').style.display = 'none';
                        successDiv.style.display = 'none';
                    }, 2000);
                } catch (error) {
                    errorDiv.textContent = error.message || 'Error al agregar proyecto';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            });

            // Formulario de editar proyecto
            document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const errorDiv = document.getElementById('edit-project-error');
                const successDiv = document.getElementById('edit-project-success');

                const projectId = document.getElementById('edit-project-id').value;
                const lat = document.getElementById('edit-project-lat').value;
                const lng = document.getElementById('edit-project-lng').value;
                
                // Validar que las coordenadas existan
                if (!lat || !lng) {
                    errorDiv.textContent = '‚ö†Ô∏è Por favor ingresa las coordenadas';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    return;
                }

                const projectData = {
                    nombre: document.getElementById('edit-project-nombre').value,
                    descripcion: document.getElementById('edit-project-descripcion').value,
                    mia: document.getElementById('edit-project-mia').value,
                    irregularidad: document.getElementById('edit-project-irregularidad').value,
                    lat: parseFloat(lat),
                    lng: parseFloat(lng)
                };

                try {
                    await updateProject(projectId, projectData);
                    successDiv.textContent = '‚úÖ Proyecto actualizado exitosamente';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    
                    setTimeout(async () => {
                        document.getElementById('edit-project-modal').style.display = 'none';
                        successDiv.style.display = 'none';
                        await loadCollaborativeProjects();
                    }, 2000);
                } catch (error) {
                    errorDiv.textContent = error.message || 'Error al actualizar proyecto';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            });

            // Bot√≥n de exportar CSV
            document.getElementById('export-csv-btn').addEventListener('click', async () => {
                await exportProjectsToCSV();
            });

            // Activar click en mapa
            document.getElementById('enable-map-click').addEventListener('click', () => {
                mapClickEnabled = !mapClickEnabled;
                const btn = document.getElementById('enable-map-click');
                const modal = document.getElementById('add-project-modal');
                const indicator = document.getElementById('map-click-indicator');
                
                if (mapClickEnabled) {
                    btn.textContent = '‚úì Click Activado - Haz click en el mapa';
                    btn.style.background = '#10b981';
                    map.getContainer().style.cursor = 'crosshair';
                    
                    // Cerrar cualquier popup abierto
                    map.closePopup();
                    
                    // Desactivar clicks en todos los layers temporalmente
                    map.eachLayer((layer) => {
                        if (layer.getPopup) {
                            layer._originalClickEvent = layer.listens('click');
                            layer.off('click');
                        }
                    });
                    
                    // Ocultar el modal y mostrar el indicador
                    modal.style.display = 'none';
                    indicator.style.display = 'block';
                } else {
                    btn.textContent = 'üìç Activar Click en Mapa';
                    btn.style.background = '#3b82f6';
                    map.getContainer().style.cursor = '';
                    
                    // Reactivar clicks en los layers
                    map.eachLayer((layer) => {
                        if (layer._originalClickEvent && layer.getPopup) {
                            layer.on('click', function() {
                                this.openPopup();
                            });
                        }
                    });
                    
                    // Mostrar el modal y ocultar el indicador
                    modal.style.display = 'flex';
                    indicator.style.display = 'none';
                    
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                }
            });

            // Bot√≥n de cancelar en el indicador flotante
            document.getElementById('cancel-map-click').addEventListener('click', () => {
                mapClickEnabled = false;
                map.getContainer().style.cursor = '';
                
                // Reactivar clicks en los layers
                map.eachLayer((layer) => {
                    if (layer._originalClickEvent && layer.getPopup) {
                        layer.on('click', function() {
                            this.openPopup();
                        });
                    }
                });
                
                document.getElementById('map-click-indicator').style.display = 'none';
                document.getElementById('add-project-modal').style.display = 'flex';
                document.getElementById('enable-map-click').textContent = 'üìç Activar Click en Mapa';
                document.getElementById('enable-map-click').style.background = '#3b82f6';
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            });


            // Control de capa de proyectos colaborativos
            document.getElementById('layer-proyectos-colab').addEventListener('change', (e) => {
                if (e.target.checked) map.addLayer(layerGroups.proyectosColab);
                else map.removeLayer(layerGroups.proyectosColab);
            });

            document.getElementById('layer-proyectos-hidrosociales')?.addEventListener('change', (e) => {
                if (e.target.checked) map.addLayer(layerGroups.proyectosHidrosociales);
                else map.removeLayer(layerGroups.proyectosHidrosociales);
            });
        });
    </script>
<!-- ============================================================ -->
<!-- MODALES Y FUNCIONES COMPLETAS PARA PROYECTOS HIDROSOCIALES -->
<!-- Insertar ANTES del cierre de </body> -->
<!-- ============================================================ -->

<!-- MODAL PARA AGREGAR PROYECTO HIDROSOCIAL -->
<div id="add-hidrosocial-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 650px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 8px; margin: -30px -30px 20px -30px;">
            <div style="font-size: 48px; text-align: center; margin-bottom: 10px;">üå±üíß</div>
            <h2 style="margin: 0; color: white; font-size: 22px; text-align: center; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                Proponer Proyecto de Restauraci√≥n Hidrosocial
            </h2>
            <p style="color: rgba(255,255,255,0.95); font-size: 13px; margin: 8px 0 0 0; text-align: center;">
                Defiende el territorio mediante apropiaci√≥n ciudadana y restauraci√≥n del ciclo del agua
            </p>
        </div>
        
        <form id="add-hidrosocial-form">
            <!-- Informaci√≥n b√°sica -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                <h3 style="margin: 0 0 12px 0; color: #1e40af; font-size: 15px;">üìã Informaci√≥n del Proyecto</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Nombre del Proyecto *
                    </label>
                    <input type="text" id="hidrosocial-nombre" required 
                        placeholder="Ej: Jard√≠n de Lluvia Comunitario Leona Vicario"
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Tipo de Proyecto *
                    </label>
                    <select id="hidrosocial-tipo" required 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <option value="">Selecciona un tipo...</option>
                        <option value="infiltraci√≥n">üíß Sistema de Infiltraci√≥n</option>
                        <option value="reforestaci√≥n">üå≥ Reforestaci√≥n Nativa</option>
                        <option value="captaci√≥n_lluvia">üè† Captaci√≥n de Agua de Lluvia</option>
                        <option value="biofiltros">üåø Biofiltros Naturales</option>
                        <option value="humedales_artificiales">ü¶Ü Humedales Artificiales</option>
                        <option value="jardines_lluvia">üå∫ Jardines de Lluvia</option>
                        <option value="zanjas_infiltraci√≥n">üèûÔ∏è Zanjas de Infiltraci√≥n</option>
                        <option value="protecci√≥n_cenotes">üï≥Ô∏è Protecci√≥n de Cenotes</option>
                        <option value="restauraci√≥n_manglar">üå¥ Restauraci√≥n de Manglar</option>
                        <option value="desimpermeabilizaci√≥n">üî® Desimpermeabilizaci√≥n</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Descripci√≥n del Proyecto
                    </label>
                    <textarea id="hidrosocial-descripcion" rows="3" 
                        placeholder="Describe brevemente el proyecto..."
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <!-- Objetivos e impacto -->
            <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                <h3 style="margin: 0 0 12px 0; color: #065f46; font-size: 15px;">üéØ Objetivos e Impacto</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Objetivos Hidrosociales
                    </label>
                    <textarea id="hidrosocial-objetivos" rows="2" 
                        placeholder="Ej: Aumentar infiltraci√≥n, proteger acu√≠fero, captar agua de lluvia..."
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Beneficios Esperados
                    </label>
                    <textarea id="hidrosocial-beneficios" rows="2" 
                        placeholder="Beneficios para el ciclo del agua, comunidad, ecosistema..."
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <!-- Ubicaci√≥n -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                <h3 style="margin: 0 0 12px 0; color: #78350f; font-size: 15px;">üìç Ubicaci√≥n</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Latitud *
                        </label>
                        <input type="number" id="hidrosocial-lat" step="any" required
                            placeholder="20.849"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Longitud *
                        </label>
                        <input type="number" id="hidrosocial-lng" step="any" required
                            placeholder="-86.876"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
                
                <!-- INFO BOX -->
                <div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #f59e0b;">
                    <p style="margin: 0; font-size: 11px; color: #78350f; line-height: 1.4;">
                        <strong>üí° Dos formas de capturar ubicaci√≥n:</strong><br>
                        <strong>1) GPS:</strong> Usa tu ubicaci√≥n actual (ideal si est√°s en el sitio del proyecto)<br>
                        <strong>2) Mapa:</strong> Haz click en el mapa para elegir cualquier ubicaci√≥n
                    </p>
                </div>
                
                <!-- BOTONES DE CAPTURA -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <!-- BOT√ìN GPS -->
                    <button type="button" id="gps-location-btn" onclick="captureUserLocation()"
                        style="
                            width: 100%; 
                            padding: 12px; 
                            background: linear-gradient(135deg, #10b981, #059669); 
                            color: white; 
                            border: none; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 13px; 
                            font-weight: 600; 
                            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.3)';"
                    >
                        üì° Mi Ubicaci√≥n GPS
                    </button>
                    
                    <!-- BOT√ìN MAPA -->
                    <button type="button" id="enable-hidrosocial-map-click" 
                        style="
                            width: 100%; 
                            padding: 12px; 
                            background: linear-gradient(135deg, #f59e0b, #d97706); 
                            color: white; 
                            border: none; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 13px; 
                            font-weight: 600; 
                            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(245, 158, 11, 0.3)';"
                    >
                        üó∫Ô∏è Capturar del Mapa
                    </button>
                </div>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                <h3 style="margin: 0 0 12px 0; color: #075985; font-size: 15px;">üìä Datos Adicionales</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            √Årea (m¬≤)
                        </label>
                        <input type="number" id="hidrosocial-area" min="0"
                            placeholder="250"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Estado
                        </label>
                        <select id="hidrosocial-estado" 
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                            <option value="propuesto">üå± Propuesto</option>
                            <option value="en_planificaci√≥n">üìã En Planificaci√≥n</option>
                            <option value="en_curso">üî® En Curso</option>
                            <option value="completado">‚úÖ Completado</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Participantes Estimados
                        </label>
                        <input type="number" id="hidrosocial-participantes" min="0"
                            placeholder="15"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Presupuesto (MXN)
                        </label>
                        <input type="number" id="hidrosocial-presupuesto" min="0"
                            placeholder="25000"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
            </div>
            
            <!-- Contacto -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ec4899;">
                <h3 style="margin: 0 0 12px 0; color: #9f1239; font-size: 15px;">üë• Contacto y Colaboraci√≥n</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Organizaci√≥n
                    </label>
                    <input type="text" id="hidrosocial-organizacion" 
                        placeholder="Colectivo, vecinos, ejido..."
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Email de Contacto
                        </label>
                        <input type="email" id="hidrosocial-email" 
                            placeholder="ejemplo@email.com"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Tel√©fono
                        </label>
                        <input type="tel" id="hidrosocial-telefono" 
                            placeholder="998-123-4567"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
            </div>
            
            <!-- Mensajes -->
            <div id="add-hidrosocial-error" style="display: none; padding: 10px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; margin-bottom: 15px; color: #991b1b; font-size: 13px;"></div>
            <div id="add-hidrosocial-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 10px;">
                <button type="submit" 
                    style="flex: 1; padding: 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
                    üíæ Guardar Proyecto
                </button>
                <button type="button" id="close-add-hidrosocial-modal" 
                    style="flex: 1; padding: 14px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL PARA EDITAR PROYECTO HIDROSOCIAL -->
<div id="edit-hidrosocial-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 650px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 8px; margin: -30px -30px 20px -30px;">
            <div style="font-size: 48px; text-align: center; margin-bottom: 10px;">‚úèÔ∏èüíß</div>
            <h2 style="margin: 0; color: white; font-size: 22px; text-align: center; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                Editar Proyecto Hidrosocial
            </h2>
        </div>
        
        <form id="edit-hidrosocial-form">
            <input type="hidden" id="edit-hidrosocial-id">
            
            <!-- Igual estructura que add-hidrosocial-modal pero con prefijo "edit-" -->
            <!-- Informaci√≥n b√°sica -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                <h3 style="margin: 0 0 12px 0; color: #1e40af; font-size: 15px;">üìã Informaci√≥n del Proyecto</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Nombre del Proyecto *
                    </label>
                    <input type="text" id="edit-hidrosocial-nombre" required 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Tipo de Proyecto *
                    </label>
                    <select id="edit-hidrosocial-tipo" required 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <option value="infiltraci√≥n">üíß Sistema de Infiltraci√≥n</option>
                        <option value="reforestaci√≥n">üå≥ Reforestaci√≥n Nativa</option>
                        <option value="captaci√≥n_lluvia">üè† Captaci√≥n de Agua de Lluvia</option>
                        <option value="biofiltros">üåø Biofiltros Naturales</option>
                        <option value="humedales_artificiales">ü¶Ü Humedales Artificiales</option>
                        <option value="jardines_lluvia">üå∫ Jardines de Lluvia</option>
                        <option value="zanjas_infiltraci√≥n">üèûÔ∏è Zanjas de Infiltraci√≥n</option>
                        <option value="protecci√≥n_cenotes">üï≥Ô∏è Protecci√≥n de Cenotes</option>
                        <option value="restauraci√≥n_manglar">üå¥ Restauraci√≥n de Manglar</option>
                        <option value="desimpermeabilizaci√≥n">üî® Desimpermeabilizaci√≥n</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Descripci√≥n
                    </label>
                    <textarea id="edit-hidrosocial-descripcion" rows="3" 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <!-- Objetivos -->
            <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                <h3 style="margin: 0 0 12px 0; color: #065f46; font-size: 15px;">üéØ Objetivos e Impacto</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Objetivos
                    </label>
                    <textarea id="edit-hidrosocial-objetivos" rows="2" 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Beneficios Esperados
                    </label>
                    <textarea id="edit-hidrosocial-beneficios" rows="2" 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <!-- Ubicaci√≥n -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                <h3 style="margin: 0 0 12px 0; color: #78350f; font-size: 15px;">üìç Ubicaci√≥n</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Latitud *
                        </label>
                        <input type="number" id="edit-hidrosocial-lat" step="any" required
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Longitud *
                        </label>
                        <input type="number" id="edit-hidrosocial-lng" step="any" required
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
            </div>
            
            <!-- Datos adicionales -->
            <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                <h3 style="margin: 0 0 12px 0; color: #075985; font-size: 15px;">üìä Datos Adicionales</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            √Årea (m¬≤)
                        </label>
                        <input type="number" id="edit-hidrosocial-area" min="0"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Estado
                        </label>
                        <select id="edit-hidrosocial-estado" 
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                            <option value="propuesto">üå± Propuesto</option>
                            <option value="en_planificaci√≥n">üìã En Planificaci√≥n</option>
                            <option value="en_curso">üî® En Curso</option>
                            <option value="completado">‚úÖ Completado</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Participantes
                        </label>
                        <input type="number" id="edit-hidrosocial-participantes" min="0"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Presupuesto (MXN)
                        </label>
                        <input type="number" id="edit-hidrosocial-presupuesto" min="0"
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
            </div>
            
            <!-- Contacto -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ec4899;">
                <h3 style="margin: 0 0 12px 0; color: #9f1239; font-size: 15px;">üë• Contacto</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                        Organizaci√≥n
                    </label>
                    <input type="text" id="edit-hidrosocial-organizacion" 
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Email
                        </label>
                        <input type="email" id="edit-hidrosocial-email" 
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 12px;">
                            Tel√©fono
                        </label>
                        <input type="tel" id="edit-hidrosocial-telefono" 
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                </div>
            </div>
            
            <!-- Mensajes -->
            <div id="edit-hidrosocial-error" style="display: none; padding: 10px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; margin-bottom: 15px; color: #991b1b; font-size: 13px;"></div>
            <div id="edit-hidrosocial-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 10px;">
                <button type="submit" 
                    style="flex: 1; padding: 14px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
                    üíæ Actualizar Proyecto
                </button>
                <button type="button" id="close-edit-hidrosocial-modal" 
                    style="flex: 1; padding: 14px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- INDICADOR DE CAPTURA EN MAPA -->
<div id="map-click-indicator-hidrosocial" style="display: none; position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; z-index: 9999; box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4); text-align: center; max-width: 400px; border: 3px solid white;">
    <div style="font-size: 48px; margin-bottom: 15px;">üéØüíß</div>
    <h3 style="margin: 0 0 10px 0; font-size: 18px;">Modo Captura Activado</h3>
    <p style="margin: 0 0 15px 0; font-size: 14px;">Haz click en el mapa para seleccionar la ubicaci√≥n del proyecto hidrosocial</p>
    <button id="cancel-hidrosocial-map-click" 
        style="padding: 10px 25px; background: white; color: #10b981; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; pointer-events: auto;">
        ‚ùå Cancelar
    </button>
</div>

<script>
// ============================================================
// FUNCIONES JAVASCRIPT PARA PROYECTOS HIDROSOCIALES
// ============================================================

// Variable global para tracking de modo click
let mapClickEnabledHidrosocial = false;
let tempMarkerHidrosocial = null;
let gpsMarker = null; // Marcador temporal para ubicaci√≥n GPS del usuario

// Abrir modal de agregar
document.getElementById('add-hidrosocial-btn')?.addEventListener('click', () => {
    document.getElementById('add-hidrosocial-modal').style.display = 'flex';
});

// Cerrar modal de agregar
document.getElementById('close-add-hidrosocial-modal')?.addEventListener('click', () => {
    document.getElementById('add-hidrosocial-modal').style.display = 'none';
    document.getElementById('add-hidrosocial-form').reset();
    document.getElementById('add-hidrosocial-error').style.display = 'none';
    document.getElementById('add-hidrosocial-success').style.display = 'none';
    cleanupGPSMarker(); // Limpiar marcador GPS
    
    // Limpiar marcador temporal de click en mapa
    if (tempMarkerHidrosocial) {
        map.removeLayer(tempMarkerHidrosocial);
        tempMarkerHidrosocial = null;
    }
});

// Cerrar modal de editar
document.getElementById('close-edit-hidrosocial-modal')?.addEventListener('click', () => {
    document.getElementById('edit-hidrosocial-modal').style.display = 'none';
    document.getElementById('edit-hidrosocial-form').reset();
    document.getElementById('edit-hidrosocial-error').style.display = 'none';
    document.getElementById('edit-hidrosocial-success').style.display = 'none';
    cleanupGPSMarker(); // Limpiar marcador GPS
});

// Activar captura de coordenadas en mapa
document.getElementById('enable-hidrosocial-map-click')?.addEventListener('click', () => {
    mapClickEnabledHidrosocial = true;
    map.getContainer().style.cursor = 'crosshair';
    document.getElementById('map-click-indicator-hidrosocial').style.display = 'block';
    
    // Ocultar el modal temporalmente
    document.getElementById('add-hidrosocial-modal').style.display = 'none';
});

// Cancelar captura
document.getElementById('cancel-hidrosocial-map-click')?.addEventListener('click', () => {
    mapClickEnabledHidrosocial = false;
    map.getContainer().style.cursor = '';
    document.getElementById('map-click-indicator-hidrosocial').style.display = 'none';
    document.getElementById('add-hidrosocial-modal').style.display = 'flex';
    
    if (tempMarkerHidrosocial) {
        map.removeLayer(tempMarkerHidrosocial);
        tempMarkerHidrosocial = null;
    }
});

// Manejar click en mapa (agregar al event listener existente)
map.on('click', function(e) {
    if (mapClickEnabledHidrosocial) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Actualizar inputs
        document.getElementById('hidrosocial-lat').value = lat.toFixed(6);
        document.getElementById('hidrosocial-lng').value = lng.toFixed(6);
        
        // Mostrar marcador temporal
        if (tempMarkerHidrosocial) map.removeLayer(tempMarkerHidrosocial);
        tempMarkerHidrosocial = L.circleMarker([lat, lng], {
            radius: 15,
            fillColor: '#10b981',
            color: '#ffffff',
            weight: 4,
            opacity: 1,
            fillOpacity: 0.9
        }).addTo(map);
        
        // Desactivar modo captura
        mapClickEnabledHidrosocial = false;
        map.getContainer().style.cursor = '';
        document.getElementById('map-click-indicator-hidrosocial').style.display = 'none';
        document.getElementById('add-hidrosocial-modal').style.display = 'flex';
        
        alert(`‚úÖ Ubicaci√≥n capturada:\nLat: ${lat.toFixed(6)}\nLng: ${lng.toFixed(6)}`);
    }
});

// Enviar formulario de agregar
document.getElementById('add-hidrosocial-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('add-hidrosocial-error');
    const successDiv = document.getElementById('add-hidrosocial-success');
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    try {
        const projectData = {
            nombre_proyecto: document.getElementById('hidrosocial-nombre').value,
            tipo_proyecto: document.getElementById('hidrosocial-tipo').value,
            descripcion: document.getElementById('hidrosocial-descripcion').value || null,
            objetivos: document.getElementById('hidrosocial-objetivos').value || null,
            beneficios_esperados: document.getElementById('hidrosocial-beneficios').value || null,
            estado: document.getElementById('hidrosocial-estado').value,
            lat: parseFloat(document.getElementById('hidrosocial-lat').value),
            lng: parseFloat(document.getElementById('hidrosocial-lng').value),
            area_m2: parseFloat(document.getElementById('hidrosocial-area').value) || null,
            participantes_estimados: parseInt(document.getElementById('hidrosocial-participantes').value) || null,
            presupuesto_estimado: parseFloat(document.getElementById('hidrosocial-presupuesto').value) || null,
            organizacion: document.getElementById('hidrosocial-organizacion').value || null,
            contacto_email: document.getElementById('hidrosocial-email').value || null,
            contacto_telefono: document.getElementById('hidrosocial-telefono').value || null
        };
        
        await addProyectoHidrosocial(projectData);
        
        successDiv.textContent = '‚úÖ ¬°Proyecto hidrosocial guardado exitosamente!';
        successDiv.style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('add-hidrosocial-modal').style.display = 'none';
            document.getElementById('add-hidrosocial-form').reset();
            successDiv.style.display = 'none';
            
            if (tempMarkerHidrosocial) {
                map.removeLayer(tempMarkerHidrosocial);
                tempMarkerHidrosocial = null;
            }
        }, 2000);
        
    } catch (error) {
        console.error('Error guardando proyecto:', error);
        errorDiv.textContent = '‚ùå Error: ' + error.message;
        errorDiv.style.display = 'block';
    }
});

// Enviar formulario de editar
document.getElementById('edit-hidrosocial-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('edit-hidrosocial-error');
    const successDiv = document.getElementById('edit-hidrosocial-success');
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    try {
        const projectId = document.getElementById('edit-hidrosocial-id').value;
        const projectData = {
            nombre_proyecto: document.getElementById('edit-hidrosocial-nombre').value,
            tipo_proyecto: document.getElementById('edit-hidrosocial-tipo').value,
            descripcion: document.getElementById('edit-hidrosocial-descripcion').value || null,
            objetivos: document.getElementById('edit-hidrosocial-objetivos').value || null,
            beneficios_esperados: document.getElementById('edit-hidrosocial-beneficios').value || null,
            estado: document.getElementById('edit-hidrosocial-estado').value,
            lat: parseFloat(document.getElementById('edit-hidrosocial-lat').value),
            lng: parseFloat(document.getElementById('edit-hidrosocial-lng').value),
            area_m2: parseFloat(document.getElementById('edit-hidrosocial-area').value) || null,
            participantes_estimados: parseInt(document.getElementById('edit-hidrosocial-participantes').value) || null,
            presupuesto_estimado: parseFloat(document.getElementById('edit-hidrosocial-presupuesto').value) || null,
            organizacion: document.getElementById('edit-hidrosocial-organizacion').value || null,
            contacto_email: document.getElementById('edit-hidrosocial-email').value || null,
            contacto_telefono: document.getElementById('edit-hidrosocial-telefono').value || null
        };
        
        await updateProyectoHidrosocial(projectId, projectData);
        await loadProyectosHidrosociales();
        
        successDiv.textContent = '‚úÖ ¬°Proyecto actualizado exitosamente!';
        successDiv.style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('edit-hidrosocial-modal').style.display = 'none';
            successDiv.style.display = 'none';
        }, 2000);
        
    } catch (error) {
        console.error('Error actualizando proyecto:', error);
        errorDiv.textContent = '‚ùå Error: ' + error.message;
        errorDiv.style.display = 'block';
    }
});

// Funci√≥n EDIT mejorada
async function editProyectoHidrosocial(projectId) {
    try {
        map.closePopup();
        
        const project = await getProyectoHidrosocialById(projectId);
        if (!project) {
            alert('‚ùå Error: No se pudo cargar el proyecto');
            return;
        }
        
        // Llenar el formulario
        document.getElementById('edit-hidrosocial-id').value = project.id;
        document.getElementById('edit-hidrosocial-nombre').value = project.nombre_proyecto || '';
        document.getElementById('edit-hidrosocial-tipo').value = project.tipo_proyecto || '';
        document.getElementById('edit-hidrosocial-descripcion').value = project.descripcion || '';
        document.getElementById('edit-hidrosocial-objetivos').value = project.objetivos || '';
        document.getElementById('edit-hidrosocial-beneficios').value = project.beneficios_esperados || '';
        document.getElementById('edit-hidrosocial-lat').value = project.lat || '';
        document.getElementById('edit-hidrosocial-lng').value = project.lng || '';
        document.getElementById('edit-hidrosocial-area').value = project.area_m2 || '';
        document.getElementById('edit-hidrosocial-estado').value = project.estado || 'propuesto';
        document.getElementById('edit-hidrosocial-participantes').value = project.participantes_estimados || '';
        document.getElementById('edit-hidrosocial-presupuesto').value = project.presupuesto_estimado || '';
        document.getElementById('edit-hidrosocial-organizacion').value = project.organizacion || '';
        document.getElementById('edit-hidrosocial-email').value = project.contacto_email || '';
        document.getElementById('edit-hidrosocial-telefono').value = project.contacto_telefono || '';
        
        // Mostrar modal
        document.getElementById('edit-hidrosocial-modal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error en editProyectoHidrosocial:', error);
        alert('‚ùå Error al cargar proyecto: ' + error.message);
    }
}

// Funci√≥n MOVE mejorada
function moveProyectoHidrosocial(projectId, currentLat, currentLng) {
    map.closePopup();
    
    alert(`üìç Modo de movimiento activado.\n\nHaz click en el mapa para mover el proyecto a una nueva ubicaci√≥n.`);
    
    // Destacar el marcador actual
    const currentMarker = Object.values(layerGroups.proyectosHidrosociales._layers).find(
        layer => layer.projectId === projectId
    );
    
    if (currentMarker) {
        currentMarker.setStyle({
            fillColor: '#f59e0b',
            radius: 15,
            weight: 4
        });
    }
    
    // Activar modo click para mover
    const moveClickHandler = async function(e) {
        const newLat = e.latlng.lat;
        const newLng = e.latlng.lng;
        
        if (confirm(`¬øMover proyecto a:\nLat: ${newLat.toFixed(6)}\nLng: ${newLng.toFixed(6)}?`)) {
            try {
                await updateProyectoHidrosocialLocation(projectId, newLat, newLng);
                await loadProyectosHidrosociales();
                alert('‚úÖ Proyecto movido exitosamente');
            } catch (error) {
                alert('‚ùå Error al mover proyecto: ' + error.message);
            }
        }
        
        // Desactivar handler
        map.off('click', moveClickHandler);
        map.getContainer().style.cursor = '';
        
        // Restaurar estilo del marcador
        if (currentMarker) {
            currentMarker.setStyle({
                fillColor: '#10b981',
                radius: 12,
                weight: 3
            });
        }
    };
    
    map.on('click', moveClickHandler);
    map.getContainer().style.cursor = 'crosshair';
}

// ============================================================
// FUNCI√ìN PARA CAPTURAR UBICACI√ìN GPS DEL USUARIO
// ============================================================

/**
 * Captura la ubicaci√≥n GPS del usuario usando la API de Geolocalizaci√≥n
 * √ötil para m√≥viles cuando el usuario est√° en el sitio del proyecto
 */
async function captureUserLocation() {
    // Verificar que el navegador soporte geolocalizaci√≥n
    if (!navigator.geolocation) {
        alert('‚ùå Tu navegador no soporta geolocalizaci√≥n.\n\nPor favor usa el bot√≥n "üó∫Ô∏è Capturar del Mapa" en su lugar.');
        return;
    }
    
    // Mostrar indicador de carga
    const button = document.getElementById('gps-location-btn');
    const originalText = button.innerHTML;
    button.innerHTML = 'üì° Obteniendo ubicaci√≥n GPS...';
    button.disabled = true;
    button.style.opacity = '0.6';
    
    // Opciones para la geolocalizaci√≥n
    const options = {
        enableHighAccuracy: true,  // Usar GPS de alta precisi√≥n
        timeout: 10000,            // Timeout de 10 segundos
        maximumAge: 0              // No usar cach√©, obtener ubicaci√≥n fresca
    };
    
    try {
        // Obtener posici√≥n GPS
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, options);
        });
        
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy; // Precisi√≥n en metros
        
        // Actualizar campos del formulario
        document.getElementById('hidrosocial-lat').value = lat.toFixed(6);
        document.getElementById('hidrosocial-lng').value = lng.toFixed(6);
        
        // Remover marcador GPS anterior si existe
        if (gpsMarker) {
            map.removeLayer(gpsMarker);
            if (gpsMarker.accuracyCircle) {
                map.removeLayer(gpsMarker.accuracyCircle);
            }
        }
        
        // Crear marcador GPS en el mapa
        gpsMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'gps-marker',
                html: `
                    <div style="position: relative;">
                        <div style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            border: 4px solid white;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            animation: pulse 2s infinite;
                        ">
                            üìç
                        </div>
                        <div style="
                            position: absolute;
                            top: -30px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: #10b981;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 4px;
                            white-space: nowrap;
                            font-size: 11px;
                            font-weight: 600;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            Mi ubicaci√≥n GPS
                        </div>
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            })
        }).addTo(map);
        
        // Agregar c√≠rculo de precisi√≥n
        const accuracyCircle = L.circle([lat, lng], {
            radius: accuracy,
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(map);
        
        // Asociar c√≠rculo al marcador para eliminarlo despu√©s
        gpsMarker.accuracyCircle = accuracyCircle;
        
        // Centrar el mapa en la ubicaci√≥n GPS
        map.setView([lat, lng], 17); // Zoom 17 para ver detalles
        
        // Restaurar bot√≥n
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
        
        // Mensaje de √©xito
        const accuracyText = accuracy < 10 ? 
            'excelente precisi√≥n' : 
            accuracy < 50 ? 
            'buena precisi√≥n' : 
            'precisi√≥n moderada';
        
        alert(
            `‚úÖ Ubicaci√≥n GPS capturada exitosamente!\n\n` +
            `üìç Latitud: ${lat.toFixed(6)}\n` +
            `üìç Longitud: ${lng.toFixed(6)}\n` +
            `üéØ Precisi√≥n: ¬±${Math.round(accuracy)} metros (${accuracyText})\n\n` +
            `Los campos del formulario han sido actualizados.`
        );
        
    } catch (error) {
        // Manejar errores
        let errorMessage = '‚ùå No se pudo obtener tu ubicaci√≥n GPS.\n\n';
        
        if (error.code === 1) {
            // PERMISSION_DENIED
            errorMessage += 
                'üîí Permisos de ubicaci√≥n denegados.\n\n' +
                'Para usar esta funci√≥n:\n' +
                '1. Ve a la configuraci√≥n de tu navegador\n' +
                '2. Permite el acceso a ubicaci√≥n para este sitio\n' +
                '3. Intenta de nuevo\n\n' +
                'O usa el bot√≥n "üó∫Ô∏è Capturar del Mapa" en su lugar.';
        } else if (error.code === 2) {
            // POSITION_UNAVAILABLE
            errorMessage += 
                'üì° Ubicaci√≥n no disponible.\n\n' +
                'Posibles causas:\n' +
                '- GPS desactivado en tu dispositivo\n' +
                '- Mala se√±al GPS (intenta al aire libre)\n' +
                '- Problemas de conectividad\n\n' +
                'Usa el bot√≥n "üó∫Ô∏è Capturar del Mapa" en su lugar.';
        } else if (error.code === 3) {
            // TIMEOUT
            errorMessage += 
                '‚è±Ô∏è Tiempo de espera agotado.\n\n' +
                'El GPS est√° tardando demasiado.\n' +
                'Intenta:\n' +
                '- Moverte al aire libre\n' +
                '- Esperar un momento y reintentar\n' +
                '- Usar el bot√≥n "üó∫Ô∏è Capturar del Mapa"';
        } else {
            errorMessage += 
                `Error: ${error.message}\n\n` +
                'Usa el bot√≥n "üó∫Ô∏è Capturar del Mapa" en su lugar.';
        }
        
        alert(errorMessage);
        
        // Restaurar bot√≥n
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
        
        console.error('Error de geolocalizaci√≥n:', error);
    }
}

// Limpiar marcadores GPS cuando se cierra el modal
function cleanupGPSMarker() {
    if (gpsMarker) {
        map.removeLayer(gpsMarker);
        if (gpsMarker.accuracyCircle) {
            map.removeLayer(gpsMarker.accuracyCircle);
        }
        gpsMarker = null;
    }
}
</script>
</body>
</html>