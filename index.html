<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <title>Geoportal de Toma las Aguas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: white;
            padding: 12px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .header-title h1:hover {
            color: #667eea;
        }

        .toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .toggle-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .panel-minimized {
            width: 50px !important;
            height: 50px !important;
            overflow: hidden !important;
            padding: 10px !important;
        }

        .panel-minimized > *:not(.toggle-btn) {
            display: none !important;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .control-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c5282;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 8px;
        }

        .control-panel h3 {
            font-size: 13px;
            margin: 15px 0 8px 0;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-control {
            margin: 6px 0;
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .layer-control:hover {
            background-color: #f7fafc;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .layer-control label {
            cursor: pointer;
            flex: 1;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .layer-count {
            margin-left: auto;
            font-size: 10px;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .layer-count.loaded {
            background: #c6f6d5;
            color: #22543d;
        }

        .color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .toggle-all {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 10px 0;
            width: 100%;
        }

        .toggle-all:hover {
            background: #3182ce;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 250px;
        }

        .custom-popup {
            padding: 15px;
            font-family: 'Segoe UI', sans-serif;
            max-width: 100%;
            box-sizing: border-box;
        }

        .custom-popup h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .custom-popup-divider {
            border-top: 2px solid;
            padding-top: 10px;
            margin-top: 10px;
        }

        .custom-popup p {
            margin: 8px 0;
            color: #374151;
            font-size: 13px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.5;
        }

        .custom-popup strong {
            color: #1f2937;
        }

        .custom-popup a {
            word-break: break-all;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: 100%;
        }

        .leaflet-popup-content-wrapper {
            overflow: hidden;
            box-sizing: border-box;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            overflow: hidden;
            width: 100% !important;
            box-sizing: border-box;
        }

        .collaborative-project-popup .leaflet-popup-content-wrapper {
            min-width: 300px;
            max-width: 400px;
            overflow: hidden;
        }

        .collaborative-project-popup .leaflet-popup-content {
            overflow: hidden;
            word-wrap: break-word;
        }

        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-modal.closing {
            animation: slideToHeader 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes slideToHeader {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(0.1) translateY(-90vh);
            }
        }

        .welcome-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            color: white;
            position: relative;
            transform: scale(1);
            transition: transform 0.5s ease;
        }

        .welcome-modal.closing .welcome-content {
            transform: scale(0.8);
        }

        .welcome-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.5);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 20px;
        }

        .welcome-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-style: italic;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 15px;
            display: block;
        }

        .welcome-section {
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .welcome-section h3 {
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .welcome-section p {
            font-size: 15px;
            margin-bottom: 10px;
            text-align: justify;
        }

        .highlight-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #fbbf24;
        }

        .highlight-box strong {
            color: #fbbf24;
        }

        .alert-box {
            background: rgba(239, 68, 68, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .features-list li:before {
            content: "üíß";
            position: absolute;
            left: 0;
        }

        .close-welcome-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .close-welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: #fbbf24;
            color: white;
        }

        .welcome-content::-webkit-scrollbar {
            width: 10px;
        }

        .welcome-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .header {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .panel-minimized {
            cursor: move !important;
            user-select: none;
        }

        .panel-minimized.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        }

        .control-panel, .legends-panel {
            transition: box-shadow 0.3s;
        }

        @media (max-width: 768px) {
            .control-panel, .legends-panel {
                max-width: 90vw !important;
                max-height: 70vh !important;
                width: auto !important;
                font-size: 13px;
                overflow-y: auto;
            }

            .control-panel {
                padding: 12px;
                top: 10px;
                left: 10px;
                max-width: 85vw !important;
            }

            .legends-panel {
                right: 10px;
                bottom: 10px !important;
                top: auto !important;
                padding: 12px;
                max-width: 85vw !important;
                max-height: 60vh !important;
            }

            .toggle-btn {
                width: 44px !important;
                height: 44px !important;
                font-size: 20px !important;
                top: 5px !important;
                right: 5px !important;
                background: #ef4444 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .toggle-btn:active {
                transform: scale(0.95);
            }

            .panel-minimized {
                width: 70px !important;
                height: 70px !important;
                padding: 10px !important;
            }

            .layer-control {
                padding: 10px 12px;
                min-height: 44px;
            }

            .layer-control input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            .control-panel h3 {
                font-size: 15px;
                margin: 15px 0 10px 0;
            }

            button {
                min-height: 44px;
                font-size: 14px !important;
                padding: 10px 15px !important;
            }

            #add-project-modal > div,
            #edit-project-modal > div {
                width: 95% !important;
                max-width: 95% !important;
                padding: 20px !important;
                margin: 10px;
                max-height: 90vh !important;
            }

            input, textarea, select {
                font-size: 16px !important;
                padding: 12px !important;
                min-height: 44px;
            }

            #add-project-modal input[type="number"],
            #edit-project-modal input[type="number"] {
                font-size: 14px !important;
            }

            .leaflet-popup-content-wrapper {
                max-width: calc(100vw - 60px) !important;
            }

            .collaborative-project-popup .leaflet-popup-content-wrapper {
                min-width: auto !important;
                max-width: calc(100vw - 60px) !important;
            }

            .custom-popup {
                font-size: 12px;
                padding: 12px;
            }

            .custom-popup h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .custom-popup p {
                font-size: 12px;
                margin: 6px 0;
            }

            .custom-popup button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            #map-click-indicator {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: calc(100vw - 20px);
                padding: 15px;
            }

            #map-click-indicator h3 {
                font-size: 14px;
            }

            #map-click-indicator p {
                font-size: 11px;
            }

            #user-section {
                font-size: 11px;
            }

            #user-section button {
                font-size: 11px !important;
                padding: 8px !important;
                min-height: 40px;
            }

            .control-panel h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .layer-count {
                min-width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .panel-minimized {
                width: 60px !important;
                height: 60px !important;
            }

            .welcome-modal {
                padding: 20px;
                max-width: 90%;
            }

            .welcome-modal h1 {
                font-size: 22px;
            }

            .welcome-modal p {
                font-size: 14px;
            }

            #login-modal > div,
            #register-modal > div {
                width: 95% !important;
                padding: 20px !important;
                max-height: 90vh;
            }

            form > div {
                margin-bottom: 12px !important;
            }

            label {
                font-size: 13px !important;
            }
        }

        @media (max-width: 480px) {
            .control-panel, .legends-panel {
                font-size: 12px;
                padding: 12px;
            }

            .control-panel h2 {
                font-size: 14px;
            }

            .control-panel h3 {
                font-size: 13px;
            }

            button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }

            .layer-control {
                padding: 8px 10px;
            }

            .custom-popup {
                font-size: 11px;
                padding: 10px;
            }

            .custom-popup h3 {
                font-size: 13px;
            }

            .custom-popup p {
                font-size: 11px;
            }

            .custom-popup button {
                font-size: 10px !important;
                padding: 5px 8px !important;
                min-height: 32px !important;
            }

            .custom-popup button[onclick*="editProject"],
            .custom-popup button[onclick*="moveProject"],
            .custom-popup button[onclick*="deleteProject"] {
                width: 100%;
                margin-bottom: 4px;
            }

            .welcome-modal h1 {
                font-size: 18px;
            }

            #map-click-indicator {
                padding: 12px;
            }

            #map-click-indicator div[style*="font-size: 32px"] {
                font-size: 24px !important;
            }
        }

        @media (max-width: 896px) and (max-height: 450px) and (orientation: landscape) {
            .control-panel, .legends-panel {
                max-width: 45vw !important;
                max-height: 85vh !important;
                font-size: 11px !important;
                padding: 10px !important;
            }

            .control-panel {
                max-width: 40vw !important;
            }

            .legends-panel {
                max-width: 40vw !important;
                bottom: 5px !important;
                right: 5px !important;
            }

            .control-panel h2,
            .control-panel h3,
            .legends-panel h3 {
                font-size: 12px !important;
                margin: 5px 0 !important;
            }

            .layer-control {
                padding: 6px 8px !important;
                min-height: 36px !important;
                font-size: 11px !important;
            }

            button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            .toggle-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }

            .panel-minimized {
                width: 55px !important;
                height: 55px !important;
            }

            #add-project-modal > div,
            #edit-project-modal > div {
                max-height: 85vh !important;
                padding: 15px !important;
            }

            .legends-panel > div {
                margin-bottom: 8px !important;
            }

            .legends-panel strong {
                font-size: 10px !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                max-width: 350px;
            }

            .legends-panel {
                max-width: 350px;
            }
        }
    </style>
</head>
<body>
    <div id="welcome-modal" class="welcome-modal">
        <div class="welcome-content">
                     <img src="data:image/webp;base64,UklGRtInAABXRUJQVlA4WAoAAAAgAAAA4AAA4AAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDgg5CUAADBzAJ0BKuEA4QA+USSORSOiISUpuao4oAoJY27esA40ecyTycuPe5j5nGL5E8uXpHzhf8L1ifrL2GOgF5x/Nb/437Ie+/+t+pB/Sf6561/rAftv7F37Zem5+43w8f3D/hemBnQ3kQ+r9aPjU9v/tX7qeuViz6xP970G/mn31/Z+u/+U72/iT/neoL+Zf0P/e+nb9j2bdt/QR97/u//S9Hr6j/n+hP2L9gP+if2z/sesP/F8FP71/tvYC/qH90/9X9893X+q/+H+o8930t/8v9H8CX9C/u3/g/yHtg//D3L/t1/+Pdz/Yr/0m1u10zMK4PgzNrpjxorSxnue8TkVN7tjz0j4MEaOz6ul3/gzZXIYEi+iwtCQG+oUEAUocK67qkvpWROlTJh3Ixr9R1a6ZEtNGuj8KwOtXo99eMPEqt4z9/YvAk3yj3buuzmZ2V0kF/drdnx29Z8x62+zosslVofTnc/WDnXxnro9FA+w5QsX9lhWytaiqxNfpSrMlxTbWg5FXikM4DDVMiJL0lXC4vv7V24P732HQRCiCCiutwlwV2GKx057iLRnrH6TEv9KCkSaNL2Kt+Z5P3YxZHYZdPxxbKdaiP0giHhO9/QXQi/j/l6AD/cq+jnkC/NyNqXuQxtqRcgOyKZg5v1509w10AtN4M1tiWhCUNBkNiQBMqPwgeDMoirE8yO5U71qWSj1Y3IiYtQ6HpRpMhkMWVXyr9ngXsxCBO6BCabc9lQbC8QdAqVpJ8MzZrxJ1wqs8oQG/wlN5HJJRrLljlSnZMZbj/lvRq3/7TlXdzCU4tI80rp+rQ4akQipi6sSOelpvW4I0E+5XS++hlo7GBodGhywAxH0qtRBtQ7aTe0vat5NerABNvCL1+cmHFrtytlKCkrDDUePe4aQG37Jt0JJakLYJkF/Wse1BX/UCbDwpO/CxtNKgL3tNmpPS1vgs6QmabW/83MbgWZIAwXtK/gJyy9orlYEm5u/ywDU8ZmixhkIa8DQuKC9k2LFEbFDOE+YSwguEWLZaXkgJI2kTFx8b2Fy7UMapQDYsO+iN5P3ic2eQmmkkcvt6HPwgztjKC0kAUrQZ495ys39gSYDCcZftuQusVdFcCBc94h4SoMt/ABKKIAOHnyr7JvUvoDkH6Ba0gyBcBVkYf4KqUFHsQCNPF2L0wHVzA1jJZqsN2Fw6DbdI6SYP7LAIOt7AY0A5C8ZURwDunVgoZS61JgcuEH3fZT+LJjtwAD++b5ljbf/8u5/y3/3SbmgXhxX0AAAjXEUDifiHE8DEmr+K78MUaxcCTzrXtYsl6t3xZ5Cr05Kpz6fkCEZNBNqXOvU68ap46eNAzaaUiM+GLf8m2udIyDp14F7R5qu27JEjhOMSsDIwYb1Fb6s8QWGYi0j4QO54tH6dSM4RDFRLdr9O9/+F0r4PEduHA2dCDLcXJK/GKLVqvuS2xf8+Modmd+txLDhrANVFosAAMFg/ROZcfqdX4iRf21xNrY06yks3TR+HBamZcGzdB/xBfFzvwAyeMUX6izvcoAJXiwf0yzHOTc7XeC+PxOHg8jvrqmm9TjL7ZaDtqf7Yn6H0ZD8F/pdehr/itDaptvy/dgd9thi2slLwZkJLJVnC6eUkCt4CZtkJ1FAevGeTrTr4aNWavEqOkdNTn/CQLcou83Ljcl9qCi4j2gVN/1f7fFurgFO8LFrXslTP++3T/95T8i67treGuH8E/xRGGzCHOzIdqJfaq3/kvATc5yThYzBwLisf9sFnJf7J9etyNWei2n3oewBnCmzDWEkfX9qKT1VWmIpSss1kXpUB2qjj4QXkiHJ+N72rSVaBpNGLzPQnWJRmV9zOHFhXo1jKWKAtT2kgPU4j/JGlS+F3asG2vhN/vVUeTLGmNDnG1yFurUHgcpDEHz2mRVCtpxpvog2vFWYJ9mo/VYVn2uT7YoYGyzLWDSoU5TDQsyCcSQHMOb/BzV3mxIe4wRG7PMIBieKbUM2i1kVeShwngkLqtvvxWrjhLq9x/xAUgSAbpNPEFkKKNYYXl3qsM+dJaIsHLxGSsg08fNU8IrdvrVWkkN14VO3+UMZRRXg3aYyYufpnxdvm9b1EHyoE6fUiMwoBv2fMgbcIpLLFVzWtAW8e4ukWNGg4yk9It+usX47EhXZFbzsG2GGkcVFWQH0ToLeNFklam4aS+Ym7p2LjNtBH0gIP+0896Gd2kdDzlAMVhkx17OdgKAEZzrrXj3WpR1MnmnsV62LgwBKTzSMecmnpdqlKM0L2PFLHYx9isKRHZwR1X6ApETyRmvxLvcndIpK/MarlhBXCTpfz/9Dgmfpt17JFLaX3yRPbyl3HHTfKQ7dtDc9v+nm85VINovgfLHHjGOkTkjyNRo5EqiuYSGgQjgXQowMAAWH9uzSK4ySxnCSxiDrflgvfCT3l47ujoYBYy0OgwJCFkZr9l4tKurkyGGXPm7rAYrqtYd9KbRk5iEpKCa48HiFNGgNpPq7mFeSBebzbiZLyK/IzPYWs0lQ4e9MR7xC2LFuZh+WB9LpbbYn4ziiU0CZUc0IdHrRa7w4tveRrwk+ebfPxctGySGhDNZ8d7KuxyxljfycKwhAPMEk43DkSj06oKYLmiWCcQrupUp2vjc+rWSaBE+mW922eJFQGsQuI6SY72I2ylAd472hUrLMrM8EOtTZDmsDq2fwxT4oYlc3PKV+h2l52clco2idSAQO0hTPeXjKAwdMXk837XF2cnLxK2Jk0tRSNDOFaYUDPtKodoe9aINchpXODtOb/bsWSdIRFDk9M7qBe9gdzlUTykiv7hCz9CGsz2LDRC2+cceP9PrvHRcO53t5zCmr0yV0LDCTdyz3xRdxKVf0fXKXOcjW2WtDtjVtYfunKO/vDuu1CN6OooUnmihB3hC1D7ahTMyydCigNT2nL1sxBAAGE56XXcFFJ3tnAtWN+Wag/ZDj9fqHfy7QsT6IfF6iN091Bad32nqrHq1A88z7xnanttJ9zhkuAXqaRFNLDu1o//PQDXfIrcerPRjHaz/WUkVp106zsH2I90zdzGCiimTweS1J7V3K5feBRoq+QODEfOEiOZlXTGpwjt4QpEtNSuuxuWlNP+ggx+Mq0tfEydOF6rxbmRcafXJcLkemDGCF8AluHhTSJLqdp+sMQZea6+r+RIDmGeRq6j6lpmQFaMz55OG+HU2uZJzDztXUrQ77dt0TXRuj3f4tlcAlcs8vN1i3UPiGVM02oXbuKTxiUay5AG17vI6Wv4b6/UF5mm0cQvxhIMzAgYcL0aPOgnl4xbHO2LMMCy6/cws4fXmdWfnH5bFA/eD0Y9ntEdEodk2yk871iwr30WYNgqDnyIiSUsnp8J8LXjkoSDA1GErqCSU9AHBxiT7TYXy6O/gl+QI398lcv9ccEuh/fqGPfQcqizbnz6kOjg19cYIvCoMA0tZwuzXsHXx72Cvk9Hc67LucMdxX6oGWOgPUm9cFavKU8eEAfn3MlzGF22XtQ+lp6uU7YS1qztM3kr4YBmRs44W91r4Hz7fIDWCxgeXKxKVg7VgVnQVOVjo9+fL89/NPUZMujJuKaxX6EIGpSHbO3fy6/PKoYhJl3btQRCdZXMVLEvst6hFh2YVVxga+KhFPMTiQWoi0WGGjTsIRgfNY7HJbnjMxEz7QpdnjHLOYH7EkzeXVPfQQBtb1RmqybDkOgvV1X0Jxd4JiBVnzOw7eS8KCCgj/YMageJvNA3URpNjp+DNwlgGCGa7EjKtw5ZOaSTfkXQ/WyZrIJ9gqMQ46//Iu3Qfb26wjB9kQigYA4Eb+mFQBX4Ux3IDgp1w9S1Ol2Oc7yUaM085UTuwPNzkVgdy4mNQ7GwoqBrOgjmk7TQ8h0ZMDnTBoPlygy1QQWac/VbbiEGk69w1xT0HSVUq4CHGWuaT11wkvjTZ5InnamESLMljP5wd6WuGH84z7mBiPbj9ElxjmX2d7V0hJtFlsTvnA/YI3MOzFbi6Jc+iYLV+h9D+SJcYXYGNCVUKMqxY70JqvPMzbN7pY9ifpW37HtW4l0odurZgmQA6QQ6I0UY5jg7XDm6C87FeNKTSwYgj/76H5LPlgz/y6Y/w1Dt+SrpI76bWhOWpZzYKxl6Cpz+QcS31yuraJlfrfCbWWjc1fEu4/kn9dN1/i166+vAciwU8U63yCKThLdJuaxOZ0EeGQ5YFM9H4kWCEKPWpkfEoKLNMaO5t2o/s0nlKmZYvf9ld3qLfsw2rINgZPc8nWNwgMs1URuCRcVhppNSaGCUciu7CCtX6iQ0uTfrPVL3kfZbqtj9XsYSs3S94TurZvilP1bpcSHzP8MuXarDGnC0niNuW2pXK+3sytKbGMmYRPF9t8ItP6t8UPrO9fLxn6kybAZfzoA6ohH1LopAZSDUhvaibovw+gaE8wCvrKSTCcJ1IwS2F2wSNrAI2KuohNiH9HF0poE/q8wMzWk6V4ANjUdMsJmPrIleJym0KxS/83T7w9GYmnPAnkiKANnTOiahjLQs7wVxIRuDPr7S+e+FHCRjsOX20fqMkpoxJrBw+l9JaiEgqi/xHXffVVZ+qI/pqlJCRrgsLb+OT8LHkMeSUY+jjckA2YrXE+XAQmeCFalZiJe8ZVxiTNMEnS+DTuw0LWYrgWKVJcPOIIt/Rcj1seJ5Y2pM50+3i5xSfxSXRyTXztEpKD7W28af1PmHvMN25I96+B8O5O7LGFSqNsdovJ6+w2aIdz5IgsAZe9klBEhz54aMwzmv9Ube2/R1pfyY3m73+51aLDcdAZ4+yVdrM6Y3B4DoVxN/h3y58ggYoo4bZRu+Rb617NyUPSNQUbSEtMwevjZikWYVv7c74xLpd6tOP3ygDlNX4LBB2Wu/5yS0FyqK+vNaHSfRuvbUgVJ7djTShpALd2BJ6G6mM9ZwAj0SiDXpt2xV3PjGjtAirLjhloE6YhskENM3jNtjKrEWFsBgB+WUGqbxvIof8wHKN0dX1zuLDzR0T64OJkOHbRFz2M9yTfmHQgiy9TjyZs6YiiznqrdvnO6MiZKX/OBq8Lr8r/1iAWhFjBekuEMc4rPnkhi2GeYrcpMgYBy3XQWm8XE1yjDdf2YK1J/gmOv4MVGwvw62cSS1HXVDSkRT2ODBurrKv6/wSFDxJ22MasoUyCAbD56xZ9lSugCm1DqFgEzxDNR/9AMCu5ohA6pbz3LzFBmcYz/wkDx7T4y48K9/1H9WegRe35VhC7gKbFYNKj1e3TKc8J/h2O71hFvUYTue8y8w8qK1sYqni2U8L/iuE35rfkPbTmfZ8e7KRCvMPrV07suVP7XhpM2RLdKN7OQ1b0I/ZbmIXIgphHIYINEcLR6f75H2a7g/39RAm0ZC6WHZDJBdrbHCTM2T3m+XxNfp7vXoWXjEBuDxj8sNMe/ZwCYuqLluMYkhTB90C+8V7FCE+C/U8TqEkzcFRYdUTKTBQfKM4SBPOqpr9GBDaeND+52o59KS2IPviSPAPpz6UjeQTf4HzTjEM9u+xYPeM6e0RWgEo6xW1nDLZVtg795u28ek7m8oXEc3a7n9aNopWwmBvVxDMgz7dU0rlq+mHP/sfwHHiI6rVAaLGhkAr7k4MtIGGCbTWSXePrBfgRFq1m67dWSIu9qPLU/xWKxKdPMnmbHvA+yWlvrqvK4y8Djk80zzTzjp/IVqZtouxp3M22FRcM43LDGegLDyD/PcGa76/gdmu+JU5mWpLGNgyBALYTHVb6Q0MipLiJt5yhfUJFhSDFyPISa+eMtUkLsjZvdAB8/WCsoviWyw8qUSz7DEP2ggUduy2fl1z7Zz+LwOllA9cPjrtEC0WdVXTB3dn7ONkbysKSzyKQjkjoTt30n6FLwsDivUUaX0olOYZQgIbpg1Q1VZTOcYwGf3xai3VrPwxXwh71GjJBRSVdqNTrK6hfPKukq2rNOOC6tUR9SPDLlOWGBPA3OQtLqpKpH34UN7WH2UA7s5kHF40Ipi/ohvbpN6s7IaDjpjSixygezapMOVsqHYvX/bHyJG0JukVmN8nsdqAqIGlHsNotsOQi7Nf9fXd4yIOZLVFeSdxHsKB6QjwPnlqxu4/EDP9JRcKJCeXEDBh7EaDZPvF6gZ+o0VYYGafKrLe95+BfQl0+tzGthKCltbCNvFn3za38WBI6pJfP62cIKaT0JLljlv5BNj8cq8vYIdPKbf71htC0tjfh5d4MggJ1fLQqDUH5C9/o7Ig+cYxaWGNpJuaouCW5vg4Etclf+ohqYLKQWEeuHHBau1YF5JbqBor9WteKuzLPjmQsDmAwjBrluRFX/hO9S/hXkx24EvXcNk9bpd4trY+wkNIND5O/AbiyKm5Hw/gI6yRROBZ63PWwJNv8VGb7742kBiwuWEzbocnCoW9PJXAkl7fyD5RlAGcota+/XUNHi+ynx9+7++1GHWOMDI22+YAWBufbUWT8xvhqbimeCcpRFHEfwNeNHr+Z+8ucMnq4QEqOouY8WgmXrV3vnCcHtTFlESSxhfyTaFcmOiP1XTx6b341Lu50P/YfwBbof2TeW4IlT92s0CxT+nJVCjaLH1K4jypRw5qJ75+5wFdmQThbGvbF4CQ84W5oQ0gNty4kpmYJTcEbecFk/Pr3+vAXjsd6fxnLFTDa36P5c6MoUeObdw8duEG1xJgdAEcTOZStZAKNbIWiIzj7GJpKmLM5lt/AH/ugzGrchsmTDZvybrpdMYSLyNOunj7QsPyK7UPLg0OIXYU4kl2Q+Sff8QNLlZEhvgUYAo5DDzXGayQdZ3mSBJ9AKWjF8PKOW84crVqBD2q/UDsN6SK/oJN2Oj44628nD1AM4Q8qB5GxpXbsfMe109y4jG3yeyMGVqLpFujk7EPFUSUC9VwLZRTCqx8wstWZqvAbTLkYrv23/1ag+bfoNgFmwmSkh6FgBGfXWvwiq6sYl/lEZ9ZT8PwsH9azfAbrTje4/VRijaQRg7f2aUkh9FQ6MgTQZFIBAVW3gVvDsIg0RdWQ8DEuXvn/25gATn4ShtUeRnLKhy1m/m7384Ex5Ow71/BdAQYmXA+N3WErbJ5aD/NIScOx54fxDLekUuscOwkj69EP1VQz22LNbdgtayKqElCCGrDhR2VrMKzrag7HeoeU9gFe1oDOcTc4i+GjrCUzn/dB6eOoL0seQIn3KugltAEvXVIy+GM6xq9MGOsT3/HY2+LC1HsLttwel+et+uXFZ98B/jppmARKkCe3q+KqAnMaV3L9Lsl7M4ZHV8W/jDXWooJKsdIboIUDgD33+t5VIyTWS2HqWfRXbz1/P06VhAOfNkinC163fco6pU2GConF79Gm0b1NwcQARwLrskIx5oGmcIoYM69wU7OB4wWcI4TwwDP0vQjXoZK9gNS+cAiU7OneHxO/It7Fh0mOXgnzWa1zjxDGcKTXJjaqe6+gWIwEvosMr4GL3uVRJeclfOU402VeqT2eKlMiOs//nOOoWv7t/yEdx+iLcj/0A6fXrht0oy5Rf40os+mpMkU9p4b+9e6Jqg34Esw70Kn5d2zuI4t8jjYVwTI3TRVCg69LzcWNFG3OmqXc5wE46sfJbgAetqT+QRmu004QyEpm33xwtJdvgunE0nA1FzEpCCEirJUVaj4dRCnorDqn5E9E7n6mhEiYNwwoF87BJpiCj2otKVnovqVECJLdZ+F8uPI7EMdH6wcdeJG5znT2EKkbB2w9GtnaLpLM3wclL/naEXYKDllyr9Wn1yTQAl/0eNqeQNSIJ/LmsnCHWWpSzOHiaUN21rc/xNJJra3ZjOfxmX/IxSL56x1QdRTaI0qAKJnDMrUOHhs5akCJVJSU5NzXD+1jxfShmnrqEFwu1GalKJoF8IDsUtuk2uWwo1Mxu7q4XiS9NbvGALXMjL5n2Xy9njCl1+4R70f9/VuihhD2LjJucCjeiiu4hzbbfM6fUTBZTCvgVBjD9hMhdvpfEgwwekGtTTrBhlJeQOq9WF5LLrLoI6ABOiSnHPAKdl28dEgJpI0iyy/mVLLLhoc2w6vJzTpSk7eLnsBYoif7FVgu19IKk9fEpBF7w1voP3bhmdY4tZyhSqKlK4hJXeripItfkwqGWbOZAugMnKZIhOwIOVBoN0YON3v1d1uNuyXUF9vfnDBLzOu7Xu0KW9XDsRJf1DOQq5RTXazn9PsLIYSGioeiQKUo8Gu/S5u4p3EHCI7nsAW5UdZF6NnwYl+o3aFzZS9uwHJlDbA27wkDQZYTQYHapc/tu+qhsq/9PJXZXrIWQZ8GLfMuax2f5r7jcscvZFtDLvFX0hjjPZFuX2ooU9DRGdzNZj/2kkuK/Dtv5OHxe+Cvdj+kyo/8uwTZLn2jzxQSpz0YJ5sZ333p8DGwBROPJAXIMnzSuFY/xXlrUrHy+w90YkdXL1AXr7n+hCBa0D8p5bfKxzDDKaudELvbPhI8/GqviyZpe9AkhAJMMoBr/2Brqrlc+S2sC/Y5zqlH5PUW+bTMnRty06PloGsPAM3R/upW0WqJNgSnXxXcCcshIdPRQe0VulPwYAiPnY1J4pKJenprRFfr/y99aUScK6p+lcbufKgABh8pul7RovQZqdO8lZL1qL0NmBHOAShOx4H0DcZLbc6fVeft+xwrdvZDN+O4pC+YPc+A2g2/42msX/sCegWN76rffSp2d/Z3DAbmg5Mv2X1XMfHelKsnNofiU3GElRmta0rj1pkzEHaSX+uOckJLISKDtJXtpIzYyD7oxk1sbTje2sowSWVzfdFo5L14DesuzuzbmIyY5q3PCFxyndwa4dJBq0Nf2dh1UPIj0eoqDYrfbNisFhfDef/MtshOG+GiKOSEn5XK0EX+RcRxGaPmeax6CIBYvJ9XoCtVhZXZVDgrhUlzwecs1V6m+5v8lr0a2vxbCPuyvr1MfkTpOERKT8jP+XAdnLbJzkdvr10Bw6UopjD11V4iwqFXzn9vpZQ+dRy713dDA966PvgXH2Vwt5sKrfSIxaIGINgItjlU4pWwBxZ59XPt7V7I5beK2/0Pi5rvN6HSJrA9t+aVtbrSvFeZ19x43HWqbXHD36W1auLoGq2eAgHLFwBHM7xy4eWr1ICnGQLHzTBe0GEJsiBTVq3bdXS67fYvTzCaWNNgG90zeqgQK/gerd31OUPOpxWjhv3sz7BQ7CGXCZ/2p5bnMfMnf512N2tnBaA3dK/OfP3G1Q8TnlZF8j23k4kjnhYlTeYoveV4AAc8bkW7KozRyedNkjtrEOrf/tFRl8JmNVdyjHpwLpkYY7n/jzns8GGGxdTSpAw1Wiovx3HGo26MGg2FufxeFJd6p4oRTEkfKHnFur8P3cbvcQzUecKyppX/371Ag/SjCCPWsWWXnmNPstY35g9Hnv/4Fov/rp4fIAyafQQJloLfnZjuYS7SXxEPJ+kJP10Pj1ICoi2p4xkE9VhjNQrkA2wzeFui7YYi00d7hHZC6+mxWuEuZHlUvMbOu1EGcAWsNKLctjZwt4u4YNaBJJG/QRr7k3ScBQ9By+I//0xek9ttay3xJav8iU7Fs5iLx8ni/RHyP3RognWVogF73lsYM97sqLoomwLEhgVn2uqWju/YduJe1OvCTGgcfJCovj7PSUuCrZX6/FQeROqfmpaLWp7FCMLmzbx7MDxJmp7HTv27lghd+iZloVA8pJDQHmKgCQDALgcZwHxj99Ik+3xzjGc/CcncpqiiiEmoCY6sxUKYq/3QggeLVmWp8o75jSTWKEFTY9r0mPHSEuZm3cmO5J3pV5NU0DZm9fAsZtnH6wMwTXMI9B+zmUjJDYh4RMH1ILilqJUFMBBtem6BxbP7mmkKywPW/5T5BpFLwc3RtmfWQzeOPml10WcFfvxjfp5YCkucgqmFjG1z+3brZ0fQMEM+EpwZkck8Jk6VE4xGdfG4KgL1hr3G7ID1qWK2Lto/ssFrzvNQQsdWnRNUnGpDjLHj3k90e5m8Zmm7I7ClGcl177GnxUlJpq1AwuK848eDU4S0LXEhc4N5+KB/VuOtFeZS9vtm48wnBOiEPgQ2KjCh3q64I+3USnNItDPXjnTX8GbQjd1gaHmKR2c16NxJhc5goMXwTZ0hJsumYo34tHN4jhU6bz1HWc+KXSb0K0TstuFZiqTvy3fI3r6xYlILqW4yt1favuBvKg3YNTuueRz16QAAo+ldca31MfJeWNY293oOOVBGdE3CBSYV0217vopG+Sd2l/ZkuqFBfZnU4OUbJQEvDhCr0Ti/CcA78kp/H34F/xaPeXL3Y8PjLEH/wcgcWBqLQKIrRN8y7h+gbfoTUp22ehdVilV+gc8zqONt5DCbie2rtL+lxSr0o0rOfe7PRSLFnyri7iTnRpStbeeUAOrNUyVU4GWID6o9XXwt8kh6IjXjotJA1pjMI4FNIcwN8MIJx8EDVuYKGtoKPJOBwcZeMWEe0AXuSaDgDjn4yhFL350UUXSVjUqSCI0a4Fj/J6HrGTlPmrqDBSEa4sg1GLKFSkq5GpqMbpwUdGFvyX3KSeG9pycm3twZlPGTSfdBpKYK1Pc2VBIUuhCSrg9YGXq9y8F/4XSWKvzi8/yn3rzRD0Wrf5pK/tHxtojnDclyUZC3zEGwCcd/mZyvy7GxCN/xkrTjLlAaRFo6PehVmk+OT9op0JUWScy0xNf6BWdltM7QnPFPOTRBWLhLPXlWxQwpH58Vlb8BJsp3y4wBQNEWC1QAuNSotGMAezSWzCG+q3cl1VNbGJQaIFvt8+l9SVQqZAHjmo6SDxCmG35nJBDc/hdJ+uaJhdrsdeanGHfew1A+/SMm7arsCIvzr3/86p28w+gxAuF8/WNTsdcEwVmW6ir3XYL/6ziYIYVFMh7lIejtyK1OnFlEtaTcmeyTsIF/MtD67TWlliGNCYUaNB5JJsz5+GkJzzhr6gfCLz7itA7IyKrhiVmov+W9Pzxl6bimPbLIuccqKWfL/WX117azrU313VZsm9ljFtX1Hi1pbFOAnFBaA2grJfXwiWKe0G0qOpdTgAcVMgQ6dduA+dkAsbNS31IBxj+iab5ihf0gH03Syszd6hk5gS8KxIINaSJXs6MN3m7yCdnOEOiYyDDSrCnJGuQNehgvTcYvaIf/vlnkcLSFsmonklFDFylfnUj+dI4O7bPhP6pqLH0U4b0BtYF1FtGumfyAXNWSEXcj/81hjOq2OKkcxzHlM2O6O9kgP8dkUQIjzaEUwt6I4tlHGnBvYZGHj1wGgd98ppHLRdGCibiliUGwKZ4zZvpUnGAS4KLGUsQTWgWT4H9ggp2DL57mmpQxJhkDoCmXq/xtlrLyjQwBeUnqTmEmHUuov2YCDwOdj5W4e9ZawT1wrQftpnF+XiuYatAFS1LAyEI+BF3vnyk/5N6LulTgZGHyjYtSuV0URyJtg2SlHan/n7g+r+BdDg7X+wyDTvCxdepAJ86EgceeRkjkp1/yjHkQRDnZeabjGrH8Ncmu5QH5281iHgYmSt0cQPmQf2sPVOygUIZdVxVlZwGQXP9Thp7E66JMiq+A8DBm7aCjU+lpa/NLUb/QJq70invTL2S4cmhRsH1DcYramTBUNdGlrXpE4jtMjvec03FBlXZ6SDyco5ge6oDZj9N2dBT96Cu0PrrCFn2v/pxJecXbqcVVr8FeJypKD7mkrj48sgYXZGgjuTel3/mbHQ59CkTNxpqfCLUtRV3A4LnS2zCu7IqVTwyQnP9StRF43wkXJuoyOK66jwKYIeK1xYXLtcc4mJrkcTfQ/1CD3IKHem7QIy6ZCRyCAFUVpP/OS9d2GW2l2wjpc2k/7yeW3gxIEyHC/slialkK0OgR/oyeufMczEwtwNL89fnyRYq4mcqiRy84gesVjySKXjQgVIz/eviIP7Ch7rvepqXQqZQMCT8u7/tov4+bW69SdXFv3VvuudSywRCBQv8X79usMLauZojkLnmdnIMaC6VqmpedlSbhhdUBycvUPzEPaqrGk/SNGbFRmcL/aXk475KhJGUXUWfb+hMfC6oFjMUjBjNvN+AJFcek1znHVe2IfQk21WkyOiIByfw+dnqZiu77f6PKfZupyhlpSOfU4XqvIP93/5tE896PSmWZ/Mwm4bVuIV5gYL4xruCy9fR5MeFxpeSNfF14jIJRv+THibJEEYapgDGEo7QFXy8YvkcMoGBrQv4L4Z+Tqsf2WdqdATKtQ6uxBr8S4XjoCJ7NjCfXvZpln2tabKhA+7iYTM7cCI2JrW0S3vpK+fYqv7m2DcpdApNBttrzShyRiuElOgVxwS31dPGTWEiIViNRGPNH6H6/Y8kRsYVO2UlKju5Tt7tSHv9Y3ImYlTOvRabTg1d+69vLXBu0ii3MNC6y5wIpaTKf7LjUnAGjqMlH/0ReCdNwjkKKJseyCN5ek4qeQGkZOvmqMNBYIHn9Egbas0IPQ+j/JAxCEFid+3MBLbFn9RssYJs4LO9ckRkOjrFx9CqvgQecFrXVchKfpqKIkx5nSrPpXQoiSyMgI/JmvgrTyXxBJa/jnZSgIpIFMj3fhTu3xtEuZoZTV4MuqVy9bA9axqWLxWRdUvFmJTvahrLLLW4b2qxF4N3jTCdXVaBFLEN0Pmj2sa1f0uXIZE+CFE6bUsJr4zFKf8cXj9sWAAAZOAPh7Cb9V7dCJ/KeSTkYAVeZ/mo0gA0Bdb3vR9WJtlLCSj4DXhdnIAAe2IoPFm85mAv+e/WYGdnts8ZV7VtUGrn7+HtCtWH8SL0MB5KqrNlfTlyvPOnoNbnd0JcECFg25IRmElVoY5nBjCW7SPL4/UMeTCIzUhbzfHN7wwGlEUi5xDwcnhWD9vAyBal+kxszq3/fvvrPj/xnyhppQ52X5lJl7jNDVcx3cef9e3l4o5gpEn3eZlXC9CluOY25pVkE8o0GHmPjMmgDvD9Us3q59R2KO7WisNPES0EptutukMlA7zGVMx88S3OrQzXaqMBoJTvZ6sANgeItdJlbNl4QAAAAAAA=" 
             alt="Toma las Aguas" class="welcome-logo">
            <span class="welcome-icon">üåäüíßüèùÔ∏è</span>
            <div class="welcome-header">
                <h2>Bienvenido al Geoportal Toma las Aguas</h2>
                <p class="subtitle">Transparencia y Participaci√≥n Ciudadana para la Seguridad H√≠drica de Puerto Morelos</p>
            </div>

            <div class="welcome-section">
                <h3>üó∫Ô∏è ¬øPor qu√© este geoportal?</h3>
                <p>Puerto Morelos se encuentra en una de las zonas m√°s vulnerables hidrol√≥gicamente de la Pen√≠nsula de Yucat√°n. Este territorio descansa sobre un <strong>acu√≠fero k√°rstico</strong>, un sistema geol√≥gico extraordinariamente fr√°gil donde el agua se filtra directamente a trav√©s de roca caliza porosa hacia nuestro √∫nico reservorio de agua dulce.</p>
            </div>

            <div class="alert-box">
                <h3>‚ö†Ô∏è Crisis de Seguridad H√≠drica</h3>
                <p>El acelerado desarrollo inmobiliario est√° generando una <strong>crisis sin precedentes</strong>:</p>
                <ul class="features-list">
                    <li>Sobreexplotaci√≥n del acu√≠fero mediante extracci√≥n masiva</li>
                    <li>Contaminaci√≥n directa por lixiviados y aguas residuales mal tratadas</li>
                    <li>Destrucci√≥n de cenotes y sistemas de infiltraci√≥n natural</li>
                    <li>P√©rdida irreversible de selva que regula el ciclo hidrol√≥gico</li>
                    <li>Intrusi√≥n salina por extracci√≥n excesiva en zona costera</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üî¨ Fragilidad del Sistema K√°rstico</h3>
                <p>A diferencia de otros acu√≠feros, el sistema k√°rstico de Quintana Roo <strong>no filtra contaminantes</strong>. Las fracturas, cavernas y r√≠os subterr√°neos permiten que cualquier contaminante llegue directamente al agua que consumimos. Una vez contaminado, <strong>la remediaci√≥n es pr√°cticamente imposible</strong>.</p>
            </div>

            <div class="alert-box">
                <h3>üè≠ Extracci√≥n de Agua y Consecuencias Regionales</h3>
                <p>Los sistemas de extracci√≥n de agua en Puerto Morelos no solo abastecen a nuestra poblaci√≥n local, sino que tambi√©n proveen agua a <strong>Canc√∫n y su Aeropuerto Internacional</strong>. Esta extracci√≥n masiva genera:</p>
                <ul class="features-list">
                    <li><strong>Presi√≥n adicional sobre el acu√≠fero</strong> que excede su capacidad de recarga natural</li>
                    <li><strong>Riesgo elevado de intrusi√≥n salina</strong> en la zona costera por el descenso del nivel fre√°tico</li>
                    <li><strong>Impacto desproporcionado</strong> en nuestro territorio mientras otros municipios se benefician del recurso</li>
                </ul>
            </div>

            <div class="highlight-box">
                <h3>üó∫Ô∏è La Fractura Holbox-Xel-H√° y Nuestra Reserva Estrat√©gica</h3>
                <p>Puerto Morelos se encuentra sobre la <strong>Fractura Holbox-Xel-H√°</strong>, una l√≠nea geol√≥gica de m√°s de 300 kil√≥metros que divide el estado de Quintana Roo en dos y pasa directamente por Leona Vicario. Esta fractura es m√°s que una caracter√≠stica geol√≥gica:</p>
                <ul class="features-list">
                    <li>Representa la <strong>reserva de agua m√°s importante del norte de Quintana Roo</strong></li>
                    <li>Es un corredor hidrogeol√≥gico fundamental que alimenta los sistemas de recarga del acu√≠fero</li>
                    <li><strong>Provee agua a m√°s de 1.5 millones de habitantes</strong> de la zona tur√≠stica m√°s importante de M√©xico</li>
                    <li>Constituye la <strong>mayor capacidad de almacenamiento de agua</strong> del noreste peninsular</li>
                    <li>Su protecci√≥n es <strong>estrat√©gica para la seguridad h√≠drica</strong> de toda la Riviera Maya</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Por esta raz√≥n, Puerto Morelos debe ser reconocido como un municipio proveedor de agua</strong>, con normativas especiales de protecci√≥n ambiental, ordenamiento territorial estricto y compensaciones por los servicios ecosist√©micos que brinda a la regi√≥n.</p>
            </div>

            <div class="highlight-box">
                <h3>üí° La Informaci√≥n es Poder</h3>
                <p><strong>Este geoportal democratiza el acceso a informaci√≥n geoespacial cr√≠tica</strong> que tradicionalmente ha estado dispersa o inaccesible para la ciudadan√≠a. Integramos datos sobre:</p>
                <ul class="features-list">
                    <li>Desarrollos inmobiliarios y su impacto territorial</li>
                    <li>Zonas de karstificaci√≥n y vulnerabilidad acu√≠fera</li>
                    <li>Cenotes, lagunas y cuerpos de agua amenazados</li>
                    <li>Fallas geol√≥gicas y riesgo s√≠smico</li>
                    <li>√Åreas naturales protegidas y su cumplimiento</li>
                    <li>An√°lisis socioecon√≥mico del territorio</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üë• Participaci√≥n Ciudadana</h3>
                <p>Al <strong>registrarte e iniciar sesi√≥n</strong>, podr√°s:</p>
                <ul class="features-list">
                    <li>Reportar nuevos desarrollos inmobiliarios que detectes</li>
                    <li>Documentar irregularidades ambientales</li>
                    <li>Verificar si existe Manifestaci√≥n de Impacto Ambiental (MIA)</li>
                    <li>Contribuir a un mapeo colaborativo del territorio</li>
                    <li>Acceder a an√°lisis espaciales actualizados</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üéØ Nuestro Objetivo</h3>
                <p>Hacer <strong>p√∫blica, din√°mica y colaborativa</strong> la informaci√≥n sobre el estado de nuestro territorio. Solo con transparencia y participaci√≥n ciudadana informada podremos:</p>
                <ul class="features-list">
                    <li>Exigir cumplimiento de normativas ambientales</li>
                    <li>Presionar por un desarrollo territorial sostenible</li>
                    <li>Proteger nuestro acu√≠fero para generaciones futuras</li>
                    <li>Construir resiliencia h√≠drica comunitaria</li>
                </ul>
            </div>

            <div class="highlight-box">
                <p style="text-align: center; font-size: 16px;"><strong>El agua es vida. El territorio es comunidad. La informaci√≥n es poder.</strong></p>
            </div>

            <button class="close-welcome-btn" onclick="closeWelcome()">
                üöÄ Comenzar a Explorar el Geoportal
            </button>
        </div>
    </div>

    <div class="header">
        <img src="" alt="Toma las Aguas" class="header-logo">
        <div class="header-title">
            <h1 onclick="openWelcome()">Geoportal de Toma las Aguas</h1>
        </div>
    </div>

    <div id="map"></div>

    <div class="loading-overlay" id="loading">
        <div style="text-align: center; background: white; padding: 30px; border-radius: 8px;">
            <div class="spinner"></div>
            <h3 style="color: #2c5282; margin-bottom: 10px;">Cargando Geoportal</h3>
            <p id="loading-text" style="color: #718096; font-size: 14px;">Iniciando...</p>
        </div>
    </div>

    <div class="control-panel" id="control-panel">
        <button class="toggle-btn" onclick="togglePanel('control-panel')" title="Minimizar/Maximizar">
            <span id="control-toggle-icon">‚àí</span>
        </button>
        <h2>üõ∞Ô∏è Geoportal <span class="success-badge">SATELITAL</span></h2>

        <button class="toggle-all" onclick="toggleAllLayers()">‚úì Activar/Desactivar Todas</button>
        
        <h3>üèóÔ∏è Desarrollo Urbano</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos" checked>
            <label for="layer-proyectos">
                <span class="color-indicator" style="background-color: #e53e3e;"></span>
                Proyectos Inmobiliarios-tur√≠sticos
            </label>
            <span class="layer-count" id="count-proyectos">0</span>
        </div>

        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos-colab" checked>
            <label for="layer-proyectos-colab">
                <span class="color-indicator" style="background-color: #9333ea;"></span>
                Proyectos Colaborativos
            </label>
            <span class="layer-count" id="count-proyectos-colab">0</span>
        </div>
        
        <div id="add-project-section" style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 4px; display: none;">
            <button id="add-project-btn" style="width: 100%; padding: 8px; background: #9333ea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                ‚ûï Agregar Proyecto
            </button>
            <p style="font-size: 10px; color: #6b7280; margin: 5px 0 0 0; text-align: center;">Haz click en el mapa o ingresa coordenadas</p>
        </div>
        
        <div id="login-section" style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 4px; border: 1px solid #fbbf24;">
            <p style="font-size: 11px; color: #78350f; margin: 0 0 8px 0; font-weight: 600;">Inicia sesi√≥n para colaborar</p>
            <button id="show-login-btn" style="width: 100%; padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 5px;">
                üîê Iniciar Sesi√≥n
            </button>
            <button id="show-register-btn" style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                üìù Registrarse
            </button>
        </div>
        
        <div id="user-section" style="margin: 10px 0; padding: 10px; background: #d1fae5; border-radius: 4px; border: 1px solid #10b981; display: none;">
            <p style="font-size: 11px; color: #065f46; margin: 0 0 8px 0;">
                üë§ <strong id="username-display"></strong>
            </p>
            <button id="export-csv-btn" style="width: 100%; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-bottom: 5px; font-weight: 600;">
                üìä Exportar Proyectos a CSV
            </button>
            <button id="logout-btn" style="width: 100%; padding: 6px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                Cerrar Sesi√≥n
            </button>
        </div>

        <h3>üíß Agua</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-descargas" checked>
            <label for="layer-descargas">
                <span class="color-indicator" style="background: linear-gradient(90deg, #7dd3fc, #0369a1);"></span>
                Descargas 2023
            </label>
            <span class="layer-count" id="count-descargas">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-extracciones" checked>
            <label for="layer-extracciones">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fb923c, #ea580c);"></span>
                Extracciones 2023
            </label>
            <span class="layer-count" id="count-extracciones">0</span>
        </div>

        <h3>üåä Cuerpos de Agua (IAHCSA)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-cuerpos-agua" checked>
            <label for="layer-cuerpos-agua">
                <span class="color-indicator" style="background: linear-gradient(135deg, #3b82f6, #10b981);"></span>
                Todos los Cuerpos de Agua
            </label>
            <span class="layer-count" id="count-cuerpos-agua">0</span>
        </div>
        <div id="cuerpos-agua-summary" style="padding: 8px 8px 8px 28px; font-size: 11px; color: #4a5568; background: #f7fafc; border-radius: 4px; margin: 5px 0 10px 0;">
            <strong>Total:</strong> <span id="total-area-cuerpos">0</span> m¬≤
        </div>
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-piscinas" checked>
            <label for="layer-piscinas">
                <span class="color-indicator" style="background-color: #ec4899;"></span>
                Piscinas
            </label>
            <span class="layer-count" id="count-piscinas">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-piscinas"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sup" checked>
            <label for="layer-cenotes-sup">
                <span class="color-indicator" style="background-color: #10b981;"></span>
                Cenotes Modificados
            </label>
            <span class="layer-count" id="count-cenotes-sup">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sup"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sub" checked>
            <label for="layer-cenotes-sub">
                <span class="color-indicator" style="background-color: #ef4444;"></span>
                Cenotes Artificiales
            </label>
            <span class="layer-count" id="count-cenotes-sub">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sub"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-art" checked>
            <label for="layer-aguadas-art">
                <span class="color-indicator" style="background-color: #3b82f6;"></span>
                Aguadas Antropizadas
            </label>
            <span class="layer-count" id="count-aguadas-art">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-art"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-nat" checked>
            <label for="layer-aguadas-nat">
                <span class="color-indicator" style="background-color: #8b5cf6;"></span>
                Aguadas Naturales
            </label>
            <span class="layer-count" id="count-aguadas-nat">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-nat"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-sascab" checked>
            <label for="layer-sascab">
                <span class="color-indicator" style="background-color: #f59e0b;"></span>
                Sascaberas
            </label>
            <span class="layer-count" id="count-sascab">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-sascab"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-rios" checked>
            <label for="layer-rios">
                <span class="color-indicator" style="background-color: #06b6d4;"></span>
                R√≠os Artificiales
            </label>
            <span class="layer-count" id="count-rios">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-rios"></div>

        <h3>üåä Geolog√≠a e Hidrolog√≠a</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-karstificacion" checked>
            <label for="layer-karstificacion">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fef3c7, #78350f);"></span>
                Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-karstificacion">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-colapso-karst" checked>
            <label for="layer-colapso-karst">
                <span class="color-indicator" style="background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00);"></span>
                ‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-colapso-karst">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-inegi" checked>
            <label for="layer-fallas-inegi">
                <span class="color-indicator" style="background-color: #9f7aea;"></span>
                Fallas INEGI
            </label>
            <span class="layer-count" id="count-fallas-inegi">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-cenapred" checked>
            <label for="layer-fallas-cenapred">
                <span class="color-indicator" style="background-color: #ed64a6;"></span>
                Fallas CENAPRED
            </label>
            <span class="layer-count" id="count-fallas-cenapred">0</span>
        </div>

        <h3>üèòÔ∏è Registro Agrario Nacional (RAN)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-nucleos-agrarios" checked>
            <label for="layer-nucleos-agrarios">
                <span class="color-indicator" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);"></span>
                N√∫cleos Agrarios
            </label>
            <span class="layer-count" id="count-nucleos-agrarios">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-asentamientos-humanos" checked>
            <label for="layer-asentamientos-humanos">
                <span class="color-indicator" style="background-color: #f59e0b;"></span>
                Asentamientos Humanos
            </label>
            <span class="layer-count" id="count-asentamientos-humanos">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-comunales" checked>
            <label for="layer-tierras-comunales">
                <span class="color-indicator" style="background-color: #a855f7;"></span>
                Zonas Comunales Ejidales
            </label>
            <span class="layer-count" id="count-tierras-comunales">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-parceladas" checked>
            <label for="layer-tierras-parceladas">
                <span class="color-indicator" style="background-color: #f97316;"></span>
                Zonas Parceladas
            </label>
            <span class="layer-count" id="count-tierras-parceladas">0</span>
        </div>

        <h3>‚ö†Ô∏è POEL Nuevo 2024</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-fraccionamientos-legalizar" checked>
            <label for="layer-fraccionamientos-legalizar">
                <span class="color-indicator" style="background-color: #dc2626;"></span>
                Fraccionamientos a Legalizar
            </label>
            <span class="layer-count" id="count-fraccionamientos-legalizar">0</span>
        </div>

        <h3>üèûÔ∏è Ordenamiento</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-poel" checked>
            <label for="layer-poel">
                <span class="color-indicator" style="background: linear-gradient(135deg, #0ea5e9, #1e3a8a);"></span>
                POEL 2013
            </label>
            <span class="layer-count" id="count-poel">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-socioeco" checked>
            <label for="layer-socioeco">
                <span class="color-indicator" style="background: linear-gradient(135deg, #10b981, #0891b2);"></span>
                Zonas Inundables
            </label>
            <span class="layer-count" id="count-socioeco">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-municipio" checked>
            <label for="layer-municipio">
                <span class="color-indicator" style="background-color: rgba(74, 85, 104, 0.3); border: 2px solid #4a5568;"></span>
                L√≠mite Municipal
            </label>
            <span class="layer-count" id="count-municipio">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-sin" checked>
            <label for="layer-pozos-sin">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #ef4444;"></span>
                Pozos sin Protecci√≥n
            </label>
            <span class="layer-count" id="count-pozos-sin">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-con" checked>
            <label for="layer-pozos-con">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #10b981;"></span>
                Pozos con Protecci√≥n
            </label>
            <span class="layer-count" id="count-pozos-con">0</span>
        </div>
    </div>

    <div id="legends-panel" class="legends-panel" style="position: absolute; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000; font-size: 11px;">
        <button class="toggle-btn" onclick="togglePanel('legends-panel')" title="Minimizar/Maximizar" style="top: 8px; right: 8px;">
            <span id="legends-toggle-icon">‚àí</span>
        </button>
        <h3 style="font-size: 14px; margin: 0 0 10px 0; color: #2c5282; border-bottom: 2px solid #4299e1; padding-bottom: 5px;">Leyendas</h3>
        
        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Volumen de Agua (hm¬≥/a√±o)</strong>
            <div style="margin-top: 5px;">
                <div style="font-size: 10px; font-weight: 600; color: #0369a1; margin-bottom: 2px;">Descargas</div>
                <div style="height: 12px; background: linear-gradient(90deg, #7dd3fc, #0369a1); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
            <div style="margin-top: 8px;">
                <div style="font-size: 10px; font-weight: 600; color: #ea580c; margin-bottom: 2px;">Extracciones</div>
                <div style="height: 12px; background: linear-gradient(90deg, #fb923c, #ea580c); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Intensidad de Karstificaci√≥n (medio a muy alto)</strong>
            <div style="height: 12px; background: linear-gradient(90deg, #fef3c7, #78350f); border-radius: 3px; margin: 5px 0 3px 0;"></div>
            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                <span>Medio</span><span>Muy Alto</span>
            </div>
        </div>

        <div style="margin-bottom: 12px;" id="legend-poel-section">
            <strong style="font-size: 11px; color: #4a5568;">POEL 2013 - UGAs por Pol√≠tica</strong>
            <div id="legend-poel-items" style="margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div>
            <strong style="font-size: 11px; color: #4a5568;">Cuerpos de Agua (IAHCSA)</strong>
            <div style="margin-top: 5px; font-size: 10px;">
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Piscinas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Modificados</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Artificiales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Antropizadas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Naturales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Sascaberas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #06b6d4; border-radius: 2px; margin-right: 6px;"></div>
                    <span>R√≠os Artificiales</span>
                </div>
            </div>
        </div>
    </div>

    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üîê Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="login-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a</label>
                    <input type="password" id="login-password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="login-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Entrar
                    </button>
                    <button type="button" id="close-login-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="register-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üìù Registrarse</h2>
            <form id="register-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre de Usuario</label>
                    <input type="text" id="register-username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="register-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a (m√≠nimo 6 caracteres)</label>
                    <input type="password" id="register-password" required minlength="6" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="register-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="register-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Crear Cuenta
                    </button>
                    <button type="button" id="close-register-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚ûï Agregar Proyecto Inmobiliario-tur√≠stico</h2>
            <form id="add-project-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                </div>
                <div style="padding: 12px; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; margin-bottom: 15px;">
                    <p style="margin: 0; font-size: 12px; color: #1e40af;">
                        üí° <strong>Tip:</strong> Haz click en el mapa para capturar las coordenadas autom√°ticamente
                    </p>
                    <button type="button" id="enable-map-click" style="margin-top: 8px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                        üìç Activar Click en Mapa
                    </button>
                </div>
                <div id="add-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="add-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üíæ Guardar Proyecto
                    </button>
                    <button type="button" id="close-add-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚úèÔ∏è Editar Proyecto</h2>
            <form id="edit-project-form">
                <input type="hidden" id="edit-project-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="edit-project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="edit-project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="edit-project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="edit-project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="edit-project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="edit-project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <div id="edit-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="edit-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        ‚úÖ Actualizar Proyecto
                    </button>
                    <button type="button" id="close-edit-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="map-click-indicator" style="display: none; position: fixed; top: 100px; right: 20px; z-index: 10001; background: rgba(147, 51, 234, 0.95); color: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(10px); pointer-events: none; max-width: 280px;">
        <div style="font-size: 32px; margin-bottom: 10px;">üéØ</div>
        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Modo Captura Activado</h3>
        <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa para seleccionar la ubicaci√≥n</p>
        <button id="cancel-map-click" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
            ‚ùå Cancelar
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <script>
        console.log('=== GEOPORTAL PUERTO MORELOS - VISTA SATELITAL ===');

        const SUPABASE_URL = 'https://mrniyxyurgbpfqfuzgws.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ybml5eHl1cmdicGZxZnV6Z3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTI1OTgsImV4cCI6MjA4MDk4ODU5OH0.tkZIuDNUreGSqLL0JvuzJepZEfducQ3L5N4BS7Jxv4M';

        const UTM_ZONE_16N = '+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs';
        const WGS84 = 'EPSG:4326';
        
        function isUTM(x, y) {
            return Math.abs(x) > 1000 || Math.abs(y) > 1000;
        }
        
        function convertUTMtoLatLon(x, y) {
            try {
                if (typeof proj4 === 'undefined') {
                    console.error('proj4 no est√° cargado');
                    return null;
                }
                
                const result = proj4(UTM_ZONE_16N, WGS84, [x, y]);
                return {
                    lon: result[0],
                    lat: result[1]
                };
            } catch (e) {
                console.error('Error convirtiendo coordenadas:', e);
                return null;
            }
        }

        let map;
        let layerGroups;
        let supabaseClient;

        const COLORS = {
            proyectos: '#e53e3e',
            proyectosColab: '#9333ea',
            cuerposAgua: {
                'piscina': '#ec4899',
                'cenote_s_a': '#10b981',
                'cenote_s_s': '#ef4444',
                'aguada_a': '#3b82f6',
                'aguada_n': '#8b5cf6',
                'sascab_ce': '#f59e0b',
                'rio_a': '#06b6d4',
                'default': '#6b7280'
            },
            poel: {
                'Protecci√≥n': '#1e3a8a',
                'Conservaci√≥n': '#0369a1',
                'Preservaci√≥n': '#0284c7',
                'Aprovechamiento Sustentable': '#eab308',
                'Restauraci√≥n': '#f97316',
                'default': '#a0aec0'
            },
            socioeco: {
                'manglar': '#06b6d4',
                'manglar 2': '#0891b2',
                'tular': '#0e7490',
                'planicie carstica sujeta a inu': '#0284c7',
                'suelo con poca vegetacion prop': '#0ea5e9',
                'zona de manglar inundada (est': '#38bdf8',
                'selva mediana perennifolia': '#075985',
                'nubes': '#0369a1',
                'zona de cambio de uso de suelo': '#7dd3fc',
                'default': '#718096'
            },
            colapsoKarst: {
                'Muy Alto': '#ff00ff',
                'Alto': '#00ffff',
                'Medio': '#ffff00',
                'Bajo': '#ff1493',
                'Muy Bajo': '#00ff00',
                'default': '#ff69b4'
            },
            tierrasEjidales: {
                'comunal': '#a855f7',
                'parcelada': '#f97316',
                'default': '#8b5cf6'
            },
            nucleosAgrarios: {
                'Ejido': '#8b5cf6',
                'Comunidad': '#a855f7',
                'default': '#9333ea'
            },
            asentamientosHumanos: '#f59e0b',
            fraccionamientosLegalizar: '#dc2626',
            fallasINEGI: '#9f7aea',
            fallasCENAPRED: '#ed64a6',
            municipio: '#4a5568',
            pozosSinProteccion: '#ef4444',
            pozosConProteccion: '#10b981'
        };

        function openWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('closing');
            modal.style.display = 'flex';
        }

        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.add('closing');
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 800);
        }

        let isDragging = false;
        let currentPanel = null;
        let offsetX = 0;
        let offsetY = 0;

        function setupDraggable() {
            const panels = document.querySelectorAll('.control-panel, .legends-panel');
            
            panels.forEach(panel => {
                panel.addEventListener('mousedown', startDrag);
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function startDrag(e) {
            if (!e.target.closest('.panel-minimized') || e.target.classList.contains('toggle-btn')) {
                return;
            }

            const panel = e.target.closest('.control-panel, .legends-panel');
            if (!panel || !panel.classList.contains('panel-minimized')) {
                return;
            }

            isDragging = true;
            currentPanel = panel;
            
            const rect = panel.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            currentPanel.classList.add('dragging');
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !currentPanel) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            const maxX = window.innerWidth - 50;
            const maxY = window.innerHeight - 50;

            const finalX = Math.max(0, Math.min(x, maxX));
            const finalY = Math.max(0, Math.min(y, maxY));

            currentPanel.style.left = finalX + 'px';
            currentPanel.style.top = finalY + 'px';
        }

        function stopDrag() {
            if (currentPanel) {
                currentPanel.classList.remove('dragging');
            }
            isDragging = false;
            currentPanel = null;
        }

        let maxVolumenDescarga = 0;
        let maxVolumenExtraccion = 0;
        let maxIntensidadKarst = 0;
        let minIntensidadKarst = 999;

        let allLayersData = {
            proyectos: [],
            descargas: [],
            extracciones: [],
            cuerposAgua: [],
            rios: []
        };

        let currentUser = null;
        let mapClickEnabled = false;
        let tempMarker = null;
        let movingProjectId = null;
        let movingProjectMode = false;

        function updateStatus(text) {
            console.log('[STATUS]', text);
        }

        function updateLoading(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateLayerCount(layerId, count) {
            const element = document.getElementById(`count-${layerId}`);
            if (element) {
                element.textContent = count;
                element.classList.add('loaded');
            }
        }

        function parseGeoJSON(geojson) {
            if (!geojson || !geojson.coordinates) {
                return null;
            }

            try {
                const coords = geojson.coordinates;
                let allPolygons = [];

                for (const polygon of coords) {
                    for (const ring of polygon) {
                        const leafletCoords = ring.map(coord => {
                            const x = coord[0];
                            const y = coord[1];
                            
                            if (isUTM(x, y)) {
                                const converted = convertUTMtoLatLon(x, y);
                                if (converted) {
                                    return [converted.lat, converted.lon];
                                } else {
                                    console.warn('No se pudo convertir coordenada UTM:', { x, y });
                                    return null;
                                }
                            } else {
                                return [y, x];
                            }
                        }).filter(c => c !== null);
                        
                        if (leafletCoords.length > 0) {
                            allPolygons.push(leafletCoords);
                        }
                    }
                }

                return allPolygons.length > 0 ? allPolygons : null;
            } catch (e) {
                console.error('Error parsing GeoJSON:', e);
                return null;
            }
        }

        function parseGeometry(item) {
            try {
                if (item.geojson) {
                    const geom = typeof item.geojson === 'string' ? JSON.parse(item.geojson) : item.geojson;
                    return geom;
                }
                if (item.geom) {
                    if (typeof item.geom === 'string') return JSON.parse(item.geom);
                    if (item.geom.type) return item.geom;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function getDescargaColor(vol) {
            const ratio = vol / maxVolumenDescarga;
            const r = Math.floor(125 + (3 - 125) * ratio);
            const g = Math.floor(211 + (105 - 211) * ratio);
            const b = Math.floor(252 + (161 - 252) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getExtraccionColor(vol) {
            const ratio = vol / maxVolumenExtraccion;
            const r = Math.floor(251 + (234 - 251) * ratio);
            const g = Math.floor(146 + (88 - 146) * ratio);
            const b = Math.floor(60 + (12 - 60) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getKarstColor(intensidad) {
            const ratio = (intensidad - minIntensidadKarst) / (maxIntensidadKarst - minIntensidadKarst);
            const r = Math.floor(254 + (120 - 254) * ratio);
            const g = Math.floor(243 + (53 - 243) * ratio);
            const b = Math.floor(199 + (15 - 199) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getPOELColor(politica) {
            return COLORS.poel[politica] || COLORS.poel.default;
        }

        async function checkAuthState() {
            try {
                const hash = window.location.hash;
                const hasAuthToken = hash && (hash.includes('access_token') || hash.includes('type=signup'));
                
                if (hasAuthToken) {
                    console.log('üîë Detectado token de confirmaci√≥n en URL, procesando...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error obteniendo sesi√≥n:', error);
                    showLoginSection();
                    return;
                }
                
                if (session) {
                    console.log('‚úÖ Sesi√≥n activa encontrada');
                    currentUser = session.user;
                    const { data: profile } = await supabaseClient
                        .from('proyectos_colaborativos')
                        .select('username')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    const username = profile?.username || currentUser.email.split('@')[0];
                    showUserSection(username);
                    
                    await loadCollaborativeProjects();
                    
                    if (hash) {
                        console.log('üßπ Limpiando URL...');
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                    
                    if (hasAuthToken) {
                        alert('‚úÖ Email confirmado correctamente. ¬°Bienvenido al geoportal!');
                    }
                } else {
                    console.log('‚ùå No hay sesi√≥n activa');
                    currentUser = null;
                    showLoginSection();
                }
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                showLoginSection();
            }
        }
        
        function setupAuthListener() {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('üì¢ Auth event:', event);
                
                if (event === 'SIGNED_IN') {
                    console.log('‚úÖ Usuario inici√≥ sesi√≥n');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                        await loadCollaborativeProjects();
                    }
                } else if (event === 'USER_UPDATED') {
                    console.log('üîÑ Usuario actualizado');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                    }
                } else if (event === 'SIGNED_OUT') {
                    console.log('üëã Usuario cerr√≥ sesi√≥n');
                    currentUser = null;
                    showLoginSection();
                    layerGroups.proyectosColab.clearLayers();
                    updateLayerCount('proyectos-colab', 0);
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('üîÑ Token actualizado');
                }
            });
        }

        function showLoginSection() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('add-project-section').style.display = 'none';
        }

        function showUserSection(username) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'block';
            document.getElementById('add-project-section').style.display = 'block';
            document.getElementById('username-display').textContent = username;
        }

        async function handleLogin(email, password) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;
            
            currentUser = data.user;
            const { data: profile } = await supabaseClient
                .from('proyectos_colaborativos')
                .select('username')
                .eq('user_id', currentUser.id)
                .single();
            
            const username = profile?.username || email.split('@')[0];
            showUserSection(username);
            
            document.getElementById('login-modal').style.display = 'none';
            await loadCollaborativeProjects();
        }

        async function handleRegister(username, email, password) {
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        username: username
                    }
                }
            });

            if (error) throw error;
            
            return data;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showLoginSection();
            
            layerGroups.proyectosColab.clearLayers();
            updateLayerCount('proyectos-colab', 0);
        }

        async function addProjectToMap(projectData) {
            if (!currentUser) {
                alert('Debes iniciar sesi√≥n para agregar proyectos');
                return;
            }

            const { data, error } = await supabaseClient
                .from('proyectos_colaborativos')
                .insert([{
                    user_id: currentUser.id,
                    username: currentUser.user_metadata?.username || currentUser.email.split('@')[0],
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                }])
                .select();

            if (error) throw error;

            await loadCollaborativeProjects();
            
            return data;
        }

        async function loadCollaborativeProjects() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('Tabla de proyectos colaborativos no disponible:', error.message || 'Error desconocido');
                    return;
                }

                if (data && data.length > 0) {
                    updateLayerCount('proyectos-colab', data.length);
                    renderCollaborativeProjects(data);
                    console.log(`‚úì ${data.length} proyectos colaborativos cargados`);
                } else {
                    updateLayerCount('proyectos-colab', 0);
                    console.log('No hay proyectos colaborativos todav√≠a');
                }
            } catch (e) {
                console.warn('Error cargando proyectos colaborativos:', e.message || String(e));
                updateLayerCount('proyectos-colab', 0);
            }
        }

        function renderCollaborativeProjects(data) {
            layerGroups.proyectosColab.clearLayers();
            
            const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
            
            data.forEach(item => {
                if (!item.lat || !item.lng || isNaN(item.lat) || isNaN(item.lng)) {
                    console.warn('Proyecto colaborativo sin coordenadas v√°lidas:', item);
                    return;
                }
                
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 8,
                    fillColor: COLORS.proyectosColab,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9,
                    draggable: isAdmin
                });

                const isOwner = currentUser && item.user_id === currentUser.id;
                const ownerBadge = isOwner ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">TU PROYECTO</span>' : '';
                const adminBadge = isAdmin ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">ADMIN</span>' : '';
                
                let ownerButtons = '';
                if (isOwner && !isAdmin) {
                    ownerButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <button 
                                class="edit-project-btn" 
                                data-project-id="${item.id}" 
                                type="button"
                                style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 600;
                                    pointer-events: auto;
                                    touch-action: manipulation;
                                    user-select: none;
                                "
                                onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                            >
                                ‚úèÔ∏è Editar mi proyecto
                            </button>
                        </div>
                    `;
                }
                
                let adminButtons = '';
                if (isAdmin) {
                    adminButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">‚öôÔ∏è Controles de Administrador</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <button 
                                    class="edit-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #f59e0b;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    class="move-project-btn" 
                                    data-project-id="${item.id}" 
                                    data-lat="${item.lat}" 
                                    data-lng="${item.lng}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); moveProject('${item.id}', ${item.lat}, ${item.lng});"
                                >
                                    üìç Mover
                                </button>
                                <button 
                                    class="delete-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #ef4444;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); deleteProject('${item.id}');"
                                >
                                    üóëÔ∏è Borrar
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectosColab};">
                            Proyecto Colaborativo ${ownerBadge} ${adminBadge}
                        </h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectosColab};">
                            <p><strong>Nombre:</strong> ${item.nombre_proyecto}</p>
                            ${item.descripcion ? `<p><strong>Descripci√≥n:</strong> ${item.descripcion}</p>` : ''}
                            ${item.mia ? `<p><strong>MIA:</strong> ${item.mia}</p>` : ''}
                            ${item.irregularidad ? `<p><strong>Irregularidad:</strong> ${item.irregularidad}</p>` : ''}
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">
                                üë§ Agregado por: <strong>${item.username}</strong><br>
                                üìÖ ${new Date(item.created_at).toLocaleDateString('es-MX')}<br>
                                üìç Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
                            </p>
                            ${ownerButtons}
                            ${adminButtons}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 400,
                    minWidth: 300,
                    className: 'collaborative-project-popup'
                });
                
                marker.projectId = item.id;
                marker.projectData = item;
                
                if (isAdmin) {
                    marker.on('dragend', async function(e) {
                        const newLatLng = e.target.getLatLng();
                        if (confirm('¬øMover este proyecto a la nueva ubicaci√≥n?')) {
                            try {
                                map.closePopup();
                                
                                await updateProjectLocation(item.id, newLatLng.lat, newLatLng.lng);
                                
                                await loadCollaborativeProjects();
                                
                                alert('‚úÖ Proyecto movido exitosamente');
                            } catch (error) {
                                alert('‚ùå Error al mover proyecto: ' + error.message);
                                e.target.setLatLng([item.lat, item.lng]);
                            }
                        } else {
                            e.target.setLatLng([item.lat, item.lng]);
                        }
                    });
                }
                
                marker.addTo(layerGroups.proyectosColab);
            });
        }

        async function deleteProject(projectId) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para eliminar proyectos');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este proyecto? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                map.closePopup();
                
                const { error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                await loadCollaborativeProjects();
                
                alert('‚úÖ Proyecto eliminado exitosamente');
            } catch (error) {
                console.error('Error eliminando proyecto:', error);
                alert('‚ùå Error al eliminar proyecto: ' + error.message);
            }
        }

        async function moveProject(projectId, currentLat, currentLng) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para mover proyectos');
                return;
            }
            
            map.closePopup();
            
            movingProjectMode = true;
            movingProjectId = projectId;
            
            map.getContainer().style.cursor = 'crosshair';
            
            const indicator = document.getElementById('map-click-indicator');
            if (indicator) {
                indicator.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 10px;">üìç</div>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Mover Proyecto</h3>
                    <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa en la nueva ubicaci√≥n del proyecto</p>
                    <button id="cancel-move-project" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
                        ‚ùå Cancelar
                    </button>
                `;
                indicator.style.display = 'block';
                
                document.getElementById('cancel-move-project').addEventListener('click', () => {
                    movingProjectMode = false;
                    movingProjectId = null;
                    map.getContainer().style.cursor = '';
                    indicator.style.display = 'none';
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                });
            }
        }

        async function updateProjectLocation(projectId, newLat, newLng) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({ 
                    lat: newLat, 
                    lng: newLng 
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function editProject(projectId) {
            console.log('[EDIT PROJECT] Iniciando edici√≥n de proyecto:', projectId);
            
            try {
                const project = await getProjectById(projectId);
                
                if (!project) {
                    console.error('[EDIT PROJECT] Proyecto no encontrado:', projectId);
                    alert('‚ùå Proyecto no encontrado');
                    return;
                }
                
                console.log('[EDIT PROJECT] Proyecto cargado:', project);
                
                const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
                const isOwner = currentUser && project.user_id === currentUser.id;
                
                console.log('[EDIT PROJECT] Permisos:', { isAdmin, isOwner, currentUserEmail: currentUser?.email });
                
                if (!isAdmin && !isOwner) {
                    console.error('[EDIT PROJECT] Sin permisos para editar');
                    alert('‚ùå No tienes permisos para editar este proyecto');
                    return;
                }
                
                document.getElementById('edit-project-id').value = project.id;
                document.getElementById('edit-project-nombre').value = project.nombre_proyecto || '';
                document.getElementById('edit-project-descripcion').value = project.descripcion || '';
                document.getElementById('edit-project-mia').value = project.mia || '';
                document.getElementById('edit-project-irregularidad').value = project.irregularidad || '';
                document.getElementById('edit-project-lat').value = project.lat || '';
                document.getElementById('edit-project-lng').value = project.lng || '';
                
                document.getElementById('edit-project-error').style.display = 'none';
                document.getElementById('edit-project-success').style.display = 'none';
                
                console.log('[EDIT PROJECT] Mostrando modal de edici√≥n');
                
                document.getElementById('edit-project-modal').style.display = 'flex';
            } catch (error) {
                console.error('[EDIT PROJECT] Error:', error);
                alert('‚ùå Error al cargar proyecto: ' + error.message);
            }
        }

        async function getProjectById(projectId) {
            console.log('[GET PROJECT] Buscando proyecto ID:', projectId);
            
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .eq('id', projectId)
                    .single();
                
                if (error) {
                    console.error('[GET PROJECT] Error de Supabase:', error);
                    return null;
                }
                
                console.log('[GET PROJECT] Proyecto encontrado:', data);
                return data;
            } catch (e) {
                console.error('[GET PROJECT] Excepci√≥n:', e);
                return null;
            }
        }

        async function updateProject(projectId, projectData) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function exportProjectsToCSV() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('‚ùå No hay proyectos para exportar');
                    return;
                }
                
                const headers = ['ID', 'Nombre', 'Descripci√≥n', 'MIA', 'Irregularidad', 'Latitud', 'Longitud', 'Usuario', 'Fecha de Creaci√≥n'];
                const csvRows = [headers.join(',')];
                
                data.forEach(project => {
                    const row = [
                        project.id,
                        `"${(project.nombre_proyecto || '').replace(/"/g, '""')}"`,
                        `"${(project.descripcion || '').replace(/"/g, '""')}"`,
                        `"${(project.mia || '').replace(/"/g, '""')}"`,
                        `"${(project.irregularidad || '').replace(/"/g, '""')}"`,
                        project.lat,
                        project.lng,
                        `"${project.username || ''}"`,
                        new Date(project.created_at).toLocaleString('es-MX')
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const fileName = `proyectos_colaborativos_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ ${data.length} proyectos exportados exitosamente a ${fileName}`);
            } catch (error) {
                console.error('Error exportando proyectos:', error);
                alert('‚ùå Error al exportar proyectos: ' + error.message);
            }
        }

        function formatVolume(volHm3) {
            if (volHm3 < 0.1) {
                const volM3 = volHm3 * 1000000;
                return `${volM3.toLocaleString('es-MX', {maximumFractionDigits: 2})} m¬≥/a√±o`;
            } else {
                return `${volHm3.toFixed(2)} hm¬≥/a√±o`;
            }
        }

        function calculatePolygonArea(coords) {
            if (!coords || coords.length < 3) return 0;
            
            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coords[i][1] * coords[j][0];
                area -= coords[j][1] * coords[i][0];
            }
            
            area = Math.abs(area) / 2;
            
            const metersPerDegreeLat = 110900;
            const metersPerDegreeLng = 103500;
            area = area * metersPerDegreeLat * metersPerDegreeLng;
            
            return area;
        }

        async function init

Map() {
            try {
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet no est√° cargado');
                }
                
                updateLoading('Creando mapa...');
                
                layerGroups = {
                    proyectos: L.layerGroup(),
                    proyectosColab: L.layerGroup(),
                    descargas: L.layerGroup(),
                    extracciones: L.layerGroup(),
                    cuerposAgua: L.layerGroup(),
                    piscinas: L.layerGroup(),
                    cenotesSup: L.layerGroup(),
                    cenotesSub: L.layerGroup(),
                    aguadasArt: L.layerGroup(),
                    aguadasNat: L.layerGroup(),
                    sascab: L.layerGroup(),
                    rios: L.layerGroup(),
                    karstificacion: L.layerGroup(),
                    colapsoKarst: L.layerGroup(),
                    fallasINEGI: L.layerGroup(),
                    fallasCENAPRED: L.layerGroup(),
                    poel: L.layerGroup(),
                    socioeco: L.layerGroup(),
                    municipio: L.layerGroup(),
                    pozosSinProteccion: L.layerGroup(),
                    pozosConProteccion: L.layerGroup(),
                    tierrasComunales: L.layerGroup(),
                    tierrasParceladas: L.layerGroup(),
                    nucleosAgrarios: L.layerGroup(),
                    asentamientosHumanos: L.layerGroup(),
                    fraccionamientosLegalizar: L.layerGroup()
                };
                
                map = L.map('map', {
                    center: [20.849, -86.876],
                    zoom: 12,
                    zoomControl: true
                });

                const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                });

                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19
                });

                const hybrid = L.layerGroup([
                    satellite,
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        opacity: 0.3,
                        maxZoom: 19
                    })
                ]);

                satellite.addTo(map);

                const baseMaps = {
                    "üõ∞Ô∏è Sat√©lite": satellite,
                    "üó∫Ô∏è H√≠brido": hybrid,
                    "üìç Calles": streets
                };

                L.control.layers(baseMaps, null, {
                    position: 'topright'
                }).addTo(map);

                console.log('‚úì Mapa creado');

                map.on('click', (e) => {
                    if (movingProjectMode && movingProjectId) {
                        const { lat, lng } = e.latlng;
                        
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                        }
                        
                        tempMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'temp-marker',
                                html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        if (confirm('¬øMover el proyecto a esta ubicaci√≥n?')) {
                            updateProjectLocation(movingProjectId, lat, lng)
                                .then(async () => {
                                    await loadCollaborativeProjects();
                                    alert('‚úÖ Proyecto movido exitosamente');
                                    
                                    movingProjectMode = false;
                                    movingProjectId = null;
                                    map.getContainer().style.cursor = '';
                                    document.getElementById('map-click-indicator').style.display = 'none';
                                    if (tempMarker) {
                                        map.removeLayer(tempMarker);
                                        tempMarker = null;
                                    }
                                })
                                .catch(error => {
                                    alert('‚ùå Error al mover proyecto: ' + error.message);
                                    if (tempMarker) {
                                        map.removeLayer(tempMarker);
                                        tempMarker = null;
                                    }
                                });
                        } else {
                            if (tempMarker) {
                                map.removeLayer(tempMarker);
                                tempMarker = null;
                            }
                        }
                    }
                    else if (mapClickEnabled) {
                        const { lat, lng } = e.latlng;
                        
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                        }
                        
                        tempMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'temp-marker',
                                html: '<div style="background: #9333ea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        document.getElementById('project-lat').value = lat.toFixed(6);
                        document.getElementById('project-lng').value = lng.toFixed(6);
                        
                        mapClickEnabled = false;
                        map.getContainer().style.cursor = '';
                        
                        map.eachLayer((layer) => {
                            if (layer._originalClickEvent && layer.getPopup) {
                                layer.on('click', function() {
                                    this.openPopup();
                                });
                            }
                        });
                        
                        document.getElementById('map-click-indicator').style.display = 'none';
                        document.getElementById('add-project-modal').style.display = 'flex';
                        
                        document.getElementById('enable-map-click').textContent = '‚úì Coordenadas capturadas';
                        document.getElementById('enable-map-click').style.background = '#10b981';
                        
                        setTimeout(() => {
                            document.getElementById('enable-map-click').textContent = 'üìç Activar Click en Mapa';
                            document.getElementById('enable-map-click').style.background = '#3b82f6';
                        }, 2000);
                    }
                });

                Object.values(layerGroups).forEach(group => group.addTo(map));

                await loadAllLayers();

                updateStatus('Geoportal listo ‚úì');
                hideLoading();
                console.log('=== COMPLETADO ===');

            } catch (error) {
                console.error('ERROR:', error);
                updateStatus('Error: ' + error.message);
            }
        }
async function loadAllLayers() {
            // PROYECTOS TI
            try {
                updateLoading('Cargando proyectos TI...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/proyectos_ti?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('proyectos', data.length);
                        renderProyectos(data);
                        console.log(`‚úì ${data.length} proyectos cargados`);
                    }
                }
            } catch (e) { console.error('Error proyectos:', e); }

            // DESCARGAS
            try {
                updateLoading('Cargando descargas de agua...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('clip de descarga de agua 2023')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        maxVolumenDescarga = Math.max(...data.map(d => d.vol || 0));
                        updateLayerCount('descargas', data.length);
                        renderDescargas(data);
                        console.log(`‚úì ${data.length} descargas cargadas`);
                    }
                }
            } catch (e) { console.error('Error descargas:', e); }

            // EXTRACCIONES
            try {
                updateLoading('Cargando extracciones de agua...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('clip de extracci√≥n de agua 2023')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        maxVolumenExtraccion = Math.max(...data.map(d => d.vol || 0));
                        updateLayerCount('extracciones', data.length);
                        renderExtracciones(data);
                        console.log(`‚úì ${data.length} extracciones cargadas`);
                    }
                }
            } catch (e) { console.error('Error extracciones:', e); }

            // CUERPOS DE AGUA (IAHCSA)
            try {
                updateLoading('Cargando cuerpos de agua...');
                
                const url = `${SUPABASE_URL}/rest/v1/${encodeURIComponent('IAHCSA_GEOPORTAL_TOMALASAGUAS ‚Äî indice_de_antropizacion_del_a')}?select=*`;
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('cuerpos-agua', data.length);
                        renderCuerposAgua(data);
                        console.log(`‚úì ${data.length} cuerpos de agua cargados`);
                    }
                }
            } catch (e) { console.error('Error cuerpos de agua:', e); }

            // KARSTIFICACI√ìN
            try {
                updateLoading('Cargando karstificaci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Karstificaci√≥n')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const filteredData = data.filter(d => (d.intensidad || 0) >= 5);
                        
                        const intensidades = filteredData.map(d => d.intensidad || 0).filter(i => i > 0);
                        maxIntensidadKarst = Math.max(...intensidades);
                        minIntensidadKarst = Math.min(...intensidades);
                        
                        updateLayerCount('karstificacion', filteredData.length);
                        renderKarstificacion(filteredData);
                        console.log(`‚úì ${filteredData.length} pol√≠gonos de karstificaci√≥n (medio-alto) cargados`);
                    }
                }
            } catch (e) { console.error('Error karstificaci√≥n:', e); }

            // COLAPSO POR KARSTIFICACI√ìN
            try {
                updateLoading('Cargando riesgo de colapso por karstificaci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Colapso por karstificacion ‚Äî informacin_colapso_por_uga_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('colapso-karst', data.length);
                        renderColapsoKarst(data);
                        console.log(`‚úì ${data.length} pol√≠gonos de colapso por karstificaci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error colapso por karstificaci√≥n:', e); }

            // FALLAS INEGI
            try {
                updateLoading('Cargando fallas INEGI...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Fallas (INEGI) ‚Äî clip_fallas2_inegi')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('fallas-inegi', data.length);
                        renderFallasINEGI(data);
                        console.log(`‚úì ${data.length} fallas INEGI cargadas`);
                    }
                }
            } catch (e) { console.error('Error fallas INEGI:', e); }

            // FALLAS CENAPRED
            try {
                updateLoading('Cargando fallas CENAPRED...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('fallas(CENAPRED) ‚Äî clip_fallas1_cenapred')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('fallas-cenapred', data.length);
                        renderFallasCENAPRED(data);
                        console.log(`‚úì ${data.length} fallas CENAPRED cargadas`);
                    }
                }
            } catch (e) { console.error('Error fallas CENAPRED:', e); }

            // N√öCLEOS AGRARIOS (RAN)
            try {
                updateLoading('Cargando n√∫cleos agrarios (RAN)...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('nucleos agrarios (ran) ‚Äî zo_nucleosagrarios_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('nucleos-agrarios', data.length);
                        renderNucleosAgrarios(data);
                        console.log(`‚úì ${data.length} n√∫cleos agrarios cargados`);
                    }
                }
            } catch (e) { console.error('Error n√∫cleos agrarios:', e); }

            // ASENTAMIENTOS HUMANOS (RAN)
            try {
                updateLoading('Cargando asentamientos humanos (RAN)...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zona asentamientos humanos (RAN) ‚Äî zo_asentamientoshumanos_ra')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('asentamientos-humanos', data.length);
                        renderAsentamientosHumanos(data);
                        console.log(`‚úì ${data.length} asentamientos humanos cargados`);
                    }
                }
            } catch (e) { console.error('Error asentamientos humanos:', e); }

            // FRACCIONAMIENTOS A LEGALIZAR
            try {
                updateLoading('Cargando fraccionamientos a legalizar (POEL 2024)...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('fraccionamiento que busca legalizar el poel nuevo ‚Äî fracc_poe')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('fraccionamientos-legalizar', data.length);
                        renderFraccionamientosLegalizar(data);
                        console.log(`‚úì ${data.length} fraccionamientos a legalizar cargados`);
                    }
                }
            } catch (e) { console.error('Error fraccionamientos a legalizar:', e); }

            // SOCIOECOSISTEMA
            try {
                updateLoading('Cargando socioecosistema...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('poligonos_del_socioecosistema ‚Äî shapes')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('socioeco', data.length);
                        renderSocioecosistema(data);
                        console.log(`‚úì ${data.length} pol√≠gonos socioecosistema cargados`);
                    }
                }
            } catch (e) { console.error('Error socioecosistema:', e); }

            // MUNICIPIO
            try {
                updateLoading('Cargando municipio...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('Poligono_mun_pomo ‚Äî municipio_puerto_morelos_')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('municipio', data.length);
                        renderMunicipio(data);
                        console.log(`‚úì ${data.length} l√≠mite municipal cargado`);
                    }
                }
            } catch (e) { console.error('Error municipio:', e); }

            // POZOS SIN PROTECCI√ìN
            try {
                updateLoading('Cargando pozos sin protecci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('sin protecc')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('pozos-sin', data.length);
                        renderPozosSinProteccion(data);
                        console.log(`‚úì ${data.length} pozos sin protecci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error pozos sin protecci√≥n:', e); }

            // POZOS CON PROTECCI√ìN
            try {
                updateLoading('Cargando pozos con protecci√≥n...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('protecci√≥n pozo BJ-pm')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('pozos-con', data.length);
                        renderPozosConProteccion(data);
                        console.log(`‚úì ${data.length} pozos con protecci√≥n cargados`);
                    }
                }
            } catch (e) { console.error('Error pozos con protecci√≥n:', e); }

            // TIERRAS COMUNALES EJIDALES
            try {
                updateLoading('Cargando zonas comunales ejidales...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zonas comunales ejidales ‚Äî zonas_comunales_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('tierras-comunales', data.length);
                        renderTierrasComunales(data);
                        console.log(`‚úì ${data.length} zonas comunales ejidales cargadas`);
                    }
                }
            } catch (e) { console.error('Error tierras comunales:', e); }

            // TIERRAS PARCELADAS
            try {
                updateLoading('Cargando zonas parceladas...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('zonas parceladas ‚Äî zo_parceladas_ran_copy')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('tierras-parceladas', data.length);
                        renderTierrasParceladas(data);
                        console.log(`‚úì ${data.length} zonas parceladas cargadas`);
                    }
                }
            } catch (e) { console.error('Error tierras parceladas:', e); }

            // POEL 2013
            try {
                updateLoading('Cargando y analizando POEL 2013...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent('poel_2013_ ‚Äî poel_clip_poel2013_oficial_clip_unico')}?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        updateLayerCount('poel', data.length);
                        renderPOEL(data);
                        console.log(`‚úì ${data.length} pol√≠gonos POEL cargados y analizados`);
                    }
                }
            } catch (e) { console.error('Error POEL:', e); }
        }

        function renderProyectos(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || geom.type !== 'Point') return;

                if (!geom.coordinates || geom.coordinates.length < 2) {
                    console.warn('Proyecto sin coordenadas v√°lidas:', item);
                    return;
                }

                const lat = geom.coordinates[1];
                const lng = geom.coordinates[0];
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn('Coordenadas inv√°lidas:', { lat, lng });
                    return;
                }

                allLayersData.proyectos.push({
                    lat: lat,
                    lng: lng,
                    nombre: item["Nombre_Poy"] || 'Proyecto',
                    tipo: 'Proyecto Inmobiliario-tur√≠stico'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: COLORS.proyectos,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectos};">Proyecto Inmobiliario-tur√≠stico</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectos};">
                            <p><strong>Nombre:</strong> ${item["Nombre_Poy"] || 'N/A'}</p>
                            <p><strong>MIA:</strong> ${item["MIA"] || 'N/A'}</p>
                            <p><strong>Irregularidad:</strong> ${item["¬øIlegalidad o irregularidad?"] || 'N/A'}</p>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.proyectos);
            });
        }

        function renderDescargas(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                
                if (!geom) return;
                
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    return;
                }

                const vol = item.vol || 0;
                const color = getDescargaColor(vol);

                allLayersData.descargas.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Descarga'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenDescarga) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #0369a1;">üíß Descarga de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #0369a1;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Registro:</strong> ${item.registr || 'No registrada'}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autordd || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.cuerpo ? `<p><strong>üí¶ Cuerpo Receptor:</strong> ${item.cuerpo}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.descargas);
            });
        }

        function renderExtracciones(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                
                if (!geom) return;
                
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    return;
                }

                const vol = item.vol || 0;
                const color = getExtraccionColor(vol);

                allLayersData.extracciones.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Extracci√≥n'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenExtraccion) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #ea580c;">‚ö° Extracci√≥n de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #ea580c;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Registro:</strong> ${item.registr || 'No registrada'}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autordd || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.acuifer ? `<p><strong>üíß Acu√≠fero:</strong> ${item.acuifer}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.extracciones);
            });
        }

        function renderCuerposAgua(data) {
            const counters = {
                piscinas: 0,
                cenotesSup: 0,
                cenotesSub: 0,
                aguadasArt: 0,
                aguadasNat: 0,
                sascab: 0,
                rios: 0
            };
            
            const areas = {
                piscinas: 0,
                cenotesSup: 0,
                cenotesSub: 0,
                aguadasArt: 0,
                aguadasNat: 0,
                sascab: 0,
                rios: 0
            };

            let totalArea = 0;

            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const tipo = (item.tipo || '').toLowerCase().trim();
                let color = COLORS.cuerposAgua[tipo] || COLORS.cuerposAgua.default;
                let layerGroup = null;
                let nombreTipo = '';

                const area = calculatePolygonArea(polygons[0]);
                totalArea += area;

                switch(tipo) {
                    case 'piscina':
                        layerGroup = layerGroups.piscinas;
                        counters.piscinas++;
                        areas.piscinas += area;
                        nombreTipo = 'Piscina';
                        break;
                    case 'cenote_s_a':
                        layerGroup = layerGroups.cenotesSup;
                        counters.cenotesSup++;
                        areas.cenotesSup += area;
                        nombreTipo = 'Cenote Modificado (Superficie Alterada)';
                        break;
                    case 'cenote_s_s':
                        layerGroup = layerGroups.cenotesSub;
                        counters.cenotesSub++;
                        areas.cenotesSub += area;
                        nombreTipo = 'Cenote Artificial (Superficie Subterr√°nea)';
                        break;
                    case 'aguada_a':
                        layerGroup = layerGroups.aguadasArt;
                        counters.aguadasArt++;
                        areas.aguadasArt += area;
                        nombreTipo = 'Aguada Antropizada';
                        break;
                    case 'aguada_n':
                        layerGroup = layerGroups.aguadasNat;
                        counters.aguadasNat++;
                        areas.aguadasNat += area;
                        nombreTipo = 'Aguada Natural';
                        break;
                    case 'sascab_ce':
                        layerGroup = layerGroups.sascab;
                        counters.sascab++;
                        areas.sascab += area;
                        nombreTipo = 'Sascabera';
                        break;
                    case 'rio_a':
                        layerGroup = layerGroups.rios;
                        counters.rios++;
                        areas.rios += area;
                        nombreTipo = 'R√≠o Artificial';
                        break;
                    default:
                        return;
                }

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.5
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üíß ${nombreTipo}</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Tipo:</strong> ${nombreTipo}</p>
                            <p><strong>√Årea estimada:</strong> ${area.toLocaleString('es-MX', {maximumFractionDigits: 2})} m¬≤</p>
                            ${item.nombre ? `<p><strong>Nombre:</strong> ${item.nombre}</p>` : ''}
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.cuerposAgua);
                if (layerGroup) polygon.addTo(layerGroup);

                allLayersData.cuerposAgua.push({
                    tipo: tipo,
                    area: area,
                    coordinates: polygons[0]
                });
            });

            updateLayerCount('piscinas', counters.piscinas);
            updateLayerCount('cenotes-sup', counters.cenotesSup);
            updateLayerCount('cenotes-sub', counters.cenotesSub);
            updateLayerCount('aguadas-art', counters.aguadasArt);
            updateLayerCount('aguadas-nat', counters.aguadasNat);
            updateLayerCount('sascab', counters.sascab);
            updateLayerCount('rios', counters.rios);

            document.getElementById('area-piscinas').textContent = `√Årea: ${areas.piscinas.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-cenotes-sup').textContent = `√Årea: ${areas.cenotesSup.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-cenotes-sub').textContent = `√Årea: ${areas.cenotesSub.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-aguadas-art').textContent = `√Årea: ${areas.aguadasArt.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-aguadas-nat').textContent = `√Årea: ${areas.aguadasNat.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-sascab').textContent = `√Årea: ${areas.sascab.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            document.getElementById('area-rios').textContent = `√Årea: ${areas.rios.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;

            document.getElementById('total-area-cuerpos').textContent = totalArea.toLocaleString('es-MX', {maximumFractionDigits: 0});
        }

        function renderKarstificacion(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const intensidad = item.intensidad || 0;
                const color = getKarstColor(intensidad);

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 1,
                    fillColor: color,
                    fillOpacity: 0.4
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üåã Karstificaci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Intensidad:</strong> ${intensidad}</p>
                            <p><strong>Rango:</strong> ${intensidad >= 8 ? 'Muy Alto' : intensidad >= 6 ? 'Alto' : 'Medio'}</p>
                            <p style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-top: 10px;">
                                <strong>‚ö†Ô∏è Vulnerabilidad H√≠drica:</strong> La karstificaci√≥n indica alta porosidad y permeabilidad de la roca caliza, lo que facilita la infiltraci√≥n r√°pida de contaminantes directamente al acu√≠fero sin filtraci√≥n natural.
                            </p>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.karstificacion);
            });
        }

        function renderColapsoKarst(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const rango = item.rango || 'Desconocido';
                const color = COLORS.colapsoKarst[rango] || COLORS.colapsoKarst.default;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.5,
                    dashArray: '5, 5'
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Nivel de Riesgo:</strong> ${rango}</p>
                            ${item.uga ? `<p><strong>UGA:</strong> ${item.uga}</p>` : ''}
                            <div style="background: #fee2e2; padding: 10px; border-radius: 6px; border-left: 4px solid #ef4444; margin-top: 10px;">
                                <strong>üö® Peligro de Colapso:</strong> Las √°reas con alto riesgo de colapso por karstificaci√≥n pueden experimentar hundimientos s√∫bitos del terreno debido a la disoluci√≥n de la roca caliza subyacente, especialmente cuando hay extracci√≥n excesiva de agua subterr√°nea o construcciones pesadas.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.colapsoKarst);
            });
        }

        function renderFallasINEGI(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                if (geom.type === 'LineString') {
                    const coords = geom.coordinates.map(coord => {
                        const x = coord[0];
                        const y = coord[1];
                        
                        if (isUTM(x, y)) {
                            const converted = convertUTMtoLatLon(x, y);
                            return converted ? [converted.lat, converted.lon] : null;
                        } else {
                            return [y, x];
                        }
                    }).filter(c => c !== null);

                    if (coords.length === 0) return;

                    const line = L.polyline(coords, {
                        color: COLORS.fallasINEGI,
                        weight: 3,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasINEGI};">‚ö° Falla Geol√≥gica (INEGI)</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasINEGI};">
                                <p><strong>Fuente:</strong> Instituto Nacional de Estad√≠stica y Geograf√≠a (INEGI)</p>
                                <p style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-top: 10px;">
                                    <strong>‚ö†Ô∏è Importancia:</strong> Las fallas geol√≥gicas son fracturas en la corteza terrestre que pueden representar zonas de mayor permeabilidad para contaminantes y puntos de riesgo s√≠smico.
                                </p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasINEGI);
                }
            });
        }

        function renderFallasCENAPRED(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                if (geom.type === 'LineString') {
                    const coords = geom.coordinates.map(coord => {
                        const x = coord[0];
                        const y = coord[1];
                        
                        if (isUTM(x, y)) {
                            const converted = convertUTMtoLatLon(x, y);
                            return converted ? [converted.lat, converted.lon] : null;
                        } else {
                            return [y, x];
                        }
                    }).filter(c => c !== null);

                    if (coords.length === 0) return;

                    const line = L.polyline(coords, {
                        color: COLORS.fallasCENAPRED,
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '8, 4'
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasCENAPRED};">‚ö° Falla Geol√≥gica (CENAPRED)</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasCENAPRED};">
                                <p><strong>Fuente:</strong> Centro Nacional de Prevenci√≥n de Desastres (CENAPRED)</p>
                                <p style="background: #fee2e2; padding: 10px; border-radius: 6px; border-left: 4px solid #ef4444; margin-top: 10px;">
                                    <strong>üö® Riesgo S√≠smico:</strong> CENAPRED identifica fallas con potencial s√≠smico que requieren consideraci√≥n especial en planificaci√≥n urbana y construcci√≥n.
                                </p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasCENAPRED);
                }
            });
        }

        function renderNucleosAgrarios(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const tipo = item.tipo_nucleo || 'Desconocido';
                const color = COLORS.nucleosAgrarios[tipo] || COLORS.nucleosAgrarios.default;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.3
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üèòÔ∏è N√∫cleo Agrario</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Tipo:</strong> ${tipo}</p>
                            ${item.nombre ? `<p><strong>Nombre:</strong> ${item.nombre}</p>` : ''}
                            ${item.municipio ? `<p><strong>Municipio:</strong> ${item.municipio}</p>` : ''}
                            ${item.estado ? `<p><strong>Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.ran ? `<p><strong>RAN:</strong> ${item.ran}</p>` : ''}
                            <div style="background: #ddd6fe; padding: 10px; border-radius: 6px; border-left: 4px solid #8b5cf6; margin-top: 10px;">
                                <strong>üìö ¬øQu√© es un N√∫cleo Agrario?</strong><br>
                                Los n√∫cleos agrarios (ejidos y comunidades) son formas de tenencia de la tierra reconocidas constitucionalmente en M√©xico. El Registro Agrario Nacional (RAN) certifica los derechos agrarios y delimita los territorios ejidales y comunales, proporcionando certeza jur√≠dica sobre la propiedad social de la tierra.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.nucleosAgrarios);
            });
        }

        function renderAsentamientosHumanos(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const polygon = L.polygon(polygons, {
                    color: COLORS.asentamientosHumanos,
                    weight: 2,
                    fillColor: COLORS.asentamientosHumanos,
                    fillOpacity: 0.4
                });

                const area = calculatePolygonArea(polygons[0]);

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.asentamientosHumanos};">üèòÔ∏è Asentamiento Humano (RAN)</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.asentamientosHumanos};">
                            ${item.localidad ? `<p><strong>Localidad:</strong> ${item.localidad}</p>` : ''}
                            ${item.n_a ? `<p><strong>N√∫cleo Agrario:</strong> ${item.n_a}</p>` : ''}
                            ${item.municipio ? `<p><strong>Municipio:</strong> ${item.municipio}</p>` : ''}
                            <p><strong>√Årea estimada:</strong> ${area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤</p>
                            ${item.id ? `<p><strong>ID Asentamiento:</strong> ${item.id}</p>` : ''}
                            <div style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-top: 10px;">
                                <strong>üèòÔ∏è Zona de Asentamientos Humanos:</strong><br>
                                Dentro de los ejidos y comunidades, las zonas de asentamiento humano est√°n destinadas a la vivienda y servicios de la poblaci√≥n. El RAN registra estos asentamientos para garantizar que las familias ejidatarias y comuneras tengan espacios habitacionales seguros dentro de sus n√∫cleos agrarios.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.asentamientosHumanos);
            });
        }

        function renderFraccionamientosLegalizar(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const polygon = L.polygon(polygons, {
                    color: COLORS.fraccionamientosLegalizar,
                    weight: 3,
                    fillColor: COLORS.fraccionamientosLegalizar,
                    fillOpacity: 0.5,
                    dashArray: '10, 5'
                });

                const area = calculatePolygonArea(polygons[0]);
                const areaHa = area / 10000;

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.fraccionamientosLegalizar};">‚ö†Ô∏è Fraccionamiento que Busca Legalizaci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.fraccionamientosLegalizar};">
                            ${item.nombre ? `<p><strong>Nombre:</strong> ${item.nombre}</p>` : ''}
                            ${item.poel_2024 ? `<p><strong>Pol√≠tica POEL 2024:</strong> ${item.poel_2024}</p>` : ''}
                            <p><strong>√Årea:</strong> ${areaHa.toLocaleString('es-MX', {maximumFractionDigits: 2})} hect√°reas</p>
                            <div style="background: #fee2e2; padding: 12px; border-radius: 6px; border-left: 4px solid #dc2626; margin-top: 12px;">
                                <strong style="color: #991b1b;">üö® ALERTA CIUDADANA</strong><br>
                                Este desarrollo inmobiliario se construy√≥ de manera irregular o ilegal y ahora busca ser legalizado mediante el nuevo POEL 2024. Originalmente estas √°reas no estaban destinadas para desarrollo urbano seg√∫n el POEL 2013.
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-top: 10px;">
                                <strong>üë• Participaci√≥n Ciudadana:</strong><br>
                                Durante el proceso de consulta p√∫blica del POEL 2024, los ciudadanos tienen derecho a manifestar su posici√≥n sobre estos cambios de uso de suelo. La legalizaci√≥n de desarrollos irregulares sienta precedentes peligrosos para la ordenaci√≥n territorial.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.fraccionamientosLegalizar);
            });
        }

        function renderSocioecosistema(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const descripcion = (item.descriptio || '').toLowerCase();
                const color = COLORS.socioeco[descripcion] || COLORS.socioeco.default;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.4
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üåä Zona Inundable</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Tipo:</strong> ${item.descriptio || 'No especificado'}</p>
                            ${item.area_ha ? `<p><strong>√Årea:</strong> ${parseFloat(item.area_ha).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border-left: 4px solid #0ea5e9; margin-top: 10px;">
                                <strong>üíß Importancia Hidrol√≥gica:</strong><br>
                                Las zonas inundables son √°reas cr√≠ticas para la recarga del acu√≠fero y el mantenimiento del equilibrio hidrol√≥gico. La construcci√≥n en estas √°reas impide la infiltraci√≥n natural del agua y aumenta el riesgo de inundaciones.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.socioeco);
            });
        }

        function renderMunicipio(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const polygon = L.polygon(polygons, {
                    color: COLORS.municipio,
                    weight: 3,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    dashArray: '10, 5'
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.municipio};">üó∫Ô∏è L√≠mite Municipal</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.municipio};">
                            <p><strong>Municipio:</strong> Puerto Morelos</p>
                            <p><strong>Estado:</strong> Quintana Roo</p>
                            ${item.area ? `<p><strong>√Årea:</strong> ${item.area.toLocaleString('es-MX')} m¬≤</p>` : ''}
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.municipio);
            });
        }

        function renderPozosSinProteccion(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const polygon = L.polygon(polygons, {
                    color: COLORS.pozosSinProteccion,
                    weight: 3,
                    fillColor: 'transparent',
                    fillOpacity: 0
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.pozosSinProteccion};">‚ö†Ô∏è Pozo Sin Protecci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.pozosSinProteccion};">
                            <p><strong>Estado:</strong> Sin zona de protecci√≥n establecida</p>
                            <div style="background: #fee2e2; padding: 10px; border-radius: 6px; border-left: 4px solid #ef4444; margin-top: 10px;">
                                <strong>üö® Riesgo de Contaminaci√≥n:</strong><br>
                                Este pozo no cuenta con zona de protecci√≥n oficial, lo que lo hace vulnerable a contaminaci√≥n por actividades humanas cercanas.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.pozosSinProteccion);
            });
        }

        function renderPozosConProteccion(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const polygon = L.polygon(polygons, {
                    color: COLORS.pozosConProteccion,
                    weight: 3,
                    fillColor: COLORS.pozosConProteccion,
                    fillOpacity: 0.2
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.pozosConProteccion};">‚úÖ Pozo Con Protecci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.pozosConProteccion};">
                            <p><strong>Estado:</strong> Zona de protecci√≥n establecida</p>
                            <div style="background: #d1fae5; padding: 10px; border-radius: 6px; border-left: 4px solid #10b981; margin-top: 10px;">
                                <strong>‚úì Protecci√≥n Activa:</strong><br>
                                Este pozo cuenta con zona de protecci√≥n oficial que limita actividades contaminantes en su per√≠metro.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.pozosConProteccion);
            });
        }

        function renderTierrasComunales(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const color = COLORS.tierrasEjidales.comunal;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.3
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üå≥ Zona Comunal Ejidal</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            ${item.n_a ? `<p><strong>N√∫cleo Agrario:</strong> ${item.n_a}</p>` : ''}
                            ${item.superficie ? `<p><strong>Superficie:</strong> ${parseFloat(item.superficie).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            <div style="background: #f3e8ff; padding: 10px; border-radius: 6px; border-left: 4px solid #a855f7; margin-top: 10px;">
                                <strong>üå≤ Tierras de Uso Com√∫n:</strong><br>
                                Las zonas comunales ejidales son de uso colectivo de todos los ejidatarios, destinadas principalmente a actividades forestales, ganaderas y de conservaci√≥n. No pueden ser vendidas ni enajenadas individualmente.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.tierrasComunales);
            });
        }

        function renderTierrasParceladas(data) {
            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const color = COLORS.tierrasEjidales.parcelada;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.3
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üåæ Zona Parcelada</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            ${item.n_a ? `<p><strong>N√∫cleo Agrario:</strong> ${item.n_a}</p>` : ''}
                            ${item.superficie ? `<p><strong>Superficie:</strong> ${parseFloat(item.superficie).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            <div style="background: #fed7aa; padding: 10px; border-radius: 6px; border-left: 4px solid #f97316; margin-top: 10px;">
                                <strong>üåæ Tierras Parceladas:</strong><br>
                                Las zonas parceladas son asignadas individualmente a ejidatarios para uso agr√≠cola. Aunque el ejidatario tiene derechos de uso y usufructo, la propiedad sigue siendo del ejido. Requieren autorizaci√≥n de la asamblea ejidal para cambios de uso de suelo.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.tierrasParceladas);
            });
        }

        function renderPOEL(data) {
            const politicaStats = {};

            data.forEach((item) => {
                const geom = parseGeometry(item);
                if (!geom) return;

                const polygons = parseGeoJSON(geom);
                if (!polygons || polygons.length === 0) return;

                const politica = item.poli || 'Desconocida';
                const color = getPOELColor(politica);

                politicaStats[politica] = (politicaStats[politica] || 0) + 1;

                const polygon = L.polygon(polygons, {
                    color: color,
                    weight: 1,
                    fillColor: color,
                    fillOpacity: 0.4
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">üèûÔ∏è POEL 2013 - UGA</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            ${item.uga ? `<p><strong>UGA:</strong> ${item.uga}</p>` : ''}
                            <p><strong>Pol√≠tica:</strong> ${politica}</p>
                            ${item.aprov ? `<p><strong>Aprovechamiento:</strong> ${item.aprov}</p>` : ''}
                            ${item.lineamient ? `<p><strong>Lineamiento:</strong> ${item.lineamient}</p>` : ''}
                            ${item.grado_de_a ? `<p><strong>Grado de Aprovechamiento:</strong> ${item.grado_de_a}</p>` : ''}
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border-left: 4px solid #0ea5e9; margin-top: 10px;">
                                <strong>üìã Programa de Ordenamiento Ecol√≥gico Local (POEL):</strong><br>
                                El POEL 2013 establece las pol√≠ticas de uso de suelo para Puerto Morelos. Cada Unidad de Gesti√≥n Ambiental (UGA) tiene criterios espec√≠ficos de aprovechamiento, conservaci√≥n o protecci√≥n.
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.poel);
            });

            const legendContainer = document.getElementById('legend-poel-items');
            if (legendContainer) {
                legendContainer.innerHTML = '';
                Object.entries(politicaStats)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([politica, count]) => {
                        const color = getPOELColor(politica);
                        const item = document.createElement('div');
                        item.style.cssText = 'display: flex; align-items: center; margin: 3px 0; font-size: 10px;';
                        item.innerHTML = `
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; margin-right: 6px; flex-shrink: 0;"></div>
                            <span style="flex: 1;">${politica} (${count})</span>
                        `;
                        legendContainer.appendChild(item);
                    });
            }
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const icon = document.getElementById(panelId.replace('-panel', '-toggle-icon'));
            
            if (panel.classList.contains('panel-minimized')) {
                panel.classList.remove('panel-minimized');
                if (icon) icon.textContent = '‚àí';
            } else {
                panel.classList.add('panel-minimized');
                if (icon) icon.textContent = '+';
            }
        }

        function toggleAllLayers() {
            const checkboxes = document.querySelectorAll('.layer-control input[type="checkbox"]');
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !anyChecked;
                const layerId = checkbox.id.replace('layer-', '');
                const layerGroup = getLayerGroupById(layerId);
                
                if (layerGroup) {
                    if (checkbox.checked) {
                        map.addLayer(layerGroup);
                    } else {
                        map.removeLayer(layerGroup);
                    }
                }
            });
        }

        function getLayerGroupById(layerId) {
            const mapping = {
                'proyectos': layerGroups.proyectos,
                'proyectos-colab': layerGroups.proyectosColab,
                'descargas': layerGroups.descargas,
                'extracciones': layerGroups.extracciones,
                'cuerpos-agua': layerGroups.cuerposAgua,
                'piscinas': layerGroups.piscinas,
                'cenotes-sup': layerGroups.cenotesSup,
                'cenotes-sub': layerGroups.cenotesSub,
                'aguadas-art': layerGroups.aguadasArt,
                'aguadas-nat': layerGroups.aguadasNat,
                'sascab': layerGroups.sascab,
                'rios': layerGroups.rios,
                'karstificacion': layerGroups.karstificacion,
                'colapso-karst': layerGroups.colapsoKarst,
                'fallas-inegi': layerGroups.fallasINEGI,
                'fallas-cenapred': layerGroups.fallasCENAPRED,
                'nucleos-agrarios': layerGroups.nucleosAgrarios,
                'asentamientos-humanos': layerGroups.asentamientosHumanos,
                'tierras-comunales': layerGroups.tierrasComunales,
                'tierras-parceladas': layerGroups.tierrasParceladas,
                'fraccionamientos-legalizar': layerGroups.fraccionamientosLegalizar,
                'poel': layerGroups.poel,
                'socioeco': layerGroups.socioeco,
                'municipio': layerGroups.municipio,
                'pozos-sin': layerGroups.pozosSinProteccion,
                'pozos-con': layerGroups.pozosConProteccion
            };
            
            return mapping[layerId] || null;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM cargado, esperando librer√≠as...');
            
            const waitForLibraries = setInterval(() => {
                if (typeof L !== 'undefined' && typeof supabase !== 'undefined' && typeof proj4 !== 'undefined') {
                    clearInterval(waitForLibraries);
                    
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úì Supabase cliente creado');
                    
                    setupAuthListener();
                    checkAuthState();
                    
                    initMap();
                    setupDraggable();
                }
            }, 100);

            document.querySelectorAll('.layer-control input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const layerId = this.id.replace('layer-', '');
                    const layerGroup = getLayerGroupById(layerId);
                    
                    if (layerGroup) {
                        if (this.checked) {
                            map.addLayer(layerGroup);
                        } else {
                            map.removeLayer(layerGroup);
                        }
                    }
                });
            });

            document.getElementById('show-login-btn').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'flex';
            });

            document.getElementById('show-register-btn').addEventListener('click', () => {
                document.getElementById('register-modal').style.display = 'flex';
            });

            document.getElementById('close-login-modal').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'none';
            });

            document.getElementById('close-register-modal').addEventListener('click', () => {
                document.getElementById('register-modal').style.display = 'none';
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');

                try {
                    await handleLogin(email, password);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('register-error');
                const successDiv = document.getElementById('register-success');

                try {
                    const result = await handleRegister(username, email, password);
                    
                    errorDiv.style.display = 'none';
                    successDiv.textContent = '‚úÖ Cuenta creada exitosamente. Por favor revisa tu email para confirmar tu cuenta.';
                    successDiv.style.display = 'block';
                    
                    document.getElementById('register-form').reset();
                    
                    setTimeout(() => {
                        document.getElementById('register-modal').style.display = 'none';
                        successDiv.style.display = 'none';
                    }, 5000);
                } catch (error) {
                    successDiv.style.display = 'none';
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    await handleLogout();
                }
            });

            document.getElementById('add-project-btn').addEventListener('click', () => {
                document.getElementById('add-project-modal').style.display = 'flex';
                document.getElementById('add-project-error').style.display = 'none';
                document.getElementById('add-project-success').style.display = 'none';
            });

            document.getElementById('close-add-project-modal').addEventListener('click', () => {
                document.getElementById('add-project-modal').style.display = 'none';
                document.getElementById('add-project-form').reset();
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            });

            document.getElementById('close-edit-project-modal').addEventListener('click', () => {
                document.getElementById('edit-project-modal').style.display = 'none';
                document.getElementById('edit-project-form').reset();
            });

            document.getElementById('enable-map-click').addEventListener('click', () => {
                mapClickEnabled = true;
                map.getContainer().style.cursor = 'crosshair';
                
                map.eachLayer((layer) => {
                    if (layer.getPopup && layer.off) {
                        layer._originalClickEvent = layer.listens('click');
                        layer.off('click');
                    }
                });
                
                document.getElementById('map-click-indicator').style.display = 'block';
                document.getElementById('add-project-modal').style.display = 'none';
            });

            document.getElementById('cancel-map-click').addEventListener('click', () => {
                mapClickEnabled = false;
                map.getContainer().style.cursor = '';
                
                map.eachLayer((layer) => {
                    if (layer._originalClickEvent && layer.getPopup) {
                        layer.on('click', function() {
                            this.openPopup();
                        });
                    }
                });
                
                document.getElementById('map-click-indicator').style.display = 'none';
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            });

            document.getElementById('add-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const projectData = {
                    nombre: document.getElementById('project-nombre').value,
                    descripcion: document.getElementById('project-descripcion').value,
                    mia: document.getElementById('project-mia').value,
                    irregularidad: document.getElementById('project-irregularidad').value,
                    lat: parseFloat(document.getElementById('project-lat').value),
                    lng: parseFloat(document.getElementById('project-lng').value)
                };

                if (!projectData.lat || !projectData.lng || isNaN(projectData.lat) || isNaN(projectData.lng)) {
                    document.getElementById('add-project-error').textContent = '‚ö†Ô∏è Por favor captura coordenadas v√°lidas';
                    document.getElementById('add-project-error').style.display = 'block';
                    return;
                }

                try {
                    await addProjectToMap(projectData);
                    
                    document.getElementById('add-project-success').textContent = '‚úÖ Proyecto agregado exitosamente';
                    document.getElementById('add-project-success').style.display = 'block';
                    document.getElementById('add-project-error').style.display = 'none';
                    
                    document.getElementById('add-project-form').reset();
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                    
                    setTimeout(() => {
                        document.getElementById('add-project-modal').style.display = 'none';
                        document.getElementById('add-project-success').style.display = 'none';
                    }, 2000);
                } catch (error) {
                    document.getElementById('add-project-error').textContent = '‚ùå Error: ' + error.message;
                    document.getElementById('add-project-error').style.display = 'block';
                    document.getElementById('add-project-success').style.display = 'none';
                }
            });

            document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const projectId = document.getElementById('edit-project-id').value;
                const projectData = {
                    nombre: document.getElementById('edit-project-nombre').value,
                    descripcion: document.getElementById('edit-project-descripcion').value,
                    mia: document.getElementById('edit-project-mia').value,
                    irregularidad: document.getElementById('edit-project-irregularidad').value,
                    lat: parseFloat(document.getElementById('edit-project-lat').value),
                    lng: parseFloat(document.getElementById('edit-project-lng').value)
                };

                if (!projectData.lat || !projectData.lng || isNaN(projectData.lat) || isNaN(projectData.lng)) {
                    document.getElementById('edit-project-error').textContent = '‚ö†Ô∏è Por favor ingresa coordenadas v√°lidas';
                    document.getElementById('edit-project-error').style.display = 'block';
                    return;
                }

                try {
                    await updateProject(projectId, projectData);
                    
                    document.getElementById('edit-project-success').textContent = '‚úÖ Proyecto actualizado exitosamente';
                    document.getElementById('edit-project-success').style.display = 'block';
                    document.getElementById('edit-project-error').style.display = 'none';
                    
                    await loadCollaborativeProjects();
                    
                    setTimeout(() => {
                        document.getElementById('edit-project-modal').style.display = 'none';
                        document.getElementById('edit-project-success').style.display = 'none';
                        document.getElementById('edit-project-form').reset();
                    }, 2000);
                } catch (error) {
                    document.getElementById('edit-project-error').textContent = '‚ùå Error: ' + error.message;
                    document.getElementById('edit-project-error').style.display = 'block';
                    document.getElementById('edit-project-success').style.display = 'none';
                }
            });

            document.getElementById('export-csv-btn').addEventListener('click', async () => {
                await exportProjectsToCSV();
            });
        });

        if (window.innerWidth <= 768) {
            setTimeout(() => {
                const controlPanel = document.getElementById('control-panel');
                const legendsPanel = document.getElementById('legends-panel');
                
                if (controlPanel && !controlPanel.classList.contains('panel-minimized')) {
                    togglePanel('control-panel');
                }
                if (legendsPanel && !legendsPanel.classList.contains('panel-minimized')) {
                    togglePanel('legends-panel');
                }
            }, 3000);
        }
    </script>
</body>
</html>
