<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <title>Geoportal de Toma las Aguas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Header con logo */
        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: white;
            padding: 12px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .header-title h1:hover {
            color: #667eea;
        }

        /* Botones minimizar/maximizar */
        .toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .toggle-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .panel-minimized {
            width: 50px !important;
            height: 50px !important;
            overflow: hidden !important;
            padding: 10px !important;
        }

        .panel-minimized > *:not(.toggle-btn) {
            display: none !important;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .control-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c5282;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 8px;
        }

        .control-panel h3 {
            font-size: 13px;
            margin: 15px 0 8px 0;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-control {
            margin: 6px 0;
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .layer-control:hover {
            background-color: #f7fafc;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .layer-control label {
            cursor: pointer;
            flex: 1;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .layer-count {
            margin-left: auto;
            font-size: 10px;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .layer-count.loaded {
            background: #c6f6d5;
            color: #22543d;
        }

        .color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .toggle-all {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 10px 0;
            width: 100%;
        }

        .toggle-all:hover {
            background: #3182ce;
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 250px;
        }

        .custom-popup {
            padding: 15px;
            font-family: 'Segoe UI', sans-serif;
            max-width: 100%;
            box-sizing: border-box;
        }

        .custom-popup h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .custom-popup-divider {
            border-top: 2px solid;
            padding-top: 10px;
            margin-top: 10px;
        }

        .custom-popup p {
            margin: 8px 0;
            color: #374151;
            font-size: 13px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.5;
        }

        .custom-popup strong {
            color: #1f2937;
        }

        .custom-popup a {
            word-break: break-all;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: 100%;
        }

        /* Estilos globales para todos los popups de Leaflet */
        .leaflet-popup-content-wrapper {
            overflow: hidden;
            box-sizing: border-box;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            overflow: hidden;
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Popup espec√≠fico de proyectos colaborativos */
        .collaborative-project-popup .leaflet-popup-content-wrapper {
            min-width: 300px;
            max-width: 400px;
            overflow: hidden;
        }

        .collaborative-project-popup .leaflet-popup-content {
            overflow: hidden;
            word-wrap: break-word;
        }

        /* ========== ESTILOS PARA MODAL DE BIENVENIDA ========== */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-modal.closing {
            animation: slideToHeader 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes slideToHeader {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(0.1) translateY(-90vh);
            }
        }

        .welcome-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            color: white;
            position: relative;
            transform: scale(1);
            transition: transform 0.5s ease;
        }

        .welcome-modal.closing .welcome-content {
            transform: scale(0.8);
        }

        .welcome-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.5);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 20px;
        }

        .welcome-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-style: italic;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 15px;
            display: block;
        }

        .welcome-section {
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .welcome-section h3 {
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .welcome-section p {
            font-size: 15px;
            margin-bottom: 10px;
            text-align: justify;
        }

        .highlight-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #fbbf24;
        }

        .highlight-box strong {
            color: #fbbf24;
        }

        .alert-box {
            background: rgba(239, 68, 68, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .features-list li:before {
            content: "üíß";
            position: absolute;
            left: 0;
        }

        .close-welcome-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .close-welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: #fbbf24;
            color: white;
        }

        /* Scrollbar personalizado para modal */
        .welcome-content::-webkit-scrollbar {
            width: 10px;
        }

        .welcome-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .welcome-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* ========== MEJORA PARA PANELES ARRASTRABLES ========== */
        .header {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .panel-minimized {
            cursor: move !important;
            user-select: none;
        }

        .panel-minimized.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        }

        .control-panel, .legends-panel {
            transition: box-shadow 0.3s;
        }

        /* ========== RESPONSIVE DESIGN PARA M√ìVILES ========== */
        @media (max-width: 768px) {
            /* Ajustar paneles laterales en m√≥vil - M√ÅS PEQUE√ëOS */
            .control-panel, .legends-panel {
                max-width: 90vw !important;
                max-height: 70vh !important;
                width: auto !important;
                font-size: 13px;
                overflow-y: auto;
            }

            /* Hacer el control panel m√°s compacto */
            .control-panel {
                padding: 12px;
                top: 10px;
                left: 10px;
                max-width: 85vw !important;
            }

            /* Panel de leyendas - M√ÅS COMPACTO */
            .legends-panel {
                right: 10px;
                bottom: 10px !important;
                top: auto !important;
                padding: 12px;
                max-width: 85vw !important;
                max-height: 60vh !important;
            }

            /* Hacer los botones de toggle M√ÅS GRANDES y VISIBLES */
            .toggle-btn {
                width: 44px !important;
                height: 44px !important;
                font-size: 20px !important;
                top: 5px !important;
                right: 5px !important;
                background: #ef4444 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .toggle-btn:active {
                transform: scale(0.95);
            }

            /* Panel minimizado M√ÅS GRANDE para f√°cil tap */
            .panel-minimized {
                width: 70px !important;
                height: 70px !important;
                padding: 10px !important;
            }

            /* Ajustar tama√±o de botones para touch */
            .layer-control {
                padding: 10px 12px;
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
            }

            .layer-control input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            /* Ajustar controles de capas */
            .control-panel h3 {
                font-size: 15px;
                margin: 15px 0 10px 0;
            }

            /* Hacer los botones m√°s grandes para m√≥vil */
            button {
                min-height: 44px;
                font-size: 14px !important;
                padding: 10px 15px !important;
            }

            /* Modal de agregar/editar proyecto responsive */
            #add-project-modal > div,
            #edit-project-modal > div {
                width: 95% !important;
                max-width: 95% !important;
                padding: 20px !important;
                margin: 10px;
                max-height: 90vh !important;
            }

            /* Inputs m√°s grandes en m√≥vil */
            input, textarea, select {
                font-size: 16px !important; /* Evita zoom autom√°tico en iOS */
                padding: 12px !important;
                min-height: 44px;
            }

            /* Ajustar grid de coordenadas */
            #add-project-modal input[type="number"],
            #edit-project-modal input[type="number"] {
                font-size: 14px !important;
            }

            /* Popups m√°s peque√±os en m√≥vil */
            .leaflet-popup-content-wrapper {
                max-width: calc(100vw - 60px) !important;
            }

            .collaborative-project-popup .leaflet-popup-content-wrapper {
                min-width: auto !important;
                max-width: calc(100vw - 60px) !important;
            }

            .custom-popup {
                font-size: 12px;
                padding: 12px;
            }

            .custom-popup h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .custom-popup p {
                font-size: 12px;
                margin: 6px 0;
            }

            .custom-popup button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            /* Indicador de captura de coordenadas en m√≥vil */
            #map-click-indicator {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: calc(100vw - 20px);
                padding: 15px;
            }

            #map-click-indicator h3 {
                font-size: 14px;
            }

            #map-click-indicator p {
                font-size: 11px;
            }

            /* Ajustar panel de usuario */
            #user-section {
                font-size: 11px;
            }

            #user-section button {
                font-size: 11px !important;
                padding: 8px !important;
                min-height: 40px;
            }

            /* Hacer el t√≠tulo m√°s peque√±o */
            .control-panel h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            /* Layer count badges */
            .layer-count {
                min-width: 28px;
                height: 28px;
                font-size: 12px;
            }

            /* Bot√≥n de minimizar/maximizar m√°s grande */
            .toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            /* Panel minimizado m√°s grande en m√≥vil */
            .panel-minimized {
                width: 60px !important;
                height: 60px !important;
            }

            /* Ocultar algunos elementos cuando el espacio es limitado */
            .welcome-modal {
                padding: 20px;
                max-width: 90%;
            }

            .welcome-modal h1 {
                font-size: 22px;
            }

            .welcome-modal p {
                font-size: 14px;
            }

            /* Ajustar modales de login/registro */
            #login-modal > div,
            #register-modal > div {
                width: 95% !important;
                padding: 20px !important;
                max-height: 90vh;
            }

            /* Hacer los formularios m√°s espaciados en m√≥vil */
            form > div {
                margin-bottom: 12px !important;
            }

            label {
                font-size: 13px !important;
            }
        }

        /* Para pantallas muy peque√±as (tel√©fonos en portrait) */
        @media (max-width: 480px) {
            .control-panel, .legends-panel {
                font-size: 12px;
                padding: 12px;
            }

            .control-panel h2 {
                font-size: 14px;
            }

            .control-panel h3 {
                font-size: 13px;
            }

            button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }

            .layer-control {
                padding: 8px 10px;
            }

            /* Hacer los popups a√∫n m√°s peque√±os */
            .custom-popup {
                font-size: 11px;
                padding: 10px;
            }

            .custom-popup h3 {
                font-size: 13px;
            }

            .custom-popup p {
                font-size: 11px;
            }

            /* Botones en popups m√°s peque√±os */
            .custom-popup button {
                font-size: 10px !important;
                padding: 5px 8px !important;
                min-height: 32px !important;
            }

            /* Grid de botones de admin en una columna */
            .custom-popup button[onclick*="editProject"],
            .custom-popup button[onclick*="moveProject"],
            .custom-popup button[onclick*="deleteProject"] {
                width: 100%;
                margin-bottom: 4px;
            }

            /* T√≠tulo del geoportal m√°s peque√±o */
            .welcome-modal h1 {
                font-size: 18px;
            }

            /* Indicador de captura m√°s compacto */
            #map-click-indicator {
                padding: 12px;
            }

            #map-click-indicator div[style*="font-size: 32px"] {
                font-size: 24px !important;
            }
        }

        /* M√≥viles en modo HORIZONTAL (landscape) - espacio vertical muy limitado */
        @media (max-width: 896px) and (max-height: 450px) and (orientation: landscape) {
            /* Paneles a√∫n m√°s peque√±os en landscape */
            .control-panel, .legends-panel {
                max-width: 45vw !important;
                max-height: 85vh !important;
                font-size: 11px !important;
                padding: 10px !important;
            }

            .control-panel {
                max-width: 40vw !important;
            }

            .legends-panel {
                max-width: 40vw !important;
                bottom: 5px !important;
                right: 5px !important;
            }

            /* T√≠tulos m√°s peque√±os */
            .control-panel h2,
            .control-panel h3,
            .legends-panel h3 {
                font-size: 12px !important;
                margin: 5px 0 !important;
            }

            /* Layer controls m√°s compactos */
            .layer-control {
                padding: 6px 8px !important;
                min-height: 36px !important;
                font-size: 11px !important;
            }

            /* Botones m√°s peque√±os */
            button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-height: 36px !important;
            }

            /* Toggle button */
            .toggle-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }

            /* Panel minimizado m√°s peque√±o */
            .panel-minimized {
                width: 55px !important;
                height: 55px !important;
            }

            /* Modales m√°s peque√±os */
            #add-project-modal > div,
            #edit-project-modal > div {
                max-height: 85vh !important;
                padding: 15px !important;
            }

            /* Leyendas m√°s compactas */
            .legends-panel > div {
                margin-bottom: 8px !important;
            }

            .legends-panel strong {
                font-size: 10px !important;
            }
        }

        /* Para tablets en modo landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                max-width: 350px;
            }

            .legends-panel {
                max-width: 350px;
            }
        }
    </style>
</head>
<body>
    <!-- ========== MODAL DE BIENVENIDA ========== -->
    <div id="welcome-modal" class="welcome-modal">
        <div class="welcome-content">
            <!-- PEGAR AQU√ç EL C√ìDIGO BASE64 DE LA IMAGEN DEL LOGO -->
            <img src="data:image/webp;base64,PEGAR_AQUI_CODIGO_BASE64_LOGO" 
             alt="Toma las Aguas" class="welcome-logo">
            <span class="welcome-icon">üåäüíßüèùÔ∏è</span>
            
            <div class="welcome-header">
                <h2>Bienvenido al Geoportal Toma las Aguas</h2>
                <p class="subtitle">Transparencia y Participaci√≥n Ciudadana para la Seguridad H√≠drica de Puerto Morelos</p>
            </div>

            <div class="welcome-section">
                <h3>üó∫Ô∏è ¬øPor qu√© este geoportal?</h3>
                <p>Puerto Morelos se encuentra en una de las zonas m√°s vulnerables hidrol√≥gicamente de la Pen√≠nsula de Yucat√°n. Este territorio descansa sobre un <strong>acu√≠fero k√°rstico</strong>, un sistema geol√≥gico extraordinariamente fr√°gil donde el agua se filtra directamente a trav√©s de roca caliza porosa hacia nuestro √∫nico reservorio de agua dulce.</p>
            </div>

            <div class="alert-box">
                <h3>‚ö†Ô∏è Crisis de Seguridad H√≠drica</h3>
                <p>El acelerado desarrollo inmobiliario est√° generando una <strong>crisis sin precedentes</strong>:</p>
                <ul class="features-list">
                    <li>Sobreexplotaci√≥n del acu√≠fero mediante extracci√≥n masiva</li>
                    <li>Contaminaci√≥n directa por lixiviados y aguas residuales mal tratadas</li>
                    <li>Destrucci√≥n de cenotes y sistemas de infiltraci√≥n natural</li>
                    <li>P√©rdida irreversible de selva que regula el ciclo hidrol√≥gico</li>
                    <li>Intrusi√≥n salina por extracci√≥n excesiva en zona costera</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üî¨ Fragilidad del Sistema K√°rstico</h3>
                <p>A diferencia de otros acu√≠feros, el sistema k√°rstico de Quintana Roo <strong>no filtra contaminantes</strong>. Las fracturas, cavernas y r√≠os subterr√°neos permiten que cualquier contaminante llegue directamente al agua que consumimos. Una vez contaminado, <strong>la remediaci√≥n es pr√°cticamente imposible</strong>.</p>
            </div>

            <div class="alert-box">
                <h3>üè≠ Extracci√≥n de Agua y Consecuencias Regionales</h3>
                <p>Los sistemas de extracci√≥n de agua en Puerto Morelos no solo abastecen a nuestra poblaci√≥n local, sino que tambi√©n proveen agua a <strong>Canc√∫n y su Aeropuerto Internacional</strong>. Esta extracci√≥n masiva genera:</p>
                <ul class="features-list">
                    <li><strong>Presi√≥n adicional sobre el acu√≠fero</strong> que excede su capacidad de recarga natural</li>
                    <li><strong>Riesgo elevado de intrusi√≥n salina</strong> en la zona costera por el descenso del nivel fre√°tico</li>
                    <li><strong>Impacto desproporcionado</strong> en nuestro territorio mientras otros municipios se benefician del recurso</li>
                </ul>
            </div>

            <div class="highlight-box">
                <h3>üó∫Ô∏è La Fractura Holbox-Xel-H√° y Nuestra Reserva Estrat√©gica</h3>
                <p>Puerto Morelos se encuentra sobre la <strong>Fractura Holbox-Xel-H√°</strong>, una l√≠nea geol√≥gica de m√°s de 300 kil√≥metros que divide el estado de Quintana Roo en dos y pasa directamente por Leona Vicario. Esta fractura es m√°s que una caracter√≠stica geol√≥gica:</p>
                <ul class="features-list">
                    <li>Representa la <strong>reserva de agua m√°s importante del norte de Quintana Roo</strong></li>
                    <li>Es un corredor hidrogeol√≥gico fundamental que alimenta los sistemas de recarga del acu√≠fero</li>
                    <li><strong>Provee agua a m√°s de 1.5 millones de habitantes</strong> de la zona tur√≠stica m√°s importante de M√©xico</li>
                    <li>Constituye la <strong>mayor capacidad de almacenamiento de agua</strong> del noreste peninsular</li>
                    <li>Su protecci√≥n es <strong>estrat√©gica para la seguridad h√≠drica</strong> de toda la Riviera Maya</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Por esta raz√≥n, Puerto Morelos debe ser reconocido como un municipio proveedor de agua</strong>, con normativas especiales de protecci√≥n ambiental, ordenamiento territorial estricto y compensaciones por los servicios ecosist√©micos que brinda a la regi√≥n.</p>
            </div>

            <div class="highlight-box">
                <h3>üí° La Informaci√≥n es Poder</h3>
                <p><strong>Este geoportal democratiza el acceso a informaci√≥n geoespacial cr√≠tica</strong> que tradicionalmente ha estado dispersa o inaccesible para la ciudadan√≠a. Integramos datos sobre:</p>
                <ul class="features-list">
                    <li>Desarrollos inmobiliarios y su impacto territorial</li>
                    <li>Zonas de karstificaci√≥n y vulnerabilidad acu√≠fera</li>
                    <li>Cenotes, lagunas y cuerpos de agua amenazados</li>
                    <li>Fallas geol√≥gicas y riesgo s√≠smico</li>
                    <li>√Åreas naturales protegidas y su cumplimiento</li>
                    <li>An√°lisis socioecon√≥mico del territorio</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üë• Participaci√≥n Ciudadana</h3>
                <p>Al <strong>registrarte e iniciar sesi√≥n</strong>, podr√°s:</p>
                <ul class="features-list">
                    <li>Reportar nuevos desarrollos inmobiliarios que detectes</li>
                    <li>Documentar irregularidades ambientales</li>
                    <li>Verificar si existe Manifestaci√≥n de Impacto Ambiental (MIA)</li>
                    <li>Contribuir a un mapeo colaborativo del territorio</li>
                    <li>Acceder a an√°lisis espaciales actualizados</li>
                </ul>
            </div>

            <div class="welcome-section">
                <h3>üéØ Nuestro Objetivo</h3>
                <p>Hacer <strong>p√∫blica, din√°mica y colaborativa</strong> la informaci√≥n sobre el estado de nuestro territorio. Solo con transparencia y participaci√≥n ciudadana informada podremos:</p>
                <ul class="features-list">
                    <li>Exigir cumplimiento de normativas ambientales</li>
                    <li>Presionar por un desarrollo territorial sostenible</li>
                    <li>Proteger nuestro acu√≠fero para generaciones futuras</li>
                    <li>Construir resiliencia h√≠drica comunitaria</li>
                </ul>
            </div>

            <div class="highlight-box">
                <p style="text-align: center; font-size: 16px;"><strong>El agua es vida. El territorio es comunidad. La informaci√≥n es poder.</strong></p>
            </div>

            <button class="close-welcome-btn" onclick="closeWelcome()">
                üöÄ Comenzar a Explorar el Geoportal
            </button>
        </div>
    </div>

    <!-- Header con logo -->
    <div class="header">
        <!-- PEGAR AQU√ç EL C√ìDIGO BASE64 DE LA IMAGEN DEL LOGO -->
        <img src="data:image/webp;base64,PEGAR_AQUI_CODIGO_BASE64_LOGO" 
             alt="Toma las Aguas" class="header-logo">
        <div class="header-title">
            <h1 onclick="openWelcome()">Geoportal de Toma las Aguas</h1>
        </div>
    </div>

    <div id="map"></div>

    <div class="loading-overlay" id="loading">
        <div style="text-align: center; background: white; padding: 30px; border-radius: 8px;">
            <div class="spinner"></div>
            <h3 style="color: #2c5282; margin-bottom: 10px;">Cargando Geoportal</h3>
            <p id="loading-text" style="color: #718096; font-size: 14px;">Iniciando...</p>
        </div>
    </div>

    <div class="control-panel" id="control-panel">
        <button class="toggle-btn" onclick="togglePanel('control-panel')" title="Minimizar/Maximizar">
            <span id="control-toggle-icon">‚àí</span>
        </button>
        <h2>üõ∞Ô∏è Geoportal <span class="success-badge">SATELITAL</span></h2>

        <button class="toggle-all" onclick="toggleAllLayers()">‚úì Activar/Desactivar Todas</button>
        
        <h3>üèóÔ∏è Desarrollo Urbano</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos" checked>
            <label for="layer-proyectos">
                <span class="color-indicator" style="background-color: #e53e3e;"></span>
                Proyectos Inmobiliarios-tur√≠sticos
            </label>
            <span class="layer-count" id="count-proyectos">0</span>
        </div>

        <div class="layer-control">
            <input type="checkbox" id="layer-proyectos-colab" checked>
            <label for="layer-proyectos-colab">
                <span class="color-indicator" style="background-color: #9333ea;"></span>
                Proyectos Colaborativos
            </label>
            <span class="layer-count" id="count-proyectos-colab">0</span>
        </div>
        
        <div id="add-project-section" style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 4px; display: none;">
            <button id="add-project-btn" style="width: 100%; padding: 8px; background: #9333ea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                ‚ûï Agregar Proyecto
            </button>
            <p style="font-size: 10px; color: #6b7280; margin: 5px 0 0 0; text-align: center;">Haz click en el mapa o ingresa coordenadas</p>
        </div>
        
        <div id="login-section" style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 4px; border: 1px solid #fbbf24;">
            <p style="font-size: 11px; color: #78350f; margin: 0 0 8px 0; font-weight: 600;">Inicia sesi√≥n para colaborar</p>
            <button id="show-login-btn" style="width: 100%; padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 5px;">
                üîê Iniciar Sesi√≥n
            </button>
            <button id="show-register-btn" style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                üìù Registrarse
            </button>
        </div>
        
        <div id="user-section" style="margin: 10px 0; padding: 10px; background: #d1fae5; border-radius: 4px; border: 1px solid #10b981; display: none;">
            <p style="font-size: 11px; color: #065f46; margin: 0 0 8px 0;">
                üë§ <strong id="username-display"></strong>
            </p>
            <button id="export-csv-btn" style="width: 100%; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-bottom: 5px; font-weight: 600;">
                üìä Exportar Proyectos a CSV
            </button>
            <button id="logout-btn" style="width: 100%; padding: 6px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                Cerrar Sesi√≥n
            </button>
        </div>

        <h3>üíß Agua</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-descargas" checked>
            <label for="layer-descargas">
                <span class="color-indicator" style="background: linear-gradient(90deg, #7dd3fc, #0369a1);"></span>
                Descargas 2023
            </label>
            <span class="layer-count" id="count-descargas">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-extracciones" checked>
            <label for="layer-extracciones">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fb923c, #ea580c);"></span>
                Extracciones 2023
            </label>
            <span class="layer-count" id="count-extracciones">0</span>
        </div>

        <h3>üåä Cuerpos de Agua (IAHCSA)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-cuerpos-agua" checked>
            <label for="layer-cuerpos-agua">
                <span class="color-indicator" style="background: linear-gradient(135deg, #3b82f6, #10b981);"></span>
                Todos los Cuerpos de Agua
            </label>
            <span class="layer-count" id="count-cuerpos-agua">0</span>
        </div>
        <div id="cuerpos-agua-summary" style="padding: 8px 8px 8px 28px; font-size: 11px; color: #4a5568; background: #f7fafc; border-radius: 4px; margin: 5px 0 10px 0;">
            <strong>Total:</strong> <span id="total-area-cuerpos">0</span> m¬≤
        </div>
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-piscinas" checked>
            <label for="layer-piscinas">
                <span class="color-indicator" style="background-color: #ec4899;"></span>
                Piscinas
            </label>
            <span class="layer-count" id="count-piscinas">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-piscinas"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sup" checked>
            <label for="layer-cenotes-sup">
                <span class="color-indicator" style="background-color: #10b981;"></span>
                Cenotes Modificados
            </label>
            <span class="layer-count" id="count-cenotes-sup">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sup"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-cenotes-sub" checked>
            <label for="layer-cenotes-sub">
                <span class="color-indicator" style="background-color: #ef4444;"></span>
                Cenotes Artificiales
            </label>
            <span class="layer-count" id="count-cenotes-sub">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-cenotes-sub"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-art" checked>
            <label for="layer-aguadas-art">
                <span class="color-indicator" style="background-color: #3b82f6;"></span>
                Aguadas Antropizadas
            </label>
            <span class="layer-count" id="count-aguadas-art">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-art"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-aguadas-nat" checked>
            <label for="layer-aguadas-nat">
                <span class="color-indicator" style="background-color: #8b5cf6;"></span>
                Aguadas Naturales
            </label>
            <span class="layer-count" id="count-aguadas-nat">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-aguadas-nat"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-sascab" checked>
            <label for="layer-sascab">
                <span class="color-indicator" style="background-color: #f59e0b;"></span>
                Sascaberas
            </label>
            <span class="layer-count" id="count-sascab">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-sascab"></div>
        
        <div class="layer-control" style="padding-left: 20px;">
            <input type="checkbox" id="layer-rios" checked>
            <label for="layer-rios">
                <span class="color-indicator" style="background-color: #06b6d4;"></span>
                R√≠os Artificiales
            </label>
            <span class="layer-count" id="count-rios">0</span>
        </div>
        <div style="padding-left: 40px; font-size: 10px; color: #6b7280; margin-bottom: 3px;" id="area-rios"></div>

        <h3>üåä Geolog√≠a e Hidrolog√≠a</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-karstificacion" checked>
            <label for="layer-karstificacion">
                <span class="color-indicator" style="background: linear-gradient(90deg, #fef3c7, #78350f);"></span>
                Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-karstificacion">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-colapso-karst" checked>
            <label for="layer-colapso-karst">
                <span class="color-indicator" style="background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00);"></span>
                ‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n
            </label>
            <span class="layer-count" id="count-colapso-karst">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-inegi" checked>
            <label for="layer-fallas-inegi">
                <span class="color-indicator" style="background-color: #9f7aea;"></span>
                Fallas INEGI
            </label>
            <span class="layer-count" id="count-fallas-inegi">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-fallas-cenapred" checked>
            <label for="layer-fallas-cenapred">
                <span class="color-indicator" style="background-color: #ed64a6;"></span>
                Fallas CENAPRED
            </label>
            <span class="layer-count" id="count-fallas-cenapred">0</span>
        </div>

        <h3>üèûÔ∏è Ordenamiento</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-poel" checked>
            <label for="layer-poel">
                <span class="color-indicator" style="background: linear-gradient(135deg, #0ea5e9, #1e3a8a);"></span>
                POEL 2013
            </label>
            <span class="layer-count" id="count-poel">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-socioeco" checked>
            <label for="layer-socioeco">
                <span class="color-indicator" style="background: linear-gradient(135deg, #10b981, #0891b2);"></span>
                Zonas Inundables
            </label>
            <span class="layer-count" id="count-socioeco">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-municipio" checked>
            <label for="layer-municipio">
                <span class="color-indicator" style="background-color: rgba(74, 85, 104, 0.3); border: 2px solid #4a5568;"></span>
                L√≠mite Municipal
            </label>
            <span class="layer-count" id="count-municipio">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-sin" checked>
            <label for="layer-pozos-sin">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #ef4444;"></span>
                Pozos sin Protecci√≥n
            </label>
            <span class="layer-count" id="count-pozos-sin">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-pozos-con" checked>
            <label for="layer-pozos-con">
                <span class="color-indicator" style="background-color: transparent; border: 3px solid #10b981;"></span>
                Pozos con Protecci√≥n
            </label>
            <span class="layer-count" id="count-pozos-con">0</span>
        </div>

        <h3>üèòÔ∏è Registro Agrario Nacional (RAN)</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-nucleos-agrarios" checked>
            <label for="layer-nucleos-agrarios">
                <span class="color-indicator" style="background-color: #6366f1;"></span>
                N√∫cleos Agrarios
            </label>
            <span class="layer-count" id="count-nucleos-agrarios">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-asentamientos-humanos" checked>
            <label for="layer-asentamientos-humanos">
                <span class="color-indicator" style="background-color: #ec4899;"></span>
                Asentamientos Humanos
            </label>
            <span class="layer-count" id="count-asentamientos-humanos">0</span>
        </div>
        
        <h3>‚ö†Ô∏è POEL/PDU 2024</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-fraccionamientos-poel" checked>
            <label for="layer-fraccionamientos-poel">
                <span class="color-indicator" style="background-color: #ef4444; border: 2px dashed #991b1b;"></span>
                Fraccionamientos a Legalizar
            </label>
            <span class="layer-count" id="count-fraccionamientos-poel">0</span>
        </div>

        <h3>üèòÔ∏è Tierras Ejidales</h3>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-comunales" checked>
            <label for="layer-tierras-comunales">
                <span class="color-indicator" style="background-color: #a855f7;"></span>
                Zonas Comunales Ejidales
            </label>
            <span class="layer-count" id="count-tierras-comunales">0</span>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="layer-tierras-parceladas" checked>
            <label for="layer-tierras-parceladas">
                <span class="color-indicator" style="background-color: #f97316;"></span>
                Zonas Parceladas
            </label>
            <span class="layer-count" id="count-tierras-parceladas">0</span>
        </div>
    </div>

    <!-- Panel de Leyendas -->
    <div id="legends-panel" class="legends-panel" style="position: absolute; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000; font-size: 11px;">
        <button class="toggle-btn" onclick="togglePanel('legends-panel')" title="Minimizar/Maximizar" style="top: 8px; right: 8px;">
            <span id="legends-toggle-icon">‚àí</span>
        </button>
        <h3 style="font-size: 14px; margin: 0 0 10px 0; color: #2c5282; border-bottom: 2px solid #4299e1; padding-bottom: 5px;">Leyendas</h3>
        
        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Volumen de Agua (hm¬≥/a√±o)</strong>
            <div style="margin-top: 5px;">
                <div style="font-size: 10px; font-weight: 600; color: #0369a1; margin-bottom: 2px;">Descargas</div>
                <div style="height: 12px; background: linear-gradient(90deg, #7dd3fc, #0369a1); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
            <div style="margin-top: 8px;">
                <div style="font-size: 10px; font-weight: 600; color: #ea580c; margin-bottom: 2px;">Extracciones</div>
                <div style="height: 12px; background: linear-gradient(90deg, #fb923c, #ea580c); border-radius: 3px; margin-bottom: 3px;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                    <span>Bajo</span><span>Alto</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px; color: #4a5568;">Intensidad de Karstificaci√≥n (medio a muy alto)</strong>
            <div style="height: 12px; background: linear-gradient(90deg, #fef3c7, #78350f); border-radius: 3px; margin: 5px 0 3px 0;"></div>
            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #6b7280;">
                <span>Medio</span><span>Muy Alto</span>
            </div>
        </div>

        <div style="margin-bottom: 12px;" id="legend-poel-section">
            <strong style="font-size: 11px; color: #4a5568;">POEL 2013 - UGAs por Pol√≠tica</strong>
            <div id="legend-poel-items" style="margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div>
            <strong style="font-size: 11px; color: #4a5568;">Cuerpos de Agua (IAHCSA)</strong>
            <div style="margin-top: 5px; font-size: 10px;">
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Piscinas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Modificados</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Cenotes Artificiales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Antropizadas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Aguadas Naturales</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin-right: 6px;"></div>
                    <span>Sascaberas</span>
                </div>
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <div style="width: 12px; height: 12px; background: #06b6d4; border-radius: 2px; margin-right: 6px;"></div>
                    <span>R√≠os Artificiales</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üîê Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="login-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a</label>
                    <input type="password" id="login-password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="login-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Entrar
                    </button>
                    <button type="button" id="close-login-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="register-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üìù Registrarse</h2>
            <form id="register-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre de Usuario</label>
                    <input type="text" id="register-username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Email</label>
                    <input type="email" id="register-email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Contrase√±a (m√≠nimo 6 caracteres)</label>
                    <input type="password" id="register-password" required minlength="6" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div id="register-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="register-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Crear Cuenta
                    </button>
                    <button type="button" id="close-register-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Agregar Proyecto -->
    <div id="add-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚ûï Agregar Proyecto Inmobiliario-tur√≠stico</h2>
            <form id="add-project-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="Opcional">
                    </div>
                </div>
                <div style="padding: 12px; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; margin-bottom: 15px;">
                    <p style="margin: 0; font-size: 12px; color: #1e40af;">
                        üí° <strong>Tip:</strong> Haz click en el mapa para capturar las coordenadas autom√°ticamente
                    </p>
                    <button type="button" id="enable-map-click" style="margin-top: 8px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                        üìç Activar Click en Mapa
                    </button>
                </div>
                <div id="add-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="add-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üíæ Guardar Proyecto
                    </button>
                    <button type="button" id="close-add-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Editar Proyecto -->
    <div id="edit-project-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">‚úèÔ∏è Editar Proyecto</h2>
            <form id="edit-project-form">
                <input type="hidden" id="edit-project-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nombre del Proyecto *</label>
                    <input type="text" id="edit-project-nombre" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Descripci√≥n</label>
                    <textarea id="edit-project-descripcion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">MIA</label>
                    <input type="text" id="edit-project-mia" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">¬øIlegalidad o irregularidad?</label>
                    <input type="text" id="edit-project-irregularidad" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Latitud</label>
                        <input type="number" id="edit-project-lat" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Longitud</label>
                        <input type="number" id="edit-project-lng" step="any" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <div id="edit-project-error" style="display: none; padding: 10px; background: #fee; border: 1px solid #f88; border-radius: 6px; margin-bottom: 15px; color: #c00; font-size: 13px;"></div>
                <div id="edit-project-success" style="display: none; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 13px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        ‚úÖ Actualizar Proyecto
                    </button>
                    <button type="button" id="close-edit-project-modal" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Indicador flotante para modo de captura de coordenadas -->
    <div id="map-click-indicator" style="display: none; position: fixed; top: 100px; right: 20px; z-index: 10001; background: rgba(147, 51, 234, 0.95); color: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(10px); pointer-events: none; max-width: 280px;">
        <div style="font-size: 32px; margin-bottom: 10px;">üéØ</div>
        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Modo Captura Activado</h3>
        <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa para seleccionar la ubicaci√≥n</p>
        <button id="cancel-map-click" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
            ‚ùå Cancelar
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Proj4js para conversi√≥n de coordenadas UTM a WGS84 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <script>
        console.log('=== GEOPORTAL PUERTO MORELOS - VISTA SATELITAL ===');

        const SUPABASE_URL = 'https://mrniyxyurgbpfqfuzgws.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ybml5eHl1cmdicGZxZnV6Z3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTI1OTgsImV4cCI6MjA4MDk4ODU5OH0.tkZIuDNUreGSqLL0JvuzJepZEfducQ3L5N4BS7Jxv4M';

        // Definir proyecciones para conversi√≥n de coordenadas
        // EPSG:32616 es UTM Zone 16N (usado en Quintana Roo, M√©xico)
        const UTM_ZONE_16N = '+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs';
        const WGS84 = 'EPSG:4326'; // Lat/Lon est√°ndar
        
        // Funci√≥n para detectar si coordenadas son UTM
        function isUTM(x, y) {
            // UTM en esta zona tiene valores aproximados:
            // X (Easting): 400,000 - 700,000
            // Y (Northing): 2,200,000 - 2,400,000
            return Math.abs(x) > 1000 || Math.abs(y) > 1000;
        }
        
        // Funci√≥n para convertir coordenadas UTM a Lat/Lon
        function convertUTMtoLatLon(x, y) {
            try {
                if (typeof proj4 === 'undefined') {
                    console.error('proj4 no est√° cargado');
                    return null;
                }
                
                const result = proj4(UTM_ZONE_16N, WGS84, [x, y]);
                return {
                    lon: result[0],
                    lat: result[1]
                };
            } catch (e) {
                console.error('Error convirtiendo coordenadas:', e);
                return null;
            }
        }

        // Variables globales (se inicializar√°n cuando las librer√≠as est√©n cargadas)
        let map;
        let layerGroups;
        let supabaseClient;

        const COLORS = {
            proyectos: '#e53e3e',
            proyectosColab: '#9333ea',
            cuerposAgua: {
                'piscina': '#ec4899',
                'cenote_s_a': '#10b981',
                'cenote_s_s': '#ef4444',
                'aguada_a': '#3b82f6',
                'aguada_n': '#8b5cf6',
                'sascab_ce': '#f59e0b',
                'rio_a': '#06b6d4',
                'default': '#6b7280'
            },
            poel: {
                'Protecci√≥n': '#1e3a8a',
                'Conservaci√≥n': '#0369a1',
                'Preservaci√≥n': '#0284c7',
                'Aprovechamiento Sustentable': '#eab308',
                'Restauraci√≥n': '#f97316',
                'default': '#a0aec0'
            },
            socioeco: {
                'manglar': '#06b6d4',
                'manglar 2': '#0891b2',
                'tular': '#0e7490',
                'planicie carstica sujeta a inu': '#0284c7',
                'suelo con poca vegetacion prop': '#0ea5e9',
                'zona de manglar inundada (est': '#38bdf8',
                'selva mediana perennifolia': '#075985',
                'nubes': '#0369a1',
                'zona de cambio de uso de suelo': '#7dd3fc',
                'default': '#718096'
            },
            colapsoKarst: {
                'Muy Alto': '#ff00ff',
                'Alto': '#00ffff',
                'Medio': '#ffff00',
                'Bajo': '#ff1493',
                'Muy Bajo': '#00ff00',
                'default': '#ff69b4'
            },
            tierrasEjidales: {
                'comunal': '#a855f7',
                'parcelada': '#f97316',
                'default': '#8b5cf6',
                'nucleosAgrarios': '#6366f1',
                'asentamientos': '#ec4899',
                'fraccionamientos': '#ef4444'
            },
            fallasINEGI: '#9f7aea',
            fallasCENAPRED: '#ed64a6',
            municipio: '#4a5568',
            pozosSinProteccion: '#ef4444',
            pozosConProteccion: '#10b981'
        };

        // ========== FUNCIONES PARA MODAL DE BIENVENIDA ==========
        function openWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('closing');
            modal.style.display = 'flex';
        }

        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.add('closing');
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 800);
        }

        // ========== FUNCIONES PARA ARRASTRE DE PANELES MINIMIZADOS ==========
        let isDragging = false;
        let currentPanel = null;
        let offsetX = 0;
        let offsetY = 0;

        function setupDraggable() {
            const panels = document.querySelectorAll('.control-panel, .legends-panel');
            
            panels.forEach(panel => {
                panel.addEventListener('mousedown', startDrag);
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function startDrag(e) {
            if (!e.target.closest('.panel-minimized') || e.target.classList.contains('toggle-btn')) {
                return;
            }

            const panel = e.target.closest('.control-panel, .legends-panel');
            if (!panel || !panel.classList.contains('panel-minimized')) {
                return;
            }

            isDragging = true;
            currentPanel = panel;
            
            const rect = panel.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            currentPanel.classList.add('dragging');
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !currentPanel) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            const maxX = window.innerWidth - 50;
            const maxY = window.innerHeight - 50;

            const finalX = Math.max(0, Math.min(x, maxX));
            const finalY = Math.max(0, Math.min(y, maxY));

            currentPanel.style.left = finalX + 'px';
            currentPanel.style.top = finalY + 'px';
        }

        function stopDrag() {
            if (currentPanel) {
                currentPanel.classList.remove('dragging');
            }
            isDragging = false;
            currentPanel = null;
        }

        let maxVolumenDescarga = 0;
        let maxVolumenExtraccion = 0;
        let maxIntensidadKarst = 0;
        let minIntensidadKarst = 999;

        // Almacenar datos de todas las capas para an√°lisis espacial
        let allLayersData = {
            proyectos: [],
            descargas: [],
            extracciones: [],
            cuerposAgua: [],
            rios: []
        };

        // Estado de autenticaci√≥n
        let currentUser = null;
        let mapClickEnabled = false;
        let tempMarker = null;
        let movingProjectId = null;
        let movingProjectMode = false;

        function updateStatus(text) {
            console.log('[STATUS]', text);
        }

        function updateLoading(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateLayerCount(layerId, count) {
            const element = document.getElementById(`count-${layerId}`);
            if (element) {
                element.textContent = count;
                element.classList.add('loaded');
            }
        }

        function parseGeoJSON(geojson) {
            if (!geojson || !geojson.coordinates) {
                return null;
            }

            try {
                const coords = geojson.coordinates;
                let allPolygons = [];

                for (const polygon of coords) {
                    for (const ring of polygon) {
                        const leafletCoords = ring.map(coord => {
                            const x = coord[0];
                            const y = coord[1];
                            
                            if (isUTM(x, y)) {
                                const converted = convertUTMtoLatLon(x, y);
                                if (converted) {
                                    return [converted.lat, converted.lon];
                                } else {
                                    console.warn('No se pudo convertir coordenada UTM:', { x, y });
                                    return null;
                                }
                            } else {
                                return [y, x];
                            }
                        }).filter(c => c !== null);
                        
                        if (leafletCoords.length > 0) {
                            allPolygons.push(leafletCoords);
                        }
                    }
                }

                return allPolygons.length > 0 ? allPolygons : null;
            } catch (e) {
                console.error('Error parsing GeoJSON:', e);
                return null;
            }
        }

        function parseGeometry(item) {
            try {
                if (item.geojson) {
                    const geom = typeof item.geojson === 'string' ? JSON.parse(item.geojson) : item.geojson;
                    return geom;
                }
                if (item.geom) {
                    if (typeof item.geom === 'string') return JSON.parse(item.geom);
                    if (item.geom.type) return item.geom;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function getDescargaColor(vol) {
            const ratio = vol / maxVolumenDescarga;
            const r = Math.floor(125 + (3 - 125) * ratio);
            const g = Math.floor(211 + (105 - 211) * ratio);
            const b = Math.floor(252 + (161 - 252) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getExtraccionColor(vol) {
            const ratio = vol / maxVolumenExtraccion;
            const r = Math.floor(251 + (234 - 251) * ratio);
            const g = Math.floor(146 + (88 - 146) * ratio);
            const b = Math.floor(60 + (12 - 60) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getKarstColor(intensidad) {
            const ratio = (intensidad - minIntensidadKarst) / (maxIntensidadKarst - minIntensidadKarst);
            const r = Math.floor(254 + (120 - 254) * ratio);
            const g = Math.floor(243 + (53 - 243) * ratio);
            const b = Math.floor(199 + (15 - 199) * ratio);
            return `rgb(${r},${g},${b})`;
        }

        function getPOELColor(politica) {
            return COLORS.poel[politica] || COLORS.poel.default;
        }

        // ======== AUTENTICACI√ìN Y PROYECTOS COLABORATIVOS ========

        async function checkAuthState() {
            try {
                const hash = window.location.hash;
                const hasAuthToken = hash && (hash.includes('access_token') || hash.includes('type=signup'));
                
                if (hasAuthToken) {
                    console.log('üîë Detectado token de confirmaci√≥n en URL, procesando...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error obteniendo sesi√≥n:', error);
                    showLoginSection();
                    return;
                }
                
                if (session) {
                    console.log('‚úÖ Sesi√≥n activa encontrada');
                    currentUser = session.user;
                    const { data: profile } = await supabaseClient
                        .from('proyectos_colaborativos')
                        .select('username')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    const username = profile?.username || currentUser.email.split('@')[0];
                    showUserSection(username);
                    
                    await loadCollaborativeProjects();
                    
                    if (hash) {
                        console.log('üßπ Limpiando URL...');
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                    
                    if (hasAuthToken) {
                        alert('‚úÖ Email confirmado correctamente. ¬°Bienvenido al geoportal!');
                    }
                } else {
                    console.log('‚ùå No hay sesi√≥n activa');
                    currentUser = null;
                    showLoginSection();
                }
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                showLoginSection();
            }
        }
        
        function setupAuthListener() {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('üì¢ Auth event:', event);
                
                if (event === 'SIGNED_IN') {
                    console.log('‚úÖ Usuario inici√≥ sesi√≥n');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                        await loadCollaborativeProjects();
                    }
                } else if (event === 'USER_UPDATED') {
                    console.log('üîÑ Usuario actualizado');
                    if (session) {
                        currentUser = session.user;
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        showUserSection(username);
                    }
                } else if (event === 'SIGNED_OUT') {
                    console.log('üëã Usuario cerr√≥ sesi√≥n');
                    currentUser = null;
                    showLoginSection();
                    layerGroups.proyectosColab.clearLayers();
                    updateLayerCount('proyectos-colab', 0);
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('üîÑ Token actualizado');
                }
            });
        }

        function showLoginSection() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('add-project-section').style.display = 'none';
        }

        function showUserSection(username) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'block';
            document.getElementById('add-project-section').style.display = 'block';
            document.getElementById('username-display').textContent = username;
        }

        async function handleLogin(email, password) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;
            
            currentUser = data.user;
            const { data: profile } = await supabaseClient
                .from('proyectos_colaborativos')
                .select('username')
                .eq('user_id', currentUser.id)
                .single();
            
            const username = profile?.username || email.split('@')[0];
            showUserSection(username);
            
            document.getElementById('login-modal').style.display = 'none';
            await loadCollaborativeProjects();
        }

        async function handleRegister(username, email, password) {
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        username: username
                    }
                }
            });

            if (error) throw error;
            
            return data;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showLoginSection();
            
            layerGroups.proyectosColab.clearLayers();
            updateLayerCount('proyectos-colab', 0);
        }

        async function addProjectToMap(projectData) {
            if (!currentUser) {
                alert('Debes iniciar sesi√≥n para agregar proyectos');
                return;
            }

            const { data, error } = await supabaseClient
                .from('proyectos_colaborativos')
                .insert([{
                    user_id: currentUser.id,
                    username: currentUser.user_metadata?.username || currentUser.email.split('@')[0],
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                }])
                .select();

            if (error) throw error;

            await loadCollaborativeProjects();
            
            return data;
        }

        async function loadCollaborativeProjects() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('Tabla de proyectos colaborativos no disponible:', error.message || 'Error desconocido');
                    return;
                }

                if (data && data.length > 0) {
                    updateLayerCount('proyectos-colab', data.length);
                    renderCollaborativeProjects(data);
                    console.log(`‚úì ${data.length} proyectos colaborativos cargados`);
                } else {
                    updateLayerCount('proyectos-colab', 0);
                    console.log('No hay proyectos colaborativos todav√≠a');
                }
            } catch (e) {
                console.warn('Error cargando proyectos colaborativos:', e.message || String(e));
                updateLayerCount('proyectos-colab', 0);
            }
        }

        function renderCollaborativeProjects(data) {
            layerGroups.proyectosColab.clearLayers();
            
            const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
            
            data.forEach(item => {
                if (!item.lat || !item.lng || isNaN(item.lat) || isNaN(item.lng)) {
                    console.warn('Proyecto colaborativo sin coordenadas v√°lidas:', item);
                    return;
                }
                
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 8,
                    fillColor: COLORS.proyectosColab,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9,
                    draggable: isAdmin
                });

                const isOwner = currentUser && item.user_id === currentUser.id;
                const ownerBadge = isOwner ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">TU PROYECTO</span>' : '';
                const adminBadge = isAdmin ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;">ADMIN</span>' : '';
                
                let ownerButtons = '';
                if (isOwner && !isAdmin) {
                    ownerButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <button 
                                class="edit-project-btn" 
                                data-project-id="${item.id}" 
                                type="button"
                                style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 600;
                                    pointer-events: auto;
                                    touch-action: manipulation;
                                    user-select: none;
                                "
                                onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                            >
                                ‚úèÔ∏è Editar mi proyecto
                            </button>
                        </div>
                    `;
                }
                
                let adminButtons = '';
                if (isAdmin) {
                    adminButtons = `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">‚öôÔ∏è Controles de Administrador</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <button 
                                    class="edit-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #f59e0b;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); editProject('${item.id}');"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    class="move-project-btn" 
                                    data-project-id="${item.id}" 
                                    data-lat="${item.lat}" 
                                    data-lng="${item.lng}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); moveProject('${item.id}', ${item.lat}, ${item.lng});"
                                >
                                    üìç Mover
                                </button>
                                <button 
                                    class="delete-project-btn" 
                                    data-project-id="${item.id}" 
                                    type="button"
                                    style="
                                        padding: 8px 10px;
                                        background: #ef4444;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        pointer-events: auto;
                                        touch-action: manipulation;
                                        user-select: none;
                                    "
                                    onclick="event.stopPropagation(); event.preventDefault(); deleteProject('${item.id}');"
                                >
                                    üóëÔ∏è Borrar
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectosColab};">
                            Proyecto Colaborativo ${ownerBadge} ${adminBadge}
                        </h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectosColab};">
                            <p><strong>Nombre:</strong> ${item.nombre_proyecto}</p>
                            ${item.descripcion ? `<p><strong>Descripci√≥n:</strong> ${item.descripcion}</p>` : ''}
                            ${item.mia ? `<p><strong>MIA:</strong> ${item.mia}</p>` : ''}
                            ${item.irregularidad ? `<p><strong>Irregularidad:</strong> ${item.irregularidad}</p>` : ''}
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">
                                üë§ Agregado por: <strong>${item.username}</strong><br>
                                üìÖ ${new Date(item.created_at).toLocaleDateString('es-MX')}<br>
                                üìç Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
                            </p>
                            ${ownerButtons}
                            ${adminButtons}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 400,
                    minWidth: 300,
                    className: 'collaborative-project-popup'
                });
                
                marker.projectId = item.id;
                marker.projectData = item;
                
                if (isAdmin) {
                    marker.on('dragend', async function(e) {
                        const newLatLng = e.target.getLatLng();
                        if (confirm('¬øMover este proyecto a la nueva ubicaci√≥n?')) {
                            try {
                                map.closePopup();
                                
                                await updateProjectLocation(item.id, newLatLng.lat, newLatLng.lng);
                                
                                await loadCollaborativeProjects();
                                
                                alert('‚úÖ Proyecto movido exitosamente');
                            } catch (error) {
                                alert('‚ùå Error al mover proyecto: ' + error.message);
                                e.target.setLatLng([item.lat, item.lng]);
                            }
                        } else {
                            e.target.setLatLng([item.lat, item.lng]);
                        }
                    });
                }
                
                marker.addTo(layerGroups.proyectosColab);
            });
        }

        async function deleteProject(projectId) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para eliminar proyectos');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este proyecto? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                map.closePopup();
                
                const { error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                await loadCollaborativeProjects();
                
                alert('‚úÖ Proyecto eliminado exitosamente');
            } catch (error) {
                console.error('Error eliminando proyecto:', error);
                alert('‚ùå Error al eliminar proyecto: ' + error.message);
            }
        }

        async function moveProject(projectId, currentLat, currentLng) {
            if (!currentUser || currentUser.email !== 'storresperdigon@politicas.unam.mx') {
                alert('‚ùå No tienes permisos para mover proyectos');
                return;
            }
            
            map.closePopup();
            
            movingProjectMode = true;
            movingProjectId = projectId;
            
            map.getContainer().style.cursor = 'crosshair';
            
            const indicator = document.getElementById('map-click-indicator');
            if (indicator) {
                indicator.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 10px;">üìç</div>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700;">Mover Proyecto</h3>
                    <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.9; line-height: 1.4;">Haz click en el mapa en la nueva ubicaci√≥n del proyecto</p>
                    <button id="cancel-move-project" style="padding: 8px 20px; background: white; color: #9333ea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; pointer-events: auto;">
                        ‚ùå Cancelar
                    </button>
                `;
                indicator.style.display = 'block';
                
                document.getElementById('cancel-move-project').addEventListener('click', () => {
                    movingProjectMode = false;
                    movingProjectId = null;
                    map.getContainer().style.cursor = '';
                    indicator.style.display = 'none';
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                });
            }
        }

        async function updateProjectLocation(projectId, newLat, newLng) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({ 
                    lat: newLat, 
                    lng: newLng 
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function editProject(projectId) {
            console.log('[EDIT PROJECT] Iniciando edici√≥n de proyecto:', projectId);
            
            try {
                const project = await getProjectById(projectId);
                
                if (!project) {
                    console.error('[EDIT PROJECT] Proyecto no encontrado:', projectId);
                    alert('‚ùå Proyecto no encontrado');
                    return;
                }
                
                console.log('[EDIT PROJECT] Proyecto cargado:', project);
                
                const isAdmin = currentUser && currentUser.email === 'storresperdigon@politicas.unam.mx';
                const isOwner = currentUser && project.user_id === currentUser.id;
                
                console.log('[EDIT PROJECT] Permisos:', { isAdmin, isOwner, currentUserEmail: currentUser?.email });
                
                if (!isAdmin && !isOwner) {
                    console.error('[EDIT PROJECT] Sin permisos para editar');
                    alert('‚ùå No tienes permisos para editar este proyecto');
                    return;
                }
                
                document.getElementById('edit-project-id').value = project.id;
                document.getElementById('edit-project-nombre').value = project.nombre_proyecto || '';
                document.getElementById('edit-project-descripcion').value = project.descripcion || '';
                document.getElementById('edit-project-mia').value = project.mia || '';
                document.getElementById('edit-project-irregularidad').value = project.irregularidad || '';
                document.getElementById('edit-project-lat').value = project.lat || '';
                document.getElementById('edit-project-lng').value = project.lng || '';
                
                document.getElementById('edit-project-error').style.display = 'none';
                document.getElementById('edit-project-success').style.display = 'none';
                
                console.log('[EDIT PROJECT] Mostrando modal de edici√≥n');
                
                document.getElementById('edit-project-modal').style.display = 'flex';
            } catch (error) {
                console.error('[EDIT PROJECT] Error:', error);
                alert('‚ùå Error al cargar proyecto: ' + error.message);
            }
        }

        async function getProjectById(projectId) {
            console.log('[GET PROJECT] Buscando proyecto ID:', projectId);
            
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .eq('id', projectId)
                    .single();
                
                if (error) {
                    console.error('[GET PROJECT] Error de Supabase:', error);
                    return null;
                }
                
                console.log('[GET PROJECT] Proyecto encontrado:', data);
                return data;
            } catch (e) {
                console.error('[GET PROJECT] Excepci√≥n:', e);
                return null;
            }
        }

        async function updateProject(projectId, projectData) {
            const { error } = await supabaseClient
                .from('proyectos_colaborativos')
                .update({
                    nombre_proyecto: projectData.nombre,
                    descripcion: projectData.descripcion || null,
                    mia: projectData.mia || null,
                    irregularidad: projectData.irregularidad || null,
                    lat: projectData.lat,
                    lng: projectData.lng
                })
                .eq('id', projectId);
            
            if (error) throw error;
        }

        async function exportProjectsToCSV() {
            try {
                const { data, error } = await supabaseClient
                    .from('proyectos_colaborativos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('‚ùå No hay proyectos para exportar');
                    return;
                }
                
                const headers = ['ID', 'Nombre', 'Descripci√≥n', 'MIA', 'Irregularidad', 'Latitud', 'Longitud', 'Usuario', 'Fecha de Creaci√≥n'];
                const csvRows = [headers.join(',')];
                
                data.forEach(project => {
                    const row = [
                        project.id,
                        `"${(project.nombre_proyecto || '').replace(/"/g, '""')}"`,
                        `"${(project.descripcion || '').replace(/"/g, '""')}"`,
                        `"${(project.mia || '').replace(/"/g, '""')}"`,
                        `"${(project.irregularidad || '').replace(/"/g, '""')}"`,
                        project.lat,
                        project.lng,
                        `"${project.username || ''}"`,
                        new Date(project.created_at).toLocaleString('es-MX')
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const fileName = `proyectos_colaborativos_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ ${data.length} proyectos exportados exitosamente a ${fileName}`);
            } catch (error) {
                console.error('Error exportando proyectos:', error);
                alert('‚ùå Error al exportar proyectos: ' + error.message);
            }
        }

        // ========== FUNCIONES HELPER PARA FORMATEO ========== //
        
        function formatVolume(volHm3) {
            if (volHm3 < 0.1) {
                const volM3 = volHm3 * 1000000;
                return `${volM3.toLocaleString('es-MX', {maximumFractionDigits: 2})} m¬≥/a√±o`;
            } else {
                return `${volHm3.toFixed(2)} hm¬≥/a√±o`;
            }
        }

        function calculatePolygonArea(coords) {
            if (!coords || coords.length < 3) return 0;
            
            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coords[i][1] * coords[j][0];
                area -= coords[j][1] * coords[i][0];
            }
            
            area = Math.abs(area) / 2;
            
            const metersPerDegreeLat = 110900;
            const metersPerDegreeLng = 103500;
            area = area * metersPerDegreeLat * metersPerDegreeLng;
            
            return area;
        }

        function pointInPolygon(point, polygon) {
            const x = point[1], y = point[0];
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][1], yi = polygon[i][0];
                const xj = polygon[j][1], yj = polygon[j][0];
                
                const intersect = ((yi > y) !== (yj > y)) && 
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }

        function pointInGeometry(point, geojson) {
            if (!geojson || !geojson.coordinates) return false;
            
            try {
                if (geojson.type === 'Polygon') {
                    return pointInPolygon(point, geojson.coordinates[0]);
                    
                } else if (geojson.type === 'MultiPolygon') {
                    for (const polygon of geojson.coordinates) {
                        if (pointInPolygon(point, polygon[0])) {
                            return true;
                        }
                    }
                }
            } catch (e) {
                console.warn('Error en point-in-polygon:', e);
            }
            
            return false;
        }

        // ========== FUNCIONES DE RENDERIZADO DE CAPAS ==========

        function renderProyectos(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || geom.type !== 'Point') return;

                if (!geom.coordinates || geom.coordinates.length < 2) {
                    console.warn('Proyecto sin coordenadas v√°lidas:', item);
                    return;
                }

                const lat = geom.coordinates[1];
                const lng = geom.coordinates[0];
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn('Coordenadas inv√°lidas:', { lat, lng });
                    return;
                }

                allLayersData.proyectos.push({
                    lat: lat,
                    lng: lng,
                    nombre: item["Nombre_Poy"] || 'Proyecto',
                    tipo: 'Proyecto Inmobiliario-tur√≠stico'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: COLORS.proyectos,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.9
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.proyectos};">Proyecto Inmobiliario-tur√≠stico</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.proyectos};">
                            <p><strong>Nombre:</strong> ${item["Nombre_Poy"] || 'N/A'}</p>
                            <p><strong>MIA:</strong> ${item["MIA"] || 'N/A'}</p>
                            <p><strong>Irregularidad:</strong> ${item["¬øIlegalidad o irregularidad?"] || 'N/A'}</p>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.proyectos);
            });
        }

        function renderDescargas(data) {
            console.log('Renderizando descargas, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                if (index < 3) {
                    console.log(`Descarga ${index}:`, {
                        geom: geom,
                        tipo: geom?.type,
                        vol: item.vol
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en descarga', index);
                    return;
                }
                
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no Point:', geom.type);
                    return;
                }

                const vol = item.vol || 0;
                const color = getDescargaColor(vol);

                allLayersData.descargas.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Descarga'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenDescarga) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #0369a1;">üíß Descarga de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #0369a1;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Registro:</strong> ${item.registr || 'No registrada'}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autordd || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.cuerpo ? `<p><strong>üí¶ Cuerpo Receptor:</strong> ${item.cuerpo}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.descargas);
                rendered++;
            });
            
            console.log(`‚úì ${rendered} descargas renderizadas`);
        }

        function renderExtracciones(data) {
            console.log('Renderizando extracciones, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                if (index < 3) {
                    console.log(`Extracci√≥n ${index}:`, {
                        geom: geom,
                        tipo: geom?.type,
                        vol: item.vol
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en extracci√≥n', index);
                    return;
                }
                
                let lat, lng;
                if (geom.type === 'Point') {
                    lat = geom.coordinates[1];
                    lng = geom.coordinates[0];
                } else if (geom.type === 'MultiPoint' && geom.coordinates.length > 0) {
                    lat = geom.coordinates[0][1];
                    lng = geom.coordinates[0][0];
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no Point:', geom.type);
                    return;
                }

                const vol = item.vol || 0;
                const color = getExtraccionColor(vol);

                allLayersData.extracciones.push({
                    lat: lat,
                    lng: lng,
                    vol: vol,
                    tipo: 'Extracci√≥n'
                });

                const marker = L.circleMarker([lat, lng], {
                    radius: 6 + (vol / maxVolumenExtraccion) * 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: #ea580c;">‚ö° Extracci√≥n de Agua</h3>
                        <div class="custom-popup-divider" style="border-color: #ea580c;">
                            <p><strong>üìã Titular:</strong> ${item.titular || 'No especificado'}</p>
                            <p><strong>üè∑Ô∏è Tipo de Uso:</strong> ${item.uso || 'No especificado'}</p>
                            <p><strong>üìä Volumen Concesionado:</strong> ${formatVolume(vol)}</p>
                            <p><strong>üìÖ Fecha de Registro:</strong> ${item.dia || ''}/${item.mes || ''}/${item.a√±o || ''}</p>
                            <p><strong>üèõÔ∏è Autoridad:</strong> ${item.autoridad || 'N/A'}</p>
                            ${item.titulo ? `<p><strong>üìÑ T√≠tulo:</strong> ${item.titulo}</p>` : ''}
                            ${item.estado ? `<p><strong>üìç Estado:</strong> ${item.estado}</p>` : ''}
                            ${item.mpo ? `<p><strong>üèòÔ∏è Municipio:</strong> ${item.mpo}</p>` : ''}
                            ${item.cuenca ? `<p><strong>üåä Cuenca:</strong> ${item.cuenca}</p>` : ''}
                            ${item.fuente ? `<p><strong>üö∞ Fuente:</strong> ${item.fuente}</p>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(layerGroups.extracciones);
                rendered++;
            });
            
            console.log(`‚úì ${rendered} extracciones renderizadas`);
        }

        function renderCuerposAgua(data) {
            const typeNames = {
                'piscina': 'Piscina',
                'cenote_s_a': 'Cenote Modificado',
                'cenote_s_s': 'Cenote Artificial',
                'aguada_a': 'Aguada Antropizada',
                'aguada_n': 'Aguada Natural',
                'sascab_ce': 'Sascabera',
                'rio_a': 'R√≠o Artificial'
            };

            const typeCounters = {};
            const typeAreas = {};
            let totalArea = 0;

            data.forEach(item => {
                const geom = item.geom;
                if (!geom || (geom.type !== 'MultiPolygon' && geom.type !== 'Polygon')) return;

                const clase = item.CLASE || 'default';
                const areaHa = parseFloat(item['ha_cuerp_agua-sup']) || 0;
                const areaM2 = areaHa * 10000;
                const color = COLORS.cuerposAgua[clase] || COLORS.cuerposAgua.default;

                if (!typeCounters[clase]) {
                    typeCounters[clase] = 0;
                    typeAreas[clase] = 0;
                }
                typeCounters[clase]++;
                typeAreas[clase] += areaM2;
                totalArea += areaM2;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const firstRing = coords[0];
                    let sumLat = 0, sumLng = 0;
                    firstRing.forEach(coord => {
                        sumLat += coord[0];
                        sumLng += coord[1];
                    });
                    const centroidLat = sumLat / firstRing.length;
                    const centroidLng = sumLng / firstRing.length;

                    const typeName = typeNames[clase] || clase;

                    allLayersData.cuerposAgua.push({
                        lat: centroidLat,
                        lng: centroidLng,
                        area: areaM2,
                        tipo: typeName,
                        clase: clase
                    });

                    if (clase === 'rio_a') {
                        allLayersData.rios.push({
                            lat: centroidLat,
                            lng: centroidLng,
                            area: areaM2,
                            tipo: 'R√≠o Artificial'
                        });
                    }

                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2,
                        opacity: 0.8
                    });
                    
                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">${typeName}</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>√Årea:</strong> ${areaM2.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤</p>
                                ${item.nombre ? `<p><strong>Ubicaci√≥n:</strong> ${item.nombre}</p>` : ''}
                                ${item.Politica ? `<p><strong>Pol√≠tica:</strong> ${item.Politica}</p>` : ''}
                                ${item.clase_valor ? `<p><strong>√çndice:</strong> ${item.clase_valor}</p>` : ''}
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent, {
                        maxWidth: 300,
                        closeButton: true
                    });

                    polygon.on('mouseover', function() {
                        this.setStyle({
                            fillOpacity: 0.6,
                            weight: 3
                        });
                    });

                    polygon.on('mouseout', function() {
                        this.setStyle({
                            fillOpacity: 0.4,
                            weight: 2
                        });
                    });

                    polygon.addTo(layerGroups.cuerposAgua);
                    
                    if (clase === 'piscina') polygon.addTo(layerGroups.piscinas);
                    else if (clase === 'cenote_s_a') polygon.addTo(layerGroups.cenotesSup);
                    else if (clase === 'cenote_s_s') polygon.addTo(layerGroups.cenotesSub);
                    else if (clase === 'aguada_a') polygon.addTo(layerGroups.aguadasArt);
                    else if (clase === 'aguada_n') polygon.addTo(layerGroups.aguadasNat);
                    else if (clase === 'sascab_ce') polygon.addTo(layerGroups.sascab);
                    else if (clase === 'rio_a') polygon.addTo(layerGroups.rios);
                }
            });

            updateLayerCount('piscinas', typeCounters['piscina'] || 0);
            updateLayerCount('cenotes-sup', typeCounters['cenote_s_a'] || 0);
            updateLayerCount('cenotes-sub', typeCounters['cenote_s_s'] || 0);
            updateLayerCount('aguadas-art', typeCounters['aguada_a'] || 0);
            updateLayerCount('aguadas-nat', typeCounters['aguada_n'] || 0);
            updateLayerCount('sascab', typeCounters['sascab_ce'] || 0);
            updateLayerCount('rios', typeCounters['rio_a'] || 0);

            if (typeAreas['piscina']) {
                document.getElementById('area-piscinas').textContent = 
                    `${typeAreas['piscina'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['cenote_s_a']) {
                document.getElementById('area-cenotes-sup').textContent = 
                    `${typeAreas['cenote_s_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['cenote_s_s']) {
                document.getElementById('area-cenotes-sub').textContent = 
                    `${typeAreas['cenote_s_s'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['aguada_a']) {
                document.getElementById('area-aguadas-art').textContent = 
                    `${typeAreas['aguada_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['aguada_n']) {
                document.getElementById('area-aguadas-nat').textContent = 
                    `${typeAreas['aguada_n'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['sascab_ce']) {
                document.getElementById('area-sascab').textContent = 
                    `${typeAreas['sascab_ce'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }
            if (typeAreas['rio_a']) {
                document.getElementById('area-rios').textContent = 
                    `${typeAreas['rio_a'].toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤`;
            }

            document.getElementById('total-area-cuerpos').textContent = 
                totalArea.toLocaleString('es-MX', {maximumFractionDigits: 0});

            console.log(`‚úì Cuerpos de agua renderizados por tipo:`, typeCounters);
            console.log(`‚úì √Årea total: ${totalArea.toLocaleString('es-MX')} m¬≤`);
        }

        function renderKarstificacion(data) {
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const intensidad = item.intensidad || 0;
                const color = getKarstColor(intensidad);

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: '#fbbf24',
                        fillColor: color,
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 0.9
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: #78350f;">Karstificaci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: #78350f;">
                                <p><strong>Categor√≠a:</strong> ${item.cat || 'N/A'}</p>
                                <p><strong>Intensidad:</strong> ${intensidad}</p>
                                <p><strong>Hect√°reas:</strong> ${(item.ha_cat || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.7, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 2 });
                    });

                    polygon.addTo(layerGroups.karstificacion);
                }
            });
        }

        function renderColapsoKarst(data) {
            console.log('=== RENDERIZANDO COLAPSO POR KARSTIFICACI√ìN ===');
            console.log('Total items:', data.length);
            
            let rendered = 0;
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

                const rango = item.rango || item.RANGO || item.Rango || 'default';
                const color = COLORS.colapsoKarst[rango] || COLORS.colapsoKarst.default;

                const coords = parseGeoJSON(geom);
                if (coords && coords.length > 0) {
                    const polygon = L.polygon(coords, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 0.9
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${color};">‚ö†Ô∏è Riesgo de Colapso por Karstificaci√≥n</h3>
                            <div class="custom-popup-divider" style="border-color: ${color};">
                                <p><strong>Nivel de Riesgo:</strong> ${rango}</p>
                                ${item.uga || item.UGA ? `<p><strong>UGA:</strong> ${item.uga || item.UGA}</p>` : ''}
                                ${item.descripcion || item.DESCRIPCION ? `<p><strong>Descripci√≥n:</strong> ${item.descripcion || item.DESCRIPCION}</p>` : ''}
                                <p style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; font-size: 12px;">
                                    <strong>‚ö†Ô∏è Advertencia:</strong> Esta zona presenta riesgo de colapso del terreno. No recomendado para construcci√≥n de infraestructura pesada.
                                </p>
                            </div>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    polygon.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.7, weight: 3 });
                    });
                    polygon.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 2 });
                    });

                    polygon.addTo(layerGroups.colapsoKarst);
                    rendered++;
                }
            });
            
            console.log(`‚úì ${rendered} pol√≠gonos de colapso por karstificaci√≥n renderizados`);
        }

        function renderFallasINEGI(data) {
            console.log('Renderizando fallas INEGI, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                if (index < 3) {
                    console.log(`Falla INEGI ${index}:`, {
                        geom: geom,
                        tipo: geom?.type
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en falla INEGI', index);
                    return;
                }
                
                let linesToDraw = [];
                
                if (geom.type === 'LineString') {
                    linesToDraw.push(geom.coordinates);
                } else if (geom.type === 'MultiLineString') {
                    linesToDraw = geom.coordinates;
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no LineString:', geom.type);
                    return;
                }

                linesToDraw.forEach(lineCoords => {
                    const coords = lineCoords.map(coord => [coord[1], coord[0]]);

                    const line = L.polyline(coords, {
                        color: COLORS.fallasINEGI,
                        weight: 3,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasINEGI};">Falla Geol√≥gica INEGI</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasINEGI};">
                                <p><strong>Fuente:</strong> INEGI</p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasINEGI);
                    rendered++;
                });
            });
            
            console.log(`‚úì ${rendered} fallas INEGI renderizadas`);
        }

        function renderFallasCENAPRED(data) {
            console.log('Renderizando fallas CENAPRED, total:', data.length);
            let rendered = 0;
            
            data.forEach((item, index) => {
                const geom = parseGeometry(item);
                
                if (index < 3) {
                    console.log(`Falla CENAPRED ${index}:`, {
                        geom: geom,
                        tipo: geom?.type
                    });
                }
                
                if (!geom) {
                    console.warn('Sin geometr√≠a en falla CENAPRED', index);
                    return;
                }
                
                let linesToDraw = [];
                
                if (geom.type === 'LineString') {
                    linesToDraw.push(geom.coordinates);
                } else if (geom.type === 'MultiLineString') {
                    linesToDraw = geom.coordinates;
                } else {
                    if (index < 3) console.warn('Tipo de geometr√≠a no LineString:', geom.type);
                    return;
                }

                linesToDraw.forEach(lineCoords => {
                    const coords = lineCoords.map(coord => [coord[1], coord[0]]);

                    const line = L.polyline(coords, {
                        color: COLORS.fallasCENAPRED,
                        weight: 3,
                        opacity: 0.8
                    });

                    const popupContent = `
                        <div class="custom-popup">
                            <h3 style="color: ${COLORS.fallasCENAPRED};">Falla Geol√≥gica CENAPRED</h3>
                            <div class="custom-popup-divider" style="border-color: ${COLORS.fallasCENAPRED};">
                                <p><strong>Fuente:</strong> CENAPRED</p>
                            </div>
                        </div>
                    `;

                    line.bindPopup(popupContent);
                    line.addTo(layerGroups.fallasCENAPRED);
                    rendered++;
                });
            });
            
            console.log(`‚úì ${rendered} fallas CENAPRED renderizadas`);
        }

        function renderPOEL(data) {
            console.log('Analizando elementos dentro de POEL UGAs...');
            
            const ugaPolygons = {};
            const ugaData = {};
            
            data.forEach(item => {
                const geom = parseGeometry(item);
                if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;
                
                const uga = item.UGA || 'N/A';
                const politica = item["Pol√≠tica"] || 'default';
                const aprovechamiento = item.Aprovechamiento || item.Aprovecha || 'N/A';
                
                let area = parseFloat(item.ha_uga || item.ha || 0) * 10000;
                
                if (area === 0) {
                    const coords = parseGeoJSON(geom);
                    if (coords && coords.length > 0) {
                        if (geom.type === 'MultiPolygon') {
                            coords.forEach(polygon => {
                                if (polygon.length > 0) {
                                    area += calculatePolygonArea(polygon[0]);
                                }
                            });
                        } else {
                            area = calculatePolygonArea(coords[0]);
                        }
                        console.log(`UGA ${uga}: √Årea calculada geom√©tricamente: ${area.toFixed(0)} m¬≤`);
                    }
                }
                
                if (!ugaPolygons[uga]) {
                    ugaPolygons[uga] = [];
                    ugaData[uga] = {
                        politica: politica,
                        aprovechamiento: aprovechamiento,
                        area: area,
                        proyectos: 0,
                        descargas: {count: 0, vol: 0},
                        extracciones: {count: 0, vol: 0},
                        cuerposAgua: {},
                        riosArt: {count: 0, area: 0}
                    };
                } else {
                    if (area > ugaData[uga].area) {
                        ugaData[uga].area = area;
                    }
                }
                
                ugaPolygons[uga].push(geom);
            });

            console.log(`Analizando ${Object.keys(ugaPolygons).length} UGAs...`);
            console.log(`Total elementos a verificar: ${allLayersData.proyectos.length} proyectos, ${allLayersData.descargas.length} descargas, ${allLayersData.extracciones.length} extracciones, ${allLayersData.cuerposAgua.length} cuerpos de agua`);
            
            Object.entries(ugaPolygons).forEach(([uga, polygons]) => {
                const ugaInfo = ugaData[uga];
                
                const debugUGA = ['11', '16b', '16B'].includes(uga);
                if (debugUGA) {
                    console.log(`=== Analizando UGA ${uga} ===`);
                    console.log(`Pol√≠gonos en UGA: ${polygons.length}`);
                    polygons.forEach((p, i) => {
                        console.log(`  Pol√≠gono ${i}: tipo=${p.type}, coords length=${p.coordinates?.length}`);
                    });
                }
                
                allLayersData.proyectos.forEach((proyecto, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([proyecto.lng, proyecto.lat], geom)) {
                            ugaInfo.proyectos++;
                            if (debugUGA) console.log(`  ‚úì Proyecto ${idx} dentro: [${proyecto.lat}, ${proyecto.lng}]`);
                            break;
                        }
                    }
                });

                allLayersData.descargas.forEach((descarga, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([descarga.lng, descarga.lat], geom)) {
                            ugaInfo.descargas.count++;
                            ugaInfo.descargas.vol += descarga.vol;
                            if (debugUGA) console.log(`  ‚úì Descarga ${idx} dentro: [${descarga.lat}, ${descarga.lng}]`);
                            break;
                        }
                    }
                });

                allLayersData.extracciones.forEach((extraccion, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([extraccion.lng, extraccion.lat], geom)) {
                            ugaInfo.extracciones.count++;
                            ugaInfo.extracciones.vol += extraccion.vol;
                            if (debugUGA) console.log(`  ‚úì Extracci√≥n ${idx} dentro: [${extraccion.lat}, ${extraccion.lng}]`);
                            break;
                        }
                    }
                });

                allLayersData.cuerposAgua.forEach((cuerpo, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([cuerpo.lng, cuerpo.lat], geom)) {
                            if (!ugaInfo.cuerposAgua[cuerpo.tipo]) {
                                ugaInfo.cuerposAgua[cuerpo.tipo] = {count: 0, area: 0};
                            }
                            ugaInfo.cuerposAgua[cuerpo.tipo].count++;
                            ugaInfo.cuerposAgua[cuerpo.tipo].area += cuerpo.area;
                            if (debugUGA && idx < 5) console.log(`  ‚úì ${cuerpo.tipo} ${idx} dentro: [${cuerpo.lat}, ${cuerpo.lng}]`);
                            break;
                        }
                    }
                });

                allLayersData.rios.forEach((rio, idx) => {
                    for (const geom of polygons) {
                        if (pointInGeometry([rio.lng, rio.lat], geom)) {
                            ugaInfo.riosArt.count++;
                            ugaInfo.riosArt.area += rio.area;
                            if (debugUGA) console.log(`R√≠o artificial idxdentro:[{idx} dentro: [
idxdentro:[{rio.lat}, ${rio.lng}]`);
                            break;
                        }
                    }
                });if (debugUGA) {
                console.log(`Resultados UGA ${uga}:`);
                console.log(`  - Proyectos: ${ugaInfo.proyectos}`);
                console.log(`  - Descargas: ${ugaInfo.descargas.count} (${ugaInfo.descargas.vol.toFixed(2)} hm¬≥)`);
                console.log(`  - Extracciones: ${ugaInfo.extracciones.count} (${ugaInfo.extracciones.vol.toFixed(2)} hm¬≥)`);
                console.log(`  - Cuerpos de agua:`, ugaInfo.cuerposAgua);
                console.log(`  - R√≠os artificiales: ${ugaInfo.riosArt.count} (${ugaInfo.riosArt.area.toFixed(0)} m¬≤)`);
            }
        });

        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const uga = item.UGA || 'N/A';
            const politica = item["Pol√≠tica"] || 'default';
            const aprovechamiento = item.Aprovechamiento || item.Aprovecha || 'N/A';
            const color = getPOELColor(politica);
            const ugaInfo = ugaData[uga];

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    weight: 2,
                    opacity: 0.7
                });

                let cuerposAguaText = '';
                if (Object.keys(ugaInfo.cuerposAgua).length > 0) {
                    cuerposAguaText = '<div style="margin-top: 10px; padding: 10px; background: #eff6ff; border-left: 4px solid #3b82f6;"><strong>üíß Cuerpos de Agua en esta UGA:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                    Object.entries(ugaInfo.cuerposAgua).forEach(([tipo, stats]) => {
                        cuerposAguaText += `<li>${tipo}: ${stats.count} (${stats.area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤)</li>`;
                    });
                    cuerposAguaText += '</ul></div>';
                }

                let riosArtText = '';
                if (ugaInfo.riosArt.count > 0) {
                    riosArtText = `
                        <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                            <strong>‚ö†Ô∏è R√≠os Artificiales en esta UGA:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>${ugaInfo.riosArt.count} r√≠os artificiales</li>
                                <li>√Årea total: ${ugaInfo.riosArt.area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤</li>
                            </ul>
                        </div>
                    `;
                }

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">UGA ${uga}</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Pol√≠tica:</strong> ${politica}</p>
                            <p><strong>Aprovechamiento:</strong> ${aprovechamiento}</p>
                            <p><strong>√Årea:</strong> ${ugaInfo.area.toLocaleString('es-MX', {maximumFractionDigits: 0})} m¬≤</p>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fee2e2; border-left: 4px solid #ef4444;">
                                <strong>üèóÔ∏è Proyectos Inmobiliarios-tur√≠sticos:</strong> ${ugaInfo.proyectos}
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-left: 4px solid #0369a1;">
                                <strong>üíß Descargas de Agua:</strong> ${ugaInfo.descargas.count} (${formatVolume(ugaInfo.descargas.vol)})
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fed7aa; border-left: 4px solid #ea580c;">
                                <strong>‚ö° Extracciones de Agua:</strong> ${ugaInfo.extracciones.count} (${formatVolume(ugaInfo.extracciones.vol)})
                            </div>
                            
                            ${cuerposAguaText}
                            ${riosArtText}
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 400,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.5, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.3, weight: 2 });
                });

                polygon.addTo(layerGroups.poel);
            }
        });

        const legendContainer = document.getElementById('legend-poel-items');
        if (legendContainer) {
            const uniquePoliticas = [...new Set(data.map(item => item["Pol√≠tica"]))].filter(p => p);
            legendContainer.innerHTML = uniquePoliticas.map(politica => {
                const color = getPOELColor(politica);
                return `
                    <div style="display: flex; align-items: center; margin: 3px 0;">
                        <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; margin-right: 6px;"></div>
                        <span style="font-size: 10px;">${politica}</span>
                    </div>
                `;
            }).join('');
        }

        console.log('‚úì An√°lisis espacial POEL completado');
    }

    function renderSocioEco(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const tipo = item.cvegeo || 'default';
            const color = COLORS.socioeco[tipo] || COLORS.socioeco.default;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.4,
                    weight: 2,
                    opacity: 0.8
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${color};">Zona Inundable</h3>
                        <div class="custom-popup-divider" style="border-color: ${color};">
                            <p><strong>Tipo:</strong> ${tipo}</p>
                            ${item.area_ha ? `<p><strong>√Årea:</strong> ${parseFloat(item.area_ha).toLocaleString()} ha</p>` : ''}
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                
                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.6, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.4, weight: 2 });
                });

                polygon.addTo(layerGroups.socioeco);
            }
        });
    }

    function renderMunicipio(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.municipio,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    weight: 3,
                    opacity: 0.8,
                    dashArray: '10, 5'
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.municipio};">L√≠mite Municipal</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.municipio};">
                            <p><strong>Municipio:</strong> Puerto Morelos</p>
                            <p><strong>Estado:</strong> Quintana Roo</p>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.municipio);
            }
        });
    }

    function renderPozosSinProteccion(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.pozosSinProteccion,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    weight: 4,
                    opacity: 0.9
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.pozosSinProteccion};">‚ö†Ô∏è Pozo sin Protecci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.pozosSinProteccion};">
                            <p style="background: #fee2e2; padding: 8px; border-radius: 4px;">
                                <strong>Zona de alto riesgo:</strong> Este pozo no cuenta con per√≠metro de protecci√≥n adecuado.
                            </p>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.pozosSinProteccion);
            }
        });
    }

    function renderPozosConProteccion(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.pozosConProteccion,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    weight: 4,
                    opacity: 0.9
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.pozosConProteccion};">‚úÖ Pozo con Protecci√≥n</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.pozosConProteccion};">
                            <p style="background: #d1fae5; padding: 8px; border-radius: 4px;">
                                <strong>Zona protegida:</strong> Este pozo cuenta con per√≠metro de protecci√≥n adecuado.
                            </p>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent);
                polygon.addTo(layerGroups.pozosConProteccion);
            }
        });
    }

    function renderTierrasComunales(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.tierrasEjidales.comunal,
                    fillColor: COLORS.tierrasEjidales.comunal,
                    fillOpacity: 0.35,
                    weight: 2,
                    opacity: 0.8
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.tierrasEjidales.comunal};">üèòÔ∏è Zona Comunal Ejidal</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.tierrasEjidales.comunal};">
                            <p><strong>N√∫cleo:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                            <p><strong>Tipo:</strong> Zona de uso com√∫n</p>
                            <p><strong>Municipio:</strong> ${item.NombreMunicipio || 'Puerto Morelos'}</p>
                            ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            
                            <div style="margin-top: 10px; padding: 10px; background: #f3e8ff; border-left: 4px solid #a855f7;">
                                <strong>Marco Legal:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    Las tierras de uso com√∫n son inalienables, imprescriptibles e inembargables (Ley Agraria Art. 23, 74).
                                </p>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <strong>‚ö†Ô∏è Seguridad H√≠drica:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    Estas tierras son fundamentales para la <strong>recarga del acu√≠fero</strong>. La Fractura Holbox-Xel-H√° que atraviesa Puerto Morelos es la reserva de agua m√°s importante del norte de Quintana Roo, proveyendo agua a m√°s de 1.5 millones de habitantes de la Riviera Maya.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    Puerto Morelos debe ser reconocido como <strong>municipio proveedor de agua</strong> con normativas especiales de protecci√≥n ambiental.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 450,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.55, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.35, weight: 2 });
                });

                polygon.addTo(layerGroups.tierrasComunales);
            }
        });
    }

    function renderTierrasParceladas(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.tierrasEjidales.parcelada,
                    fillColor: COLORS.tierrasEjidales.parcelada,
                    fillOpacity: 0.35,
                    weight: 2,
                    opacity: 0.8
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.tierrasEjidales.parcelada};">üåæ Zona Parcelada</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.tierrasEjidales.parcelada};">
                            <p><strong>N√∫cleo:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                            <p><strong>Tipo:</strong> Tierra parcelada</p>
                            <p><strong>Municipio:</strong> ${item.NombreMunicipio || 'Puerto Morelos'}</p>
                            ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fed7aa; border-left: 4px solid #f97316;">
                                <strong>Marco Legal:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    Las parcelas pueden ser objeto de cualquier contrato de asociaci√≥n o aprovechamiento (Ley Agraria Art. 45, 79).
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Cambio de uso de suelo:</strong> Requiere autorizaci√≥n de la asamblea ejidal con 2/3 de votos y cumplir con normativa ambiental (MIA).
                                </p>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <strong>‚ö†Ô∏è Riesgo para Seguridad H√≠drica:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    La conversi√≥n de tierras parceladas a desarrollos inmobiliarios <strong>amenaza la recarga del acu√≠fero</strong>. Puerto Morelos se encuentra sobre la Fractura Holbox-Xel-H√°, reserva estrat√©gica que provee agua a toda la Riviera Maya.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Impactos:</strong> Impermeabilizaci√≥n del suelo, extracci√≥n masiva, contaminaci√≥n por lixiviados, p√©rdida de zonas de infiltraci√≥n.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 450,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.55, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.35, weight: 2 });
                });

                polygon.addTo(layerGroups.tierrasParceladas);
            }
        });
    }
    function renderNucleosAgrarios(data) {
    data.forEach(item => {
        const geom = parseGeometry(item);
        if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

        const coords = parseGeoJSON(geom);
        if (coords && coords.length > 0) {
            const polygon = L.polygon(coords, {
                color: '#6366f1',
                fillColor: '#6366f1',
                fillOpacity: 0.35,
                weight: 2,
                opacity: 0.8
            });

            const popupContent = `
                <div class="custom-popup">
                    <h3 style="color: #6366f1;">üèòÔ∏è N√∫cleo Agrario (RAN)</h3>
                    <div class="custom-popup-divider" style="border-color: #6366f1;">
                        <p><strong>Nombre:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                        <p><strong>Tipo:</strong> ${item.TipoNucleoAgrario || 'N/A'}</p>
                        <p><strong>Municipio:</strong> ${item.NombreMunicipio || 'Puerto Morelos'}</p>
                        ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX')} ha</p>` : ''}
                        
                        <div style="margin-top: 10px; padding: 10px; background: #e0e7ff; border-left: 4px solid #6366f1;">
                            <strong>Marco Legal (Ley Agraria):</strong>
                            <p style="font-size: 12px; margin: 5px 0;">
                                <strong>Art. 23:</strong> Las tierras ejidales comprenden parceladas, de uso com√∫n y del asentamiento humano.<br>
                                <strong>Art. 56:</strong> Cambios de uso requieren 2/3 de votos en asamblea.<br>
                                <strong>Art. 87:</strong> Modificaciones requieren autorizaci√≥n del RAN.<br>
                                <strong>Requisito ambiental:</strong> MIA ante SEMARNAT.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            polygon.bindPopup(popupContent, { maxWidth: 450 });
            polygon.on('mouseover', function() { this.setStyle({ fillOpacity: 0.55, weight: 3 }); });
            polygon.on('mouseout', function() { this.setStyle({ fillOpacity: 0.35, weight: 2 }); });
            polygon.addTo(layerGroups.nucleosAgrarios);
        }
    });
}

function renderAsentamientosHumanos(data) {
    data.forEach(item => {
        const geom = parseGeometry(item);
        if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

        const coords = parseGeoJSON(geom);
        if (coords && coords.length > 0) {
            const polygon = L.polygon(coords, {
                color: '#ec4899',
                fillColor: '#ec4899',
                fillOpacity: 0.40,
                weight: 2,
                opacity: 0.8
            });

            const popupContent = `
                <div class="custom-popup">
                    <h3 style="color: #ec4899;">üèòÔ∏è Asentamiento Humano (RAN)</h3>
                    <div class="custom-popup-divider" style="border-color: #ec4899;">
                        <p><strong>Localidad:</strong> ${item.NombreLocalidad || 'N/A'}</p>
                        <p><strong>N√∫cleo Agrario:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                        ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX')} ha</p>` : ''}
                        
                        <div style="margin-top: 10px; padding: 10px; background: #fce7f3; border-left: 4px solid #ec4899;">
                            <strong>Marco Legal (Ley Agraria Art. 63-72):</strong>
                            <p style="font-size: 12px; margin: 5px 0;">
                                √Årea necesaria para desarrollo de vida comunitaria.<br>
                                <strong>Art. 64:</strong> Solares inalienables, no transferibles a ajenos al ejido.<br>
                                <strong>Restricciones:</strong> Uso exclusivamente habitacional.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            polygon.bindPopup(popupContent, { maxWidth: 450 });
            polygon.on('mouseover', function() { this.setStyle({ fillOpacity: 0.60, weight: 3 }); });
            polygon.on('mouseout', function() { this.setStyle({ fillOpacity: 0.40, weight: 2 }); });
            polygon.addTo(layerGroups.asentamientosHumanos);
        }
    });
}

function renderFraccionamientosPOEL(data) {
    data.forEach(item => {
        const geom = parseGeometry(item);
        if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

        const coords = parseGeoJSON(geom);
        if (coords && coords.length > 0) {
            const polygon = L.polygon(coords, {
                color: '#ef4444',
                fillColor: '#ef4444',
                fillOpacity: 0.50,
                weight: 3,
                opacity: 0.9,
                dashArray: '10, 5'
            });

            const popupContent = `
                <div class="custom-popup">
                    <div style="background: #fee2e2; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 2px solid #ef4444;">
                        <h3 style="color: #991b1b; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üö®</span>
                            ALERTA CIUDADANA
                        </h3>
                        <p style="font-size: 13px; font-weight: 600; margin: 0; color: #7f1d1d;">
                            Fraccionamiento Irregular que el Municipio busca legalizar mediante POEL/PDU 2024
                        </p>
                    </div>
                    
                    <div class="custom-popup-divider" style="border-color: #ef4444;">
                        ${item.Nombre ? `<p><strong>Nombre:</strong> ${item.Nombre}</p>` : ''}
                        ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX')} ha</p>` : ''}
                        
                        <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                            <strong>‚ö†Ô∏è Situaci√≥n:</strong>
                            <p style="font-size: 12px; margin: 5px 0 0 0;">
                                Construido sin permisos. El municipio busca legalizarlo mediante POEL/PDU 2024.
                            </p>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444;">
                            <strong>üåä Implicaciones para Seguridad H√≠drica:</strong>
                            <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                <li>Precedente peligroso: incentiva construcciones ilegales</li>
                                <li>Zona de recarga del acu√≠fero: Fractura Holbox-Xel-H√°</li>
                                <li>Sin MIA: sin evaluaci√≥n de impacto ambiental</li>
                                <li>Impermeabilizaci√≥n reduce infiltraci√≥n natural</li>
                                <li>Pozos sin control sobreexplotan el acu√≠fero</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6;">
                            <strong>üë• ¬øQu√© puedes hacer?</strong>
                            <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                <li>Participar en consultas p√∫blicas del POEL/PDU 2024</li>
                                <li>Exigir MIA retroactiva</li>
                                <li>Demandar transparencia</li>
                                <li>Reportar a PROFEPA y CONAGUA</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            polygon.bindPopup(popupContent, { maxWidth: 500 });
            polygon.on('mouseover', function() { this.setStyle({ fillOpacity: 0.70, weight: 4 }); });
            polygon.on('mouseout', function() { this.setStyle({ fillOpacity: 0.50, weight: 3 }); });
            polygon.addTo(layerGroups.fraccionamientosPOEL);
        }
    });
}

    // ========== NUEVAS FUNCIONES DE RENDERIZADO RAN ==========

    function renderNucleosAgrarios(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.tierrasEjidales.nucleosAgrarios,
                    fillColor: COLORS.tierrasEjidales.nucleosAgrarios,
                    fillOpacity: 0.35,
                    weight: 2,
                    opacity: 0.8
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.tierrasEjidales.nucleosAgrarios};">üèòÔ∏è N√∫cleo Agrario (RAN)</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.tierrasEjidales.nucleosAgrarios};">
                            <p><strong>Nombre:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                            <p><strong>Tipo:</strong> ${item.TipoNucleoAgrario || 'N/A'}</p>
                            <p><strong>Municipio:</strong> ${item.NombreMunicipio || 'Puerto Morelos'}</p>
                            ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            
                            <div style="margin-top: 10px; padding: 10px; background: #e0e7ff; border-left: 4px solid #6366f1;">
                                <strong>Marco Legal:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Ley Agraria Art. 23:</strong> Las tierras ejidales comprenden las parceladas, las de uso com√∫n y las del asentamiento humano.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Art. 56:</strong> La asamblea ejidal aprobar√° cambios de uso de suelo con 2/3 de los votos.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Art. 87:</strong> Cualquier acto jur√≠dico que implique modificaci√≥n requiere autorizaci√≥n del RAN.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Requisito ambiental:</strong> Cambios de uso de suelo requieren MIA (Manifestaci√≥n de Impacto Ambiental) ante SEMARNAT.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 450,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.55, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.35, weight: 2 });
                });

                polygon.addTo(layerGroups.nucleosAgrarios);
            }
        });
    }

    function renderAsentamientosHumanos(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.tierrasEjidales.asentamientos,
                    fillColor: COLORS.tierrasEjidales.asentamientos,
                    fillOpacity: 0.40,
                    weight: 2,
                    opacity: 0.8
                });

                const popupContent = `
                    <div class="custom-popup">
                        <h3 style="color: ${COLORS.tierrasEjidales.asentamientos};">üèòÔ∏è Asentamiento Humano (RAN)</h3>
                        <div class="custom-popup-divider" style="border-color: ${COLORS.tierrasEjidales.asentamientos};">
                            <p><strong>Localidad:</strong> ${item.NombreLocalidad || 'N/A'}</p>
                            <p><strong>N√∫cleo Agrario:</strong> ${item.NombreNucleoAgrario || 'N/A'}</p>
                            ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            ${item.IdAsentamientoHumano ? `<p><strong>ID:</strong> ${item.IdAsentamientoHumano}</p>` : ''}
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fce7f3; border-left: 4px solid #ec4899;">
                                <strong>Marco Legal:</strong>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Ley Agraria Art. 63-72:</strong> Las tierras del asentamiento humano son el √°rea necesaria para el desarrollo de la vida comunitaria del ejido.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Art. 64:</strong> Los solares son inalienables y no pueden transferirse a personas ajenas al ejido.
                                </p>
                                <p style="font-size: 12px; margin: 5px 0;">
                                    <strong>Restricciones:</strong> Uso exclusivamente habitacional. Densidad y extensi√≥n determinadas por reglamento interno del ejido.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 450,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.60, weight: 3 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.40, weight: 2 });
                });

                polygon.addTo(layerGroups.asentamientosHumanos);
            }
        });
    }

    function renderFraccionamientosPOEL(data) {
        data.forEach(item => {
            const geom = parseGeometry(item);
            if (!geom || (geom.type !== 'Polygon' && geom.type !== 'MultiPolygon')) return;

            const coords = parseGeoJSON(geom);
            if (coords && coords.length > 0) {
                const polygon = L.polygon(coords, {
                    color: COLORS.tierrasEjidales.fraccionamientos,
                    fillColor: COLORS.tierrasEjidales.fraccionamientos,
                    fillOpacity: 0.50,
                    weight: 3,
                    opacity: 0.9,
                    dashArray: '10, 5'
                });

                const popupContent = `
                    <div class="custom-popup">
                        <div style="background: #fee2e2; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 2px solid #ef4444;">
                            <h3 style="color: #991b1b; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;">üö®</span>
                                ALERTA CIUDADANA
                            </h3>
                            <p style="font-size: 13px; font-weight: 600; margin: 0; color: #7f1d1d;">
                                Fraccionamiento Irregular que el Municipio busca legalizar mediante POEL/PDU 2024
                            </p>
                        </div>
                        
                        <div class="custom-popup-divider" style="border-color: ${COLORS.tierrasEjidales.fraccionamientos};">
                            ${item.Nombre ? `<p><strong>Nombre:</strong> ${item.Nombre}</p>` : ''}
                            ${item.Area ? `<p><strong>√Årea:</strong> ${parseFloat(item.Area).toLocaleString('es-MX', {maximumFractionDigits: 2})} ha</p>` : ''}
                            
                            <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <strong>‚ö†Ô∏è Situaci√≥n:</strong>
                                <p style="font-size: 12px; margin: 5px 0 0 0;">
                                    Este fraccionamiento fue construido <strong>sin los permisos correspondientes</strong> y ahora el municipio busca legalizarlo mediante la actualizaci√≥n del POEL/PDU 2024.
                                </p>
                            </div>
                            
                            <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444;">
                                <strong>üåä Implicaciones para Seguridad H√≠drica:</strong>
                                <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                    <li><strong>Precedente peligroso:</strong> Legalizar desarrollos irregulares incentiva m√°s construcciones ilegales</li>
                                    <li><strong>Zona de recarga del acu√≠fero:</strong> Puerto Morelos est√° sobre la Fractura Holbox-Xel-H√°, reserva estrat√©gica de agua para 1.5 millones de habitantes</li>
                                    <li><strong>Sin evaluaci√≥n ambiental previa:</strong> Estas construcciones se realizaron sin MIA, sin considerar impacto en el acu√≠fero</li>
                                    <li><strong>Impermeabilizaci√≥n:</strong> Reducci√≥n de zonas de infiltraci√≥n natural del agua de lluvia</li>
                                    <li><strong>Extracci√≥n no planificada:</strong> Pozos sin control que sobreexplotan el acu√≠fero</li>
                                    <li><strong>Contaminaci√≥n:</strong> Aguas residuales y lixiviados sin tratamiento adecuado</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6;">
                                <strong>üë• ¬øQu√© puedes hacer como ciudadano?</strong>
                                <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                    <li><strong>Participa en las consultas p√∫blicas</strong> del POEL/PDU 2024</li>
                                    <li><strong>Exige MIA retroactiva</strong> que eval√∫e impacto real sobre el acu√≠fero</li>
                                    <li><strong>Demanda transparencia</strong> sobre permisos y autoridades responsables</li>
                                    <li><strong>Organ√≠zate</strong> con vecinos y organizaciones ambientales</li>
                                    <li><strong>Documenta</strong> irregularidades y rep√≥rtalas a PROFEPA y CONAGUA</li>
                                    <li><strong>Comparte informaci√≥n</strong> para crear conciencia ciudadana</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top: 12px; padding: 12px; background: #f3e8ff; border-left: 4px solid #a855f7; text-align: center;">
                                <p style="font-size: 13px; font-weight: 700; margin: 0; color: #6b21a8;">
                                    üíß El agua es vida. No podemos permitir que se comprometa nuestro futuro por legalizar irregularidades del pasado.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                polygon.bindPopup(popupContent, {
                    maxWidth: 500,
                    closeButton: true
                });

                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.70, weight: 4 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.50, weight: 3 });
                });

                polygon.addTo(layerGroups.fraccionamientosPOEL);
            }
        });
    }

    // ========== FUNCI√ìN PRINCIPAL DE CARGA ==========

    async function loadAllLayers() {
        updateLoading('Conectando a base de datos...');

        const layers = [
            { id: 'proyectos', table: 'proyectos inmobiliarios-tur√≠sticos ‚Äî proyectos_inmobiliario-tur', renderer: renderProyectos },
            { id: 'descargas', table: 'descargas de agua 2023 ‚Äî descarga_agua_2023_punto_copy', renderer: renderDescargas },
            { id: 'extracciones', table: 'extraccion de agua ‚Äî extraccion_de_agua_v_point', renderer: renderExtracciones },
            { id: 'cuerpos-agua', table: 'cuerpos de agua superficiales ‚Äî cuerpos_de_agua_superficia', renderer: renderCuerposAgua },
            { id: 'karstificacion', table: 'mapa de karstificacion ‚Äî karstificacion_categ', renderer: renderKarstificacion },
            { id: 'colapso-karst', table: 'colapso por karstificacion ‚Äî tabla_riesgo_colapso_copy', renderer: renderColapsoKarst },
            { id: 'fallas-inegi', table: 'Fallas INEGI ‚Äî fallas_inegi_line_copy', renderer: renderFallasINEGI },
            { id: 'fallas-cenapred', table: 'fallas cenapred ‚Äî fallas_cenapred_pm', renderer: renderFallasCENAPRED },
            { id: 'poel', table: 'poel pm 2013 ‚Äî poelpm-01102013_geo', renderer: renderPOEL },
            { id: 'socioeco', table: 'conjunto de datos (zonas inundables) ‚Äî conjuntodedatospm', renderer: renderSocioEco },
            { id: 'municipio', table: 'limite municipal pm ‚Äî limite_mpal_pm_copy', renderer: renderMunicipio },
            { id: 'pozos-sin', table: 'pozos_sin_proteccion ‚Äî pozos_sin_proteccion', renderer: renderPozosSinProteccion },
            { id: 'pozos-con', table: 'pozos con proteccion ‚Äî pozos_con_proteccion', renderer: renderPozosConProteccion },
            { id: 'tierras-comunales', table: 'tierras_de_uso_comun_ejidal ‚Äî tierras_de_uso_comun_ejida', renderer: renderTierrasComunales },
            { id: 'tierras-parceladas', table: 'tierras parceladas ‚Äî tierras_parceladas_copy', renderer: renderTierrasParceladas },
            { id: 'nucleos-agrarios', table: 'nucleos agrarios (ran) ‚Äî zo_nucleosagrarios_ran_copy', renderer: renderNucleosAgrarios },
            { id: 'asentamientos-humanos', table: 'zona asentamientos humanos (RAN) ‚Äî zo_asentamientoshumanos_ra', renderer: renderAsentamientosHumanos },
            { id: 'fraccionamientos-poel', table: 'fraccionamiento que busca legalizar el poel nuevo ‚Äî fracc_poe', renderer: renderFraccionamientosPOEL }
        ];

        for (const layer of layers) {
            try {
                updateLoading(`Cargando ${layer.id}...`);
                console.log(`Iniciando carga de: ${layer.table}`);

                const { data, error } = await supabaseClient
                    .from(layer.table)
                    .select('*');

                if (error) {
                    console.error(`Error cargando ${layer.id}:`, error);
                    updateLayerCount(layer.id, 0);
                    continue;
                }

                if (!data || data.length === 0) {
                    console.warn(`${layer.id}: Sin datos`);
                    updateLayerCount(layer.id, 0);
                    continue;
                }

                console.log(`${layer.id}: ${data.length} registros obtenidos`);

                if (layer.id === 'descargas') {
                    maxVolumenDescarga = Math.max(...data.map(d => d.vol || 0));
                    console.log('Max volumen descarga:', maxVolumenDescarga);
                }
                if (layer.id === 'extracciones') {
                    maxVolumenExtraccion = Math.max(...data.map(d => d.vol || 0));
                    console.log('Max volumen extracci√≥n:', maxVolumenExtraccion);
                }
                if (layer.id === 'karstificacion') {
                    const intensidades = data.map(d => d.intensidad || 0).filter(i => i > 0);
                    if (intensidades.length > 0) {
                        maxIntensidadKarst = Math.max(...intensidades);
                        minIntensidadKarst = Math.min(...intensidades);
                        console.log('Rango karstificaci√≥n:', minIntensidadKarst, '-', maxIntensidadKarst);
                    }
                }

                layer.renderer(data);
                updateLayerCount(layer.id, data.length);
                console.log(`‚úì ${layer.id} renderizado`);

            } catch (e) {
                console.error(`Excepci√≥n cargando ${layer.id}:`, e);
                updateLayerCount(layer.id, 0);
            }
        }

        await checkAuthState();

        updateLoading('Geoportal cargado correctamente');
        setTimeout(hideLoading, 500);
    }

    // ========== FUNCIONES DE CONTROL DE CAPAS ==========

    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        const iconId = panelId === 'control-panel' ? 'control-toggle-icon' : 'legends-toggle-icon';
        const icon = document.getElementById(iconId);
        
        if (panel.classList.contains('panel-minimized')) {
            panel.classList.remove('panel-minimized');
            icon.textContent = '‚àí';
        } else {
            panel.classList.add('panel-minimized');
            icon.textContent = '+';
        }
    }

    function toggleAllLayers() {
        const allCheckboxes = document.querySelectorAll('.layer-control input[type="checkbox"]');
        const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
        
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !anyChecked;
            checkbox.dispatchEvent(new Event('change'));
        });
    }

    // ========== INICIALIZACI√ìN ==========

    window.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM cargado, esperando librer√≠as...');
        
        while (typeof L === 'undefined' || typeof proj4 === 'undefined' || typeof supabase === 'undefined') {
            console.log('Esperando Leaflet, Proj4 y Supabase...');
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        console.log('‚úì Todas las librer√≠as cargadas');
        
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('‚úì Cliente Supabase inicializado');

        map = L.map('map', {
            center: [20.85, -86.88],
            zoom: 12,
            zoomControl: true
        });

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri',
            maxZoom: 19
        }).addTo(map);

        layerGroups = {
            proyectos: L.layerGroup().addTo(map),
            proyectosColab: L.layerGroup().addTo(map),
            descargas: L.layerGroup().addTo(map),
            extracciones: L.layerGroup().addTo(map),
            cuerposAgua: L.layerGroup().addTo(map),
            piscinas: L.layerGroup().addTo(map),
            cenotesSup: L.layerGroup().addTo(map),
            cenotesSub: L.layerGroup().addTo(map),
            aguadasArt: L.layerGroup().addTo(map),
            aguadasNat: L.layerGroup().addTo(map),
            sascab: L.layerGroup().addTo(map),
            rios: L.layerGroup().addTo(map),
            karstificacion: L.layerGroup().addTo(map),
            colapsoKarst: L.layerGroup().addTo(map),
            fallasINEGI: L.layerGroup().addTo(map),
            fallasCENAPRED: L.layerGroup().addTo(map),
            poel: L.layerGroup().addTo(map),
            socioeco: L.layerGroup().addTo(map),
            municipio: L.layerGroup().addTo(map),
            pozosSinProteccion: L.layerGroup().addTo(map),
            pozosConProteccion: L.layerGroup().addTo(map),
            tierrasComunales: L.layerGroup().addTo(map),
            tierrasParceladas: L.layerGroup().addTo(map),
            nucleosAgrarios: L.layerGroup().addTo(map),
            asentamientosHumanos: L.layerGroup().addTo(map),
            fraccionamientosPOEL: L.layerGroup().addTo(map)
        };

        document.getElementById('layer-proyectos').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.proyectos);
            else map.removeLayer(layerGroups.proyectos);
        });

        document.getElementById('layer-proyectos-colab').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.proyectosColab);
            else map.removeLayer(layerGroups.proyectosColab);
        });

        document.getElementById('layer-descargas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.descargas);
            else map.removeLayer(layerGroups.descargas);
        });

        document.getElementById('layer-extracciones').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.extracciones);
            else map.removeLayer(layerGroups.extracciones);
        });

        document.getElementById('layer-cuerpos-agua').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            if (isChecked) {
                map.addLayer(layerGroups.cuerposAgua);
            } else {
                map.removeLayer(layerGroups.cuerposAgua);
            }
            
            document.querySelectorAll('#layer-piscinas, #layer-cenotes-sup, #layer-cenotes-sub, #layer-aguadas-art, #layer-aguadas-nat, #layer-sascab, #layer-rios').forEach(cb => {
                cb.checked = isChecked;
                cb.dispatchEvent(new Event('change'));
            });
        });

        document.getElementById('layer-piscinas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.piscinas);
            else map.removeLayer(layerGroups.piscinas);
        });

        document.getElementById('layer-cenotes-sup').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.cenotesSup);
            else map.removeLayer(layerGroups.cenotesSup);
        });

        document.getElementById('layer-cenotes-sub').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.cenotesSub);
            else map.removeLayer(layerGroups.cenotesSub);
        });

        document.getElementById('layer-aguadas-art').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.aguadasArt);
            else map.removeLayer(layerGroups.aguadasArt);
        });

        document.getElementById('layer-aguadas-nat').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.aguadasNat);
            else map.removeLayer(layerGroups.aguadasNat);
        });

        document.getElementById('layer-sascab').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.sascab);
            else map.removeLayer(layerGroups.sascab);
        });

        document.getElementById('layer-rios').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.rios);
            else map.removeLayer(layerGroups.rios);
        });

        document.getElementById('layer-karstificacion').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.karstificacion);
            else map.removeLayer(layerGroups.karstificacion);
        });

        document.getElementById('layer-colapso-karst').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.colapsoKarst);
            else map.removeLayer(layerGroups.colapsoKarst);
        });

        document.getElementById('layer-fallas-inegi').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fallasINEGI);
            else map.removeLayer(layerGroups.fallasINEGI);
        });

        document.getElementById('layer-fallas-cenapred').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fallasCENAPRED);
            else map.removeLayer(layerGroups.fallasCENAPRED);
        });

        document.getElementById('layer-poel').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.poel);
            else map.removeLayer(layerGroups.poel);
        });

        document.getElementById('layer-socioeco').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.socioeco);
            else map.removeLayer(layerGroups.socioeco);
        });

        document.getElementById('layer-municipio').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.municipio);
            else map.removeLayer(layerGroups.municipio);
        });

        document.getElementById('layer-pozos-sin').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.pozosSinProteccion);
            else map.removeLayer(layerGroups.pozosSinProteccion);
        });

        document.getElementById('layer-pozos-con').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.pozosConProteccion);
            else map.removeLayer(layerGroups.pozosConProteccion);
        });

        document.getElementById('layer-tierras-comunales').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.tierrasComunales);
            else map.removeLayer(layerGroups.tierrasComunales);
        });

        document.getElementById('layer-tierras-parceladas').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.tierrasParceladas);
            else map.removeLayer(layerGroups.tierrasParceladas);
        });

        document.getElementById('layer-nucleos-agrarios').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.nucleosAgrarios);
            else map.removeLayer(layerGroups.nucleosAgrarios);
        });

        document.getElementById('layer-asentamientos-humanos').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.asentamientosHumanos);
            else map.removeLayer(layerGroups.asentamientosHumanos);
        });

        document.getElementById('layer-fraccionamientos-poel').addEventListener('change', (e) => {
            if (e.target.checked) map.addLayer(layerGroups.fraccionamientosPOEL);
            else map.removeLayer(layerGroups.fraccionamientosPOEL);
        });

        // ========== EVENT LISTENERS PARA AUTENTICACI√ìN ==========

        document.getElementById('show-login-btn').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
        });

        document.getElementById('show-register-btn').addEventListener('click', () => {
            document.getElementById('register-modal').style.display = 'flex';
            document.getElementById('register-username').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('register-success').style.display = 'none';
        });

        document.getElementById('close-login-modal').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'none';
        });

        document.getElementById('close-register-modal').addEventListener('click', () => {
            document.getElementById('register-modal').style.display = 'none';
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                await handleLogin(email, password);
                errorDiv.style.display = 'none';
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorDiv = document.getElementById('register-error');
            const successDiv = document.getElementById('register-success');
            
            try {
                const result = await handleRegister(username, email, password);
                errorDiv.style.display = 'none';
                successDiv.textContent = '‚úÖ Registro exitoso! Por favor revisa tu email para confirmar tu cuenta.';
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('register-modal').style.display = 'none';
                }, 3000);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                await handleLogout();
            }
        });

        document.getElementById('export-csv-btn').addEventListener('click', exportProjectsToCSV);

        document.getElementById('add-project-btn').addEventListener('click', () => {
            document.getElementById('add-project-modal').style.display = 'flex';
            document.getElementById('project-nombre').value = '';
            document.getElementById('project-descripcion').value = '';
            document.getElementById('project-mia').value = '';
            document.getElementById('project-irregularidad').value = '';
            document.getElementById('project-lat').value = '';
            document.getElementById('project-lng').value = '';
            document.getElementById('add-project-error').style.display = 'none';
            document.getElementById('add-project-success').style.display = 'none';
        });

        document.getElementById('close-add-project-modal').addEventListener('click', () => {
            document.getElementById('add-project-modal').style.display = 'none';
            mapClickEnabled = false;
            map.getContainer().style.cursor = '';
            document.getElementById('map-click-indicator').style.display = 'none';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        });

        document.getElementById('close-edit-project-modal').addEventListener('click', () => {
            document.getElementById('edit-project-modal').style.display = 'none';
        });

        document.getElementById('enable-map-click').addEventListener('click', () => {
            mapClickEnabled = true;
            map.getContainer().style.cursor = 'crosshair';
            document.getElementById('map-click-indicator').style.display = 'block';
            alert('Ahora haz click en el mapa para seleccionar la ubicaci√≥n del proyecto');
        });

        document.getElementById('cancel-map-click').addEventListener('click', () => {
            mapClickEnabled = false;
            map.getContainer().style.cursor = '';
            document.getElementById('map-click-indicator').style.display = 'none';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        });

        map.on('click', async (e) => {
            if (movingProjectMode && movingProjectId) {
                if (confirm('¬øMover el proyecto a esta nueva ubicaci√≥n?')) {
                    try {
                        await updateProjectLocation(movingProjectId, e.latlng.lat, e.latlng.lng);
                        
                        await loadCollaborativeProjects();
                        
                        movingProjectMode = false;
                        movingProjectId = null;
                        map.getContainer().style.cursor = '';
                        document.getElementById('map-click-indicator').style.display = 'none';
                        
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                            tempMarker = null;
                        }
                        
                        alert('‚úÖ Proyecto movido exitosamente');
                    } catch (error) {
                        alert('‚ùå Error al mover proyecto: ' + error.message);
                    }
                }
                return;
            }
            
            if (mapClickEnabled) {
                document.getElementById('project-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('project-lng').value = e.latlng.lng.toFixed(6);
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                
                tempMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                    icon: L.divIcon({
                        className: 'temp-marker',
                        html: '<div style="background: #9333ea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                
                mapClickEnabled = false;
                map.getContainer().style.cursor = '';
                document.getElementById('map-click-indicator').style.display = 'none';
            }
        });

        document.getElementById('add-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('add-project-error');
            const successDiv = document.getElementById('add-project-success');
            
            const projectData = {
                nombre: document.getElementById('project-nombre').value,
                descripcion: document.getElementById('project-descripcion').value,
                mia: document.getElementById('project-mia').value,
                irregularidad: document.getElementById('project-irregularidad').value,
                lat: parseFloat(document.getElementById('project-lat').value),
                lng: parseFloat(document.getElementById('project-lng').value)
            };
            
            if (!projectData.lat || !projectData.lng || isNaN(projectData.lat) || isNaN(projectData.lng)) {
                errorDiv.textContent = '‚ö†Ô∏è Debes proporcionar coordenadas v√°lidas (haz click en el mapa o ingr√©salas manualmente)';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                await addProjectToMap(projectData);
                successDiv.textContent = '‚úÖ Proyecto agregado exitosamente!';
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                setTimeout(() => {
                    document.getElementById('add-project-modal').style.display = 'none';
                }, 2000);
            } catch (error) {
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        });

        document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('edit-project-error');
            const successDiv = document.getElementById('edit-project-success');
            
            const projectId = document.getElementById('edit-project-id').value;
            const projectData = {
                nombre: document.getElementById('edit-project-nombre').value,
                descripcion: document.getElementById('edit-project-descripcion').value,
                mia: document.getElementById('edit-project-mia').value,
                irregularidad: document.getElementById('edit-project-irregularidad').value,
                lat: parseFloat(document.getElementById('edit-project-lat').value),
                lng: parseFloat(document.getElementById('edit-project-lng').value)
            };
            
            if (!projectData.lat || !projectData.lng || isNaN(projectData.lat) || isNaN(projectData.lng)) {
                errorDiv.textContent = '‚ö†Ô∏è Las coordenadas no son v√°lidas';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                await updateProject(projectId, projectData);
                await loadCollaborativeProjects();
                
                successDiv.textContent = '‚úÖ Proyecto actualizado exitosamente!';
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('edit-project-modal').style.display = 'none';
                }, 2000);
            } catch (error) {
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        });

        setupAuthListener();
        setupDraggable();

        await loadAllLayers();
    });
</script></body>
</html>
```
